import{bY as q,fa as le,cb as re,M as ne,dN as oe,gJ as ae,V as X,s as he,ac as d,ad as v,ag as ie,bh as de}from"./index-DX0rcHuW.js";import{e as ee,B as ce,n as a,q as J,s as Q}from"./jsxFactory-DmHi7Kb2.js";import{n as ue,a as ve}from"./Widgets-BRltxnwe.js";import{e as U}from"./utils-CXgSw6Sd.js";import{t as fe}from"./GoTo-Bv8U0vYJ.js";import{e as _}from"./globalCss-CZa70j6i.js";import{e as Y,n as me}from"./Heading-BI51LCyX.js";import{i as w}from"./legacyIcon-CtsJ0OTG.js";import{s as te}from"./substitute-e0S7rtIE.js";import"./uuid-fwrPAdZb.js";const F="esri-floor-filter",N=`${F}__filter-menu`,h={floorFilter:F,floorFilterLayout:`${F}__layout--`,floorFilterPosition:`${F}__position--`,buttonContainer:`${F}__button-container`,buttonContainerLevels:`${F}__button-container--levels`,buttonInfo:`${F}__button-info`,buttonLabel:`${F}__button-label`,browseButton:`${F}__browse-button`,closeLevelsButton:`${F}__close-levels-button`,zoomButton:`${F}__zoom-button`,zoomButtonLevels:`${F}__zoom-button--levels`,minimizeToggleButton:`${F}__minimize-toggle-button`,levelsContainer:`${F}__levels-container`,levelButton:`${F}__level-button`,levelButtonActive:`${F}__level-button--active`,separator:`${F}__separator`,filterMenu:N,filterMenuHeader:`${N}-header`,filterMenuHeaderTextGroup:`${N}-header-text-group`,filterMenuHeaderText:`${N}-header-text`,filterMenuHeaderSubtext:`${N}-header-subtext`,filterMenuHeaderBack:`${N}-header-back`,filterMenuSearch:`${N}-search`,filterMenuSearchInput:`${N}-search-input`,filterMenuItems:`${N}-items`,filterMenuItemName:`${N}-item-name`,filterMenuSelectedItem:`${N}-item-name--selected`,filterMenuSite:`${N}-site`,filterMenuFacility:`${N}-facility`,selectedItemCircle:`${F}__selected-item-circle`};function pe(e){return e.declaredClass==="esri.WebScene"}let m=class extends fe(de){constructor(e){super(e),this.filterMenuOpen=!1,this.filterMenuType="site",this.filterMode="base-floors",this.levelsExpanded=!0,this.searchTerm=null,this.view=null,this._updateFloorFilterTask=null,this._viewHeightBreakpoint=null,this._viewWidthBreakpoint=null}initialize(){this.addHandles([q(()=>{var e;return(e=this.view)==null?void 0:e.map},e=>{this._updateFloorFilterTask!=null&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null),this._updateFloorFilterTask=re(async t=>{await this._updateFloorFilterFromMap(e),ne(t),this._setInitialViewState(e)})},le),q(()=>this.view,(e,t)=>{this._unregisterWidget(t),this._registerWidget(e),this._watchSearchResults(e)},oe),q(()=>{var e;return((e=this.view)==null?void 0:e.widthBreakpoint)??null},e=>{this._viewWidthBreakpoint=e}),q(()=>{var e;return((e=this.view)==null?void 0:e.heightBreakpoint)??null},e=>{this._viewHeightBreakpoint=e})])}destroy(){this._unregisterWidget(this.view),this.view=null,this._updateFloorFilterTask!=null&&(this._updateFloorFilterTask.abort(),this._updateFloorFilterTask=null)}set enabled(e){this._callOverride("enabled",e)}set facility(e){if(e&&this._isOverridden("facility")){const t=this.getFacility(e);this.hasMultipleSites&&(this.site=(t==null?void 0:t.siteId)||null)}this._callOverride("facility",e)}set filterFeatures(e){this._callOverride("filterFeatures",e)}set filterLayers(e){this._callOverride("filterLayers",e)}get hasFacilities(){var e,t,i,s;return((e=this.filterLayers)==null?void 0:e.facilityLayer)!=null&&((s=(i=(t=this.filterFeatures)==null?void 0:t.facilities)==null?void 0:i.facilitiesInfo)==null?void 0:s.length)>0}get hasLevels(){var e,t,i,s;return((e=this.filterLayers)==null?void 0:e.levelLayer)!=null&&((s=(i=(t=this.filterFeatures)==null?void 0:t.levels)==null?void 0:i.levelsInfo)==null?void 0:s.length)>0}get hasMultipleSites(){var e,t,i,s;return((e=this.filterLayers)==null?void 0:e.siteLayer)!=null&&((s=(i=(t=this.filterFeatures)==null?void 0:t.sites)==null?void 0:i.sitesInfo)==null?void 0:s.length)>1}get isNormalMode(){let e=!0;const t=this._viewWidthBreakpoint;return this._viewHeightBreakpoint!=="xsmall"&&t!=="xsmall"||(e=!1),e}set level(e){var l;if(!e)return this._callOverride("level",e),this.facility=null,this.site=null,void this.setFloors(null);let t=null,i=null;const s=e==null?void 0:e.split("--");if((s==null?void 0:s.length)>1&&s[0]==="all"?(i=s[1],t={id:e,facilityId:i,shortName:null,longName:null,levelNumber:null,verticalOrder:null}):(t=this.getLevel(e),i=(t==null?void 0:t.facilityId)??null),this.level!==e||this.isNormalMode||this.levelsExpanded)t&&this.hasFacilities&&this.hasLevels?(this.facility=i,this.hasMultipleSites&&(this.site=((l=this.getFacility(i))==null?void 0:l.siteId)||null),this.setFloors(t)):this._isOverridden("level")&&(this.facility=null,this.site=null,this.hasMultipleSites&&(this.filterMenuType="site"),this.setFloors(null)),this._callOverride("level",e);else{const r=this.getFacilityLevels(i);(r==null?void 0:r.length)>1&&(this.levelsExpanded=!0)}}set longNames(e){this._callOverride("longNames",e)}set minimized(e){this._callOverride("minimized",e)}set pinnedLevels(e){this._callOverride("pinnedLevels",e)}set site(e){this._callOverride("site",e)}get state(){return this.view&&this.filterFeatures&&this.hasFacilities&&this.hasLevels?"ready":this.view&&!this.filterFeatures?"loading":"disabled"}filterFacilities(e){let t=e;return this.searchTerm&&(this.searchTerm=this.searchTerm.trim(),t=e.filter(i=>{var l;const{name:s}=i;return s.toLowerCase().includes((l=this.searchTerm)==null?void 0:l.toLowerCase())})),this.site&&(t=t.filter(i=>i.siteId===this.site)),t.sort((i,s)=>{const l=i.name,r=s.name;return l.localeCompare(r,void 0,{sensitivity:"base"})})}filterSites(e){let t=e;return this.searchTerm&&(this.searchTerm=this.searchTerm.trim(),t=e.filter(i=>{var l;const{name:s}=i;return s.toLowerCase().includes((l=this.searchTerm)==null?void 0:l.toLowerCase())})),t.sort((i,s)=>{const l=i.name,r=s.name;return l.localeCompare(r,void 0,{sensitivity:"base"})})}getBaseLevel(e){var s,l;const t=(l=(s=this.filterFeatures)==null?void 0:s.levels)==null?void 0:l.levelsInfo;let i=null;if(e){const{id:r}=e;if(t&&t.length>0&&(t.forEach(n=>{n.verticalOrder===0&&n.facilityId===r&&(i=n)}),!i)){let n=null;t.forEach(o=>{o.facilityId===r&&(n?(o.verticalOrder??0)>=0?n.verticalOrder!=null&&(n.verticalOrder<0||(o.verticalOrder??0)<n.verticalOrder)&&(n=o):n.verticalOrder!=null&&o.verticalOrder!=null&&n.verticalOrder<0&&o.verticalOrder>n.verticalOrder&&(n=o):n=o)}),n&&(i=n)}}return i}getFacility(e){var t,i,s;return((s=(i=(t=this.filterFeatures)==null?void 0:t.facilities)==null?void 0:i.facilitiesInfo)==null?void 0:s.find(l=>l.id===e))??null}getFacilityLevels(e){var t,i;return!e||!((i=(t=this.filterFeatures)==null?void 0:t.levels)!=null&&i.levelsInfo)?[]:this.filterFeatures.levels.levelsInfo.filter(s=>s.facilityId===e).sort((s,l)=>{const r=s.verticalOrder??0,n=l.verticalOrder??0;return r>n?-1:r===n?0:1})}getLevel(e){var t,i,s;return((s=(i=(t=this.filterFeatures)==null?void 0:t.levels)==null?void 0:i.levelsInfo)==null?void 0:s.find(l=>l.id===e))??null}getSite(e){var t,i,s;return((s=(i=(t=this.filterFeatures)==null?void 0:t.sites)==null?void 0:i.sitesInfo)==null?void 0:s.find(l=>l.id===e))??null}goTo(e){const{view:t}=this;if(!t||!e)return;const{geometry:i}=e;i&&i.extent&&this.callGoTo({target:i.extent,options:{duration:ae(1e3),easing:"in-out-quad"}})}setFloors(e){var i,s;const{view:t}=this;t&&((s=(i=t==null?void 0:t.map)==null?void 0:i.allLayers)==null||s.forEach(l=>{l.type==="feature"&&this._computeViewAllModeFloors(l)}),t.floors=new X(this._computeFloors(e)))}updateWebDocument(e){if(U(e)){const t=new ue({enabled:this.enabled,longNames:this.longNames,minimized:this.minimized,pinnedLevels:this.pinnedLevels,site:this.site??null,facility:this.facility??null,level:this.level??null});e.widgets?e.widgets.floorFilter=t:e.widgets=new ve({floorFilter:t})}}_computeFloors(e){var t;if(this.filterMode==="single-floor")this._computeSingleFloor(e);else if(this.filterMode==="base-floors")return((t=this.view)==null?void 0:t.type)==="3d"?this._computeBaseFloors3D(e):this._computeBaseFloors(e);return this._computeEmptyFloors()}_computeSingleFloor(e){if(!e)return this._computeEmptyFloors();const t=[];return(e==null?void 0:e.id)==="all"?this.getFacilityLevels(e.facilityId).forEach(i=>{i.id&&t.push(i.id)}):e&&t.push(e.id),t}_computeBaseFloors(e){var l,r;const t=(r=(l=this.filterFeatures)==null?void 0:l.levels)==null?void 0:r.levelsInfo;if(!(t!=null&&t.length))return this._computeEmptyFloors();const i=[];(e==null?void 0:e.id)==="all"?this.getFacilityLevels(e.facilityId).forEach(n=>{n.id&&i.push(n.id)}):e&&i.push(e.id);const s=e==null?void 0:e.facilityId;return t.forEach(n=>{const{id:o,facilityId:c,verticalOrder:u}=n;(s||u!==0||i.includes(o))&&(c===s||u!==0||i.includes(o))||i.push(o)}),i}_computeBaseFloors3D(e){var r,n;const t=(n=(r=this.filterFeatures)==null?void 0:r.levels)==null?void 0:n.levelsInfo;if(!(t!=null&&t.length))return this._computeEmptyFloors();const i=[],s=(e==null?void 0:e.id.split("--"))??[];(s==null?void 0:s.length)>1&&s[0]==="all"?this.getFacilityLevels(e==null?void 0:e.facilityId).forEach(o=>{o.id&&i.push(o.id)}):e&&i.push(e.id);const l=e==null?void 0:e.facilityId;return t.forEach(o=>{const{id:c,facilityId:u}=o;(l||i.includes(c))&&(u===l||i.includes(c))||i.push(c)}),i}_computeEmptyFloors(){return[]}async _setFilterLayers(){var t,i,s,l,r,n,o,c,u,f,y,p,M,L,S,B,x,O,k;const{view:e}=this;if(e&&!this._isOverridden("filterLayers")){if(!U(e.map)&&!pe(e.map))throw new he("Map must be a webmap or webscene");{const g=e.map,$=g==null?void 0:g.allLayers;if(((t=$==null?void 0:$.items)==null?void 0:t.length)>0){const T={siteLayer:null,facilityLayer:null,levelLayer:null},z=(s=(i=g.floorInfo)==null?void 0:i.siteLayer)==null?void 0:s.layerId,C=(r=(l=g.floorInfo)==null?void 0:l.facilityLayer)==null?void 0:r.layerId,V=(o=(n=g.floorInfo)==null?void 0:n.levelLayer)==null?void 0:o.layerId,R=((u=(c=g.floorInfo)==null?void 0:c.siteLayer)==null?void 0:u.sublayerId)||((y=(f=g.floorInfo)==null?void 0:f.facilityLayer)==null?void 0:y.sublayerId)||((M=(p=g.floorInfo)==null?void 0:p.levelLayer)==null?void 0:M.sublayerId);if(!C||!V)return;const H=$.items.filter(b=>b.type==="feature"||b.type==="scene"),W=$.items.filter(b=>b.type==="map-image");if((W==null?void 0:W.length)>0&&R){await Promise.all(W.map(E=>E.load()));const b=(S=(L=g.floorInfo)==null?void 0:L.siteLayer)==null?void 0:S.sublayerId,A=(x=(B=g.floorInfo)==null?void 0:B.facilityLayer)==null?void 0:x.sublayerId,Z=(k=(O=g.floorInfo)==null?void 0:O.levelLayer)==null?void 0:k.sublayerId;W.forEach(E=>{const P=E.id,D=E==null?void 0:E.allSublayers,G=D==null?void 0:D.items;(P===z||P===C||P===V)&&(G==null?void 0:G.length)>0&&D.items.forEach(K=>{const j=K.id;P===z&&j===b?T.siteLayer=K:j===A?T.facilityLayer=K:j===Z&&(T.levelLayer=K)})})}(H==null?void 0:H.length)>0&&H.forEach(b=>{const A=b.id;A===z?T.siteLayer=b:A===C?T.facilityLayer=b:A===V&&(T.levelLayer=b)}),this.filterLayers=T}}}}async _getFilterFeatures(){if(this._isOverridden("filterFeatures"))return this.filterFeatures;const[e,t,i]=await Promise.all([this._getSites(),this._getFacilities(),this._getLevels()]);return{sites:e,facilities:t,levels:i}}async _getSites(){var u,f,y,p;const e={sitesInfo:[]},{filterLayers:t,view:i}=this,s=i==null?void 0:i.map,{siteLayer:l}=t;if(!l||!((u=s==null?void 0:s.floorInfo)!=null&&u.siteLayer))return e;const r=l.createQuery();r.returnGeometry=!0,r.outFields=["*"],r.returnZ=!0,"type"in l&&l.type==="scene"&&(r.multipatchOption="xyFootprint");const{siteIdField:n,nameField:o}=s.floorInfo.siteLayer,c=await l.queryFeatures(r);if(((f=c==null?void 0:c.features)==null?void 0:f.length)>0){const M=c.features,L=((y=l==null?void 0:l.fieldsIndex.get(n))==null?void 0:y.name)||n,S=((p=l==null?void 0:l.fieldsIndex.get(o))==null?void 0:p.name)||o;L!=null&&S!=null&&M.forEach(B=>{const x=B.attributes,O=B.geometry,k=x[L],g=x[S];k&&g&&e.sitesInfo.push({id:k,name:g,geometry:O})})}return e}async _getFacilities(){var f,y,p,M,L;const{filterLayers:e,view:t}=this,i=t==null?void 0:t.map,{facilityLayer:s}=e,l={facilitiesInfo:[]};if(!s||!((f=i==null?void 0:i.floorInfo)!=null&&f.facilityLayer))return l;const r=s.createQuery();r.returnGeometry=!0,r.outFields=["*"],r.returnZ=!0,"type"in s&&s.type==="scene"&&(r.multipatchOption="xyFootprint");const{facilityIdField:n,siteIdField:o,nameField:c}=i.floorInfo.facilityLayer,u=await s.queryFeatures(r);if(((y=u==null?void 0:u.features)==null?void 0:y.length)>0){const S=u.features,B=((p=s==null?void 0:s.fieldsIndex.get(n))==null?void 0:p.name)||n,x=((M=s==null?void 0:s.fieldsIndex.get(o))==null?void 0:M.name)||o,O=((L=s==null?void 0:s.fieldsIndex.get(c))==null?void 0:L.name)||c;B&&x&&O&&S.forEach(k=>{const g=k.attributes,$=k.geometry,T=g[B],z=g[x],C=g[O];T&&C&&l.facilitiesInfo.push({id:T,siteId:z,name:C,geometry:$})})}return l}async _getLevels(){var M,L,S,B,x,O,k,g;const{filterLayers:e,view:t}=this,i=t==null?void 0:t.map,{levelLayer:s}=e,l={levelsInfo:[]};if(!s||!((M=i==null?void 0:i.floorInfo)!=null&&M.levelLayer))return l;const r=s.createQuery();r.returnGeometry=!0,r.outFields=["*"],r.returnZ=!0;const{levelIdField:n,facilityIdField:o,longNameField:c,shortNameField:u,levelNumberField:f,verticalOrderField:y}=i.floorInfo.levelLayer,p=await s.queryFeatures(r);if(((L=p==null?void 0:p.features)==null?void 0:L.length)>0){const $=p.features,T=((S=s==null?void 0:s.fieldsIndex.get(n))==null?void 0:S.name)||n,z=((B=s==null?void 0:s.fieldsIndex.get(o))==null?void 0:B.name)||o,C=((x=s==null?void 0:s.fieldsIndex.get(c))==null?void 0:x.name)||c,V=((O=s==null?void 0:s.fieldsIndex.get(u))==null?void 0:O.name)||u,R=((k=s==null?void 0:s.fieldsIndex.get(f))==null?void 0:k.name)||f,H=((g=s==null?void 0:s.fieldsIndex.get(y))==null?void 0:g.name)||y;T&&z&&C&&V&&R&&H&&$.forEach(W=>{const b=W.attributes,A=b[T],Z=b[z],E=b[C],P=b[V],D=b[R],G=b[H];A&&Z&&E&&P&&typeof D=="number"&&typeof G=="number"&&l.levelsInfo.push({id:A,facilityId:Z,longName:E,shortName:P,levelNumber:D,verticalOrder:G})})}return l}_registerWidget(e){(e==null?void 0:e.persistableViewModels.includes(this))||(e==null||e.persistableViewModels.add(this))}_unregisterWidget(e){e==null||e.persistableViewModels.remove(this)}_watchSearchResults(e){e==null||e.on("select-result-floor",t=>{const i=this.getLevel(t);i&&this.level!==t&&(this.level=t,this.setFloors(i))})}async _setInitialViewState(e){var t;if(this.view)try{await this.view.when(),await this._setFilterLayers();const i=await this._getFilterFeatures();if(!i)return;if(this.filterFeatures=i,!this.hasFacilities||!this.hasLevels)return void console.error("Facilities and Levels are required for the Floor Filter widget");if(this.hasMultipleSites||(this.filterMenuType="facility"),this.facility&&this.level){this.filterMenuType="facility";const s=this.getFacility(this.facility),l=this.getLevel(this.level);this.site||(this.site=(s==null?void 0:s.siteId)||void 0),this.setFloors(l)}else if(this.facility&&!this.level){this.filterMenuType="facility";const s=this.getFacility(this.facility),l=this.getBaseLevel(s);this.site||(this.site=(s==null?void 0:s.siteId)||void 0),this.level=(l==null?void 0:l.id)||void 0,this.setFloors(l)}else if(!this.facility&&this.level){this.filterMenuType="facility";const s=this.getLevel(this.level),l=this.getFacility(s==null?void 0:s.facilityId);this.facility=(l==null?void 0:l.id)||void 0,this.site||(this.site=(l==null?void 0:l.siteId)||void 0),this.setFloors(s)}else if(!this.site||this.facility||this.level){if(!e||!U(e))return void this.setFloors(null);const s=(t=e==null?void 0:e.widgets)==null?void 0:t.floorFilter;if(!s)return void this.setFloors(null);s.site&&!this.site&&(this.site=s.site,this.filterMenuType="facility"),this.setFloors(null)}else this.filterMenuType="site",this.setFloors(null)}catch(i){console.error("Couldn't retrieve sites, facilities, and levels",i)}}_callOverride(e,t){this._override(e,t)}async _updateFloorFilterFromMap(e){var i;if(!e||!U(e))return;const t=(i=e==null?void 0:e.widgets)==null?void 0:i.floorFilter;t&&(this._isOverridden("enabled")||(this.enabled=t.enabled),this._isOverridden("longNames")||(this.longNames=t.longNames),this._isOverridden("minimized")||(this.minimized=t.minimized),this._isOverridden("pinnedLevels")||(this.pinnedLevels=t.pinnedLevels),this._isOverridden("site")||(this.site=t.site),this._isOverridden("facility")||(this.facility=t.facility),this._isOverridden("level")||(this.level=t.level))}_computeViewAllModeFloors(e){var i;const{filterFeatures:t}=this;if((i=e.floorInfo)!=null&&i.viewAllMode&&this.hasLevels&&this.hasFacilities&&this.filterMode==="base-floors"){const{level:s,facility:l}=this,r=[];t.levels.levelsInfo.forEach(n=>{const{id:o,facilityId:c}=n;l&&c===l?s&&o===s&&r.push(o):r.push(o)}),e.floorInfo.viewAllLevelIds=new X(r)}}};d([v({value:!1})],m.prototype,"enabled",null),d([v({value:void 0})],m.prototype,"facility",null),d([v({value:null})],m.prototype,"filterFeatures",null),d([v({value:null})],m.prototype,"filterLayers",null),d([v()],m.prototype,"filterMenuOpen",void 0),d([v()],m.prototype,"filterMenuType",void 0),d([v()],m.prototype,"filterMode",void 0),d([v()],m.prototype,"hasFacilities",null),d([v()],m.prototype,"hasLevels",null),d([v()],m.prototype,"hasMultipleSites",null),d([v({readOnly:!0})],m.prototype,"isNormalMode",null),d([v({value:void 0})],m.prototype,"level",null),d([v({value:!1})],m.prototype,"longNames",null),d([v()],m.prototype,"levelsExpanded",void 0),d([v({value:!1})],m.prototype,"minimized",null),d([v({value:!1})],m.prototype,"pinnedLevels",null),d([v()],m.prototype,"searchTerm",void 0),d([v({value:void 0})],m.prototype,"site",null),d([v({readOnly:!0})],m.prototype,"state",null),d([v()],m.prototype,"view",void 0),d([v()],m.prototype,"_viewHeightBreakpoint",void 0),d([v()],m.prototype,"_viewWidthBreakpoint",void 0),d([v()],m.prototype,"updateWebDocument",null),m=d([ie("esri.widgets.FloorFilter.FloorFilterViewModel")],m);const se=m,ye=new Set(["ArrowUp","ArrowDown","End","Home"]);let I=class extends ce{constructor(e,t){super(e,t),this._activeMenu=null,this._activeMenuIndex={levels:-1,menuItems:-1},this._baseNode=null,this._facilitiesListNode=null,this._levelsListNode=null,this._sitesListNode=null,this._searchInput=null,this.viewModel=new se,this.messages=null,this.messagesCommon=null,this.headingLevel=2,this._resizeObserver=new ResizeObserver(()=>this.scheduleRender()),this.addHandles(q(()=>this._searchInput,()=>this._focusSearch()))}destroy(){var e;(e=this._resizeObserver)==null||e.disconnect()}get enabled(){return this.viewModel.enabled}set enabled(e){this.viewModel.enabled=e}get longNames(){return this.viewModel.longNames}set longNames(e){this.viewModel.longNames=e}get minimized(){return this.viewModel.minimized}set minimized(e){this.viewModel.minimized=e}get pinnedLevels(){return this.viewModel.pinnedLevels}set pinnedLevels(e){this.viewModel.pinnedLevels=e}get site(){return this.viewModel.site}set site(e){this.viewModel.site=e}get facility(){return this.viewModel.facility}set facility(e){this.viewModel.facility=e}get level(){return this.viewModel.level}set level(e){this.viewModel.level=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get icon(){return"floor-plan"}set icon(e){this._overrideIfSome("icon",e)}updateWebDocument(e){return this.viewModel.updateWebDocument(e)}render(){var p;const{longNames:e}=this,t=e&&this.viewModel.isNormalMode?"expanded":"collapsed",i=this._renderButtons(),s=this._renderFilterMenu(),l=a("div",{class:this.classes(h.separator)}),r=this._getComponentPosition(),n=this._getPosition(r),o=r==="top-right"||r==="bottom-right",c=r==="top-left"||r==="bottom-left",u=J(this.container),f=u&&c||!u&&o?s:i,y=u&&c||!u&&o?i:s;return a("div",{afterCreate:this._afterBaseNodeCreate,class:this.classes(h.floorFilter,_.widget,`${h.floorFilterLayout}${t}`,`${h.floorFilterPosition}${n}`),key:"floor-filter-menu"},f,(p=this.viewModel)!=null&&p.filterMenuOpen?l:null,y)}_renderButtons(){const e=this._getComponentPosition(),t=[];return this._getPosition(e)==="top"?(t.push(this._renderBrowseButton()),t.push(this._renderLevelButtons()),t.push(this._renderCloseLevelsButton()),t.push(this._renderZoomButton()),t.push(this._renderCollapseToggleButton())):(t.push(this._renderCollapseToggleButton()),t.push(this._renderZoomButton()),t.push(this._renderCloseLevelsButton()),t.push(this._renderLevelButtons()),t.push(this._renderBrowseButton())),a("div",{class:this.classes(_.widget,h.buttonContainer),key:"button-container"},t)}_renderBrowseButton(){var i;const{longNames:e,messages:t}=this;return a("button",{"aria-expanded":this.viewModel.filterMenuOpen.toString(),"aria-label":t.buttons.browse,bind:this,class:this.classes(_.widget,_.widgetButton,_.interactive,(this.viewModel.state==="loading"||this.viewModel.state==="disabled")&&_.buttonDisabled,h.browseButton,((i=this.viewModel)==null?void 0:i.filterMenuOpen)&&_.widgetButtonActive),key:"browse-button",onclick:this._toggleFilterMenu,title:t.buttons.browse,type:"button"},a("div",{class:this.classes(h.buttonInfo)},a("span",{class:this.classes(w.icon,w.urbanModel)}),a("span",{class:this.classes(h.buttonLabel)},e&&this.viewModel.isNormalMode?t.buttons.browse:null)))}_renderLevelButtons(){var o,c,u,f,y,p;if(!((u=(c=(o=this.viewModel)==null?void 0:o.filterFeatures)==null?void 0:c.levels)!=null&&u.levelsInfo)||!this.facility)return null;const{facility:e,messagesCommon:t,messages:i}=this,s=(f=this.viewModel)==null?void 0:f.getFacility(e),l=(y=this.viewModel)==null?void 0:y.getFacilityLevels(e),r=l.map(M=>this._renderLevelButton(M));if(!r.length)return null;const n=s&&te(i.selector.levelsLabel,{name:`"${s.name}"`});if(this._isWebScene((p=this.view)==null?void 0:p.map)&&(r==null?void 0:r.length)>1){const M={id:`all--${e}`,facilityId:e,shortName:t.all,longName:t.all,levelNumber:null,verticalOrder:null},L=this._renderLevelButton(M);r.push(L)}return a("ul",{afterCreate:Q,"aria-label":n,bind:this,class:this.classes(h.levelsContainer),"data-id":"levels","data-node-ref":"_levelsListNode",key:"levels-button-container",onkeydown:this._handleListKeydown},r)}_renderLevelButton(e){const{longNames:t}=this,{shortName:i,longName:s,id:l}=e,r=`levels--${l}`,n=this.level===l,o=t&&this.viewModel.isNormalMode?s:i;return this.viewModel.isNormalMode||n||this.viewModel.levelsExpanded?a("li",{key:r},a("button",{bind:this,class:this.classes(_.widgetButton,n?_.widgetButtonActive:null,_.interactive,h.levelButton),"data-id":l,"data-list-id":"levels",onclick:this._levelSelected,onfocus:this._onItemFocus,type:"button"},o)):null}_renderCloseLevelsButton(){if(!this.level||this.viewModel.isNormalMode||!this.viewModel.levelsExpanded)return null;const{messagesCommon:e}=this;return a("button",{"aria-label":e.close,bind:this,class:this.classes(_.widget,_.widgetButton,_.interactive,h.closeLevelsButton),key:"close-levels-button",onclick:this._closeLevels,title:e.close,type:"button"},a("div",{class:this.classes(h.buttonInfo)},a("span",{class:this.classes(w.icon,w.close)})))}_renderZoomButton(){var u,f,y,p,M;const{longNames:e,messages:t,facility:i,site:s}=this,l=(u=this.viewModel)==null?void 0:u.filterMenuType,r=(f=this.viewModel)==null?void 0:f.filterMenuOpen,n=(y=this.viewModel)==null?void 0:y.getSite(s),o=(p=this.viewModel)==null?void 0:p.getFacility(i),c=l==="site"&&r?!n:!o;return a("button",{"aria-label":t.buttons.zoomTo,bind:this,class:this.classes(_.widget,_.widgetButton,c&&_.buttonDisabled,_.interactive,((M=this.viewModel)==null?void 0:M.getFacilityLevels(i).length)>0?h.zoomButtonLevels:h.zoomButton),key:"zoom-button",onclick:this._zoomToClicked,title:t.buttons.zoomTo,type:"button"},a("div",{class:this.classes(h.buttonInfo)},a("span",{class:this.classes(w.icon,w.zoomToObject)}),a("span",{class:this.classes(h.buttonLabel)},e&&this.viewModel.isNormalMode?t.buttons.zoomTo:null)))}_renderCollapseToggleButton(){const{longNames:e,messagesCommon:t}=this,i=e?w.collapse:w.expand,s=this.classes(w.icon,i),l=e?t.collapse:t.expand;return a("button",{"aria-label":l,bind:this,class:this.classes(_.widget,_.widgetButton,_.interactive,h.minimizeToggleButton),key:"minimize-toggle-button",onclick:this._toggleCollapsed,title:l,type:"button"},a("div",{class:this.classes(h.buttonInfo)},a("span",{class:s}),a("span",{class:this.classes(h.buttonLabel)},e&&this.viewModel.isNormalMode?t.collapse:null)))}_renderFilterMenu(){var e,t,i;return(e=this.viewModel)!=null&&e.filterMenuOpen?((t=this.viewModel)==null?void 0:t.filterMenuType)==="site"?this._renderSiteFilterMenu():((i=this.viewModel)==null?void 0:i.filterMenuType)==="facility"?this._renderFacilityFilterMenu():null:null}_renderSiteFilterMenu(){var n,o;const{messages:e,messagesCommon:t}=this,i=this.site?(o=(n=this.viewModel)==null?void 0:n.getSite(this.site))==null?void 0:o.name:e.selector.selectSite,s=a("div",{class:this.classes(`${h.filterMenuHeader}`),key:"filter-menu-site-header"},a("div",{class:this.classes(h.filterMenuHeaderTextGroup)},a(Y,{class:this.classes(h.filterMenuHeaderText),level:this.headingLevel},i)),a("button",{bind:this,class:this.classes(w.icon,w.close),onclick:this._closeClicked,title:t.close,type:"button"})),l=this._renderSearchInput(),r=this._renderSiteItems();return a("div",{class:this.classes(h.filterMenu),key:"filter-menu-site"},s,l,r)}_renderFacilityFilterMenu(){var f,y,p,M;const{messages:e,messagesCommon:t,site:i}=this,s=(y=(f=this.viewModel)==null?void 0:f.getSite(i))==null?void 0:y.name,l=this.facility&&((M=(p=this.viewModel)==null?void 0:p.getFacility(this.facility))==null?void 0:M.name)||e.selector.selectFacility,r=this.viewModel.hasMultipleSites?a("button",{bind:this,class:this.classes(h.filterMenuHeaderBack),onclick:this._backClicked,title:t.back,type:"button"},a("span",{class:this.classes(J(this.container)?w.right:w.left)})):null,n=this.viewModel.hasMultipleSites?a(Y,{class:this.classes(h.filterMenuHeaderSubtext),level:me(this.headingLevel)},s):null,o=a("div",{class:this.classes(h.filterMenuHeader),key:"filter-menu-site-header"},r,a("div",{class:this.classes(h.filterMenuHeaderTextGroup)},a(Y,{class:this.classes(h.filterMenuHeaderText),level:this.headingLevel},l),n),a("button",{bind:this,class:this.classes(w.icon,w.close),onclick:this._closeClicked,title:t.close,type:"button"})),c=this._renderSearchInput(),u=this._renderFacilityItems();return a("div",{class:this.classes(h.filterMenu),key:"filter-menu-facility"},o,c,u)}_renderSearchInput(){const{messagesCommon:e}=this;return a("div",{class:this.classes(h.filterMenuSearch),key:"filter-menu-search"},a("span",{class:this.classes(w.icon,w.search)}),a("input",{afterCreate:Q,bind:this,class:this.classes(h.filterMenuSearchInput),"data-node-ref":"_searchInput",oninput:this._onSearchChange,onpaste:this._onSearchChange,placeholder:e.search,value:this.viewModel.searchTerm??void 0}))}_renderBlueCircle(){return a("span",{class:this.classes(h.selectedItemCircle),key:"floor-filter__selected-item-circle"})}_renderSiteItems(){var l,r,n,o;if(!((n=(r=(l=this.viewModel)==null?void 0:l.filterFeatures)==null?void 0:r.sites)!=null&&n.sitesInfo))return null;const{messages:e}=this,t=this.viewModel.filterFeatures.sites.sitesInfo,i=this.viewModel.filterSites(t).map(c=>this._renderSiteItem(c)),s=i.length===0&&((o=this.viewModel)==null?void 0:o.searchTerm)&&a("div",{class:this.classes(_.empty)},e.noResults);return a("ul",{afterCreate:Q,"aria-label":e.selector.sitesLabel,bind:this,class:this.classes(h.filterMenuItems),"data-id":"sites","data-node-ref":"_sitesListNode",key:"filter-menu-items--sites",onkeydown:this._handleListKeydown,tabIndex:-1},i,s)}_renderSiteItem(e){const{name:t,id:i}=e,s=`filter-menu-site--${i}`,l=this.site===i;return a("li",{key:s},a("button",{bind:this,class:this.classes(h.filterMenuSite),"data-id":i,"data-list-id":"sites",onclick:this._siteSelected,onfocus:this._onItemFocus,type:"button"},l?this._renderBlueCircle():null,a("span",{class:this.classes(l?h.filterMenuSelectedItem:h.filterMenuItemName)},t),a("span",{class:this.classes(J(this.container)?w.left:w.right)})))}_renderFacilityItems(){var o,c,u,f;if(!((u=(c=(o=this.viewModel)==null?void 0:o.filterFeatures)==null?void 0:c.facilities)!=null&&u.facilitiesInfo))return null;const{messages:e,site:t}=this,i=this.viewModel.getSite(t),s=this.viewModel.filterFeatures.facilities.facilitiesInfo,l=this.viewModel.filterFacilities(s).map(y=>this._renderFacilityItem(y)),r=l.length===0&&((f=this.viewModel)==null?void 0:f.searchTerm)&&a("div",{class:this.classes(_.empty)},e.noResults),n=i?te(e.selector.siteFacilitiesLabel,{name:`"${i.name}"`}):e.selector.facilitiesLabel;return a("ul",{afterCreate:Q,"aria-label":n,bind:this,class:this.classes(h.filterMenuItems),"data-id":"facilities","data-node-ref":"_facilitiesListNode",key:"filter-menu-items--facilities",onkeydown:this._handleListKeydown,tabIndex:-1},l,r)}_renderFacilityItem(e){const{name:t,id:i}=e,s=`filter-menu-facility--${i}`,l=this.facility===i;return a("li",{key:s},a("button",{bind:this,class:this.classes(h.filterMenuFacility),"data-id":i,"data-list-id":"facilities",onclick:this._facilitySelected,onfocus:this._onItemFocus,type:"button"},l?this._renderBlueCircle():null,a("span",{class:this.classes(l?h.filterMenuSelectedItem:h.filterMenuItemName)},t)))}_afterBaseNodeCreate(e){var t,i;this._baseNode&&((t=this._resizeObserver)==null||t.unobserve(this._baseNode)),this._baseNode=e,(i=this._resizeObserver)==null||i.observe(this._baseNode)}_toggleCollapsed(){this.longNames=!this.longNames}_toggleFilterMenu(){var t;const e=((t=this.viewModel)==null?void 0:t.filterMenuOpen)??!1;this.viewModel.filterMenuOpen=!e}_setFilterMenuType(e){this.viewModel.filterMenuType=e}_zoomToClicked(){var e,t,i,s,l;if(this.site&&((e=this.viewModel)==null?void 0:e.filterMenuType)==="site"&&((t=this.viewModel)!=null&&t.filterMenuOpen)){const r=(i=this.viewModel)==null?void 0:i.getSite(this.site);this.viewModel.goTo(r)}else if(this.facility){const r=(s=this.viewModel)==null?void 0:s.getFacility(this.facility);this.viewModel.goTo(r)}else if(this.site){const r=(l=this.viewModel)==null?void 0:l.getSite(this.site);this.viewModel.goTo(r)}}_onSearchChange(e){var i;const t=e.target;t.value===""?this.viewModel.searchTerm=null:t.value&&((i=this.viewModel)==null?void 0:i.searchTerm)!==t.value&&(this.viewModel.searchTerm=t.value)}_closeClicked(){this.viewModel.searchTerm=null,this.viewModel.filterMenuOpen=!1}_backClicked(){this._setFilterMenuType("site"),this.viewModel.searchTerm=null}_siteSelected(e){const t=e.currentTarget.getAttribute("data-id"),i=this.viewModel.getSite(t);let s=!1;this.site!==t&&(this.facility=null,this.level=null,s=!0,this.viewModel.levelsExpanded=!1),this.site=t,this.viewModel.searchTerm=null,this._setFilterMenuType("facility"),this.viewModel.goTo(i),s&&this.viewModel.setFloors(null)}_facilitySelected(e){var l;const t=e.currentTarget.getAttribute("data-id"),i=this.viewModel.getFacility(t);let s=!1;if(this.facility!==t){if(this.viewModel.filterMode==="base-floors"){const r=(l=this.viewModel)==null?void 0:l.getBaseLevel(i);this.level=r?r.id:null}else this.level=null;s=!0,this.viewModel.levelsExpanded=!1}if(this.facility=t,this.viewModel.goTo(i),s){const r=this.viewModel.getLevel(this.level);this.viewModel.setFloors(r)}if(!this.viewModel.isNormalMode){const r=this.viewModel.getFacilityLevels(t);(r==null?void 0:r.length)>1&&(this.viewModel.levelsExpanded=!0)}setTimeout(()=>this._focusActiveLevel(),50)}_levelSelected(e){const t=e.currentTarget.getAttribute("data-id");this.level=t}_closeLevels(){this.viewModel.levelsExpanded=!1}_isWebScene(e){return(e==null?void 0:e.declaredClass)==="esri.WebScene"}_getComponentPosition(){var e,t;return this.container!=null?(t=(e=this.view)==null?void 0:e.ui)==null?void 0:t.getPosition(this.container):null}_getPosition(e){switch(e){case"bottom-right":case"bottom-left":return"bottom";default:return"top"}}_handleListKeydown(e){const t=e.currentTarget.getAttribute("data-id");let i=null;t==="sites"||t==="facilities"?(this._activeMenu!==t&&(this._activeMenuIndex.menuItems=-1),this._activeMenu=t,i="menuItems"):t==="levels"&&(i="levels");const s=t==="sites"?this._sitesListNode:t==="facilities"?this._facilitiesListNode:t==="levels"?this._levelsListNode:null,{key:l}=e,r=l==="Tab",n=ye.has(l);n&&e.preventDefault();const o=s==null?void 0:s.getElementsByTagName("li");o&&o.length!==0&&(n||r)&&this._handleItemNavigation(l,e.shiftKey,o,r,i)}_handleItemNavigation(e,t,i,s,l){if(!l)return;this._activeMenuIndex[l]===i.length&&this._activeMenuIndex[l]--,this._activeMenuIndex[l]===-1&&this._activeMenuIndex[l]++;const r=this._activeMenuIndex[l];switch(e){case"Home":this._activeMenuIndex[l]=0;break;case"End":this._activeMenuIndex[l]=i.length-1;break;case"ArrowUp":this._activeMenuIndex[l]=this._activeMenuIndex[l]<=0?i.length-1:this._activeMenuIndex[l]-1;break;case"ArrowDown":this._activeMenuIndex[l]=this._activeMenuIndex[l]===i.length-1?0:this._activeMenuIndex[l]+1}if(e==="Tab"&&t&&this._activeMenuIndex[l]>=0&&this._activeMenuIndex[l]--,e==="Tab"&&!t&&this._activeMenuIndex[l]<i.length&&this._activeMenuIndex[l]++,r!==this._activeMenuIndex[l]&&this._activeMenuIndex[l]>-1&&this._activeMenuIndex[l]<i.length&&!s){const n=i[this._activeMenuIndex[l]].getElementsByTagName("button"),o=(n==null?void 0:n.length)===1?n[0]:null;o==null||o.focus()}}_focusSearch(){var e;(e=this._searchInput)==null||e.focus()}_focusActiveLevel(){var r;const{level:e}=this,t=this._levelsListNode,i=t==null?void 0:t.getElementsByTagName("li");if(!e||!t||!i)return;const s=(r=this._facilitiesListNode)==null?void 0:r.getElementsByTagName("li");this._activeMenuIndex.menuItems=s?s.length-1:-1;const l=[];for(let n=0;n<i.length;n++){const o=i[n].getElementsByTagName("button");(o==null?void 0:o.length)===1&&l.push(o[0])}l.forEach((n,o)=>{n.getAttribute("data-id")===e&&(n.focus(),this._activeMenuIndex.levels=o)})}_onItemFocus(e){const t=e.currentTarget,i=t.getAttribute("data-list-id"),s=t.getAttribute("data-id"),l=i==="sites"?this._sitesListNode:i==="facilities"?this._facilitiesListNode:i==="levels"?this._levelsListNode:null;if(!l)return;const r=l==null?void 0:l.getElementsByTagName("li");if(!r)return;const n=[];Array.from(r).forEach(u=>{const f=u.getElementsByTagName("button");(f==null?void 0:f.length)===1&&n.push(f[0])});let o=null;switch(i){case"sites":case"facilities":o="menuItems";break;case"levels":o="levels"}if(!o)return;const c=o;n.forEach((u,f)=>{u.getAttribute("data-id")===s&&this._activeMenuIndex[c]!==f&&(this._activeMenuIndex[c]=f)})}};d([v()],I.prototype,"_searchInput",void 0),d([v()],I.prototype,"enabled",null),d([v()],I.prototype,"longNames",null),d([v()],I.prototype,"minimized",null),d([v()],I.prototype,"pinnedLevels",null),d([v()],I.prototype,"site",null),d([v()],I.prototype,"facility",null),d([v()],I.prototype,"level",null),d([v()],I.prototype,"view",null),d([v({type:se})],I.prototype,"viewModel",void 0),d([v(),ee("esri/widgets/FloorFilter/t9n/FloorFilter")],I.prototype,"messages",void 0),d([v(),ee("esri/t9n/common")],I.prototype,"messagesCommon",void 0),d([v()],I.prototype,"goToOverride",null),d([v()],I.prototype,"headingLevel",void 0),d([v()],I.prototype,"icon",null),I=d([ie("esri.widgets.FloorFilter")],I);const Be=I;export{Be as default};
