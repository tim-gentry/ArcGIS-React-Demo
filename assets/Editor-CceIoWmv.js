const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/symbolLayerUtils-CuNRZSQV.js","assets/index-DX0rcHuW.js","assets/index-B2yzeq1w.css","assets/Upload-BUSBqM6b.js","assets/progressUtils-BAUYKe1N.js","assets/infoFor3D-CxOdoily.js","assets/helpMessageUtils3d-CB9ADCcM.js","assets/elevationInfoUtils-JmMUMmCn.js","assets/calcite-scrim-ChpvlkQb.js","assets/scrim-CLRFMMcr.js","assets/jsxFactory-DmHi7Kb2.js","assets/uuid-fwrPAdZb.js","assets/locale-jvDArz_C.js","assets/dom-Dv5tDaqe.js","assets/key-D5DPfjW0.js","assets/observers-CLdbMMrh.js","assets/t9n-Bv5oqD69.js","assets/loader-CQvnYTBN.js","assets/calcite-button-B3dK3J4O.js","assets/button-D77aSY9T.js","assets/form-DT0Txu1X.js","assets/interactive-CM5F_5Ay.js","assets/label-CcvHzygA.js","assets/component-ByvC-PUv.js","assets/loadable-BpL5xwNx.js","assets/icon-CWAu07D3.js","assets/calcite-notice-DA7FQ9_1.js","assets/conditionalSlot-CqkDrxC7.js","assets/openCloseComponent-BcNBZQe2.js","assets/calcite-accordion-DJA6uq4Y.js","assets/calcite-accordion-item-CudDdE0M.js","assets/calcite-icon-W-AdNGRC.js","assets/calcite-loader-DWyhLzpy.js","assets/calcite-flow-item-C1dz4xH2.js","assets/panel-DPpK0hDp.js","assets/action-menu-D84YVNtM.js","assets/array-DofFqflK.js","assets/action-BdLH7y4R.js","assets/popover-Zk0D1hdH.js","assets/floating-ui-CVXgJmXk.js","assets/debounce-C5YDvsuO.js","assets/focusTrapComponent-CklV4nIL.js","assets/Heading-DiaW_And.js","assets/FloatingArrow-Cy8j4zsH.js","assets/calcite-flow-DRMo8BV0.js","assets/calcite-list-Dnyd1Dz_.js","assets/resources4-CT6dxwoZ.js","assets/utils3-DHpXCuCx.js","assets/filter-BHzLPuAd.js","assets/input2-Dot_SaOW.js","assets/Validation-BmSC9xQN.js","assets/input-Dt5r39B0.js","assets/input-message-D42H2lMx.js","assets/progress-Cn98mWq-.js"])))=>i.map(i=>d[i]);
import{ac as o,ad as l,ag as O,bh as ie,V as Fe,o6 as Yt,ox as Xt,oy as ea,oz as ta,oA as aa,h1 as ia,bY as F,ar as I,d as it,M as _e,eH as X,eJ as H,a as sa,fo as ra,_ as V,eG as Oe,fd as We,eQ as oa,oB as na,eU as Et,mm as At,cb as $t,eB as Le,b5 as Wt,s as $,j2 as la,L as st,as as wt,lZ as pe,cx as Ie,fa as ae,dN as we,dI as rt,h7 as da,nr as ca,oC as pa,eK as ua,cw as gt,oD as yt,m5 as ha,n as z,eE as He,cy as ma,cA as fa,b$ as Re,B as wa,O as ga,G as Ue,A as ya,w as va,C as _a,b_ as J,bZ as ge,id as Ge,ii as ka,ij as ba,mz as Ma,b6 as ze,dM as Fa}from"./index-DX0rcHuW.js";import{l as Te,a as Ia}from"./isSupportedObject-DZrOSWxn.js";import{y as Ca,I as Ea}from"./Attachments-DXLBKqC7.js";import{Y as St,a as Vt,Z as Aa,n as $a,s as Wa}from"./FeatureForm-C4gJkA2z.js";import{t as Ot,h as Sa,o as Va,F as Oa,m as Ta}from"./FeatureTemplates-DgSywfIx.js";import{p as Pa,h as La}from"./Spinner-D82_54Uv.js";import{r as se,n as h,f as Ne,u as ot,T as Ua,e as xe,B as xa}from"./jsxFactory-DmHi7Kb2.js";import{h as Tt}from"./UpdatingHandles-CERUeL1P.js";import nt from"./GraphicsLayer-SBXo_p0G.js";import{e as Be}from"./editableLayers-DuIVmwOk.js";import{l as Da,k as Pt,I as Ha}from"./SnappingManager-C8RCylzd.js";import{r as vt}from"./uuid-fwrPAdZb.js";import{e as Ra}from"./helpMessageUtils-M95XMmyR.js";import{_ as Lt}from"./InputManager-abOXR3ru.js";import{o as Ga,r as za}from"./drapedUtils-C1LMlkrW.js";import{L as qe}from"./symbolUtils-d94wRD2Y.js";import{e as Ut}from"./GraphicState-8Z_F1at3.js";import{t as Na,s as xt}from"./hitTestSelectUtils-UXJPjatw.js";import{p as lt}from"./SketchViewModel-CW2OqW_5.js";import{h as Dt}from"./HighlightHelper-C-sbQSeG.js";import{v as Ba}from"./elevationInfoUtils-JmMUMmCn.js";import{n as qa}from"./layerViewUtils-D2JqIDZ8.js";import{K as ja,J as Za}from"./featureUtils-5jWDUftn.js";import{u as Ka,i as Qa}from"./infoFor3D-CxOdoily.js";import{l as Ja}from"./ViewingMode-Dodu7ZZk.js";import{z as Ya}from"./featureFormUtils-CYPLvOWh.js";import{s as dt,k as Xa,L as ei}from"./SnappingControls-CTI1mz5k.js";import{s as Se}from"./substitute-e0S7rtIE.js";import{e as je,n as Ce}from"./Heading-BI51LCyX.js";import{l as ti,m as ai,i as ii}from"./uploadAssetErrors-cyorhvqm.js";import{e as _t}from"./globalCss-CZa70j6i.js";import{e as si}from"./vmEvent-D4Ubqkbq.js";import"./SketchLabelOptions-zVB6yjLA.js";import"./unitFormatUtils-BYvkXWcg.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./Cyclical-CEj-eenM.js";import"./quantityUtils-DSpmykXR.js";import"./AttachmentInfo-CypukXoR.js";import"./legacyIcon-CtsJ0OTG.js";import"./FeatureLayerBase-uK0oK06Z.js";import"./inputs-Due4QVtL.js";import"./formUtils-Dni92j4V.js";import"./HeightModelInfo-DaJXTLDg.js";import"./arcgisLayerUrl-BpJodxxk.js";import"./LayerFloorInfo-D-bXPB8b.js";import"./Relationship-Clp_49iY.js";import"./serviceCapabilitiesUtils-CIgEASrL.js";import"./FieldInput-ceCDYTYN.js";import"./utils-CZ12wTZ2.js";import"./Basemap-CjElSnyL.js";import"./loadAll-8MiqgLTH.js";import"./writeUtils-RiCb1SCd.js";import"./arcade-B3Cvm7De.js";import"./TimeOnly-DZBbU_oj.js";import"./ImmutableArray-BPVd6ESQ.js";import"./FeatureLayer-Bb5mf85J.js";import"./editsZScale-BDLbHb5e.js";import"./queryZScale-B1r3mH-Y.js";import"./APIKeyMixin-DSbft86T.js";import"./ArcGISService-CVVnFG2B.js";import"./EditBusLayer-Brt5ASt_.js";import"./FeatureType-Bb4KOLCq.js";import"./versionUtils-DlHqsQBg.js";import"./styleUtils-CxRaW7Jr.js";import"./TopFeaturesQuery-B-wHLSqs.js";import"./interfaces-CL2NbQte.js";import"./FeatureRelationshipViewModel-Ce0Hgjfu.js";import"./ReactiveMap-r-vujrh9.js";import"./ReactiveSet-BcQY7AxE.js";import"./AnchorElementViewModel-tkNzekRS.js";import"./GraphicsCollection-BjA_qBYu.js";import"./catalogUtils-B2PovfNH.js";import"./projectVectorToVector-DjKO2tJh.js";import"./projectPointToVector-6lqiVL77.js";import"./vec2-C-4tM9Uv.js";import"./vec2f64-Diu2Kaa8.js";import"./geodesicUtils-BPlO99Nt.js";import"./plane-BL9J6YX0.js";import"./mat3f64-BBpwCtoL.js";import"./mat4f64-Dk4dwAN8.js";import"./quatf64-BrpT0VRp.js";import"./mathUtils-BsqbT0oM.js";import"./sphere-COyqsaGw.js";import"./geometry2dUtils-D5ud2BJg.js";import"./floorFilterUtils-DZ5C6FQv.js";import"./keybindings-RFI4I3n4.js";import"./utils-CXgSw6Sd.js";import"./geodesicLengthMeasurementUtils-1VjlYqtL.js";import"./geometryEngine-C92iiwvG.js";import"./geometryEngineBase-RmbNeFm7.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./hydrated-CEL7VY_R.js";import"./signal-CpmfLcHB.js";import"./utils-BbU12Hvz.js";import"./cimSymbolUtils-DzDRYI6s.js";import"./mat2df32-orApM5a3.js";import"./mat2d-CXMJJ9G6.js";import"./webStyleSymbolUtils-CT_ZIx-N.js";import"./devEnvironmentUtils-D6qIi8Ky.js";import"./layerUtils-BS1Di3Pm.js";import"./screenUtils-BcEL8jIe.js";import"./directionModeIcons-Br5woIHu.js";import"./layerListUtils-BVwRmkZ0.js";import"./LayerListViewModel-MYdpjDKH.js";import"./ListItem-DtMf9zrO.js";import"./widget-Co0CQfZ6.js";const re="esri-editor",oe={base:re,helpMessage:`${re}__help-message`,updateActions:`${re}__update-actions`,updateActionsList:`${re}__update-actions-list`,featureTemplatesContainer:`${re}__feature-templates-container`,templateItemContentEnd:`${re}__template-item-content-end`};let N=class extends ie{constructor(t){super(t),this.creationInfo=null,this.editorItem=null,this.parent=null,this.pendingFeatures=new Fe,this.sketchOptions=null,this.snappingManager=null,this.viewModel=null,this.upload=null}};o([l()],N.prototype,"creationInfo",void 0),o([l()],N.prototype,"editorItem",void 0),o([l()],N.prototype,"parent",void 0),o([l({constructOnly:!0})],N.prototype,"sketchOptions",void 0),o([l()],N.prototype,"snappingManager",void 0),o([l()],N.prototype,"viewModel",void 0),o([l()],N.prototype,"upload",void 0),N=o([O("esri.widgets.Editor.CreateFeaturesWorkflowData")],N);function ct(e){const t=e.sourceLayer;if(!t||t.type!=="feature"||!di(t.renderer))return{rotation:null,size:null};let a=null,i=null;const s=t.renderer.getVisualVariablesForType("rotation").filter(n=>(!n.axis||n.axis==="heading")&&n.field&&!n.valueExpression&&Yt(n,e)!=null);s.length===1&&(a=ri(s[0],t));const r=t.renderer.getVisualVariablesForType("size").filter(n=>n.field&&!n.useSymbolValue&&!n.valueExpression&&Xt(n)===ea.RealWorldSize&&ta(n,e)!=null);return r.length===1&&(i=li(r[0],t)),{rotation:a,size:i}}function ri(e,t){const a=(e.axis||"heading")==="heading"&&e.rotationType==="arithmetic"?-1:1,i=e.field,s=t.fields&&t.fields.filter(d=>d.name===i),r=s&&s.length===1?s[0].type:"double",n={initial:0,current:0};return{field:i,fieldType:r,getDefault:()=>Promise.resolve(0),getValue:d=>(n.current=n.initial-a*d,Ze((n.current+360)%360,r)),setInitialValue:d=>{n.initial=d,n.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}function oi(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}async function ni(e,t,a){if(t==null)return 0;const{symbol:i}=ra(t);if(i==null||i.type==="web-style"||i.type==="cim")return 0;const s=i.symbolLayers.at(0);if(!s)return 0;switch(s.type){case"icon":{const{computeIconLayerResourceSize:r}=await V(()=>import("./symbolLayerUtils-CuNRZSQV.js"),__vite__mapDeps([0,1,2]));return s.size||Math.min(Q.icon,(await r(s,Q.icon))[0])||Q.icon}case"text":return s.size||Q.text;case"line":return s.size||Q.line;case"object":{const{computeObjectLayerResourceSize:r}=await V(()=>import("./symbolLayerUtils-CuNRZSQV.js"),__vite__mapDeps([0,1,2]));return oi(await r(s,e.scale/Q.viewScaleSizeFactor),a)}case"path":return(s.width!=null?s.width:s.height)||e.scale/Q.viewScaleSizeFactor;case"extrude":return s.size||e.scale/Q.viewScaleSizeFactor;default:return 0}}function li(e,t){const a=e.field,i=e.axis,s=t.fields&&t.fields.filter(p=>p.name===a),r=s&&s.length===1?s[0].type:"double",n={initial:0,current:0},d=aa[e.valueUnit]??1;let c;return c=e.valueRepresentation==="area"?p=>(p*d/2)**2*Math.PI:e.valueRepresentation==="radius"||e.valueRepresentation==="distance"?p=>p*d/2:p=>p*d,{field:a,fieldType:r,getDefault:async(p,u)=>Ze(c(await ni(u,p,i)),r),getValue:(p,u)=>(n.initial||(n.initial=u.pixelSizeAt(u.center)),n.current=n.initial*p,Ze(n.current,r)),setInitialValue:p=>{n.initial=p,n.current=0},isUpdatingInteractively:!1,displayUnit:Fi(e.valueUnit),axis:e.axis}}function Ze(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function di(e){switch(e==null?void 0:e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}async function Z(e,t,a){const i=await qe(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t,scale:a});ia(e.symbol,i)!=null&&(e.symbol=i)}function ci(e){if(!e)throw new Error("no geometry type");return e==="multipatch"?"mesh":e}async function pi(e,t,a){var u;const i=t.layer,s={...(u=t.template)==null?void 0:u.prototype.attributes,...t.attributeOverrides};let r=null;const{view:n}=e,d=(n==null?void 0:n.type)==="2d";if(await kt(e,i,s,a,d?n.scale:null),d){const m=Oe(f=>kt(e,i,s,a,f));r=F(()=>n.scale,f=>m(f))}const{data:c,editing:p}=i.capabilities;return e.layer.elevationInfo=i.elevationInfo,t.geometryToPlace==null?await e.create(ci(i.geometryType),{graphicProperties:{attributes:s,sourceLayer:i},hasZ:c.supportsZ,defaultZ:(d?p.zDefault:null)??e.defaultCreateOptions.defaultZ}):await e.place(t.geometryToPlace,{graphicProperties:{attributes:s,sourceLayer:i}}),r??I()}async function kt(e,t,a,i,s){const r=new it({sourceLayer:t,attributes:a}),{rotation:n,size:d}=ct(r);let c=await qe(r,{useSourceLayer:!0,webStyleCache:i,scale:s}),p=!1;for(const u of[d,n])u!=null&&a[u.field]==null&&(a[u.field]=await u.getDefault(c,e.view),p=!0);switch(p&&(c=await qe(r,{useSourceLayer:!0,webStyleCache:i,scale:s})),c==null?void 0:c.type){case"simple-fill":case"polygon-3d":e.polygonSymbol=c;break;case"simple-line":case"line-3d":e.polylineSymbol=c;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":e.pointSymbol=c;break;case"mesh-3d":e.meshSymbol=c}Ht(e.tooltipOptions,d,n)}function Ht(e,t,a){e.visualVariables=t!=null||a!=null?{size:t!=null?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:a!=null?{valueType:a.fieldType,rotationType:a.rotationType??"geographic"}:null}:null}function ui(e,t){return e==null?void 0:e.find(a=>a.layer===t)}async function hi(e,t,a,i){switch(t.type){case"3d":return mi(e,t,a,i);case"2d":return fi(e,t,a,i)}}async function mi(e,t,a,i){if(e.length===0)return[];const{updatable:s,graphicsByLayer:r}=await a.async(async()=>{const{results:n}=await We(Na(t,a),i),d=new Map,c=u=>{const m=u.layer,f=d.get(m);if(!f){const y=new Array;return d.set(m,y),y}return f};xt(n).forEach(({graphic:u})=>c(u).push(u));const p=e.filter(({capabilities:u,layer:m})=>u.update.enabled&&d.has(m));return p.length!==0&&a.stopPropagation(),{updatable:p,graphicsByLayer:d}});return We(Promise.allSettled(s.map(async({layer:n})=>{const d=r.get(n),c=Rt(n);if(d.every(m=>oa(c,m)))return d;const p=[];for(const m of d){p.push(m.getObjectId());const f=Object.keys(m.attributes);na(c,f)}const u=n.createQuery();return u.returnGeometry=!1,u.objectIds=p,u.outFields=Et(n.fieldsIndex,c),n.queryFeatures(u,{signal:i}).then(({features:m})=>m)})),i)}async function fi(e,t,a,i){if(e.length===0)return[];const{mapPoint:s}=a;if(s==null)return[];let r=null;const n=await a.async(async()=>{const{results:d}=await We(t.hitTest(a),i);if(d.length===0)return[];const c=new Set;r=xt(d),r.forEach(({graphic:u})=>u&&c.add(u.layer));const p=e.filter(u=>c.has(u.layer)&&u.supportsUpdateWorkflow);return p.length>0&&a.stopPropagation(),p});return We(Promise.allSettled(n.map(async({layer:d})=>{const c=d.createQuery();c.returnGeometry=!1,c.outFields=Rt(d);const p="renderer"in d?Ga({renderer:d.renderer,pointerType:a.pointerType}):0;c.geometry=za(s,p,t),c.outSpatialReference=t.spatialReference;const{features:u}=await d.queryFeatures(c,{signal:i});return r==null||r.forEach(({graphic:m})=>{m.layer!==d||u.some(f=>f.getObjectId()===m.getObjectId())||u.push(m)}),u})),i)}function Rt(e){return Et(e.fieldsIndex,[e.objectIdField,At({displayField:"displayField"in e?e.displayField:null,fields:e.fields})])}async function wi(e,t,a){const{sourceLayer:i}=e,s=i.createQuery();s.objectIds=[e.getAttribute(i.objectIdField)],s.outFields=["*"],s.returnM=i.capabilities.data.supportsM,s.returnZ=i.capabilities.data.supportsZ,i.type==="scene"&&i.infoFor3D!=null||(s.outSpatialReference=t);const r=await i.queryFeatures(s,{signal:a});return _e(a),r.features[0]}async function Ke(e){var u;const{graphic:t,sketchViewModel:a,sourceLayer:i,visualVariables:s,webStyleCache:r}=e;let n=!1;const{rotation:d,size:c}=s;if([d,c].forEach(async m=>{if(m==null)return;const f=t.getAttribute(m.field);if(f!=null)m.setInitialValue(f);else{const y=await m.getDefault(t.symbol,a.view);m.setInitialValue(y),t.setAttribute(m.field,y),n=!0}}),n){const m=((u=a.view)==null?void 0:u.type)==="2d"?a.view.scale:null;await Z(t,r,m)}const p={multipleSelectionEnabled:!1};return i.geometryType==="point"&&(p.enableRotation=d!=null,p.enableScaling=c!=null),Ht(a.tooltipOptions,c,d),a.layer.elevationInfo=i.elevationInfo,a.update(t,p)}function gi(e){return e==null||e.type!=="rotate-start"&&e.type!=="rotate"&&e.type!=="rotate-stop"?null:e}function yi(e){return e==null||e.type!=="scale-start"&&e.type!=="scale"&&e.type!=="scale-stop"?null:e}async function Gt(e,t,a,i,s){var p;if(t.geometry==null||((p=t.geometry)==null?void 0:p.type)!=="point")return;const r=i.rotation,n=gi(a.toolEventInfo);if(r!=null&&n!=null){const{field:u,getValue:m}=r;n.type==="rotate-stop"?(r.isUpdatingInteractively=!1,r.setInitialValue(t.getAttribute(u))):(r.isUpdatingInteractively=!0,t.setAttribute(u,m(n.angle,e)))}const d=i.size,c=yi(a.toolEventInfo);if(d!=null&&c!=null){const{field:u,getValue:m}=d;c.type==="scale-stop"?(d.isUpdatingInteractively=!1,d.setInitialValue(t.getAttribute(u))):(d.isUpdatingInteractively=!0,t.setAttribute(u,m(c.xScale,e)))}await Z(t,s,e.type==="2d"?e.scale:null)}async function vi({feature:e,featureClone:t,visualVariableAttributes:a,sketchViewModel:i,view:s,onUpdate:r,webStyleCache:n}){var b;await Z(t,n,s.type==="2d"?s.scale:null);let d=null;if(((b=i==null?void 0:i.view)==null?void 0:b.type)==="2d"){const _=Oe(M=>Z(t,n,M));d=F(()=>{var M;return(M=i==null?void 0:i.view)==null?void 0:M.scale},M=>_(M))}const c=t.sourceLayer,p=he(s,c);await Ke({graphic:t,sketchViewModel:i,sourceLayer:c,visualVariables:a,webStyleCache:n});let u=null;p.then(_=>u=_).catch(()=>{});const m=a.size,f=a.rotation,y=F(()=>e.attributes,async _=>{let M=!1;for(const E in _){const U=_[E];U!==t.getAttribute(E)&&(t.setAttribute(E,U),m==null||m.isUpdatingInteractively||m.field!==E||m.setInitialValue(U),f==null||f.isUpdatingInteractively||f.field!==E||f.setInitialValue(U),(u==null||u.requiredFields.includes(E))&&(M=!0))}M&&await Z(t,n,s.type==="2d"?s.scale:null)}),w=i.on("update",async _=>{const M=_.graphics[0];if(_.state==="complete")return Ke({graphic:M,sketchViewModel:i,sourceLayer:c,visualVariables:a,webStyleCache:n});await Gt(s,M,_,a,n),r(Qe(M),_)}),g=i.on(["undo","redo"],async _=>{r(Qe(_.graphics[0]),_)});return X([g,w,I(()=>i.cancel()),y,d])}async function _i(e,t,a){const i=e.view;e.layer.add(a);const s=t.sourceLayer,r=t.layer,n=t.getAttribute(r.objectIdField);let d=null;function c(p){d==null||d.abort(),d=$t(async u=>{var f;const m=await he(i,s);_e(u),(f=m.setVisibility)==null||f.call(m,n,p)})}return await bi(i,a),c(!1),X([ki(i,a,p=>c(!p)),I(async()=>{c(!0);try{const p=await he(i,s);await H(()=>!p.updating)}finally{e.layer.remove(a)}})])}function ki(e,t,a){if(e.type==="3d"){const i=new Ut({graphic:t});return X([e.trackGraphicState(i),F(()=>i.displaying,a)])}return F(()=>t.visible,a)}async function bi(e,t){if(e.type==="3d"){const a=new Ut({graphic:t}),i=e.trackGraphicState(a);await H(()=>a.displaying),i.remove()}else await H(()=>t.visible)}const Q={icon:Le(24),text:Le(12),line:Le(1),viewScaleSizeFactor:100};function zt(e,t,a){let i=!1;return e.filter(s=>!!i||(i=s===t,i)).map(s=>a[s]())}function Mi(e,t){e.viewModel.syncFeatureTemplates();const a=e.creationInfo;if(t[0].id==="awaiting-feature-creation-info"&&a){const i=a.layer,s=Ot(i);s.length===1&&i.type!=="scene"&&(a.template=s[0],t.shift())}return t}function Fi(e){switch(e){case"unknown":case"decimal-degrees":return null;default:return e}}function Ii(e){e.filesEnabled=!0,e.mode="view",e.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}}const Nt=e=>/-stop/.test(e)||/vertex-/.test(e),he=(e,t)=>{const a=t.type==="subtype-sublayer"?t.parent:t;return e.whenLayerView(a)};function Ci(e){return"createInteractiveEditSession"in e}function Qe(e){var a;const t=e.geometry;if((t==null?void 0:t.type)==="mesh"){const i=e.cloneShallow();return i.attributes=sa(e.attributes),i.geometry=t.cloneShallow(),i.geometry.transform=((a=t.transform)==null?void 0:a.clone())??null,i}return e.clone()}function Je(e){const t=e.cursor;return e.cursor="progress",I(()=>e.cursor=t)}async function Ei({view:e,data:t,signal:a,next:i,cancel:s}){const{creationInfo:r}=t;if(!r)return I();if(!ye(r))return I();const{layer:n}=r,d=r.geometryToPlace!=null;if(r.geometryToPlace=null,d)return s(),I();const{Upload:c}=await V(()=>import("./Upload-BUSBqM6b.js"),__vite__mapDeps([3,1,2,4,5]));_e(a);const p=new c;t.upload=p;let u=null;const m=()=>u==null?void 0:u.remove(),f=X([F(()=>p.state,y=>{switch(y){case"default":case"error":m();break;case"pending":m(),u=Je(e);break;case"success":r.maxFeatures=1,r.geometryToPlace=p.result,m(),i()}}),I(()=>{p.cancel(),m()})]);return p.uploadTo(n),f}function ye(e){const t=e==null?void 0:e.layer;return(t==null?void 0:t.type)==="scene"}let C=class extends Wt.EventedAccessor{constructor(t){super(t),this._indexHistory=[],this._lastStepIndex=-1,this._stepIndex=-1,this._updatingHandles=new Tt,this._handleKeys={afterCommit:"after-commit",beforeCommit:"before-commit"},this.data=void 0,this.started=!1,this.steps=[],this.type=null,this._pendingOperation=null}destroy(){this._updatingHandles.destroy()}get hasNextStep(){const{steps:t}=this;return!!(t&&this._stepIndex<t.filter(a=>!a.parent).length-1)}get hasPreviousStep(){return this._stepIndex>0}get reliesOnOwnerAdminPrivileges(){return!1}get hasInvalidFormTemplate(){return!1}get shouldShowAttachments(){return!1}get shouldAllowAttachmentEditing(){return!1}get stepId(){const{steps:t}=this,a=t&&t[this._stepIndex];return a&&a.id}get helpMessage(){}get hasPendingEdits(){return!1}get keyboardCancellationEnabled(){return!0}get updating(){return this._updatingHandles.updating}async back(t=()=>Promise.resolve(!0)){this.hasPendingEdits&&!await t()||(this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0}))}async cancel(t={force:!0}){return t.force!==!1?this._cancel(t):new Promise((a,i)=>{this.emit("cancel-request",{controller:{allow:()=>{this._cancel({...t,force:!0}).then(a)},deny:()=>i(new $("workflow:cancel-denied","Request to cancel workflow was denied."))}})})}async commit(){this.removeHandles(this._handleKeys.beforeCommit),this.onCommit&&await this.onCommit(this.data),this.removeHandles(this._handleKeys.afterCommit),this.emit("commit")}async go(t){const{steps:a}=this,i=a.findIndex(s=>s.id===t);this._indexHistory.push(this._stepIndex),await this._go(i)}async next(){this._indexHistory.push(this._stepIndex),await this._go(this._stepIndex+1)}async previous(t={cancelCurrentStep:!1}){await this._go(this._indexHistory.pop(),t.cancelCurrentStep)}async reset(){await this._cancel({emitCancelEvent:!1}),await this.start()}async save(){await this.commit(),await this.reset()}async start(){this._set("started",!0);const t=this._stepIndex===-1?0:this._stepIndex;await this._go(t)}async _cancel({emitCancelEvent:t=!0,error:a}={}){this.started&&(this._set("started",!1),await this._transaction(()=>{var i;return(i=this.steps[this._stepIndex])==null?void 0:i.tearDown({canceled:!0})})),this.removeHandles([this._handleKeys.afterCommit,this._handleKeys.beforeCommit]),this._resetIndexing(t),t&&this.emit("cancel",{error:a})}_go(t=-1,a=!1){return this._transaction(async()=>{const{steps:i}=this;if(!(t<=-1||t>=i.length)){if(!this.started)return this._stepIndex=t,void this._notifyStepProps();this._lastStepIndex>-1&&await i[this._lastStepIndex].tearDown({canceled:a});try{await i[t].setUp()}catch(s){la(s)}this._lastStepIndex=t,this._stepIndex=t,this._notifyStepProps()}})}async _transaction(t){const a=this._pendingOperation,i=st(),s=(a??Promise.resolve()).then(()=>i.promise);this._pendingOperation=s,this._updatingHandles.addPromise(s);try{a&&await a,await t()}finally{i.resolve(),s===this._pendingOperation&&(this._pendingOperation=null)}}_resetIndexing(t=!0){this._stepIndex=-1,this._lastStepIndex=-1,this._indexHistory.length=0,t&&this._notifyStepProps()}_notifyStepProps(){this.notifyChange("stepId"),this.notifyChange("hasPreviousStep"),this.notifyChange("hasNextStep")}};o([l()],C.prototype,"data",void 0),o([l()],C.prototype,"hasNextStep",null),o([l()],C.prototype,"hasPreviousStep",null),o([l()],C.prototype,"onCommit",void 0),o([l()],C.prototype,"reliesOnOwnerAdminPrivileges",null),o([l()],C.prototype,"hasInvalidFormTemplate",null),o([l()],C.prototype,"shouldShowAttachments",null),o([l()],C.prototype,"shouldAllowAttachmentEditing",null),o([l()],C.prototype,"started",void 0),o([l({readOnly:!0})],C.prototype,"stepId",null),o([l()],C.prototype,"steps",void 0),o([l({readOnly:!0})],C.prototype,"type",void 0),o([l()],C.prototype,"helpMessage",null),o([l()],C.prototype,"hasPendingEdits",null),o([l()],C.prototype,"keyboardCancellationEnabled",null),o([l()],C.prototype,"updating",null),C=o([O("esri.widgets.Editor.Workflow")],C);const pt=C;var Ee;const De=Symbol(),ne=Symbol(),be=Symbol();let A=Ee=class extends pt{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this.data=void 0,this.isNested=!1,this._getDrawMeshHelpMessage=void 0,this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._featureFormViewModel=new St,this._sketchViewModel=null,this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[],this._isActive=!0,this._updateGraphicDebounced=Oe((t,a,i)=>Z(t,a,i))}initialize(){this.isNested&&(this._isActive=!1),this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){var r,n;if(this.numPendingFeatures>0)return!0;const{creationInfo:e,upload:t}=this.data,a=this._sketchViewModel,{activeComponent:i}=a,s=(n=(r=a.createGraphic)==null?void 0:r.geometry)==null?void 0:n.type;return!(s!=="polyline"&&s!=="polygon"&&s!=="multipoint"||(i==null?void 0:i.type)!=="draw-2d"&&(i==null?void 0:i.type)!=="draw-3d")&&i.drawOperation.committedVertices.length>0||!(!t||t.state!=="pending"&&t.state!=="success")||!!(e!=null&&e.geometryToPlace)}get helpMessage(){var s;const{creationInfo:e,viewModel:t}=this.data;if(this.stepId!=="creating-features"||!e)return;const a=e.layer.geometryType,i=this._sketchViewModel.createGraphic;if(a==="mesh"){this._getDrawMeshHelpMessage||V(()=>import("./helpMessageUtils3d-CB9ADCcM.js"),__vite__mapDeps([6,1,2,7])).then(n=>{this._getDrawMeshHelpMessage=n.getDrawMeshHelpMessage});const{view:r}=t;return(r==null?void 0:r.type)==="3d"?(s=this._getDrawMeshHelpMessage)==null?void 0:s.call(this,i,r):void 0}return Ra(a,i==null?void 0:i.geometry)}get layer(){var e;return(e=this.data.creationInfo)==null?void 0:e.layer}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get parentLayer(){var e;return(e=this.parent)==null?void 0:e.data.editorItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return this.numPendingFeatures===0}get reliesOnOwnerAdminPrivileges(){var e;return((e=this.data.editorItem)==null?void 0:e.capabilities.create.reliesOnOwnerAdminPrivileges)??!1}get shouldShowAttachments(){var e;return((e=this.data.editorItem)==null?void 0:e.capabilities.create.attachments.enabled)??!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){}async enter(){this._isActive=!0,this.stepId!=="awaiting-feature-creation-info"&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=!1,this.removeHandles([be])}async updatePendingFeature(e,t){return this._preventDefaultActionOnCancel=!0,this._sketchViewModel.cancel(),wt(this._lastActiveGraphics,e),this._startUpdating(e,t)}async start(){var e;return await super.start(),pe((e=this.data.creationInfo)==null?void 0:e.layer)?null:{enter:async()=>{},exit:async()=>{},viewModel:this._sketchViewModel}}static create(e){const{addAttachmentsCallback:t,applyEditsCallback:a,isNested:i,creationInfo:s,parent:r,snappingManager:n,startAt:d,viewModel:c}=e,p=e.sketchOptions??new Te,u=s==null?void 0:s.layer,m=u?c.findEditorItemForLayer(u):void 0,f=new Ee({data:new N({creationInfo:s,editorItem:m,parent:r,sketchOptions:p,snappingManager:n,viewModel:c}),isNested:i,onCommit:async y=>{var U;const{creationInfo:w}=y;if(!w)return;const g=y.pendingFeatures.toArray(),{layer:b}=w,_=((U=b.capabilities)==null?void 0:U.editing.supportsGlobalId)&&"globalIdField"in b,M=f._attachmentFileInfos;if(_){const K=Wi(g,b,M);return void await a(b,K,{globalIdUsed:!0})}const E=await a(b,{addFeatures:g});if(M.size>0){const K=(E==null?void 0:E.addFeatureResults)??[];await t(b,$i(g,K,b,M))}}});return f._set("steps",this._createWorkflowSteps(f,d)),f}_fadeExistingFeatures(e){if("effect"in e){const a=e.effect;return e.effect="saturate(0.6) opacity(0.8)",I(()=>e.effect=a)}const t=e.opacity;return e.opacity=.7,I(()=>e.opacity=t)}_highlight(e){const t=this.data.viewModel.view;(t==null?void 0:t.type)==="3d"&&this._highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){Ie(this._highlightHandles.get(e)),this._highlightHandles.delete(e)}async _startCreating(e){this.removeHandles(ne);const{creationInfo:t}=this.data;if(!t)return;this.createFeatureState="create-new";const a=await pi(this._sketchViewModel,t,e);this.addHandles(a,ne)}async _startUpdating(e,t){var w;const{pendingFeatures:a}=this;a.includes(e)||a.add(e);const{_featureFormViewModel:i,_sketchViewModel:s}=this,{creationInfo:r,viewModel:n}=this.data,{attachmentsViewModel:d,layerInfos:c,view:p}=n;if(!p||!r)return;const u=r.layer,m=ui(c,u),f=m==null?void 0:m.formTemplate,y=p.spatialReference;if(i.set({arcadeEditType:"INSERT",feature:e,formTemplate:f,spatialReference:y,map:p.map}),d.mode!=="add"&&d.mode!=="edit"||((w=n.activeWorkflow)==null||w.previous()),d.graphic=e,d.fileInfos.removeAll(),d.mode="view",(this._attachmentFileInfos.get(e)||[]).forEach(({file:g,form:b})=>d.addFile(g,b)),this._removeHighlight(e),await Z(e,t,p.type==="2d"?p.scale:null),this.removeHandles(ne),Ie(this._featureFormHandle),p.type==="2d"){const g=F(()=>p.scale,b=>this._updateGraphicDebounced(e,t,b));this.addHandles(g,ne)}return this._featureFormHandle=X([i.on("value-change",async()=>{e.attributes=i.getValues(),await Z(e,t,p.type==="2d"?p.scale:null)}),s.on(["update","undo","redo"],g=>{(g.type==="undo"||g.type==="redo"||g.type==="update"&&g.toolEventInfo!=null&&Nt(g.toolEventInfo.type))&&i.notifyFeatureGeometryChanged()})]),this.createFeatureState="update-pending",this._visualVariableAttributes=ct(e),pe(u)?void 0:Ke({graphic:e,sketchViewModel:s,sourceLayer:u,visualVariables:this._visualVariableAttributes,webStyleCache:t})}static _createWorkflowSteps(e,t="awaiting-feature-creation-info"){const{data:a}=e,i=zt(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],t,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const{creationInfo:s,viewModel:r}=a,{view:n}=r;n&&(ye(s)?e.addHandles(await Ei({view:n,data:a,next:()=>e.next(),cancel:()=>r.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(a.parent&&s&&(e.addHandles(r.lockFeatureTemplatesViewModel(),this.id),r.featureTemplatesViewModel.layers=[s.layer]),e.addHandles(r.featureTemplatesViewModel.on("select",({item:d})=>{d&&(a.creationInfo={...a.creationInfo,layer:d.layer,template:d.template},e.next())}),this.id)))},async tearDown(){e.removeHandles([this.id,ne])}}),"creating-features":()=>({id:"creating-features",async setUp(){e._isActive&&await e._setUpCreatingFeaturesStep()},async tearDown(s){const{viewModel:r}=a;s.canceled&&(e.removeHandles([be,De,ne]),r.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:s}=a.viewModel,{graphic:r,fileInfos:n}=s;e._attachmentFileInfos.set(r,n.toArray()),s.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:s}=a.viewModel,{graphic:r,fileInfos:n}=s;e._attachmentFileInfos.set(r,n.toArray()),s.mode="view"}})});return Mi(a,i)}static _configureSketchViewModel(e,t){const{data:a}=e,{creationInfo:i,viewModel:s}=a,{view:r}=s,n=e._sketchViewModel;let d=null;const c=[];if(!r)return I();r.type==="2d"&&i&&c.push(e._fadeExistingFeatures(i.layer));const p=async w=>{if(w.state==="cancel"){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e._lastActiveGraphics.length<1)return e._startCreating(t);const g=e._lastActiveGraphics.pop();return e._startUpdating(g,t)}if(w.state==="complete"&&w.graphic)return e._startUpdating(w.graphic,t)},u=async w=>{var mt;const{attachmentsViewModel:g}=s,{_featureFormViewModel:b}=e,_=w.graphics[0];if(w.state==="complete"){_!==d&&(e._lastActiveGraphics.push(_),e._highlight(_)),d=null;const{hasPendingSubtypeChoice:ee,submittable:ft}=b;if(e.numPendingFeatures===(i==null?void 0:i.maxFeatures)||ee||!ft){!ft&&b.submit();const Pe=e._lastActiveGraphics.pop();return e._startUpdating(Pe,t)}if(g.mode!=="add"&&g.mode!=="edit"||((mt=s.activeWorkflow)==null||mt.previous()),w.aborted&&e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);e.addHandles([Je(r),r.on("click",Pe=>Pe.preventDefault())],De),await H(()=>!b.updating),e.removeHandles(De),e._startCreating(t)}w.state==="start"&&e._removeHighlight(_);const M=e._visualVariableAttributes;await Gt(r,_,w,M,t);const E=_.attributes,{rotation:U,size:K}=M;if(U!=null){const{field:ee}=U;b.setValue(ee,E[ee])}if(K!=null){const{field:ee}=K;b.setValue(ee,E[ee])}},m=w=>{const g=w.graphics[0];e.pendingFeatures.remove(g),wt(e._lastActiveGraphics,g),d=g},f=async w=>{if(ye(i))return;const{results:g}=await r.hitTest(w,{include:n.layer}),b=g.find(M=>M.type==="graphic"&&M.graphic.sourceLayer===(i==null?void 0:i.layer));if(!b)return;const _=b.graphic;if(n.activeTool==="transform"||n.activeTool==="reshape"){if(n.updateGraphics.at(0)===_)return;const{submittable:M,hasPendingSubtypeChoice:E}=e._featureFormViewModel;if(!M||E)return;await e.updatePendingFeature(_,t)}};c.push(n.on("create",w=>e._updatingHandles.addPromise(p(w))),n.on("update",w=>e._updatingHandles.addPromise(u(w))),n.on("delete",w=>m(w)),r.on("immediate-click",w=>e._updatingHandles.addPromise(f(w)),Lt.TOOL),I(()=>{e._preventDefaultActionOnCancel=!0,n.cancel()}),Ai(n,a));const y=X(c);return n.addHandles(y),y}_initializeSketchViewModel(){var s;const{data:e}=this,{view:t}=e.viewModel,a=new nt({elevationInfo:(s=e.creationInfo)==null?void 0:s.layer.elevationInfo,internal:!0,listMode:"hide"}),i=new lt({layer:a,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:t});this._sketchViewModel=i,t==null||t.map.add(a),this.addHandles(I(()=>{t!=null&&t.destroyed||(t==null||t.map.remove(a)),a.destroy()}))}async _setUpCreatingFeaturesStep(){var w;if(this.hasHandles(be))return;const{creationInfo:e,viewModel:t}=this.data,{attachmentsViewModel:a,view:i}=t;if(!i||!(e!=null&&e.layer))throw new $("missing-parameters","CreateFeaturesWorkflow requires a view and creationInfo.");const{initialFeature:s,layer:r}=e,n=this._sketchViewModel,d=new Map,c=[];this._lastActiveGraphics=[],this._featureFormHandle=Ie(this._featureFormHandle),this._visualVariableAttributes={rotation:null,size:null},this.data.editorItem=t.findEditorItemForLayer(e.layer),Ii(a),c.push(F(()=>a.mode,g=>{switch(g){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}));const p=Je(i);c.push(p);const u=pe(e.layer);try{if(u){const g=s??new it({attributes:{...(w=e.template)==null?void 0:w.prototype.attributes,...e.attributeOverrides},sourceLayer:r});await this._startUpdating(g,d)}else c.push(Ee._configureSketchViewModel(this,d)),s?(n.layer.add(s),await this._startUpdating(s,d)):await this._startCreating(d)}finally{p.remove()}const m=I(()=>this.pendingFeatures.drain(g=>n.layer.remove(g))),f=F(()=>i==null?void 0:i.timeZone,g=>this._featureFormViewModel.timeZone=g,ae),y=I(()=>{ye(e)&&t.cancelWorkflow({warnIfNoWorkflow:!1})});this._featureFormHandle&&c.push(this._featureFormHandle),this.addHandles(c,this._handleKeys.beforeCommit),this.addHandles([I(()=>a.fileInfos.removeAll()),X(c),y,m,f],be)}};function Ai(e,t){let a=null;const i=()=>e.snappingOptions.featureSources,s=()=>(a=new Da({layer:e.layer}),i().add(a),a),r=()=>{a!=null&&(i().remove(a),a=rt(a))};return X([F(()=>{var c;const n=(c=t.creationInfo)==null?void 0:c.layer,d=i().find(p=>p.layer===n);return{hasFeatureLayerSource:!!d,enabled:(d==null?void 0:d.enabled)??!1}},({hasFeatureLayerSource:n,enabled:d})=>{if(!n)return r();a??(a=s()),a.enabled=d},we),I(r)])}function $i(e,t,a,i){const s=[];return t.forEach((r,n)=>{if(!r.error){const d=e[n],c=i.get(d)||[];d.attributes[a.objectIdField]=r.objectId,c.forEach(({form:p})=>s.push({feature:d,attachment:p}))}}),s}function Wi(e,t,a){const i=[],s=t.globalIdField;return e.forEach((r,n)=>{var d;(d=e[n].attributes)[s]??(d[s]=vt()),((a==null?void 0:a.get(r))||[]).forEach(({file:c})=>i.push({feature:r,attachment:{globalId:vt(),data:c}}))}),i.length?{addFeatures:e,addAttachments:i}:{addFeatures:e}}o([l()],A.prototype,"createFeatureState",void 0),o([l()],A.prototype,"data",void 0),o([l({constructOnly:!0})],A.prototype,"isNested",void 0),o([l()],A.prototype,"featureFormViewModel",null),o([l()],A.prototype,"hasPendingEdits",null),o([l()],A.prototype,"_getDrawMeshHelpMessage",void 0),o([l()],A.prototype,"helpMessage",null),o([l()],A.prototype,"layer",null),o([l()],A.prototype,"parent",null),o([l()],A.prototype,"parentLayer",null),o([l()],A.prototype,"keyboardCancellationEnabled",null),o([l()],A.prototype,"reliesOnOwnerAdminPrivileges",null),o([l()],A.prototype,"shouldShowAttachments",null),o([l()],A.prototype,"shouldAllowAttachmentEditing",null),o([l()],A.prototype,"sketchViewModel",null),A=Ee=o([O("esri.widgets.Editor.CreateFeaturesWorkflow")],A);const Bt=A;function bt(e){return e==null?null:JSON.stringify(e)}let j=class extends ie{constructor(t){super(t),this._stagedForDelete=!1,this.feature=null,this.initialFeature=null}get attributesModified(){return this._stringifyAttributes(this.feature)!==this._stringifyAttributes(this.initialFeature)}get geometryModified(){return this._stringifyGeometry(this.feature)!==this._stringifyGeometry(this.initialFeature)}get stagedForDelete(){return this._stagedForDelete}get modified(){return this.attributesModified||this.geometryModified||this._stagedForDelete}stageDelete(){this._stagedForDelete=!0}unstageDelete(){this._stagedForDelete=!1}trackChanges(){var t;this.initialFeature=(t=this.feature)==null?void 0:t.clone()}updateAttributes(t){const{feature:a}=this;a&&(a.attributes=t,this.notifyChange("attributesModified"))}updateGeometry(t){const{feature:a}=this;a&&(a.geometry=t,this.notifyChange("geometryModified"))}_stringifyAttributes(t){return bt(t==null?void 0:t.attributes)}_stringifyGeometry(t){const a=t==null?void 0:t.geometry;return bt((a==null?void 0:a.type)==="mesh"?{transform:a.transform,vertexSpace:a.vertexSpace}:a)}};o([l()],j.prototype,"_stagedForDelete",void 0),o([l()],j.prototype,"attributesModified",null),o([l()],j.prototype,"feature",void 0),o([l()],j.prototype,"geometryModified",null),o([l()],j.prototype,"initialFeature",void 0),o([l()],j.prototype,"modified",null),j=o([O("esri.widgets.Editor.Edits")],j);var Ae;let B=Ae=class extends ie{constructor(e){super(e),this.editorItem=null,this.edits=null,this.parent=null,this.relatedRecordCallbacks=null,this.viewModel=null}get attachmentsCapabilities(){const e=this.editorItem.capabilities.update.attachments.enabled;return{editing:!0,operations:{add:e,update:e,delete:e}}}get formTemplate(){return this.editorItem.formTemplate}static async create(e){const t=Ae._makeConstructorProps(e);return new Ae(t)}static _makeConstructorProps(e){const{feature:t,parent:a,relatedRecordCallbacks:i,viewModel:s}=e,r=s.editorItems.find(n=>n.layer===t.layer);if(!r)throw new $("no-editorItem-found","The EditorViewModel provided did not have an EditorItem associated with the specified Graphic's layer");return{editorItem:r,edits:new j({feature:t}),parent:a,relatedRecordCallbacks:i,viewModel:s}}};o([l()],B.prototype,"attachmentsCapabilities",null),o([l({constructOnly:!0})],B.prototype,"editorItem",void 0),o([l()],B.prototype,"edits",void 0),o([l()],B.prototype,"formTemplate",null),o([l()],B.prototype,"parent",void 0),o([l()],B.prototype,"relatedRecordCallbacks",void 0),o([l()],B.prototype,"viewModel",void 0),B=Ae=o([O("esri.widgets.Editor.UpdateRecordWorkflowData")],B);const qt=B;var $e;let de=$e=class extends qt{constructor(e){super(e),this.sketchOptions=null,this.snappingManager=null}static async create(e){const{feature:t,snappingManager:a,viewModel:i}=e,s=e.sketchOptions??new Te,{view:r}=i;if(!r)throw new $("editor:cannot-create-workflow-data","The provided EditorViewModel does not have an associated view");const n=await he(r,t.layer);return new $e({...$e._makeConstructorProps(e),layerView:n,sketchOptions:s,snappingManager:a})}};o([l()],de.prototype,"layerView",void 0),o([l({constructOnly:!0})],de.prototype,"sketchOptions",void 0),o([l()],de.prototype,"snappingManager",void 0),de=$e=o([O("esri.widgets.Editor.UpdateFeatureWorkflowData")],de);const Si=de;var Ye;const Xe={exit:Symbol()};let T=Ye=class extends pt{constructor(e){super(e),this._highlightHelper=null,this.fullFeature=null,this.type="update-table-record"}initialize(){const{data:e}=this,{edits:t}=e,{view:a}=e.viewModel,i=t.feature,s=new AbortController;this.addHandles(pa(s)),this._updatingHandles.addPromise(wi(i,e.viewModel.view.spatialReference,s.signal).then(r=>{ua(s)||(this._onFullFeatureLoaded(r),this._initializeFeatureFormViewModel())},r=>this.cancel({force:!0,error:new $("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:r}})}))),a&&(this._highlightHelper=new Dt({view:a}),this.addHandles(I(()=>{var r;return(r=this._highlightHelper)==null?void 0:r.removeAll()})))}get editorItem(){return this.data.editorItem}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){return this.data.edits.modified}get layer(){return this.data.editorItem.layer}get parent(){return this.data.parent}get parentLayer(){var e;return(e=this.parent)==null?void 0:e.data.editorItem.layer}get shouldShowAttachments(){return this.editorItem.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return this.editorItem.capabilities.update.attachments.enabled}get reliesOnOwnerAdminPrivileges(){const e=this.editorItem.capabilities;return e.update.reliesOnOwnerAdminPrivileges||e.delete.reliesOnOwnerAdminPrivileges}async deleteAndCommit(){return this.data.edits.stageDelete(),this.commit()}async enter(){this._configureAttachmentsViewModel()}exit(e){this.removeHandles(Xe.exit)}async start(){return await super.start(),null}_configureAttachmentsViewModel(){const{data:e,fullFeature:t}=this,{attachmentsCapabilities:a,viewModel:i}=e,{attachmentsViewModel:s}=i;s.set({capabilities:a,graphic:t,filesEnabled:!1,mode:"view"}),this.addHandles([I(()=>s.fileInfos.removeAll()),F(()=>s.mode,r=>{switch(r){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}})],Xe.exit)}_initializeFeatureFormViewModel(){const{edits:e,formTemplate:t,viewModel:{view:a}}=this.data,i=this._featureFormViewModel=new St({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:t,highlightHelper:this._highlightHelper,map:a==null?void 0:a.map,spatialReference:a.spatialReference,timeZone:a==null?void 0:a.timeZone});i.relatedRecordCallbacks={...this.data.relatedRecordCallbacks,showAllRelatedRecords:r=>i.relationshipId=r.relationshipId};const{initialFeature:s}=e;s&&i.overrideInitialFeature(s),this.addHandles([i.on("value-change",()=>{e.updateAttributes(i.getValues()),this.fullFeature.attributes=e.feature.attributes}),F(()=>a==null?void 0:a.timeZone,r=>i.timeZone=r)])}_onFullFeatureLoaded(e){this.fullFeature=e;const{edits:t}=this.data;t.updateAttributes(e.attributes),t.trackChanges()}static async create(e){const t=new Ye({data:await qt.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}static _createWorkflowSteps(e){const{attachmentsViewModel:t}=e.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){t.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){t.mode="view"}}]}};T._onCommitFactory=e=>async t=>{var d;const{edits:a}=t,{feature:i}=a;if(!i)return;const s=i.sourceLayer,r=i.clone();if(!a.attributesModified||a.stagedForDelete){const c=s.objectIdField;if(r.attributes={[c]:i.getAttribute(c)},da()&&ca()&&s.type==="scene"&&s.infoFor3D!=null){const p=(d=s.associatedLayer)==null?void 0:d.globalIdField;p!=null&&r.setAttribute(p,i.getAttribute(p))}}a.geometryModified&&!a.stagedForDelete||(r.geometry=null);const n=a.stagedForDelete?"deleteFeatures":"updateFeatures";await e(s,{[n]:[r]})},o([l()],T.prototype,"editorItem",null),o([l()],T.prototype,"featureFormViewModel",null),o([l()],T.prototype,"fullFeature",void 0),o([l()],T.prototype,"hasPendingEdits",null),o([l()],T.prototype,"layer",null),o([l()],T.prototype,"parent",null),o([l()],T.prototype,"parentLayer",null),o([l()],T.prototype,"shouldShowAttachments",null),o([l()],T.prototype,"shouldAllowAttachmentEditing",null),o([l()],T.prototype,"reliesOnOwnerAdminPrivileges",null),T=Ye=o([O("esri.widgets.Editor.UpdateRecordWorkflow")],T);var et;const G={...Xe,highlights:Symbol(),sketchGraphics:Symbol(),sketchViewModel:Symbol()};let ce=et=class extends T{constructor(e){super(e),this.type="update-feature",this._layerViewEditSession=null,this._sketchGraphicClone=null,this._sketchViewModel=null,this._webStyleCache=new Map}destroy(){var e;(e=this._layerViewEditSession)==null||e.rollback()}async commit(){this.removeHandles(G.sketchGraphics);try{const e=this.data.edits.stagedForDelete;await super.commit();const t=this._layerViewEditSession;e?t==null||t.rollback():t==null||t.commit()}catch(e){throw await this._configureSketchViewModel(),new $("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:e})}}async start(){return await super.start(),await this._initializeSketchViewModel()}_initializeFeatureFormViewModel(){super._initializeFeatureFormViewModel(),this.addHandles(this._featureFormViewModel.on("value-change",e=>{var t;(t=this._layerViewEditSession)==null||t.setAttribute(e.fieldName,e.value)}))}_configureHighlight(){const{edits:e,layerView:t}=this.data;qa(t)&&this.addHandles(t.highlight(e.feature),G.highlights)}async _configureSketchViewModel(){const e=this._sketchViewModel;if(!e)return;const{data:t,_featureFormViewModel:a,_sketchGraphicClone:i}=this,{edits:s,viewModel:r}=t,n=s.feature,{view:d}=r,c=ct(n),p=await vi({feature:n,featureClone:i,visualVariableAttributes:c,sketchViewModel:e,view:d,onUpdate:({geometry:u,attributes:m},f)=>{if(s.updateAttributes(m),s.updateGeometry(u),a.feature.geometry=u,c.rotation!=null){const{field:y}=c.rotation;a.setValue(y,m[y])}if(c.size!=null){const{field:y}=c.size;a.setValue(y,m[y])}(f.type==="undo"||f.type==="redo"||f.type==="update"&&f.toolEventInfo!=null&&Nt(f.toolEventInfo.type))&&a.notifyFeatureGeometryChanged()},webStyleCache:this._webStyleCache});this.addHandles(p,G.sketchGraphics),e.addHandles(p)}async _initializeSketchViewModel(){const{data:e,_sketchGraphicClone:t}=this,a=e.edits.feature,{capabilities:i,layer:s}=e.editorItem,{view:r}=e.viewModel;if(this.removeHandles([G.highlights,G.sketchGraphics,G.sketchViewModel]),!i.update.geometry||(r==null?void 0:r.type)==="3d"&&Ba(s.elevationInfo))return{enter:async()=>{this.hasHandles(G.highlights)||this._configureHighlight()},exit:()=>this.removeHandles([G.highlights])};const n=new nt({elevationInfo:s.elevationInfo,internal:!0,listMode:"hide"}),d=new lt({allowDeleteKey:!1,layer:n,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:r});return this._sketchViewModel=d,r==null||r.map.add(n),this.addHandles(I(()=>{r!=null&&r.destroyed||(r==null||r.map.remove(n)),n.destroy(),this._sketchViewModel=rt(d)}),G.sketchViewModel),await Z(t,this._webStyleCache,(r==null?void 0:r.type)==="2d"?r.scale:null),this.addHandles([await _i(d,a,t)]),{enter:async()=>{this.hasHandles(G.sketchGraphics)||await this._configureSketchViewModel()},exit:()=>this.removeHandles([G.sketchGraphics]),viewModel:d}}_onFullFeatureLoaded(e){super._onFullFeatureLoaded(e);const t=this._sketchGraphicClone=Qe(e),{edits:a,layerView:i}=this.data;a.updateGeometry(e.geometry),a.trackChanges(),Ci(i)&&(this._layerViewEditSession=i.createInteractiveEditSession(t))}static async create(e){const t=new et({data:await Si.create(e),onCommit:this._onCommitFactory(e.applyEdits)});return t._set("steps",this._createWorkflowSteps(t)),t}get test(){}};o([l()],ce.prototype,"_layerViewEditSession",void 0),o([l()],ce.prototype,"_sketchGraphicClone",void 0),o([l()],ce.prototype,"_sketchViewModel",void 0),ce=et=o([O("esri.widgets.Editor.UpdateFeatureWorkflow")],ce);let q=class extends ie{constructor(t){super(t),this.addAttachmentsCallback=null,this.applyEditsCallback=null,this.candidates=null,this.rootFeature=null,this.sketchOptions=null,this.snappingManager=null,this.viewModel=null}};o([l()],q.prototype,"addAttachmentsCallback",void 0),o([l()],q.prototype,"applyEditsCallback",void 0),o([l()],q.prototype,"candidates",void 0),o([l()],q.prototype,"rootFeature",void 0),o([l({constructOnly:!0})],q.prototype,"sketchOptions",void 0),o([l()],q.prototype,"snappingManager",void 0),o([l()],q.prototype,"viewModel",void 0),q=o([O("esri.widgets.Editor.UpdateWorkflowData")],q);const Vi=q;var tt;const jt="esri.widgets.Editor.UpdateWorkflow",Oi=()=>z.getLogger(jt);let W=tt=class extends pt{constructor(e){super(e),this._workflowStack=new gt(yt),this._sketchStack=new gt(yt),this.data=void 0,this.type="update"}get activeEditorItem(){var e;return((e=this.activeWorkflow)==null?void 0:e.data.editorItem)??void 0}get activeFeatureFormViewModel(){var e;return(e=this.activeWorkflow)==null?void 0:e.featureFormViewModel}get activeSketchViewModel(){var e;return(e=this._sketchStack.peek())==null?void 0:e.viewModel}get activeWorkflow(){return this._workflowStack.last()}get hasUpdatableCandidates(){const{candidates:e,viewModel:t}=this.data;return e.some(({layer:a})=>{var i;return(i=t.findEditorItemForLayer(a))==null?void 0:i.supportsUpdateWorkflow})}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){var e;return!!((e=this.activeEditorItem)!=null&&e.capabilities.attachments.enabled)}get shouldAllowAttachmentEditing(){var e;return!!((e=this.activeEditorItem)!=null&&e.capabilities.update.attachments.enabled)}get hasPendingEdits(){return Array.from(this._workflowStack).some(e=>e.hasPendingEdits)}get helpMessage(){var e;return(e=this.activeWorkflow)!=null&&e.helpMessage?this.activeWorkflow.helpMessage:this.stepId==="awaiting-feature-to-update"?"select":void 0}get reliesOnOwnerAdminPrivileges(){var e;return((e=this.activeWorkflow)==null?void 0:e.reliesOnOwnerAdminPrivileges)??!1}get hasInvalidFormTemplate(){var e;return!!((e=this.activeEditorItem)!=null&&e.hasInvalidFormTemplate)}async back(e=()=>Promise.resolve(!0)){const{activeWorkflow:t}=this;if((t==null?void 0:t.featureFormViewModel.relationshipId)==null)if(t){if(t.hasPendingEdits&&!await e())return;t.hasPreviousStep?await t.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else t.featureFormViewModel.relationshipId=null}async cancelActiveWorkflow(e){var t;await((t=this.activeWorkflow)==null?void 0:t.cancel(e)),await this._popWorkflow()}async commit(){await this._drainWorkflowStack(e=>e.commit()),await super.commit()}static create(e){const{viewModel:t,snappingManager:a,startAt:i,addAttachmentsCallback:s,applyEditsCallback:r}=e,n=e.sketchOptions??new Te,d=new tt({data:new Vi({addAttachmentsCallback:s,applyEditsCallback:r,sketchOptions:n,snappingManager:a,viewModel:t}),onCommit:async()=>{}});return d._set("steps",this._createWorkflowSteps(d,i)),d}async save(){var e;this.nestedWorkflowCount>1?(await((e=this.activeWorkflow)==null?void 0:e.commit()),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(e){try{const t=await this._createNestedCreateFeaturesWorkflow(e);await this._pushWorkflow(t)}catch(t){throw new $("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:t})}}async startUpdating(e){try{const t=await this._createNestedUpdateWorkflow(e);await this._pushWorkflow(t)}catch(t){throw new $("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:t})}}async deleteActiveFeature(){const{activeWorkflow:e}=this;if(!e)throw new $("editor:nothing-to-delete","There is no feature to delete");Ti(e)?await e.deleteAndCommit():await e.cancel(),this.nestedWorkflowCount===1?await this.reset():await this._popWorkflow()}async cancelAll(){await this._drainWorkflowStack(e=>e.cancel({force:!0}))}async _createNestedCreateFeaturesWorkflow(e){var u;const{relatedLayer:t}=e,{addAttachmentsCallback:a,applyEditsCallback:i,sketchOptions:s,snappingManager:r,viewModel:n}=this.data;if(!Be(t))throw new $("editor:unsupported-layer","Editing is not supported on the provided layer");const d=this._getCreationInfoForNestedCreateFeaturesWorkflow(e),c=d.template||d.initialFeature?"creating-features":"awaiting-feature-creation-info",p=((u=this.activeWorkflow)==null?void 0:u.type)!=="create-features"?this.activeWorkflow:void 0;return Bt.create({addAttachmentsCallback:a,applyEditsCallback:i,creationInfo:d,isNested:!0,parent:p,sketchOptions:s,snappingManager:r,startAt:c,viewModel:n})}_getCreationInfoForNestedCreateFeaturesWorkflow(e){const{relatedLayer:t}=e;if(!Be(t)||ha(t))throw new $("editor:unsupported-layer","Editing is not supported on the provided layer");const a={layer:t,maxFeatures:1},i=this._makeRelatedRecordAttributes(e),s=Ot(t);return(s==null?void 0:s.length)>0?(a.attributeOverrides=i,s.length===1&&(a.template=s[0])):a.initialFeature=new it({sourceLayer:t,attributes:i}),a}async _createNestedUpdateWorkflow(e){var c;const t=pe(e.sourceLayer)?T:ce,{applyEditsCallback:a,sketchOptions:i,snappingManager:s,viewModel:r}=this.data,n=((c=this.activeWorkflow)==null?void 0:c.type)!=="create-features"?this.activeWorkflow:void 0,d=await t.create({feature:e,parent:n,sketchOptions:i,snappingManager:s,viewModel:r,applyEdits:a,relatedRecordCallbacks:{addRelatedRecord:async p=>await this.startCreatingRelatedRecord(p),editRelatedRecord:async({relatedFeature:p})=>await this.startUpdating(p)}});return await H(()=>!d.updating),d}async _drainWorkflowStack(e){const t=this._workflowStack,a=[];for(;t.length>0;){const i=t.pop();this._sketchStack.pop();const s=e(i).then(()=>i.destroy());this._updatingHandles.addPromise(s),a.push(s)}await Promise.all(a)}_makeRelatedRecordAttributes(e){var c,p;const{parentFeature:t,relatedLayer:a,relationshipId:i}=e;if(!ja(t))return;const s=(c=a.relationships)==null?void 0:c.find(u=>u.id===i);if(!s)return void me("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if(s.role==="origin")return void me("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const r=t.sourceLayer;s.relatedTableId!==r.layerId&&me("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const n=(p=r.relationships)==null?void 0:p.find(u=>u.id===i);if(!n)return void me("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const d=t.getAttribute(n.keyField);return d||me("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field."),{[s.keyField]:d}}async _popWorkflow(){var t;(t=this._workflowStack.pop())==null||t.destroy(),this._sketchStack.pop();const e=await this._reconcileWorkflowStack();if(e.failureCount>0)throw new $("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",e)}async _pushWorkflow(e){var n;const t=this._workflowRequiresSketchViewModel(e);(n=this.activeWorkflow)==null||n.exit({removeSketchHandles:t});const a=this._sketchStack,i=await(e==null?void 0:e.start()),s=a.peek();i?(s==null||s.exit(),a.push(i)):a.push(this._cloneSketchController(s)),this._workflowStack.push(e);const r=await this._reconcileWorkflowStack();if(r.failureCount>0)throw new $("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",r)}async _reconcileWorkflowStack(){var a;const e=this._workflowStack,t=this._sketchStack;try{const i=e.peek();return await(i==null?void 0:i.enter()),await((a=t.peek())==null?void 0:a.enter()),{activeWorkflow:i,failureCount:0}}catch{e.pop().destroy(),t.pop();const{activeWorkflow:s,failureCount:r}=await this._reconcileWorkflowStack();return{activeWorkflow:s,failureCount:r+1}}}_cloneSketchController(e){return{enter:(e==null?void 0:e.enter)??(async()=>{}),exit:(e==null?void 0:e.exit)??(async()=>{}),viewModel:e==null?void 0:e.viewModel}}_workflowRequiresSketchViewModel(e){var a;const{type:t}=e;return t==="update-feature"||t==="create-features"&&!pe((a=e.data.creationInfo)==null?void 0:a.layer)}static _createWorkflowSteps(e,t="awaiting-feature-to-update"){const{data:a}=e;return zt(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],t,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:i}=a.viewModel,s=a.viewModel.view;let r=null;e.addHandles(I(()=>{r=He(r)}),this.id),a.rootFeature=null,a.candidates=[];const n=s.on("immediate-click",async d=>{i.location=d.mapPoint,i.visible=!0,r==null||r.abort();const{editorItems:c}=a.viewModel;r=new AbortController;const p=await d.async(()=>new Promise((u,m)=>{ma(r==null?void 0:r.signal,()=>m(fa())),u(hi(c,s,d,r==null?void 0:r.signal))}));_e(r),a.candidates=p.filter(u=>u.status==="fulfilled").flatMap(u=>u.value).filter(u=>!u.isAggregate),i.visible=a.candidates.length===1,a.candidates.length!==0&&(d.stopPropagation(),a.candidates.length===1?(a.rootFeature=a.candidates[0],e.go("editing-existing-feature").catch(()=>{}).then(()=>i.visible=!1)):e.next())},Lt.TOOL);s.focus(),e.addHandles(n,this.id)},async tearDown(){a.candidates.length===0&&(a.viewModel.spinnerViewModel.visible=!1),e.removeHandles(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){a.rootFeature=null;const{view:i}=a.viewModel;if(!i)return;const s=new Dt({view:i});e.addHandles([F(()=>a.rootFeature,(r,n)=>{s.remove(n),s.add(r)},Re),I(()=>s.removeAll())],this.id)},async tearDown(){e.removeHandles(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:i,viewModel:s}=e.data;if(!i)throw new $("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await e.startUpdating(i),s.spinnerViewModel.visible=!1;const r=Oe(async()=>{await H(()=>!e.updating),e.previous()});e.addHandles([F(()=>e.nestedWorkflowCount,(n,d)=>{n===0&&d!==0&&r()},Re)],this.id)},async tearDown(){await e.cancelAll(),e.removeHandles(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){a.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){a.viewModel.attachmentsViewModel.mode="view"}})})}};o([l()],W.prototype,"activeEditorItem",null),o([l()],W.prototype,"activeFeatureFormViewModel",null),o([l()],W.prototype,"activeSketchViewModel",null),o([l()],W.prototype,"activeWorkflow",null),o([l()],W.prototype,"data",void 0),o([l()],W.prototype,"hasUpdatableCandidates",null),o([l()],W.prototype,"nestedWorkflowCount",null),o([l()],W.prototype,"shouldShowAttachments",null),o([l()],W.prototype,"shouldAllowAttachmentEditing",null),o([l()],W.prototype,"hasPendingEdits",null),o([l()],W.prototype,"helpMessage",null),o([l()],W.prototype,"reliesOnOwnerAdminPrivileges",null),o([l()],W.prototype,"hasInvalidFormTemplate",null),W=tt=o([O(jt)],W);const me=(e,t)=>Oi().warn(`editor:${e}`,t,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),Ti=e=>!!e&&/update-/.test(e.type),Pi=W;let L=class extends ie{constructor(t){super(t),this.layer=null}get attachments(){var t;return{enabled:this._effectiveEnabled&&!!((t=this._effectiveCapabilities)!=null&&t.data.supportsAttachment)}}get create(){var d;const{_effectiveCapabilities:t,layer:a}=this,i=this._createEnabled,s=i,r=(d=a.capabilities)==null?void 0:d.operations.supportsAdd,n=!!(t!=null&&t.operations.supportsAdd);return{attachments:{enabled:i&&this.attachments.enabled},attributes:i,enabled:i,geometry:s,reliesOnOwnerAdminPrivileges:!r&&n}}get delete(){var r;const{_effectiveCapabilities:t,layer:a}=this,i=(r=a.capabilities)==null?void 0:r.operations.supportsDelete,s=!!(t!=null&&t.operations.supportsDelete);return{enabled:this._effectiveEnabled&&!!(t!=null&&t.operations.supportsDelete),reliesOnOwnerAdminPrivileges:!i&&s}}get reliesOnOwnerAdminPrivileges(){return this._effectiveEnabled&&!this.layer.editingEnabled||this.create.reliesOnOwnerAdminPrivileges||this.update.reliesOnOwnerAdminPrivileges||this.delete.reliesOnOwnerAdminPrivileges}get update(){var p;const{_effectiveCapabilities:t,layer:a}=this,i=this._updateEnabled,s=!(!i||!(t!=null&&t.editing.supportsGeometryUpdate)),r=(p=a.capabilities)==null?void 0:p.operations.supportsUpdate,n=!!(t!=null&&t.operations.supportsUpdate),d=this.attachments.enabled,c=d&&this._canCreateOrUpdate;return{attachments:{enabled:d,create:c,update:c},attributes:i,enabled:i,geometry:s,reliesOnOwnerAdminPrivileges:!r&&n}}get _createEnabled(){var t;return this._effectiveEnabled&&!!((t=this._effectiveCapabilities)!=null&&t.operations.supportsAdd)}get _updateEnabled(){var t;return this._effectiveEnabled&&!!((t=this._effectiveCapabilities)!=null&&t.operations.supportsUpdate)}get _canCreateOrUpdate(){return!(!this._createEnabled&&!this._updateEnabled)}get _effectiveEnabled(){return wa(this.layer)}get _effectiveCapabilities(){return ga(this.layer)}};o([l()],L.prototype,"attachments",null),o([l()],L.prototype,"create",null),o([l()],L.prototype,"delete",null),o([l()],L.prototype,"layer",void 0),o([l()],L.prototype,"reliesOnOwnerAdminPrivileges",null),o([l()],L.prototype,"update",null),o([l()],L.prototype,"_createEnabled",null),o([l()],L.prototype,"_updateEnabled",null),o([l()],L.prototype,"_canCreateOrUpdate",null),o([l()],L.prototype,"_effectiveEnabled",null),o([l()],L.prototype,"_effectiveCapabilities",null),L=o([O("esri.layers.support.EditingCapabilities")],L);const Mt=L,le="esri.views.layers.support.editableLayerViews";function Li(e,t){const{associatedLayer:a}=e,i=a==null?void 0:a.infoFor3D;if(!i)return!1;const{supportedFormats:s,queryFormats:r}=i,n=Ka("model/gltf-binary",s)??Qa("glb",s);if(!(n!=null&&r.includes(n)))return z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits because it does not support GLB queries.`),!1;const d=e.spatialReference,c=a.spatialReference;if(!Ue(d,c))return z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits because its spatial reference (wkid:${d.wkid}) is different from its associated FeatureLayer's spatial reference (wkid:${c.wkid}).`),!1;const p=a.sourceJSON.sourceSpatialReference;if(!(p==null||Ue(p,c)))return z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits because the spatial reference of its associated FeatureLayer's service (wkid:${c.wkid}) is different from its source spatial reference (wkid:${p.wkid}).`),!1;const{view:u}=t;if(t.destroyed||u==null)return!1;const m=u.spatialReference,{viewingMode:f}=u.state,y=ya(d),w=f===Ja.Global;return y&&!w?(z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits in local viewing mode because its spatial reference (wkid:${d.wkid}) is geographic. Please consider changing the viewing mode to global.`),!1):!y&&w?(z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits in global viewing mode because its spatial reference (wkid:${d.wkid}) is projected. Please consider changing the viewing mode to local.`),!1):!!(Ue(d,m)||w&&va(m)&&_a(d))||(z.getLogger(le).warnOnce(`SceneLayer (${e.title??"Untitled layer"}, ${e.id}) does not support geometry edits because its spatial reference (wkid:${d.wkid}) does not match the view spatial reference (wkid:${m.wkid}).`),!1)}let x=class extends Mt{constructor(t){super(t),this.layerInfo=null,this.layerView=null}get attachments(){const t=this.defaults.attachments.enabled,a=this.layerInfo;return{enabled:t&&(a==null?void 0:a.enabled)!==!1}}get create(){const{attachments:t,defaults:a,layerInfo:i,layer:s,layerView:r}=this,n=a.create,d=(i==null?void 0:i.enabled)!==!1&&(i==null?void 0:i.addEnabled)!==!1,c=n.enabled&&d;return{attributes:c&&n.attributes,enabled:c,geometry:c&&n.geometry&&Ft(s,r),attachments:{enabled:t.enabled&&c&&(i==null?void 0:i.attachmentsOnCreateEnabled)!==!1},reliesOnOwnerAdminPrivileges:n.reliesOnOwnerAdminPrivileges}}get defaults(){return new Mt({layer:this.layer})}get delete(){const{defaults:t,layerInfo:a}=this,i=t.delete,s=(a==null?void 0:a.enabled)!==!1&&(a==null?void 0:a.deleteEnabled)!==!1;return{enabled:i.enabled&&s,reliesOnOwnerAdminPrivileges:i.reliesOnOwnerAdminPrivileges}}get formTemplate(){const{layer:t,layerInfo:a}=this;return a!=null&&a.formTemplate?a.formTemplate:t&&"formTemplate"in t?t.formTemplate:null}get relationship(){var s,r,n;const{layer:t}=this,a=!(!Za(t)||!((s=t.relationships)!=null&&s.length)),i=!!((n=(r=this.formTemplate)==null?void 0:r.elements)!=null&&n.some(d=>d.type==="relationship"));return{enabled:a&&i}}get update(){const{attachments:t,defaults:a,layerInfo:i,layer:s,layerView:r}=this,n=a.update,d=(i==null?void 0:i.enabled)!==!1&&(i==null?void 0:i.updateEnabled)!==!1,c=n.enabled&&d,p=c&&n.attributes&&(i==null?void 0:i.attributeUpdatesEnabled)!==!1,u=c&&n.geometry&&(i==null?void 0:i.geometryUpdatesEnabled)!==!1&&Ft(s,r),m=t.enabled&&(i==null?void 0:i.attachmentsOnUpdateEnabled)!==!1;return{attributes:p,enabled:c,geometry:u,attachments:{enabled:m,create:m&&n.attachments.create,update:m&&n.attachments.update},reliesOnOwnerAdminPrivileges:n.reliesOnOwnerAdminPrivileges}}};function Ft(e,t){return e.type!=="scene"||t!=null&&"type"in t&&t.type==="scene-layer-3d"&&Li(e,t)}o([l()],x.prototype,"attachments",null),o([l()],x.prototype,"create",null),o([l()],x.prototype,"defaults",null),o([l()],x.prototype,"delete",null),o([l()],x.prototype,"formTemplate",null),o([l()],x.prototype,"layerInfo",void 0),o([l()],x.prototype,"layerView",void 0),o([l()],x.prototype,"relationship",null),o([l()],x.prototype,"update",null),x=o([O("esri.widgets.Editor.support.EditorEditingCapabilities")],x);const Ui=x;let S=class extends ie{constructor(t){super(t),this.disabled=!1,this.layer=null,this.layerInfo=null,this.layerView=null}get _suspended(){var t;return!!((t=this.layerView)!=null&&t.suspended)}get capabilities(){return new Ui({layer:this.layer,layerInfo:this.layerInfo,layerView:this.layerView})}get editable(){const{create:t,relationship:a,update:i,delete:{enabled:s}}=this.capabilities,r=t.attachments.enabled||i.attachments.enabled;return!this.disabled&&(t.enabled||i.enabled||r||s||a.enabled)}get formTemplate(){return this.capabilities.formTemplate}get hasInvalidFormTemplate(){return Ya(this.layer,this.formTemplate)}get isTable(){return pe(this.layer)}get supportsCreateFeaturesWorkflow(){if(this.disabled)return!1;const{enabled:t,geometry:a}=this.capabilities.create;return this.isTable?t:t&&a}get supportsUpdateWorkflow(){const{capabilities:t}=this;return!this.disabled&&(t.update.enabled||t.update.attachments.enabled||t.delete.enabled)}get visible(){const{layer:t}=this,a=t.parent;return!this._suspended&&t.visible&&(!a||!("visible"in a)||a.visible)}};o([l()],S.prototype,"_suspended",null),o([l()],S.prototype,"capabilities",null),o([l()],S.prototype,"disabled",void 0),o([l()],S.prototype,"editable",null),o([l()],S.prototype,"formTemplate",null),o([l()],S.prototype,"hasInvalidFormTemplate",null),o([l()],S.prototype,"isTable",null),o([l()],S.prototype,"layer",void 0),o([l()],S.prototype,"layerInfo",void 0),o([l()],S.prototype,"layerView",void 0),o([l()],S.prototype,"supportsCreateFeaturesWorkflow",null),o([l()],S.prototype,"supportsUpdateWorkflow",null),o([l()],S.prototype,"visible",null),S=o([O("esri.widgets.Editor.support.EditorItem")],S);const xi=S,Zt="esri.widgets.Editor.EditorViewModel",Di=()=>z.getLogger(Zt),Kt=["create-features","update"];function te(e,t,a){Di().error(new $(e,t,a))}function Hi(e,t){return e==null?void 0:e.find(a=>a.layer===t)}let v=class extends Wt.EventedAccessor{constructor(e){super(e),this._sketchEventListenerHandle=null,this._sketchGraphicsLayer=new nt({listMode:"hide",internal:!0}),this._snappingManager=null,this._updateItemsTask=null,this._updatingHandles=new Tt,this._featureTemplatesViewModelLocked=!1,this.activeWorkflow=null,this._activityQueue=new Fe,this.editorItems=new Fe,this.failures=[],this.hideTemplatesForInactiveLayers=!1,this.attachmentsViewModel=new Ca({capabilities:{editing:!0}}),this.featureTemplatesViewModel=new Sa({disabledItemFunction:({layer:t})=>this._itemIsSuspended(t)}),this.layerInfos=null,this.ownSketchViewModel=new lt({layer:this._sketchGraphicsLayer}),this.sketchOptions=new Te,this.snappingOptions=new Pt({attributeRulesEnabled:!0}),this.spinnerViewModel=new Pa,this.pageStack=[],this.showDiscardEditsPrompt=()=>Promise.resolve(!0),this._candidateCommitted=!1,this.back=async()=>{var t;this.canGoBack&&((t=this.activeWorkflow)!=null&&t.hasPreviousStep?await this.activeWorkflow.back(this.showDiscardEditsPrompt):await this._cancelWorkflow({force:!this.hasPendingEdits}))},this.saveWorkflow=async()=>{var a;const{featureFormViewModel:t}=this;if(t){if(t.submit(),!t.submittable||t.hasPendingSubtypeChoice)return;const i=t.getValues();if(t.validateContingencyConstraints(i,{includeIncompleteViolations:!0}).length>0)return}await((a=this.activeWorkflow)==null?void 0:a.save())},this.selectFeature=(t,a=!1)=>{const i=this.activeWorkflow;this._candidateCommitted||(i==null?void 0:i.type)!=="update"||(i.data.rootFeature=t,a&&(i.next(),this._candidateCommitted=!0))}}initialize(){this.addHandles([F(()=>{var s;const e=this.view,t=(s=e==null?void 0:e.map)==null?void 0:s.editableLayers,a=e==null?void 0:e.allLayerViews,i=a==null?void 0:a.filter(r=>!!(t!=null&&t.includes(r.layer)));return[t,i,this.layerInfos,this.allowedWorkflows]},()=>this._updateEditorItems(),we),F(()=>this.hideTemplatesForInactiveLayers,()=>this.syncFeatureTemplates()),J(()=>this.activeWorkflow,"cancel",()=>this.emit("workflow-cancel")),J(()=>this.activeWorkflow,"commit",()=>this.emit("workflow-commit")),J(()=>this.activeWorkflow,"complete",()=>{this.emit("workflow-commit"),this._set("activeWorkflow",null)}),ge(()=>{var e;return(e=this.view)==null?void 0:e.map},e=>e.add(this._sketchGraphicsLayer),ae),J(()=>this.editorItems,"change",()=>this._afterEditorItemsChange()),F(()=>[this.canCreate,this.canUpdateVisible],()=>this._afterEditorItemsChange()),F(()=>this.page,(e,t)=>{const a=[...this.pageStack];if(a.indexOf(e)===-1)a.push(e);else for(;a.length&&a.at(-1)!==e;)a.pop();this.pageStack=a},we),ge(()=>this.state==="awaiting-update-feature-candidate",()=>this._candidateCommitted=!1),J(()=>this.featureTemplatesViewModel,"select",async({item:e,oldItem:t})=>{var s;const{activeWorkflow:a}=this;if(a){if(a.type==="update"&&((s=a.activeWorkflow)==null?void 0:s.stepId)==="awaiting-feature-creation-info")return;try{await this.cancelWorkflow({force:!this.hasPendingEdits})}catch{return void this.featureTemplatesViewModel.select(t,{emit:!1})}}if(!e)return;const i={layer:e.layer,template:e.template};if(e.supportsUpload)return this.featureTemplatesViewModel.select(t,{emit:!1}),this.startCreateFeaturesWorkflow(i);this.startCreateFeaturesWorkflowAtFeatureCreation(i)}),J(()=>this.view,"key-down",e=>{var t;e.key==="Escape"&&((t=this.activeWorkflow)!=null&&t.keyboardCancellationEnabled)&&(e.stopPropagation(),this.back())}),J(()=>this.sketchViewModel,["create","delete","update"],e=>{var n,d;const{activeWorkflow:t}=this,a=(t==null?void 0:t.type)==="update",i=a?(n=t.activeWorkflow)==null?void 0:n.layer:t==null?void 0:t.layer,s=a?(d=t==null?void 0:t.activeWorkflow)==null?void 0:d.parentLayer:void 0,r=`sketch-${e.type}`;this.emit(r,{type:r,detail:e,layer:i,parentLayer:s})},Re),F(()=>this.view,e=>{if(this._snappingManager=rt(this._snappingManager),!e)return;const t=this.snappingOptions;this._snappingManager=new Ha({view:e,options:t})},we),F(()=>this.snappingOptions,e=>{this._snappingManager&&(this._snappingManager.options=e)},we)])}destroy(){this._cancelWorkflow({warnIfNoWorkflow:!1}).then(()=>{var e,t;(t=(e=this.view)==null?void 0:e.map)==null||t.remove(this._sketchGraphicsLayer),this.view=null}),this._updateItemsTask=He(this._updateItemsTask),this._updatingHandles.destroy(),this._sketchEventListenerHandle=Ie(this._sketchEventListenerHandle)}get allowedWorkflows(){return this._get("allowedWorkflows")}set allowedWorkflows(e){Ge(z.getLogger(this),"allowedWorkflows",{replacement:"Editor.visibleElements",version:"4.29",warnOnce:!0}),e&&e.length!==0||(e=[...Kt]),this._set("allowedWorkflows",e)}get canCreate(){return this.editorItems.some(e=>e.supportsCreateFeaturesWorkflow)}get canCreateVisible(){return!!this.featureTemplatesLayers.length}get canUpdate(){return this.editorItems.some(e=>e.supportsUpdateWorkflow)}get canUpdateVisible(){return this.editorItems.some(e=>e.supportsUpdateWorkflow&&e.visible)}get featureTemplatesLayers(){const e=new Fe;for(const t of this.editorItems){const a=t.supportsCreateFeaturesWorkflow&&!t.isTable,i=this.hideTemplatesForInactiveLayers&&!t.visible;a&&!i&&e.push(t.layer)}return e}get editableItems(){return Ge(z.getLogger(this),"editableItems",{replacement:"editorItems",version:"4.29",warnOnce:!0}),this.editorItems.map(e=>{const{capabilities:t,disabled:a,hasInvalidFormTemplate:i,layer:s}=e,r=[],n=t.create,d=t.update,c=t.delete;return n.enabled&&r.push("create"),d.enabled&&r.push("update"),c.enabled&&r.push("delete"),{layer:s,supports:r,suspended:a,attributeUpdatesEnabled:d.attributes,geometryUpdatesEnabled:d.geometry,attachmentsOnCreateEnabled:n.attachments.enabled,attachmentsOnUpdateEnabled:d.attachments.enabled,hasInvalidFormTemplate:i,hasAttachments:t.attachments.enabled}})}get featureFormViewModel(){const{activeWorkflow:e}=this;return(e==null?void 0:e.type)==="update"?e.activeFeatureFormViewModel:(e==null?void 0:e.type)==="create-features"?e.featureFormViewModel:null}get labelOptions(){return this.sketchOptions.labels}set labelOptions(e){this.sketchOptions.labels=e}get sketchViewModel(){const{activeWorkflow:e}=this;return(e==null?void 0:e.type)==="update"?e.activeSketchViewModel:(e==null?void 0:e.type)==="create-features"?e.sketchViewModel:this.ownSketchViewModel}get state(){var a,i;if(!((a=this.view)!=null&&a.ready))return"disabled";const e=this.attachmentsViewModel.mode;if(e==="add")return"adding-attachment";if(e==="edit")return"editing-attachment";const{activeWorkflow:t}=this;return t!=null&&t.stepId?t.type==="update"&&((i=t.activeWorkflow)!=null&&i.stepId)?t.activeWorkflow.stepId:t.stepId:"ready"}get syncing(){return this._activityQueue.length>0}get updating(){var e;return this._updatingHandles.updating||((e=this.activeWorkflow)==null?void 0:e.updating)===!0}get tooltipOptions(){return this.sketchOptions.tooltips}set tooltipOptions(e){this.sketchOptions.tooltips=e}get valueOptions(){return this.sketchOptions.values}set valueOptions(e){this.sketchOptions.values=e}set view(e){this.ownSketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}get page(){const{activeWorkflow:e,state:t}=this;if((e==null?void 0:e.type)==="update"&&e.stepId==="awaiting-feature-to-update")return"ready";if((e==null?void 0:e.type)==="create-features"&&e.numPendingFeatures===0){const a=e.data.upload;if(a)return a.state==="default"?"ready":"creating-features-upload-details"}return t??"disabled"}get featureFormDisabled(){var t;const{activeWorkflow:e}=this;return(e==null?void 0:e.type)==="update"&&((t=e.activeEditorItem)==null?void 0:t.capabilities.update.attributes)===!1}get canGoBack(){return this.activeWorkflow!=null&&!this.syncing}get shouldShowDeleteButton(){var t;const{activeWorkflow:e}=this;return!!e&&e.type==="update"&&!!((t=e.activeEditorItem)!=null&&t.capabilities.delete.enabled)}get hasPendingEdits(){var e;return((e=this.activeWorkflow)==null?void 0:e.hasPendingEdits)??!1}async startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.startCreateFeaturesWorkflow()}async startCreateFeaturesWorkflowAtFeatureCreation(e){return this.startCreateFeaturesWorkflow(e,"creating-features")}async startCreateFeaturesWorkflow(e,t="awaiting-feature-creation-info"){if(await H(()=>!this.updating),!this.canCreate)throw new $("editing:unsupported-workflow","Creating features is unsupported or disabled.");const a=this._createUpdatingResolver();try{await this._cancelWorkflow();const i=this._createCreateFeaturesWorkflow(e,t);this._set("activeWorkflow",i),await i.start()}catch(i){this._logErrorAndCancelWorkflow(i)}finally{a.resolve()}}async startCreateFeaturesWorkflowAtFeatureEdit(e){await H(()=>!this.updating);const t=this._createUpdatingResolver();try{const{initialFeature:a}=e,i=a.sourceLayer=a.layer,s=i?this.findEditorItemForLayer(i):void 0;if(!(s!=null&&s.supportsCreateFeaturesWorkflow))throw new $("editing:unsupported-workflow","Creating features is unsupported or disabled for this layer.");await this._cancelWorkflow();const r=this._createCreateFeaturesWorkflow({initialFeature:a,layer:s.layer,maxFeatures:1},"creating-features");this._set("activeWorkflow",r),await r.start()}catch(a){this._logErrorAndCancelWorkflow(a)}finally{t.resolve()}}async startUpdateWorkflowAtFeatureSelection(){if(await H(()=>!this.updating),!this.canUpdate)return void te("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const e=this._createUpdatingResolver();try{await this._cancelWorkflow();const t=this._createUpdateWorkflow();this._set("activeWorkflow",t),await t.start()}catch(t){this._logErrorAndCancelWorkflow(t)}finally{e.resolve()}}async startUpdateWorkflowAtMultipleFeatureSelection(e){if(await H(()=>!this.updating),!this.canUpdate)return void te("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const t=this._createUpdatingResolver();try{await this._cancelWorkflow();const a=this._createUpdateWorkflow("awaiting-update-feature-candidate");a.data.candidates=e,this._set("activeWorkflow",a),await a.start()}catch(a){this._logErrorAndCancelWorkflow(a)}finally{t.resolve()}}async startUpdateWorkflowAtFeatureEdit(e){if(await H(()=>!this.updating),!this.canUpdate)return void te("editing:unsupported-workflow","Update workflow is unsupported or disabled.");const t=this._createUpdatingResolver();try{await this._cancelWorkflow();const a=this._createUpdateWorkflow("editing-existing-feature");a.data.rootFeature=e,this._set("activeWorkflow",a),await a.start()}catch(a){this._logErrorAndCancelWorkflow(a)}finally{t.resolve()}}async deleteFeatureFromWorkflow(){const{activeWorkflow:e}=this;e&&e.type==="update"?await e.deleteActiveFeature():te("editing:unsupported-workflow","Deleting requires an active update workflow.")}async cancelWorkflow(e){return this._cancelWorkflow({warnIfNoWorkflow:!0,...e})}findEditorItemForLayer(e){return this.editorItems.find(t=>t.layer===e)}itemHasInvalidFormTemplate(e){var t;return e!=null&&((t=this.findEditorItemForLayer(e.layer))==null?void 0:t.hasInvalidFormTemplate)===!0}syncFeatureTemplates(){this._featureTemplatesViewModelLocked||(this.featureTemplatesViewModel.layers=this.featureTemplatesLayers.toArray())}async toggleUpdateWorkflow(){this.canUpdate&&(this.hasPendingEdits&&!await this.showDiscardEditsPrompt()||(this.activeWorkflow&&this.state==="awaiting-feature-to-update"?await this.cancelWorkflow({force:!0}):await this.startUpdateWorkflowAtFeatureSelection()))}lockFeatureTemplatesViewModel(){return this._featureTemplatesViewModelLocked=!0,I(()=>{this._featureTemplatesViewModelLocked=!1,this.syncFeatureTemplates()})}async _getEditorItemCandidates(e){const{view:t}=this;if(!(t!=null&&t.map))return[];const{map:a}=t,i=a.editableLayers.toArray()??[],s=a.allTables.toArray().filter(ka)??[];return await Promise.allSettled([...i.map(r=>r.type==="subtype-group"?r.loadAll():Promise.resolve()),...s.map(r=>r.load())]),_e(e),[...i.reverse(),...s.reverse()].filter(r=>Be(r)&&(r.geometryType!=="mesh"||t.type==="3d")).flatMap(r=>r.type==="subtype-group"?r.sublayers.toArray():r)}_drainEditorItems(){this.editorItems.drain(e=>e.destroy())}async _updateEditorItems(){He(this._updateItemsTask);const{view:e}=this,t=$t(async a=>{if(!(e!=null&&e.map)||!(e!=null&&e.allLayerViews))return;const i=await this._getEditorItemCandidates(a);if(!i.length)return void this._drainEditorItems();const s=[],r=[],n=[],{layerInfos:d}=this;for(const p of i){const u=Hi(d,p),m=await he(e,p).catch(()=>null);(u?s:m?r:n).push(new xi({layer:p,layerInfo:u,layerView:m}))}d!=null&&d.length&&s.sort((p,u)=>d.findIndex(({layer:m})=>m===p.layer)-d.findIndex(({layer:m})=>m===u.layer));const c=[...s,...r,...n];a.aborted||(this._drainEditorItems(),this.editorItems.addMany(c))});this._updatingHandles.addPromise(t.promise),this._updateItemsTask=t}_afterEditorItemsChange(){const{activeWorkflow:e}=this;if(this.syncFeatureTemplates(),!e)return;const{stepId:t}=e;e.type!=="create-features"?e.type==="update"&&(t==="awaiting-feature-to-update"&&!this.canUpdateVisible||t==="awaiting-update-feature-candidate"&&!e.hasUpdatableCandidates)&&this._cancelWorkflow():t!=="awaiting-feature-creation-info"||this.canCreate||this._cancelWorkflow()}async _cancelWorkflow(e){const t=this.activeWorkflow;if(!t)return void((e==null?void 0:e.warnIfNoWorkflow)&&te("editing:no-active-workflow","There is no active workflow to cancel."));if(!e||e.force!==!1)return this.emit("workflow-cancel"),this._set("activeWorkflow",null),void await t.cancel(e);await t.cancel(e),this._set("activeWorkflow",null)}_createCreateFeaturesWorkflow(e,t){return Bt.create({viewModel:this,creationInfo:e,sketchOptions:this.sketchOptions,snappingManager:this._snappingManager,startAt:t,applyEditsCallback:(a,i,s)=>this._applyEdits(a,i,s),addAttachmentsCallback:(a,i)=>this._addAttachments(a,i)})}_createUpdateWorkflow(e){return Pi.create({viewModel:this,sketchOptions:this.sketchOptions,snappingManager:this._snappingManager,startAt:e,applyEditsCallback:(t,a,i)=>this._applyEdits(t,a,i),addAttachmentsCallback:(t,a)=>this._addAttachments(t,a)})}_addAttachments(e,t){const a=t.map(i=>this._addAttachment(e,i.feature,i.attachment))??[];return Promise.all(a)}async _addAttachment(e,t,a){var s;let i=null;if(!("addAttachment"in e)||((s=e.capabilities)==null?void 0:s.attachment)==null)throw new $("editor:attachments-not-supported","Adding attachments is not supported for this layer type");return await this._queueOperation(async()=>{var r;return i=await((r=e.addAttachment)==null?void 0:r.call(e,t,a).catch(n=>{throw(n==null?void 0:n.error)||n}))??null,i}),i}async _applyEdits(e,t,a){let i=null;const s=e.url?await ba(e.url):null,r={returnServiceEditsOption:(!s||!Ma(s))&&!RegExp("/hosted/","i").test(e.url)?"original-and-current-features":void 0,...a};return await this._queueOperation(async()=>{const{view:n}=this;if(!n)return null;const d=await he(n,e).catch(()=>null);return i=await e.applyEdits(t,r),d&&await H(()=>!d.updating),i}),i}_queueOperation(e){this._activityQueue.push(e);const t=(a,i)=>{const s=i.indexOf(a);s>-1&&i.splice(s,1)};return e().then(a=>{if(a!=null&&"error"in a&&a.error!=null)throw a.error;if(a!=null&&"addFeatureResults"in a){const{addFeatureResults:i,deleteFeatureResults:s,updateFeatureResults:r}=a,n=i.find(d=>!!d.error)||r.find(d=>!!d.error)||s.find(d=>!!d.error);if(n)throw n.error}return a}).catch(a=>{te("editing:operation-error","An error occurred.",{error:a});const i={error:a,retry:()=>(t(i,this.failures),this._queueOperation(e)),cancel:()=>{t(i,this.failures)}};this._set("failures",[...this.failures,i])}).then(()=>{t(e,this._activityQueue)})}_createUpdatingResolver(){const e=st();return this._updatingHandles.addPromise(e.promise),e}_logErrorAndCancelWorkflow(e){const{name:t,message:a,details:i}=e;te(t??"editing:workflow-start-failed",a??void 0,i??e),this._cancelWorkflow({force:!0})}_itemIsSuspended(e){const t=this.findEditorItemForLayer(e);return t!=null&&(!t.visible||t.disabled)}};o([l({readOnly:!0})],v.prototype,"activeWorkflow",void 0),o([l({readOnly:!0})],v.prototype,"_activityQueue",void 0),o([l({value:[...Kt]})],v.prototype,"allowedWorkflows",null),o([l({readOnly:!0})],v.prototype,"canCreate",null),o([l()],v.prototype,"canCreateVisible",null),o([l({readOnly:!0})],v.prototype,"canUpdate",null),o([l()],v.prototype,"canUpdateVisible",null),o([l()],v.prototype,"featureTemplatesLayers",null),o([l()],v.prototype,"editableItems",null),o([l()],v.prototype,"editorItems",void 0),o([l({readOnly:!0})],v.prototype,"failures",void 0),o([l()],v.prototype,"hideTemplatesForInactiveLayers",void 0),o([l()],v.prototype,"attachmentsViewModel",void 0),o([l()],v.prototype,"featureFormViewModel",null),o([l()],v.prototype,"featureTemplatesViewModel",void 0),o([l()],v.prototype,"labelOptions",null),o([l()],v.prototype,"layerInfos",void 0),o([l()],v.prototype,"ownSketchViewModel",void 0),o([l()],v.prototype,"sketchOptions",void 0),o([l()],v.prototype,"sketchViewModel",null),o([l({type:Pt,nonNullable:!0})],v.prototype,"snappingOptions",void 0),o([l()],v.prototype,"spinnerViewModel",void 0),o([l()],v.prototype,"state",null),o([l({readOnly:!0})],v.prototype,"syncing",null),o([l()],v.prototype,"updating",null),o([l()],v.prototype,"tooltipOptions",null),o([l()],v.prototype,"valueOptions",null),o([l()],v.prototype,"view",null),o([l()],v.prototype,"pageStack",void 0),o([l()],v.prototype,"showDiscardEditsPrompt",void 0),o([l()],v.prototype,"_candidateCommitted",void 0),o([l()],v.prototype,"page",null),o([l()],v.prototype,"featureFormDisabled",null),o([l()],v.prototype,"canGoBack",null),o([l()],v.prototype,"shouldShowDeleteButton",null),o([l()],v.prototype,"hasPendingEdits",null),v=o([O(Zt)],v);const Ri=v;let D=class extends ie{constructor(t){super(t),this.createFeaturesSection=!0,this.directionModePicker=!1,this.editFeaturesSection=!0,this.labelsToggle=!0,this.settingsMenu=!0,this.snappingControls=!0,this.snappingControlsElements=new dt,this.tooltipsToggle=!0,this.undoRedoButtons=!1}};o([l({type:Boolean,nonNullable:!0})],D.prototype,"createFeaturesSection",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"directionModePicker",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"editFeaturesSection",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"labelsToggle",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"settingsMenu",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"snappingControls",void 0),o([l({type:dt,nonNullable:!0})],D.prototype,"snappingControlsElements",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"tooltipsToggle",void 0),o([l({type:Boolean,nonNullable:!0})],D.prototype,"undoRedoButtons",void 0),D=o([O("esri.widgets.Editor.VisibleElements")],D);const Qt=D,fe="esri-editor__panel-content",ve={base:fe,message:`${fe}__message`,section:`${fe}__section`,sectionGroup:`${fe}__section__group`,scrimContainer:`${fe}__scrim-container`},ke=()=>se({scrim:()=>V(()=>import("./calcite-scrim-ChpvlkQb.js"),__vite__mapDeps([8,9,10,1,2,11,12,13,14,15,16,17]))});function Y(e,...t){return h("div",{class:Ne(ve.base,e!=null&&e.showScrimOverlay?ve.scrimContainer:void 0),key:(e==null?void 0:e.key)??"panel-content"},...t,e!=null&&e.showScrimOverlay?h("calcite-scrim",null):void 0)}function ut(e,...t){return h("div",{class:ve.message,"data-testid":"panel-content-message",key:(e==null?void 0:e.key)??"panel-content-message"},...t)}function ue(e,...t){return h("div",{class:ve.section,key:(e==null?void 0:e.key)??"panel-content-section"},...t)}function Gi(e,...t){return h("div",{class:ve.sectionGroup,key:(e==null?void 0:e.key)??"panel-content-section-group"},...t)}const zi=()=>ke();function Ni({helpMessage:e}){return h(Y,{key:"creating-features-panel-content"},h(ut,{key:"content-message"},e))}const Bi=()=>ke();function qi({editorItems:e,filterText:t,id:a,messagesTemplates:i,onFilterTextChange:s,onSelectFeature:r,workflow:n}){const d=new Map,c=n.data.candidates;let p=0;c.map(f=>({label:ji(f),id:f.attributes[f.layer.objectIdField],data:f})).filter(({label:f,data:y})=>{const w=t.toLowerCase(),{title:g}=y.layer,b=e.find(_=>_.layer===y.sourceLayer);return b?b.supportsUpdateWorkflow&&(!w||(f==null?void 0:f.toLowerCase().includes(w))||(g==null?void 0:g.toLowerCase().includes(w))):null}).filter(ze).forEach(f=>{var w;p++;const y=f.data.layer;d.has(y)?(w=d.get(y))==null||w.items.push(f):d.set(y,{id:`${y.id}`,label:y.title??"",items:[f]})});const u=e.toArray().map(({layer:f})=>d.get(f)).filter(ze),m=p>10||t.length>0;return h(Y,{key:"feature-list"},h(ue,null,Va({enableListScroll:!1,filterEnabled:m,filterText:t,id:a,items:u,messages:{filterPlaceholder:i.filterPlaceholder,noItems:i.noItems,noMatches:i.noMatches},onFilterChange:f=>s(f),onItemMouseEnter:f=>r(f.data),onItemMouseLeave:()=>r(null),onItemSelect:f=>r(f.data,!0)})))}function ji(e){const t=e.layer;if(!t)return null;const a=t.fieldsIndex.get(t.objectIdField),i=a.alias||a.name,{attributes:s}=e,r=At(t);return r&&s[r]&&`${s[r]}`||`${i}: ${s[a.name]}`}const Zi={base:"esri-editor__actions"},ht=()=>se({button:()=>V(()=>import("./calcite-button-B3dK3J4O.js"),__vite__mapDeps([18,19,10,1,2,11,20,13,21,22,23,24,12,14,15,16,25,17]))});function Ve({buttons:e,key:t}){return h("div",{class:Zi.base,key:t??"footer-actions",slot:"footer"},e.filter(ze).map(({disabled:a,onClick:i,label:s,...r},n)=>h("calcite-button",{disabled:a??!1,key:`action-${n}`,onclick:()=>{a||i()},slot:"footer-actions",width:"full",...r},s)))}const Ki={notice:"esri-editor__notice"},Jt=()=>se({notice:()=>V(()=>import("./calcite-notice-DA7FQ9_1.js"),__vite__mapDeps([26,10,1,2,11,27,15,13,24,12,14,16,28,23,25]))});function Qi({workflow:e,messages:t}){return h(ot,null,e!=null&&e.reliesOnOwnerAdminPrivileges?h(at,{message:t.ownerAdminNotice}):void 0,e!=null&&e.hasInvalidFormTemplate?h(at,{icon:Vt,message:t.formFieldUpdateError}):void 0)}function at({message:e,...t}){return h("calcite-notice",{class:Ki.notice,open:!0,scale:"s",...t},h("div",{slot:"message"},e))}const Ji={settingsContainer:"esri-editor__settings"},Yi=()=>se({accordion:()=>V(()=>import("./calcite-accordion-DJA6uq4Y.js"),__vite__mapDeps([29,10,1,2,11,15])),"accordion-item":()=>V(()=>import("./calcite-accordion-item-CudDdE0M.js"),__vite__mapDeps([30,10,1,2,11,27,15,13,23,24,25]))});function Xi({editorViewModel:e,messagesCommon:t,visibleElements:a}){const{snappingOptions:i,sketchOptions:s,view:r}=e,n=[],d={directionModePicker:a.directionModePicker,labelsToggle:a.labelsToggle,tooltipsToggle:a.tooltipsToggle};return Ua(d)&&n.push(h(Xa,{sketchOptions:s,viewType:r==null?void 0:r.type,visibleElements:d})),a.snappingControls&&n.push(h(ei,{afterCreate:c=>c.layerListOpen=!1,snappingOptions:i,view:r,visibleElements:a.snappingControlsElements??new dt})),n.length===0?null:h("calcite-accordion",{appearance:"transparent",class:Ji.settingsContainer,key:"settings"},h("calcite-accordion-item",{"data-testid":"settings",heading:t.settings,iconStart:"gear"},n))}const es={base:"esri-editor__panel-toolbar"},ts=()=>Promise.all([se({button:()=>V(()=>import("./calcite-button-B3dK3J4O.js"),__vite__mapDeps([18,19,10,1,2,11,20,13,21,22,23,24,12,14,15,16,25,17]))}),Yi()]);function as({editorViewModel:e,messagesCommon:t,visibleElements:a}){const{sketchViewModel:i}=e;return h("div",{class:es.base,key:"panel-toolbar"},h(Xi,{editorViewModel:e,messagesCommon:t,visibleElements:a}),a.undoRedoButtons?[h("calcite-button",{alignment:"center",appearance:"transparent",disabled:!(i!=null&&i.canUndo()),iconStart:"undo",key:"undo-button",kind:"neutral",label:t.undo,onclick:()=>i==null?void 0:i.undo(),scale:"l"},t.undo),h("calcite-button",{alignment:"center",appearance:"transparent",disabled:!(i!=null&&i.canRedo()),iconStart:"redo",key:"redo-button",kind:"neutral",label:t.redo,onclick:()=>i==null?void 0:i.redo(),scale:"l"},t.redo)]:null)}const is=()=>Promise.all([ht(),Jt(),ke()]);function It({editorViewModel:e,headingLevel:t,messages:a,messagesCommon:i,onDelete:s,onSave:r,renderAttachments:n,renderFeatureForm:d}){const{activeWorkflow:c,featureFormViewModel:p,syncing:u}=e;if(!c||!p)return null;const m=c.type,f="activeWorkflow"in c?c.activeWorkflow:void 0,y=f==null?void 0:f.type,w=f&&!f.hasPendingEdits||m==="update"&&!c.hasPendingEdits||u||p.updating,g=m==="update"&&y!=="create-features"?i.update:i.create,b=m==="create-features"&&c.createFeatureState==="create-new",_=m==="create-features"?c.numPendingFeatures:0,M=_>1?Se(a.createFeaturesTemplate,{numFeatures:_}):g,E=c.shouldShowAttachments&&!p.activeRelationshipInput,U=p.inputs.every(K=>!K.visible)&&!E?h(ut,{key:"panel-content-message"},Se(a.clickToFinishTemplate,{button:g})):h(ue,{key:"panel-content-section"},h(Qi,{messages:a,workflow:c}),h(Gi,null,d(),E?h("div",{key:"attachments"},h(je,{level:Ce(t)},a.attachments),n()):null));return h(ot,null,h(Y,{key:"attribute-panel-content",showScrimOverlay:b},U),h(Ve,{buttons:[{onClick:r,disabled:w,label:M},e.shouldShowDeleteButton?{appearance:"outline",onClick:s,disabled:u,kind:"danger",label:i.delete}:void 0]}))}const P="esri-editor__upload-details",R={base:P,status:`${P}__status`,titleWrapper:`${P}__title-wrapper`,title:`${P}__title`,description:`${P}__description`,loader:`${P}__loader`,iconSuccess:`${P}__icon ${P}__icon--success`,iconError:`${P}__icon ${P}__icon--error`,fileList:`${P}__file-list`,file:`${P}__file`,fileIcon:`${P}__file-icon`,fileName:`${P}__file-name`},ss=()=>Promise.all([se({icon:()=>V(()=>import("./calcite-icon-W-AdNGRC.js"),__vite__mapDeps([31,25,10,1,2,11,13,15])),loader:()=>V(()=>import("./calcite-loader-DWyhLzpy.js"),__vite__mapDeps([32,17,10,1,2,11,13,12,14,15]))}),ht(),ke()]);function rs(e){const{messages:t,key:a,upload:i}=e;return h(ot,null,h(Y,{key:a??"upload-details"},h(ue,null,os(e))),i.state==="error"?h(Ve,{buttons:[{onClick:()=>i.retry(),label:t.modelUploads.error.uploadNew,iconStart:"upload-to"}],key:"upload-details-footer-actions"}):null)}function os(e){const t=ns(e);return t?h("div",{class:R.base,"data-testid":"upload-details",key:"upload-details-content"},h("div",{class:R.status,key:"status"},t.iconContent,h("div",{class:R.titleWrapper,key:"text"},h("div",{class:R.title,key:"title"},t.title),h("div",{class:R.description,key:"description"},t.description))),ds(e.upload)):null}function ns({helpMessage:e,messages:t,upload:a}){switch(a.state){case"pending":{const{title:i,description:s}=t.modelUploads.pending;return{title:i,description:s,iconContent:h("calcite-loader",{"aria-hidden":"true",class:R.loader,label:"",scale:"s",type:"determinate",value:Math.min(Math.round(100*a.progress),a.progress===1?100:99)})}}case"success":{const{title:i}=t.modelUploads.success;return{title:i,description:e||t.helpMessages3d.mesh,iconContent:h("calcite-icon",{class:Ne(R.iconSuccess),icon:"check",scale:"l"})}}case"error":{const{title:i}=t.modelUploads.error;return{title:i,description:ls(a.error,t),iconContent:h("calcite-icon",{class:Ne(R.iconError),icon:"exclamation-mark-circle",scale:"l"})}}default:return null}}function ls(e,t){if(!e)return null;const a=t.modelUploads.error.messages;switch(e.constructor){case ii:return a.noModel;case ai:return a.multipleModels;case ti:return a.conversionFailed;default:return a.default}}function ds(e){return h("div",{class:R.fileList,key:"file-list"},e.files.map(t=>h("div",{class:R.file,key:`file-${t.name}`},h("calcite-icon",{class:R.fileIcon,icon:ps(t),scale:"s"}),h("span",{class:R.fileName},cs(t.name)))))}function cs(e){var t;return((t=e.split("/").pop())==null?void 0:t.split("\\").pop())??""}function ps(e){var a;const t=(a=e.name.split(".").pop())==null?void 0:a.toLowerCase();return(t?hs[t]:null)??us}const us="file",Ct="file-shape",Me="file-image",hs={glb:Ct,gltf:Ct,jpeg:Me,jpg:Me,png:Me,svg:Me,zip:"file-zip"};let k=class extends xa{constructor(e,t){super(e,t),this._featureForm=new Aa,this._attachments=new Ea({visibleElements:{addSubmitButton:!1,cancelAddButton:!1,cancelUpdateButton:!1,deleteButton:!1,errorMessage:!1,progressBar:!1,updateButton:!1}}),this._featureTemplates=new Oa({enableListScroll:!1,renderItemContentEnd:a=>a.supportsUpload?h("calcite-icon",{class:oe.templateItemContentEnd,icon:"upload-to",key:"upload-icon"}):null,renderItemLabel:a=>a.label,renderCustomGroupContent:a=>this._renderCustomTemplateGroupContent(a)}),this._filterText="",this._prompt=null,this._spinner=new La,this.headingLevel=4,this.messages=null,this.messagesCommon=null,this.messagesTemplates=null,this.supportingWidgetDefaults=null,this.viewModel=new Ri,this.visibleElements=new Qt,this._renderSelectIcon=()=>h("calcite-icon",{icon:"cursor",slot:"content-start"}),this.EditorPanel=({heading:a,key:i},...s)=>{const{visibleElements:r}=this;return h("calcite-flow-item",{closable:!1,heading:a,headingLevel:this.headingLevel,key:i,loading:this._loading,onCalciteFlowItemBack:this._onBack},r.settingsMenu?h(as,{editorViewModel:this.viewModel,messagesCommon:this.messagesCommon,visibleElements:r}):null,...s)},this._showDiscardEditsPrompt=()=>{var s;const{messages:a,activeWorkflow:i}=this;return(i==null?void 0:i.type)==="create-features"&&ye(i.data.creationInfo)?this._showPromptAndWait(((s=i.data.upload)==null?void 0:s.state)==="success"?a.modelUploads.cancelPlacementPrompt:a.modelUploads.cancelUploadPrompt):this._showPromptAndWait({title:a.cancelEditTitle,message:a.cancelEditWarningMessage,yesLabel:a.discardEdits,noLabel:a.continueEditing})},this._showGenericCancelPrompt=()=>{const{messages:a,messagesCommon:i}=this;return this._showPromptAndWait({title:a.cancelRequestTitle,message:a.cancelRequestWarningMessage,yesLabel:i.form.yes,noLabel:i.form.no})},this._showPrompt=a=>{var i,s;(s=(i=this._prompt)==null?void 0:i.cancel)==null||s.call(i),this._prompt=a},this._clearPrompt=()=>{this._prompt=null},this._onSave=()=>{this.viewModel.saveWorkflow()},this._onDelete=()=>{const{messages:a,messagesCommon:i}=this;this._showPrompt({title:a.deleteWarningTitle,message:a.deleteWarningMessage,context:"danger",actions:{primary:{label:i.delete,action:()=>{this.deleteFeatureFromWorkflow(),this._clearPrompt()}},secondary:{label:a.keepFeature,action:this._clearPrompt}}})},this._onToggleUpdateWorkflow=()=>this.viewModel.toggleUpdateWorkflow(),this._onBack=a=>(a==null||a.stopPropagation(),this.viewModel.back()),this._onAttachmentAdd=()=>{var i;const{activeWorkflow:a}=this.viewModel;a&&(a.type==="create-features"||a.type==="update"&&((i=a.activeWorkflow)==null?void 0:i.type)==="create-features"?(this._attachments.addFile(),a.back()):this._attachments.addAttachment().then(()=>a.back()))},this._onAttachmentUpdate=()=>{const{activeWorkflow:a}=this.viewModel;a&&(a.type==="create-features"?(this._attachments.updateFile(),a.back()):this._attachments.updateAttachment().then(()=>a.back()))},this._onAttachmentDelete=()=>{const{messages:a,messagesCommon:i}=this;this._showPrompt({title:a.deleteAttachmentWarningTitle,message:a.deleteAttachmentWarningMessage,context:"danger",actions:{primary:{label:i.delete,action:this._onAttachmentDeleteConfirm},secondary:{label:a.keepAttachment,action:this._clearPrompt}}})},this._onAttachmentDeleteConfirm=async()=>{const a=this._attachments,{activeWorkflow:i}=this.viewModel;i&&(i.type==="create-features"?a.deleteFile():(await a.deleteAttachment(a.viewModel.activeAttachmentInfo),this._clearPrompt()),await i.back(),this._clearPrompt())},this._onAttachmentsError=a=>{this._showPrompt({title:this.messages.errorWarningTitle,message:a.message,context:"warning",actions:{primary:{label:this.messagesCommon.form.ok,action:this._clearPrompt}}})}}initialize(){this._featureForm.showPrompt=this._showPrompt,this._featureForm.clearPrompt=this._clearPrompt,this.addHandles([F(()=>Ce(this.headingLevel),e=>{this._featureForm.headingLevel=e,this._featureTemplates.headingLevel=e},ae),J(()=>this.viewModel.activeWorkflow,"cancel-request",({controller:e})=>{(this.viewModel.hasPendingEdits?this._showDiscardEditsPrompt():this._showGenericCancelPrompt()).then(t=>t?e.allow():e.deny())}),ge(()=>this.viewModel.featureFormViewModel,e=>{this._featureForm.viewModel=e},ae),F(()=>this.viewModel,e=>{this._attachments.viewModel=(e==null?void 0:e.attachmentsViewModel)??null,this._featureTemplates.viewModel=(e==null?void 0:e.featureTemplatesViewModel)??null,this._spinner.viewModel=(e==null?void 0:e.spinnerViewModel)??null,e.showDiscardEditsPrompt=this._showDiscardEditsPrompt},ae),F(()=>this.view,(e,t)=>{const a=`editor-${this.id}-spinner`;t==null||t.ui.remove(this._spinner,a),e==null||e.ui.add(this._spinner,{key:a,position:"manual"})},ae),F(()=>[this.supportingWidgetDefaults,this.viewModel.sketchViewModel],([e])=>{var t;e&&(this._featureForm.set(e.featureForm),this._attachments.set(e.attachments),this._featureTemplates.set(e.featureTemplates),(t=this.viewModel.sketchViewModel)==null||t.set(e.sketch))},ae),ge(()=>{var e;return(e=this._attachments)==null?void 0:e.error},e=>this._onAttachmentsError(e)),ge(()=>{var e;return(e=this.viewModel)==null?void 0:e.failures},e=>{const{messages:t}=this,[{error:a,retry:i,cancel:s}]=e;this._showPrompt({title:t.errorWarningTitle,message:Se(t.errorWarningMessageTemplate,{errorMessage:a.message}),context:"warning",actions:{primary:{label:t.retry,action:()=>{i(),this._clearPrompt()}},secondary:{label:t.ignore,action:()=>{s(),this._clearPrompt()}}}})}),F(()=>{var e;return(e=this.viewModel)==null?void 0:e.state},e=>{switch(e){case"awaiting-feature-to-update":case"ready":case"disabled":this._filterText="",this._featureTemplates.filterText=""}}),F(()=>this.viewModel.featureFormDisabled,e=>this._featureForm.disabled=e)])}destroy(){this._attachments.destroy(),this._featureForm.destroy(),this._featureTemplates.destroy()}loadDependencies(){return Promise.all([se({"flow-item":()=>V(()=>import("./calcite-flow-item-C1dz4xH2.js"),__vite__mapDeps([33,10,1,2,11,13,21,24,12,14,15,16,34,35,36,37,23,25,17,38,39,40,41,28,42,43,9])),flow:()=>V(()=>import("./calcite-flow-DRMo8BV0.js"),__vite__mapDeps([44,10,1,2,11,15,24])),icon:()=>V(()=>import("./calcite-icon-W-AdNGRC.js"),__vite__mapDeps([31,25,10,1,2,11,13,15])),list:()=>V(()=>import("./calcite-list-Dnyd1Dz_.js"),__vite__mapDeps([45,10,1,2,11,13,21,15,46,47,24,16,12,14,48,40,25,49,20,22,23,50,51,52,53,17,9]))}),zi(),Bi(),ht(),Jt(),ke(),ts(),$a(),is(),ss()])}get _deleteButtonCommonInfo(){return{appearance:"outline",kind:"danger"}}get _loading(){const{viewModel:e}=this;return e.syncing||e.updating||this._attachments.submitting}get activeWorkflow(){return this.viewModel.activeWorkflow}get allowedWorkflows(){return this.viewModel.allowedWorkflows}set allowedWorkflows(e){Ge(z.getLogger(this),"allowedWorkflows",{replacement:"visibleElements",version:"4.29",warnOnce:!0}),this.viewModel.allowedWorkflows=e}get hideTemplatesForInactiveLayers(){return this.viewModel.hideTemplatesForInactiveLayers}set hideTemplatesForInactiveLayers(e){this.viewModel.hideTemplatesForInactiveLayers=e}get icon(){return"pencil"}set icon(e){this._overrideIfSome("icon",e)}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get labelOptions(){return this.viewModel.labelOptions}set labelOptions(e){this.viewModel.labelOptions=e}get layerInfos(){return this.viewModel.layerInfos}set layerInfos(e){this.viewModel.layerInfos=e}get snappingOptions(){return this.viewModel.snappingOptions}set snappingOptions(e){this.viewModel.snappingOptions=e}get tooltipOptions(){return this.viewModel.tooltipOptions}set tooltipOptions(e){this.viewModel.tooltipOptions=e}get valueOptions(){return this.viewModel.valueOptions}set valueOptions(e){this.viewModel.valueOptions=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.viewModel.startCreateFeaturesWorkflowAtFeatureTypeSelection()}startCreateFeaturesWorkflowAtFeatureCreation(e){return this.viewModel.startCreateFeaturesWorkflowAtFeatureCreation(e)}startCreateFeaturesWorkflowAtFeatureEdit(e){return this.viewModel.startCreateFeaturesWorkflowAtFeatureEdit(e)}startUpdateWorkflowAtFeatureSelection(){return this.viewModel.startUpdateWorkflowAtFeatureSelection()}startUpdateWorkflowAtMultipleFeatureSelection(e){return this.viewModel.startUpdateWorkflowAtMultipleFeatureSelection(e)}startUpdateWorkflowAtFeatureEdit(e){return this.viewModel.startUpdateWorkflowAtFeatureEdit(e)}deleteFeatureFromWorkflow(){return this.viewModel.deleteFeatureFromWorkflow()}cancelWorkflow(e){return this.viewModel.cancelWorkflow(e)}render(){const{viewModel:e}=this,t=this.classes(oe.base,_t.widget,_t.panel);return e?h("div",{class:t,key:"base"},h("calcite-flow",{key:"flow"},e.pageStack.map(a=>this._renderPage(a))),this._prompt?h(Wa,{...this._prompt,headingLevel:this.headingLevel}):void 0):h("div",{class:t,key:"empty"})}_renderPage(e){switch(e){case"disabled":break;case"ready":return this._renderReady();case"awaiting-feature-creation-info":return this._renderAwaitingFeatureCreationInfo();case"creating-features-upload-details":return this._renderUploadDetails();case"creating-features":return this._renderCreatingFeatures();case"editing-existing-feature":case"editing-attributes":return this._renderUpdateFeature();case"awaiting-update-feature-candidate":return this._renderFeatureList();case"adding-attachment":return this._renderAttachmentAdding();case"editing-attachment":return this._renderAttachmentEditing()}return h("div",{key:"empty-page"})}_renderAwaitingFeatureCreationInfo(){const{EditorPanel:e,messages:t}=this;return h(e,{heading:t.selectTemplate,key:"templates-panel"},h(Y,{key:"feature-templates"},h(ue,null,this._featureTemplates.render())))}_renderUploadDetails(){const{EditorPanel:e,activeWorkflow:t,messages:a}=this;if((t==null?void 0:t.type)!=="create-features")return null;const i=t.data.upload;return i?h(e,{heading:a.createFeatures,key:"upload-details-panel"},h(rs,{helpMessage:this._helpMessage,messages:a,upload:i})):null}_renderCreatingFeatures(){var d,c;const{EditorPanel:e,activeWorkflow:t,messages:a,messagesCommon:i,headingLevel:s,viewModel:r}=this;if(!t)return null;const n=t.type==="create-features"&&t.numPendingFeatures>0||t.type==="update"&&((d=t==null?void 0:t.activeWorkflow)==null?void 0:d.type)==="create-features"&&((c=t.activeWorkflow)==null?void 0:c.numPendingFeatures)>0;return h(e,{heading:a.createFeatures,key:"create-features-panel"},n?h(It,{editorViewModel:r,headingLevel:s,messages:a,messagesCommon:i,renderAttachments:()=>this._attachments.render(),renderFeatureForm:()=>this._featureForm.render(),onDelete:this._onDelete,onSave:this._onSave}):h(Ni,{helpMessage:this._helpMessage}))}_renderUpdateFeature(){const{EditorPanel:e,messages:t,messagesCommon:a,headingLevel:i,viewModel:s}=this;return h(e,{heading:t.editFeature,key:"update-feature-panel"},h(It,{editorViewModel:s,headingLevel:i,messages:t,messagesCommon:a,renderAttachments:()=>this._attachments.render(),renderFeatureForm:()=>this._featureForm.render(),onDelete:this._onDelete,onSave:this._onSave}))}_renderCustomTemplateGroupContent(e){const{messages:t,viewModel:a}=this,i=Fa(e.group.items,s=>a.itemHasInvalidFormTemplate(s)?t.formFieldCreateError:void 0);return i?h(at,{icon:Vt,message:i}):null}_renderAttachmentAdding(){const{EditorPanel:e,_attachments:t,messages:a,messagesCommon:i}=this;return h(e,{heading:a.addAttachment,key:"attachment-adding-panel"},h(Y,{key:"attachments"},t.render()),h(Ve,{buttons:[{label:t.submitting?i.cancel:i.add,disabled:t.submitting||!t.selectedFile,onClick:this._onAttachmentAdd}]}))}_renderAttachmentEditing(){const{EditorPanel:e,_attachments:t,activeWorkflow:a,messages:i,messagesCommon:s}=this;return a?h(e,{heading:i.editAttachment,key:"attachment-editing-panel"},h(Y,{key:"attachments"},t.render()),a.shouldAllowAttachmentEditing?h(Ve,{buttons:[{label:s.update,disabled:t.submitting||!t.selectedFile,onClick:this._onAttachmentUpdate},{...this._deleteButtonCommonInfo,onClick:this._onAttachmentDelete,disabled:t.submitting,label:s.delete}]}):void 0):null}_renderReady(){const{EditorPanel:e,messages:t,viewModel:a,visibleElements:i}=this,s=this._helpMessage;return h(e,{heading:t.widgetLabel,key:"landing-panel"},h(Y,{key:"landing-content"},a.editorItems.length?[i.editFeaturesSection?h(ue,{key:"edit-actions"},this._renderUpdateActions()):null,i.createFeaturesSection&&a.canCreateVisible?h(ue,{key:"create-actions"},this._renderCreateActions()):null]:h(ut,{key:"no-content"},t.noEditableLayers)),s?h("div",{class:oe.helpMessage,key:"footer-actions",slot:"footer"},s):void 0)}get _helpMessage(){var s;const{activeWorkflow:e,messages:t,view:a}=this,i=e==null?void 0:e.helpMessage;return i?(s=t[(a==null?void 0:a.type)==="3d"?"helpMessages3d":"helpMessages2d"])==null?void 0:s[i]:void 0}_renderUpdateActions(){var s;const{messages:e,messagesCommon:t,viewModel:a}=this,i={id:"select",label:t.select};return h("div",{class:oe.updateActions,key:"update-actions"},h(je,{level:Ce(this.headingLevel)},e.editFeatures),h("calcite-list",{class:oe.updateActionsList,selectionAppearance:"border",selectionMode:"single"},Ta({disabled:!a.canUpdateVisible,grouped:!1,item:i,selectedItem:((s=a.activeWorkflow)==null?void 0:s.stepId)==="awaiting-feature-to-update"?i:void 0,renderIcon:this._renderSelectIcon,onItemSelect:this._onToggleUpdateWorkflow})))}_renderCreateActions(){return h("div",{key:"create-actions"},h(je,{level:Ce(this.headingLevel)},this.messages.createFeatures),h("div",{class:oe.featureTemplatesContainer,key:"templates"},this._featureTemplates.render()))}_renderFeatureList(){const{EditorPanel:e,viewModel:t}=this,{activeWorkflow:a}=t;if((a==null?void 0:a.type)!=="update")return null;const i=a.data.candidates,s=Se(this.messages.multipleFeaturesTemplate,{total:i.length});return h(e,{heading:s,key:"feature-list"},h(qi,{editorItems:t.editorItems,filterText:this._filterText,id:this.id,messagesTemplates:this.messagesTemplates,workflow:a,onFilterTextChange:r=>this._filterText=r,onSelectFeature:(r,n)=>t.selectFeature(r,n)}))}_showPromptAndWait({title:e,message:t,yesLabel:a,noLabel:i}){const s=st(),{view:r}=this,n=r==null?void 0:r.focused;return this._showPrompt({title:e,message:t,context:"danger",actions:{primary:{label:a,action:()=>s.resolve(!0)},secondary:{label:i,action:()=>s.resolve(!1)}}}),s.promise.finally(()=>{this._clearPrompt(),n&&(r==null||r.focus())})}};o([l()],k.prototype,"_featureForm",void 0),o([l()],k.prototype,"_attachments",void 0),o([l()],k.prototype,"_featureTemplates",void 0),o([l()],k.prototype,"_filterText",void 0),o([l()],k.prototype,"_prompt",void 0),o([l()],k.prototype,"_spinner",void 0),o([l()],k.prototype,"_deleteButtonCommonInfo",null),o([l()],k.prototype,"_loading",null),o([l({readOnly:!0})],k.prototype,"activeWorkflow",null),o([l()],k.prototype,"allowedWorkflows",null),o([l()],k.prototype,"headingLevel",void 0),o([l()],k.prototype,"hideTemplatesForInactiveLayers",null),o([l()],k.prototype,"icon",null),o([l()],k.prototype,"label",null),o([l()],k.prototype,"labelOptions",null),o([l()],k.prototype,"layerInfos",null),o([l(),xe("esri/widgets/Editor/t9n/Editor")],k.prototype,"messages",void 0),o([l(),xe("esri/t9n/common")],k.prototype,"messagesCommon",void 0),o([l(),xe("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],k.prototype,"messagesTemplates",void 0),o([l()],k.prototype,"snappingOptions",null),o([l()],k.prototype,"tooltipOptions",null),o([l()],k.prototype,"supportingWidgetDefaults",void 0),o([l({type:Ia,nonNullable:!0})],k.prototype,"valueOptions",null),o([l()],k.prototype,"view",null),o([l(),si(["sketch-create","sketch-delete","sketch-update","workflow-cancel","workflow-commit"])],k.prototype,"viewModel",void 0),o([l({type:Qt,nonNullable:!0})],k.prototype,"visibleElements",void 0),o([l()],k.prototype,"_helpMessage",null),k=o([O("esri.widgets.Editor")],k);const ko=k;export{ko as default};
