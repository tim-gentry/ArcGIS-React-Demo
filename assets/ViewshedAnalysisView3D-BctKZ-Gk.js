import{d0 as le,bp as c,dk as J,d_ as fe,cC as G,ac as n,ad as p,ag as k,bh as W,bY as w,mZ as ct,fa as C,dI as M,dR as Z,bC as Q,d3 as N,gd as D,d1 as Se,bq as K,d6 as R,ec as Ve,dj as ut,bv as it,d5 as H,bX as b,m_ as He,i0 as mt,aI as ae,d2 as P,fN as vt,dw as _t,fT as wt,el as ft,fU as Vt,j6 as pe,eH as st,m$ as ne,n0 as ge,kX as rt,lI as be,eP as Ee,bw as ye,bn as gt,n1 as B,dO as ze,dm as xe,dN as X,b6 as bt,db as yt,c$ as Me,b$ as Mt,eE as Le}from"./index-DX0rcHuW.js";import{s as Dt}from"./AnalysisView3D-CE-ePUC9.js";import{e as O}from"./mat4f64-Dk4dwAN8.js";import"./vec2-C-4tM9Uv.js";import"./vec2f64-Diu2Kaa8.js";import{distance as ke}from"./geometryEngine-C92iiwvG.js";import{E as Ot,j as $t,J as Ct}from"./plane-BL9J6YX0.js";import{O as Tt,b as St,a as L,e as Re,f as Ht}from"./RenderObject-DkCzcdYd.js";import{O as Et,k as Rt}from"./dragEventPipeline3D-RNpaSYaQ.js";import{f as F}from"./LineVisualElement-MvRjXGhW.js";import{h as he}from"./Material-BfvzXcva.js";import{h as At}from"./lineStippleUtils-Cu2kwDBg.js";import{a as De,n as Pt}from"./Cyclical-CEj-eenM.js";import{o as Ft}from"./ViewingMode-Dodu7ZZk.js";import{H as Oe}from"./boundedPlane-MAPkm7Yi.js";import{b as zt,s as te}from"./sliceToolConfig-Dggn55q9.js";import{t as ot,A,u as xt,o as Lt}from"./MoveManipulation-BsIADcwL.js";import{z as kt,g as Ut,A as Ue,w as It,s as jt}from"./RenderGeometry-CQQOC_nW.js";import{s as Nt}from"./Util-HYkJg9Vp.js";import{p as oe,M as Bt,h as de,f as Gt}from"./InteractiveToolBase-DBqJNRIA.js";import{t as j}from"./interfaces-D6pIddIh.js";import{v as Kt}from"./sphere-COyqsaGw.js";import{e as Wt}from"./basicInterfaces-wONHx_SN.js";import{d as qt}from"./ColorMaterial.glsl-CcrBVOmk.js";import{j as Jt}from"./settings-gcMFavfO.js";import{G as Xt}from"./ExtendedLineVisualElement-BOr1bkvb.js";import{c as Yt}from"./Laserlines.glsl-DcZ83Cyr.js";import{E as Zt}from"./EditGeometryOperations-BmjyQqm3.js";import{o as Qt}from"./ShadedColorMaterial.glsl-DyqRY4bT.js";import{p as Ie}from"./keybindings-RFI4I3n4.js";import{t as ei}from"./ToolIntersector-B0Bzxzjy.js";import{c as ti}from"./screenUtils-BcEL8jIe.js";import{C as ii}from"./Viewshed.glsl-BfaJltDE.js";import{a as si,v as ri,l as oi}from"./analysisViewUtils-yNuHBTif.js";import"./geometryEngineBase-RmbNeFm7.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./hydrated-CEL7VY_R.js";import"./mat3f64-BBpwCtoL.js";import"./quatf64-BrpT0VRp.js";import"./mathUtils-BsqbT0oM.js";import"./mat3-Ck4GO2qT.js";import"./computeTranslationToOriginAndRotation-B9BchKSd.js";import"./lineSegment-C2OVzbAD.js";import"./hydratedFeatures-DcIGyuBL.js";import"./projectVectorToVector-DjKO2tJh.js";import"./projectPointToVector-6lqiVL77.js";import"./elevationInfoUtils-JmMUMmCn.js";import"./ElevationProvider-Xg9LKEp7.js";import"./verticalOffsetUtils-Bq_pVrum.js";import"./orientedBoundingBox-BTwqkknQ.js";import"./quat-DrJsq_-D.js";import"./spatialReferenceEllipsoidUtils-Bv0mQCFg.js";import"./ray-BtGY6UNr.js";import"./BufferView-XrMc2vJu.js";import"./InterleavedLayout-ZKuAjCiK.js";import"./types-D0PSWh4d.js";import"./Matrix4PassUniform-CTNrzJ6Q.js";import"./interfaces-B8ge7Jg9.js";import"./BindType-BmZEZMMh.js";import"./VertexAttribute-BnAa5VW0.js";import"./Texture-0jciB86n.js";import"./enums-BlUEVwJR.js";import"./Texture-BF0Xf23l.js";import"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import"./doublePrecisionUtils-B0owpBza.js";import"./Indices-BZu2O98k.js";import"./triangle-CGr49R4x.js";import"./renderState-yUi34s5A.js";import"./requestImageUtils-Cd7mPI4y.js";import"./VertexColor.glsl-BX9otDj2.js";import"./Object3DVisualElement-CUM8kkkv.js";import"./VisualElement-B9pa0AX0.js";import"./DoubleArray-tnpOy9RK.js";import"./triangulationUtils-BSy4A0L9.js";import"./earcut-BqgeR2O3.js";import"./deduplicate-CREmZpKM.js";import"./vec3f32-Cw9Q6TO_.js";import"./frustum-Tc8kkw3_.js";import"./axisAngleDegrees-jEN9n05M.js";import"./weather-CSMUgeU9.js";import"./Scheduler-Bg_fxWwI.js";import"./signal-CpmfLcHB.js";import"./debugFlags-Cr0sx6r_.js";import"./Float4DrawUniform-X0Lc1Ix0.js";import"./NestedMap-DgiGbX8E.js";import"./Octree-lrGXb_0y.js";import"./floatRGBA-DZ6CgOhi.js";import"./Intersector-CG5xfiNM.js";import"./glUtil-C6KhMg1m.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./VertexArrayObject-9V6uZ6_q.js";import"./BufferObject-CWTeBz1x.js";import"./meshVertexSpaceUtils-UWZ_3JBG.js";import"./MeshLocalVertexSpace-Ck1lhGhd.js";import"./vec4f32-CjrfB-0a.js";import"./EngineVisualElement-DinfBZ8X.js";import"./geometry2dUtils-D5ud2BJg.js";import"./InputManager-abOXR3ru.js";import"./Viewpoint-sw4jiA6m.js";import"./jsxFactory-DmHi7Kb2.js";import"./uuid-fwrPAdZb.js";import"./GraphicsCollection-BjA_qBYu.js";import"./HeightModelInfo-DaJXTLDg.js";import"./WaterSurface.glsl-CB7boCuS.js";import"./vec2f32-BbH2jxlN.js";import"./dehydratedFeatures-DvwHN5Vy.js";import"./featureConversionUtils-C8uvc1AG.js";import"./OptimizedFeature-7juV2tZm.js";import"./OptimizedGeometry-vU5jWBvU.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./edgeUtils-CckHLSHv.js";import"./DecodeSymbolColor.glsl-CpAWHGzb.js";import"./vec3-DxxvdsHs.js";import"./SnappingCandidate-O5eRSE6e.js";import"./Normals-ClOhen2_.js";import"./objectResourceUtils-dMevf21j.js";import"./devEnvironmentUtils-D6qIi8Ky.js";import"./vec4-B2fX0VJI.js";import"./DefaultMaterial_COLOR_GAMMA-vDn2TTUE.js";import"./resourceUtils-Cv8EFCAN.js";import"./CIMSymbolHelper-DvNaY2BT.js";import"./BidiEngine-BwB1Df7c.js";import"./fontUtils-BN21lj56.js";import"./GeometryUtils-CGNDP0vy.js";import"./enums-BRXbslMp.js";import"./definitions-ByNBSgP9.js";import"./mat2d-CXMJJ9G6.js";import"./mat2df32-orApM5a3.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BhuXqU4L.js";import"./cimSymbolUtils-DzDRYI6s.js";import"./utils-BbU12Hvz.js";import"./projectVectorToPoint-jxEu1YJy.js";import"./MeshComponent-CcZOTV9N.js";import"./imageUtils-BsB3EL45.js";import"./MeshVertexAttributes-DiX-RN8y.js";import"./projection-BJFZt5ZW.js";import"./DefaultLayouts-LbPHMYzg.js";import"./webStyleSymbolUtils-CT_ZIx-N.js";import"./Intersector-ENyKy7_L.js";import"./RenderCoordsHelper-D33jtR9v.js";import"./scaleUtils-ClqQrarK.js";import"./DefaultUI-BM5o-ZLH.js";import"./UpdatingHandles-CERUeL1P.js";import"./Map-BcseqEdU.js";import"./Basemap-CjElSnyL.js";import"./loadAll-8MiqgLTH.js";import"./writeUtils-RiCb1SCd.js";import"./Ground-dhRLerDt.js";import"./CollectionFlattener-Be8YW6oV.js";import"./editableLayers-DuIVmwOk.js";import"./catalogUtils-B2PovfNH.js";import"./basemapUtils-rjdIOXhY.js";import"./TablesMixin-CcZZ6esO.js";import"./ReactiveMap-r-vujrh9.js";import"./selectionUtils-DYi6daQO.js";import"./IViewEvents-Bci6PjlS.js";import"./a11yUtils-BcOnuh2m.js";import"./heightModelInfoUtils-CTi_JiJC.js";import"./arcgisLayerUrl-BpJodxxk.js";import"./capabilities-C84AMSCg.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-CZa70j6i.js";import"./accessibleHandler-CjDcv_he.js";import"./Compass-S4M9NML1.js";import"./utils-DsJqvptN.js";import"./GoTo-Bv8U0vYJ.js";import"./NavigationToggle-Da_EVApx.js";import"./Zoom-OTCbJYcz.js";import"./viewpointUtils-CNGyoIgw.js";import"./earthUtils-GWU8KixL.js";import"./spatialReferenceSupport-Bk67zMEK.js";import"./ElevationSamplerData-CFwzCheb.js";import"./terrainUtils-BQLPw4Jq.js";import"./TileInfo-DuivnO5H.js";import"./TileKey-DZd6gJy7.js";import"./Environment-Bpau6Ty8.js";import"./quantityUtils-DSpmykXR.js";import"./Program-BnQQlkGO.js";import"./ShadowCastVisualizeTechniqueConfiguration-Dah3u-G-.js";import"./euclideanLengthMeasurementUtils-CuSkQONc.js";import"./ZoomMomentumEstimator-pQkiU-PR.js";import"./labelFormatUtils-DjuAeSua.js";import"./FeatureTileDescriptor3D-CvT50Jkf.js";import"./ElevationQueryTileCache-ByGSevWc.js";import"./LayerConstants-B33OP6sh.js";import"./ElevationRange-BrgM1moX.js";import"./geometryServiceUtils-zF1xOQ4Y.js";import"./project-BQyPiext.js";import"./utils-nzDIu46v.js";import"./utils-D67OULxu.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./RenderableTile-CE6botJN.js";import"./enums-BRzLM11V.js";import"./TileStrategy-CcsveE-I.js";import"./TileKey-m4M152GY.js";import"./QueueProcessor-01Ee2ByR.js";import"./config-MDUrh2eL.js";import"./DefaultVertexAttributeLayouts-_lUGuBk_.js";import"./DisplayObject-I7xo9JVP.js";import"./StyleDefinition-BK3ROBTO.js";import"./resources-Bv-4dVJF.js";import"./edgeProcessing-BO3TMEUB.js";import"./testSVGPremultipliedAlpha-eKesxQ43.js";import"./RenderingContext-DNkBZ-bu.js";import"./ProgramCache-DLTjjJNh.js";import"./layerViewUtils-D2JqIDZ8.js";function at({tiltedUpVector:t,rightVector:e,observerRenderSpace:i},s){const r=Tt(t,e,i,s);return r[12]=0,r[13]=0,r[14]=0,r}function $e(t,e,i){const s=c(),r=le(c(),i.basis1,i.basis2);return t.next(Et(e,i.plane)).next(o=>{o.action==="start"&&J(s,o.renderStart);const a=fe(St(s,o.renderEnd,i.origin,r));return{...o,deltaAngle:a}})}function nt(t,e){if(t==null)return 0;const{observer:i,target:s}=t,r=e.camera.position,o=ke(r,i)>ke(r,s)?i:s;return e.pixelSizeAt(o)}const ai=2,je=new G([85,85,85,.5]);let E=class extends W{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:c(),topRight:c(),bottomLeft:c(),bottomRight:c(),center:c()},this._arcCenterPoints={top:c(),bottom:c(),left:c(),right:c()},this._parallelCenters={top:c(),bottom:c()}}initialize(){const e={view:this.view,isDecoration:!0,color:this._color,renderOccluded:he.OccludeAndTransparent},i={...e,width:ai,stipplePattern:At(2)};this._boundaryLinesVisualElement=new F(e),this._leftArcVisualElement=new F(e),this._rightArcVisualElement=new F(e),this._topArcVisualElement=new F(e),this._bottomArcVisualElement=new F(e),this._centralLongitude=new F(i),this._centralLatitude=new F(i),this.addHandles([w(()=>{const s=this.viewshedComputedData;if(!(s!=null&&s.isValid()))return null;const r=this._offsetScale,o=this._viewshedCorners,a=this._arcCenterPoints,l=this._parallelCenters;return s.cornerPoints(r,o),s.arcCentersPoints(r,a),s.parallelCenterPoints(l),{viewshedComputedData:s,corners:o,arcCenters:a,parallelCenters:l}},s=>{s!=null?(this._forEachVisualElement(r=>r.attached=!0),this._updateVisualElements(s)):this._forEachVisualElement(r=>r.attached=!1)},{initial:!0,equals:ct}),w(()=>{var s;return{visible:this.visible,horFOV:(s=this.viewshedComputedData)==null?void 0:s.horizontalFieldOfView}},({visible:s,horFOV:r},o)=>{s!==(o==null?void 0:o.visible)&&this._forEachVisualElement(a=>a.visible=s),s&&r!==(o==null?void 0:o.horFOV)&&(this._boundaryLinesVisualElement.visible=r!==360)},C),w(()=>this._color,s=>this._forEachVisualElement(r=>r.color=s),C)])}get _color(){var l,d;const e=this.viewshedComputedData;if(e==null)return G.toUnitRGBA(je);const i=this.analysisViewData,s=((l=i.tool)==null?void 0:l.active)||i.interactive,r=e===i.selectedViewshedComputedData,o=e.viewshed===((d=i.tool)==null?void 0:d.stagedViewshed),a=s&&(r||o)?this.view.effectiveTheme.accentColor:je;return G.toUnitRGBA(a)}get _offsetScale(){return nt(this.viewshedComputedData,this.view)}destroy(){this._boundaryLinesVisualElement=M(this._boundaryLinesVisualElement),this._leftArcVisualElement=M(this._leftArcVisualElement),this._rightArcVisualElement=M(this._rightArcVisualElement),this._topArcVisualElement=M(this._topArcVisualElement),this._bottomArcVisualElement=M(this._bottomArcVisualElement),this._centralLongitude=M(this._centralLongitude),this._centralLatitude=M(this._centralLatitude)}_forEachVisualElement(e){[this._boundaryLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_updateVisualElements(e){const{viewshedComputedData:i,corners:s,arcCenters:r,parallelCenters:o}=e;this._updateBoundaryLines(s),this._updateBoundaryArcs(i,s,o),this._updateCentralHelperArcs(i,r)}_updateBoundaryLines(e){this._boundaryLinesVisualElement.geometry=[[e.center,e.topLeft],[e.center,e.topRight],[e.center,e.bottomLeft],[e.center,e.bottomRight]]}_updateBoundaryArcs(e,i,s){const{observerRenderSpace:r,rightVector:o,horizontalFieldOfView:a,tiltedUpVector:l}=e,d=b(a),h=c(),u=O();Z(u,d/2,l),Q(h,o,u),U(this._leftArcVisualElement,r,i.bottomLeft,i.topLeft,"forward",h),Z(u,-d/2,l),N(h,0,0,0),Q(h,o,u),U(this._rightArcVisualElement,r,i.bottomRight,i.topRight,"forward",h);const v=a>180?"backward":"forward";U(this._topArcVisualElement,s.top,i.topRight,i.topLeft,v,l),U(this._bottomArcVisualElement,s.bottom,i.bottomRight,i.bottomLeft,v,l)}_updateCentralHelperArcs(e,i){const s=e.observerRenderSpace,r=e.horizontalFieldOfView>=180?"backward":"forward";U(this._centralLatitude,s,i.right,i.left,r,e.tiltedUpVector),U(this._centralLongitude,s,i.top,i.bottom,"forward",e.leftVector)}};function U(t,e,i,s,r,o,a=5){const l=c();D(l,i,e);const d=Se(l),h=c();D(h,s,e),K(h,h),R(h,h,d);let u=Ve(l,h);const v=ut(o);r==="backward"&&(it(v,v),u=-(2*Math.PI-u));const m=[],f=Math.ceil(Math.abs(u)/b(a)),g=O();Z(g,u/f,v);const y=c();J(y,l);const ie=c();J(ie,i);for(let Ae=0;Ae<f;Ae++){const Pe=c();J(Pe,ie),Q(y,y,g),H(ie,e,y);const Fe=c();J(Fe,ie),m.push([Pe,Fe])}t.geometry=m}n([p()],E.prototype,"view",void 0),n([p()],E.prototype,"analysisViewData",void 0),n([p()],E.prototype,"viewshedComputedData",void 0),n([p()],E.prototype,"visible",void 0),n([p()],E.prototype,"_color",null),n([p()],E.prototype,"_offsetScale",null),E=n([k("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],E);const ni=E;let x=class extends W{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,i=He(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:s})=>{const r=new ni({view:this.view,viewshedComputedData:s,analysisViewData:e});return{visualization:r,remove:()=>r.destroy()}});this._viewshedVisualizations=i,this.addHandles([mt(i),w(()=>this.visible,s=>this._viewshedVisualizations.forEach(({visualization:r})=>r.visible=s))])}};n([p({constructOnly:!0})],x.prototype,"analysisViewData",void 0),n([p({constructOnly:!0,nonNullable:!0})],x.prototype,"view",void 0),n([p({constructOnly:!0})],x.prototype,"isDecoration",void 0),n([p()],x.prototype,"visible",null),x=n([k("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],x);var Ce;let _=Ce=class extends W{constructor(t){super(t)}get observer(){return this.viewshed.observer??new ae}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,c())}get target(){const t=this.targetRenderSpace;return this.renderSpaceToPoint(t,this.observer.spatialReference)}get targetRenderSpace(){const{leftVector:t,northVector:e,upVector:i}=this,s=this.observerRenderSpace,r=this.farDistanceRenderSpace,o=c();return R(o,e,r),I(o,-b(this.heading),i,o),I(o,-b(this.tiltParallelToSurface),t,o),H(o,s,o),o}get targetDirection(){const t=D(c(),this.targetRenderSpace,this.observerRenderSpace);return K(t,t)}get tiltedUpVector(){const t=I(this.upVector,-b(this.tiltParallelToSurface),this.leftVector,c());return K(t,t)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,O())}get upVector(){const t=this._basis;return P(t[8],t[9],t[10])}get northVector(){const t=this._basis;return P(t[4],t[5],t[6])}get leftVector(){const t=this.upVector,e=I(this.northVector,-b(this.heading),t,c());return le(e,t,e)}get rightVector(){return it(c(),this.leftVector)}clone(){return new Ce({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(t,e,i){const{observerRenderSpace:s,targetRenderSpace:r}=this,o=D(Y,r,s);return I(o,-b(e),this.leftVector,o),I(o,-b(t),this.tiltedUpVector,o),H(i,o,s)}cornerPoints(t,e){const i=this.observerRenderSpace,s=this.horizontalFieldOfView/2,r=this.verticalFieldOfView/2,o=this.pointOnSphere(-s,r,_i),a=this.pointOnSphere(s,r,wi),l=this.pointOnSphere(-s,-r,fi),d=this.pointOnSphere(s,-r,Vi),h=D(ci,o,i),u=D(ui,a,i),v=D(mi,l,i),m=D(vi,d,i),{horizontalFieldOfView:f}=this,g=hi;Ne(h,u,o,l,i,t,f,e.topLeft,e.bottomLeft,g);const y=di;Ne(m,v,a,d,i,t,f,e.topRight,e.bottomRight,y),R(e.center,H(e.center,y,g),.5)}arcCentersPoints(t,e){const i=this.horizontalFieldOfView/2,s=this.verticalFieldOfView/2,r=this.pointOnSphere(0,s,e.top),o=this.pointOnSphere(0,-s,e.bottom),a=this.pointOnSphere(-i,0,e.left),l=this.pointOnSphere(i,0,e.right),{observerRenderSpace:d}=this;se(r,d,t),se(o,d,t),se(a,d,t),se(l,d,t)}parallelCenterPoints(t){const e=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin(b(this.verticalFieldOfView/2)),s=R(Y,this.tiltedUpVector,i);H(t.top,e,s),D(t.bottom,e,s)}renderSpaceToPoint(t,e){const i=Y;return this.renderCoordsHelper.fromRenderCoords(t,i,e),new ae(i[0],i[1],i[2],e)}_pointToRenderSpace(t,e){const i=vt(t.toArray());return this.renderCoordsHelper.toRenderCoords(i,t.spatialReference,e),e}};function Ne(t,e,i,s,r,o,a,l,d,h){const u=li(t,e,o,pi);H(h,r,u),Be(i,t,u,o,a,l),Be(s,t,u,o,a,d)}function I(t,e,i,s){return Z(Ge,e,i),Q(s,t,Ge)}function li(t,e,i,s){const r=le(s,t,e);return K(r,r),R(r,r,i),r}function Be(t,e,i,s,r,o){const a=K(Y,e);return R(a,a,s),H(o,t,a),r!==0&&r!==360&&H(o,o,i),o}function se(t,e,i){const s=D(Y,t,e);K(s,s),R(s,s,i),H(t,t,s)}n([p()],_.prototype,"renderCoordsHelper",void 0),n([p()],_.prototype,"viewshed",void 0),n([p()],_.prototype,"observer",null),n([p()],_.prototype,"farDistance",null),n([p()],_.prototype,"farDistanceRenderSpace",null),n([p()],_.prototype,"heading",null),n([p()],_.prototype,"tilt",null),n([p()],_.prototype,"tiltParallelToSurface",null),n([p()],_.prototype,"horizontalFieldOfView",null),n([p()],_.prototype,"verticalFieldOfView",null),n([p()],_.prototype,"observerRenderSpace",null),n([p()],_.prototype,"target",null),n([p()],_.prototype,"targetRenderSpace",null),n([p()],_.prototype,"targetDirection",null),n([p()],_.prototype,"tiltedUpVector",null),n([p()],_.prototype,"_basis",null),n([p()],_.prototype,"upVector",null),n([p()],_.prototype,"northVector",null),n([p()],_.prototype,"leftVector",null),n([p()],_.prototype,"rightVector",null),n([p()],_.prototype,"isValid",null),n([p()],_.prototype,"metersPerUnit",null),_=Ce=n([k("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],_);const Y=c(),pi=c(),hi=c(),di=c(),ci=c(),ui=c(),mi=c(),vi=c(),_i=c(),wi=c(),fi=c(),Vi=c(),Ge=O();let S=class extends _t(W){constructor(e){super(e),this.observer=null,this.farDistance=1e3,this.heading=0,this.tilt=90,this.horizontalFieldOfView=45,this.verticalFieldOfView=45}isValid(){return this.observer!=null&&this.farDistance>0}equals(e){return wt(this.observer,e.observer)&&this.farDistance===e.farDistance&&this.heading===e.heading&&this.tilt===e.tilt&&this.horizontalFieldOfView===e.horizontalFieldOfView&&this.verticalFieldOfView===e.verticalFieldOfView}};n([p({type:ae})],S.prototype,"observer",void 0),n([p({type:Number,nonNullable:!0,range:{min:0}})],S.prototype,"farDistance",void 0),n([p({type:Number,nonNullable:!0}),ft(t=>De.normalize(Vt(t)))],S.prototype,"heading",void 0),n([p({type:Number,nonNullable:!0,range:{min:0,max:180}})],S.prototype,"tilt",void 0),n([p({type:Number,nonNullable:!0,range:{min:0,max:360}})],S.prototype,"horizontalFieldOfView",void 0),n([p({type:Number,nonNullable:!0,range:{min:0,max:180}})],S.prototype,"verticalFieldOfView",void 0),n([p()],S.prototype,"isValid",null),S=n([k("esri.analysis.Viewshed")],S);const gi=S,lt=zt,bi=te*lt,ce=5,re=.0025,yi=1,Mi=Math.sin(b(2)),Di=te/1.5,Ke=5,ue=1;let Oi=class extends ot{constructor(e){super(),this._handles=new pe,this._interactive=!0,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles=M(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulators=null}get interactive(){return this._interactive}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}createDragPipeline(e,i){const s=Object.values(this._manipulators);return st(s.map(({manipulator:r,side:o})=>oe(r,(a,l,d,h,u)=>{const v=Si(o,i);ee(o)?i.horizontalFieldOfView:i.verticalFieldOfView;const m=l.next(g=>({...g,manipulatorType:A.SCALE,side:o})),f=$e(m,this._view,v);e(a,f,d)})))}updateManipulatorsTransform(e){this._forEachManipulatorInfo(i=>this._updateArcManipulatorTransform(i,e))}updateManipulatorVisuals(e){this._forEachManipulatorInfo(i=>this._updateArcManipulatorVisuals(i,e))}_updateArcManipulatorVisuals({manipulator:e,side:i},s){const r=[];if(s!=null){if(i==="left"&&(s.horizontalFieldOfView<ue||s.horizontalFieldOfView>360-ue)||i==="bottom"&&s.verticalFieldOfView<ue)return e.renderObjects=[],void(e.collisionType={type:"line",paths:[]});const[o,a]=$i(i,s,this._unfocusedArcMaterial);r.push(new L(o,j.Unfocused),new L(o.instantiate({material:this._focusedArcMaterial}),j.Focused)),e.collisionType={type:"line",paths:[a]}}e.renderObjects=r,e.radius=10}_updateArcManipulatorTransform({manipulator:e,side:i},s){const r=s.horizontalFieldOfView,o=b(s.verticalFieldOfView/2),a=b(r/2),l=ee(i);e.location=s.observer;const d=O(),h=y=>{ye(d,y,d)};h(ne(z,b(-90))),l||h(ge(z,o));const u=s.farDistanceRenderSpace;h(rt(z,N(We,u,u,u))),h(be(z,Ti(i))),h(at(s,z));const v=D(We,s.targetRenderSpace,s.observerRenderSpace);let m,f;if(h(Ee(z,v)),l){if(m=a,f=s.tiltedUpVector,r!==0&&r!==360){const y=nt(s,this._view);m+=2*Math.tan(y/(2*s.farDistance))}}else f=s.rightVector,m=o;m*=i==="right"||i==="bottom"?-1:1;const g=Z(z,m,f);g!=null&&h(g),e.modelTransform=d}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator(i=>{i.interactive=!e&&this.interactive||i.grabbing})}_createManipulators(){const e=this._createArcManipulator("left"),i=this._createArcManipulator("right"),s=this._createArcManipulator("top"),r=this._createArcManipulator("bottom");this._manipulators={left:e,right:i,top:s,bottom:r};const o=[[r.manipulator,s.manipulator],[e.manipulator,i.manipulator]];o.push(...o.map(([a,l])=>[l,a])),this._handles.add(o.map(([a,l])=>a.events.on("focus-changed",d=>{const h=d.action==="focus";l.hovering=h})))}_createArcManipulator(e){const i={manipulator:new Re({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),side:e};return this._updateArcManipulatorVisuals(i),i}_createArcMaterial(e){const i=e?bi:lt,s=new kt({renderOccluded:he.OccludeAndTransparent,isDecoration:!0,width:i});return this._handles.add(w(()=>G.toUnitRGBA(this._view.effectiveTheme.accentColor),r=>s.setParameters({color:r}),C)),s}forEachManipulator(e){Object.values(this._manipulators).forEach(({manipulator:i})=>e(i,A.SCALE))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach(i=>e(i))}};function $i(t,e,i){const{horizontalFieldOfView:s,verticalFieldOfView:r}=e,o=ee(t),a=b(gt((o?r:s)/2,0,15)),l=o?1:Math.max(Math.sin(b(90-r/2)),.1),d=pt(-a/2,a/2,l,[-l,0,0]);return[Ut(i,d),d]}function pt(t,e,i,s=[0,0,0],r=10){Nt(r>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const o=e-t,[a,l,d]=s;if(o<=0||i<=0)return[P(a,l,d+.001),P(a,l,l+-.001)];const h=[],u=o/r;for(let v=0;v<r;v++){let m=t+v*u;v===r-1&&(m=e);const f=Math.cos(m)*i,g=Math.sin(m)*i,y=P(f+a,l,g+d);h.push(y)}return h}function Ci(t){switch(t){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function Ti(t){return Ci(t)*Hi}function ee(t){return t==="left"||t==="right"}function Si(t,{observerRenderSpace:e,targetDirection:i,tiltedUpVector:s,rightVector:r}){const o=ee(t)?r:s;return Oe(e,i,o)}const Hi=Math.PI/2,z=O(),We=c();class me extends Re{constructor(e,i,s,r){super({view:e,autoScaleRenderObjects:!1,worldSized:!0,radius:5}),this._handles=new pe,this._setupManipulatorVisual(i,s,r)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e,i,s){const r=this._createMaterial(),o=b(i),a=e?1:Math.sin(o),l=e?pt(0,o,a,[-a,0,0]):[P(0,0,0),P(0,0,a)],d=Ue(r,l,s,16,!1),h=Ue(r,l,s*te,16,!1),u=qe(!1,r,s),v=qe(!0,r,s),m=O();Ee(m,l[l.length-1]),B(m,m,ge(ve,Math.PI/2)),B(m,m,ne(ve,Math.PI/2)),e&&B(m,m,ge(ve,-o)),u.transformation=m,v.transformation=m,this.renderObjects=[new L(d,j.Unfocused),new L(h,j.Focused),new L(u,j.Unfocused),new L(v,j.Focused)];const f=P(0,ht(!0),0),g=Q(f,f,m),y=[...l,g];this.collisionType={type:"line",paths:[y]}}_createMaterial(){const e=new qt({cullFace:Wt.Back,renderOccluded:he.OccludeAndTransparent,isDecoration:!0,writeLinearDepth:!0});return this._handles.add(w(()=>G.toUnitRGBA(this.view.effectiveTheme.accentColor),i=>e.setParameters({color:i}),C)),e}}function qe(t,e,i){const s=ht(t);let r=2*i;t&&(r*=te);const o=s/2;return It(e,s,o,o,r,0)}function ht(t){let e=Mi;return t&&(e*=Di),e}const ve=O();let Ei=class extends ot{constructor(e){super(),this._handles=new pe,this._interactive=!0,this._tool=e.tool,this._view=e.view,this._manipulatorHeading=new me(this._view,!0,ce,re),this._manipulatorTilt=new me(this._view,!0,ce,re),this._manipulatorDistance=new me(this._view,!1,ce,re),this.forEachManipulator(i=>{this._tool.manipulators.add(i),this._handles.add(i.events.on("grab-changed",()=>this._updateManipulatorInteractivity()))})}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}get interactive(){return this._interactive}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}createHeadingDragPipeline(e,i){return oe(this._manipulatorHeading,(s,r,o,a,l)=>{const{_view:d}=this,h=Math.sin(b(i.tiltParallelToSurface))*i.farDistanceRenderSpace,u=H(_e,i.observerRenderSpace,R(Ye,i.upVector,h)),v=le(Ye,i.northVector,i.upVector),m=Oe(u,i.northVector,v),f=$e(r,d,m).next(g=>({...g,manipulatorType:A.ROTATE}));e(s,f,o)})}createTiltDragPipeline(e,i){return oe(this._manipulatorTilt,(s,r,o,a,l)=>{const d=Oe(i.observerRenderSpace,i.targetDirection,i.tiltedUpVector),h=$e(r,this._view,d).next(u=>({...u,manipulatorType:A.ROTATE}));e(s,h,o)})}createDistanceDragPipeline(e,i){return oe(this._manipulatorDistance,(s,r,o,a,l)=>{const d=Kt(i.observerRenderSpace,i.targetDirection),h=r.next(Bt(this._view,s.location)).next(Rt(this._view,d)).next(u=>({...u,manipulatorType:A.SCALE}));e(s,h,o)})}updateManipulators(e){const{target:i}=e;this._manipulatorHeading.location=i,this._manipulatorTilt.location=i,this._manipulatorDistance.location=i;const s=O(),r=u=>{ye(s,u,s)},o=Ri(e);r(rt(q,N(_e,o,o,o))),r(at(e,q));const a=re*te*o,l=R(_e,e.targetDirection,a);r(Ee(q,l));const d=be(q,-we);B(d,d,ne(Xe,-we)),this._manipulatorHeading.modelTransform=B(O(),s,d);const h=ne(q,we);B(h,h,be(Xe,Math.PI)),this._manipulatorTilt.modelTransform=ye(O(),s,h),this._manipulatorDistance.modelTransform=s}_updateManipulatorInteractivity(){const e=!this.grabbing;this.forEachManipulator(i=>{i.interactive=e&&this._interactive||i.grabbing})}forEachManipulator(e){e(this._manipulatorHeading,A.ROTATE),e(this._manipulatorTilt,A.ROTATE),e(this._manipulatorDistance,A.SCALE)}};const Je={top:c(),bottom:c(),left:c(),right:c()},q=O(),Xe=O(),_e=c(),Ye=c(),we=Math.PI/2;function Ri(t){const{verticalFieldOfView:i,horizontalFieldOfView:s}=t,r=i>180,o=s>180,a=t.farDistanceRenderSpace;if(r&&o)return Math.max(1,a);t.arcCentersPoints(a,Je);const{left:l,right:d,top:h,bottom:u}=Je,v=1.9*(r?ze(l,d):o?ze(u,l):Math.sqrt(Math.min(xe(u,h),xe(l,d))));return Math.max(1,Math.min(a,v))}class dt extends Re{constructor(e,i){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:Ke,interactive:!1}),this._handles=new pe;const s=Ht(this._color);this.renderObjects=[new L(jt(s,Ke,32,32))],i.manipulators.add(this),this._handles.add([w(()=>this._color,r=>{s.setParameters({color:r})},C)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return G.toUnitRGBA(this.view.effectiveTheme.accentColor)}}n([p()],dt.prototype,"_color",null);const Ze=Symbol("dragHandles"),Qe=Symbol("hideManipulators");let $=class extends W{constructor(t){super(t),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._moveHelperVisualElement=null,this._settings=new Jt({getTheme:()=>this.view.effectiveTheme}),this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new Oi({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Ei({view:this.view,tool:this.parentTool}),this._observerManipulator=new dt(this.view,this.parentTool),this._createMoveHelperVisuals(),this.addHandles([w(()=>{const{observer:e}=this;return{observer:e,array:e==null?void 0:e.toArray()}},({observer:e})=>{e!=null&&(this._moveManipulation.location=e,this._observerManipulator.location=e)},X),w(()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e==null?void 0:e.observer}},({viewshedComputedData:e,observer:i},s)=>{this._grabbing&&i!==(s==null?void 0:s.observer)||(this.removeHandles(Ze),e!=null&&e.isValid()&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(bt),Ze))},C),w(()=>{const e=this.viewshedComputedData;return e!=null&&e.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},C),w(()=>{const e=this.viewshedComputedData;return e!=null&&e.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},C),w(()=>{var e;return this.analysisViewData.visible&&(((e=this.viewshedComputedData)==null?void 0:e.isValid())??!1)&&!this.parentTool.placingTarget},e=>this._updateManipulationAvailability(e),C),w(()=>{const e=this.viewshedComputedData;if(!(e!=null&&e.isValid()))return null;const{observer:i,target:s,verticalFieldOfView:r,horizontalFieldOfView:o}=e;return{viewshedCompData:e,observer:i,target:s,verticalFieldOfView:r,horizontalFieldOfView:o}},e=>{e!=null&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},C),w(()=>{var e;return(e=this.viewshedComputedData)==null?void 0:e.observerRenderSpace},e=>{e!=null&&this._updateMoveHelperVisualsLocation(e)},C)]);const t=e=>{this.addHandles([e.events.on("focus-changed",()=>this._updateManipulatorVisibility()),e.events.on("grab-changed",i=>{this._grabbing=i.action==="start"})])};this._forEachManipulator(t)}destroy(){this._moveManipulation=M(this._moveManipulation),this._fieldOfViewManipulation=M(this._fieldOfViewManipulation),this._scaleOrientManipulation=M(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=M(this._observerManipulator),this._destroyMoveHelperVisuals()}get viewshed(){var t;return(t=this.viewshedComputedData)==null?void 0:t.viewshed}get grabbing(){return this._grabbing}get observer(){var t;return(t=this.viewshed)==null?void 0:t.observer}set observer(t){const e=this.viewshed;e!=null&&(e.observer=t)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}onManipulatorSelectionChanged(){this._updateManipulatorVisibility()}hasManipulator(t){let e=!1;return this._forEachManipulator(i=>{e=e||i===t}),e}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new xt({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:Lt})}_buildObserverDragPipeline(t){const e={mode:"absolute-height",offset:0},i=t.observer;return i==null?null:this._moveManipulation.createDragPipeline((s,r,o,a,l)=>{a=a.next(de(this,["observer"]));const d=t.observer.clone();if(d==null)return{steps:o,cancel:a};const h=Zt.fromGeometry(d,Ft(this.view.viewingMode));return{steps:o.next(Gt({operations:h})).next(u=>(this.observer=yt(h.data.geometry,d.spatialReference),u)),cancel:a}},e,i.spatialReference,void 0)}_buildFOVDragPipeline(t){let e=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((s,r,o)=>{if(t==null)return{steps:r,cancel:o};const a=t.viewshed;return o=o.next(de(t,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next(l=>{l.action==="start"&&(e=t.horizontalFieldOfView,i=t.verticalFieldOfView);const d=l.deltaAngle;let h=0;switch(l.side){case"left":h=e/2-d;break;case"right":h=e/2+d;break;case"top":h=i+2*d;break;case"bottom":h=i-2*d}return ee(l.side)?(h=De.normalize(h),h=h>270?0:h>180?180:h,a.horizontalFieldOfView=2*h):a.verticalFieldOfView=h,l}),cancel:o}},t)}_buildScaleOrientDragPipeline(t){let e=0,i=0;const s=(r,o)=>(a,l,d)=>{if(t==null)return{steps:l,cancel:d};const h=t.viewshed;return d=d.next(de(h,[r])),{steps:l=l.next(o(h,t)),cancel:d}};return st([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",(r,o)=>a=>(a.action==="start"&&(i=t.heading),r.heading=De.normalize(i+a.deltaAngle),a)),t),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",(r,o)=>a=>{a.action==="start"&&(e=t.tilt);let l=e+a.deltaAngle;return l<-90?l=180:l>270&&(l=0),r.tilt=Pi.clamp(l),a}),t),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",(r,o)=>a=>{const l=D(Ai,a.renderEnd,o.observerRenderSpace),d=Se(l)*o.metersPerUnit,h=Me(l,o.targetDirection)<0?yi:d;return r.farDistance=h,a}),t)])}_updateManipulationAvailability(t){this._moveManipulation.available=t,this._fieldOfViewManipulation.available=t,this._scaleOrientManipulation.available=t,this._observerManipulator.available=t}_updateManipulatorVisibility(){const t=this._someManipulatorSelected()||this._someManipulatorHovering()&&this.view.activeTool==null;if(t)this.removeHandles(Qe);else{const e=[],i=s=>{e.push(s.disableDisplay())};this._forEachManipulator(i),this.addHandles(e,Qe)}this._updateMoveHelperVisualsVisibility(t)}_forEachManipulator(t){this._moveManipulation.forEachManipulator(t),this._fieldOfViewManipulation.forEachManipulator(t),this._scaleOrientManipulation.forEachManipulator(t),t(this._observerManipulator)}_createMoveHelperVisuals(){this._destroyMoveHelperVisuals();const t=new Yt({view:this.view,attached:!0,style:{glowWidth:this._settings.visualElements.heightPlane.glowWidth,innerWidth:this._settings.visualElements.heightPlane.innerWidth},isDecoration:!0}),e=new Xt({view:this.view,extensionType:this._settings.visualElements.zVerticalLine.extensionType,attached:!0,innerWidth:1,writeDepthEnabled:!1,renderOccluded:he.OccludeAndTransparent,isDecoration:!0});this._moveHelperVisualElement={laserline:t,verticalLine:e},this.addHandles([w(()=>this._settings.visualElements.zVerticalLine,i=>i.apply(e),X),w(()=>this._settings.visualElements.heightPlane,i=>i.apply(t),X)])}_updateMoveHelperVisualsVisibility(t){t=this.analysisViewData.visible&&t;const e=this._moveHelperVisualElement;e!=null&&(e.verticalLine.visible=t,e.laserline.visible=t)}_updateMoveHelperVisualsLocation(t){const e=this._moveHelperVisualElement;if(e==null)return;const{laserline:i,verticalLine:s}=e;i.heightManifoldTarget=t,i.intersectsWorldUpAtLocation=t,t!=null&&s.setStartEndFromWorldDownAtLocation(t)}_destroyMoveHelperVisuals(){const t=this._moveHelperVisualElement;t!=null&&(t.laserline.destroy(),t.verticalLine.destroy(),this._moveHelperVisualElement=null)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,moveHelperVisualElements:this._moveHelperVisualElement,viewshedComputedData:this.viewshedComputedData}}};n([p({constructOnly:!0})],$.prototype,"analysis",void 0),n([p({constructOnly:!0})],$.prototype,"analysisViewData",void 0),n([p({constructOnly:!0})],$.prototype,"parentTool",void 0),n([p({constructOnly:!0,nonNullable:!0})],$.prototype,"view",void 0),n([p()],$.prototype,"viewshed",null),n([p()],$.prototype,"_grabbing",void 0),n([p()],$.prototype,"grabbing",null),n([p()],$.prototype,"viewshedComputedData",void 0),n([p()],$.prototype,"observer",null),$=n([k("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],$);const Ai=c(),Pi=new Pt(0,180);var Te;let V=Te=class extends Qt{constructor(t){super(t),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creating=!1,this._selectedManipulator=null,this._selectedManipulatorSubTool=null}initialize(){this._intersector=ei(this.view.state.viewingMode);const t=this.analysisViewData.viewshedComputedDataHandles;this.addHandles([w(()=>t.some(e=>e.viewshedComputedData.isValid()),e=>{e&&this.finishToolCreation()},X),w(()=>this._stagedViewshed,e=>{var i;this._stagedViewshedComputedData=e!=null?(i=this.analysisViewData.viewshedComputedDataHandles.find(s=>s.viewshedComputedData.viewshed===e))==null?void 0:i.viewshedComputedData:null},X),w(()=>this.firstGrabbedManipulator,e=>{e!=null&&this._selectManipulator(e)},Mt),w(()=>this.analysisViewData.visible,e=>{e||this._selectManipulator(null)}),w(()=>this.view.activeTool,e=>{e!==this&&e!=null&&this._selectManipulator(null)})]),this.subToolHandles=He(()=>t,({viewshedComputedData:e})=>{const i=new $({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:i,remove:()=>{this._selectedManipulatorSubTool===i&&this._selectManipulator(null),i.destroy()}}})}destroy(){this.subToolHandles=M(this.subToolHandles)}onDeactivate(){this.removeStaged()}get cursor(){return this.creating?"crosshair":null}_selectManipulator(t){var i,s,r;const e=this._selectedManipulator;e!=null&&(e.selected=!1,this._selectedManipulator=null,(i=this._selectedManipulatorSubTool)==null||i.onManipulatorSelectionChanged(),this._selectedManipulatorSubTool=null),t!=null&&(t.selected=!0,this._selectedManipulator=t,this._selectedManipulatorSubTool=(s=this.subToolHandles.find(o=>o.subTool.hasManipulator(t)))==null?void 0:s.subTool,(r=this._selectedManipulatorSubTool)==null||r.onManipulatorSelectionChanged())}get selectedViewshed(){var t;return(t=this._selectedManipulatorSubTool)==null?void 0:t.viewshed}set selectedViewshed(t){this.selectViewshed(t)}get selectedViewshedComputedData(){var t;return(t=this._selectedManipulatorSubTool)==null?void 0:t.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:t})=>t.grabbing)}get creating(){return this._creating&&this.active}get placingTarget(){return this._stagedViewshed!=null}createViewsheds(){this._creating=!0}onManipulatorSelectionChanged(){this.subToolHandles.forEach(t=>t.subTool.onManipulatorSelectionChanged())}onInputEvent(t){switch(t.type){case"immediate-click":this._clickDeselectHandler();break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":Ie.cancel===t.key?this._cancelKeyHandler(t):Ie.delete.includes(t.key)&&this._deleteKeyHandler()}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickPlacementHandler(t)}_clickDeselectHandler(){this.hasFocusedManipulators||this._selectManipulator(null)}_clickPlacementHandler(t){if(!this.creating||this.hasFocusedManipulators)return;const e=this._stagedViewshed,i=this._intersectScreen(t,tt);if(i!=null){if(e==null){i.mapPoint.z=(i.mapPoint.z??0)+2;const s=new gi({observer:i.mapPoint.clone()});this.analysis.viewsheds.add(s),this._stagedViewshed=s,this._updateStagedViewshed(i.scenePoint)}else{this._updateStagedViewshed(i.scenePoint);const s=this._stagedViewshed;this._stagedViewshed=null,this.selectViewshed(s)}t.stopPropagation()}}_doubleClickHandler(t){this.creating&&(this.removeStaged(),this._selectManipulator(null),this._creating=!1,this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(!this.creating||this._stagedViewshed==null)return;const e=this._intersectScreen(t,tt);e!=null&&this._updateStagedViewshed(e.scenePoint)}_cancelKeyHandler(t){if(this.creating){if(this.removeStaged())return this._selectManipulator(null),void t.stopPropagation();this._creating=!1}else if(!this.grabbing)return this.selectViewshed(null),void t.stopPropagation()}_deleteKeyHandler(){this.creating&&this.removeStaged(),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(t){const e=this._stagedViewshed,i=this._stagedViewshedComputedData;if(e==null||i==null)return;const{heading:s,tilt:r,farDistance:o}=Fi(this.view,i,t);e.farDistance=o,e.tilt=r,e.heading=s}removeStaged(){return this._stagedViewshed!=null&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}selectViewshed(t){var i;if(t!=null)for(const s of this.view.tools.items)s!==this&&s instanceof Te&&s.selectViewshed(null);const e=(i=this.subToolHandles.find(s=>s.subTool.viewshed===t))==null?void 0:i.subTool;this._selectManipulator(e==null?void 0:e.discManipulator)}_intersectScreen(t,e){const i=ti(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,r=e.scenePoint;if(!s.getIntersectionPoint(r))return null;const o=e.mapPoint;return o.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(r,o),o==null?null:e}get test(){var t;return{subTools:this.subToolHandles.map(e=>e.subTool.test),selectedSubTool:(t=this._selectedManipulatorSubTool)==null?void 0:t.test,stagedViewshed:this._stagedViewshed}}};function Fi(t,e,i){const s=e.observerRenderSpace,r=D(zi,i,s),o=Se(r)*e.metersPerUnit,a=t.renderCoordsHelper.basisMatrixAtPosition(s,ki),l=N(xi,a[8],a[9],a[10]),d=$t(s,l,Ui),h=Ct(d,i,Li),u=D(h,h,s),v=fe(Ve(r,u))*(Me(l,r)<0?-1:1)+90,m=N(et,a[4],a[5],a[6]),f=fe(Ve(m,u)),g=N(et,a[0],a[1],a[2]);return{heading:Me(u,g)<0?360-f:f,tilt:v,farDistance:o}}n([p({constructOnly:!0})],V.prototype,"view",void 0),n([p()],V.prototype,"analysisViewData",void 0),n([p()],V.prototype,"removeIncompleteOnCancel",void 0),n([p()],V.prototype,"automaticManipulatorSelection",void 0),n([p({constructOnly:!0})],V.prototype,"analysis",void 0),n([p()],V.prototype,"subToolHandles",void 0),n([p()],V.prototype,"_stagedViewshed",void 0),n([p()],V.prototype,"_stagedViewshedComputedData",void 0),n([p()],V.prototype,"_creating",void 0),n([p({readOnly:!0})],V.prototype,"cursor",null),n([p()],V.prototype,"_selectedManipulator",void 0),n([p()],V.prototype,"_selectedManipulatorSubTool",void 0),n([p()],V.prototype,"selectedViewshed",null),n([p()],V.prototype,"selectedViewshedComputedData",null),n([p()],V.prototype,"grabbing",null),n([p()],V.prototype,"creating",null),n([p()],V.prototype,"placingTarget",null),V=Te=n([k("esri.views.3d.analysis.Viewshed.ViewshedTool")],V);const zi=c(),xi=c(),Li=c(),et=c(),ki=O(),Ui=Ot(),tt={mapPoint:new ae,scenePoint:c()},Ii=V;let T=class extends Dt(W){constructor(t){super(t),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this.viewshedComputedDataHandles=null,this._placementTask=null}get selectedViewshed(){var t;return(t=this.tool)==null?void 0:t.selectedViewshed}set selectedViewshed(t){const{tool:e}=this;e!=null&&(e.selectedViewshed=t)}get selectedViewshedComputedData(){var t;return(t=this.tool)==null?void 0:t.selectedViewshedComputedData}initialize(){this._initializeUpdateHandle(),this.viewshedComputedDataHandles=He(()=>this.analysis.viewsheds,t=>{const e=new _({renderCoordsHelper:this.view.renderCoordsHelper,viewshed:t}),i=Symbol();return this.addHandles(w(()=>e.isValid(),(s,r)=>{this.visible&&(s?this._addViewshedsToRenderer(e):r&&this._removeViewshedsFromRenderer(e))},C)),{viewshedComputedData:e,remove:()=>{this.removeHandles(i),this._removeViewshedsFromRenderer(e),e.destroy()}}}),this._analysisVisualization=new x({view:this.view,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([w(()=>this.visible,t=>{const e=this.viewshedComputedDataHandles.map(i=>i.viewshedComputedData).filter(i=>i.isValid());t?this._addViewshedsToRenderer(e):this._removeViewshedsFromRenderer(e)}),w(()=>this.view.renderCoordsHelper,t=>{this.viewshedComputedDataHandles.forEach(({viewshedComputedData:e})=>e.renderCoordsHelper=t)}),si(this,Ii)])}destroy(){this._placementTask=Le(this._placementTask),ri(this),this._analysisVisualization=M(this._analysisVisualization),this._removeViewshedsFromRenderer(this.viewshedComputedDataHandles.map(t=>t.viewshedComputedData))}async createViewsheds(t){return this._placementTask=Le(this._placementTask),this._placementTask=oi(this,t),this.tool!=null&&this.tool.createViewsheds(),await this._placementTask.promise}_initializeUpdateHandle(){const t=this.view._stage.renderer.plugins.plugins.find(e=>e instanceof ii);t&&(this._updateHandleInRenderer=t.updateViewsheds.bind(t))}_addViewshedsToRenderer(t){this._updateHandleInRenderer({adds:t})}_removeViewshedsFromRenderer(t){this._updateHandleInRenderer({removes:t})}};n([p({readOnly:!0})],T.prototype,"type",void 0),n([p({constructOnly:!0,nonNullable:!0})],T.prototype,"analysis",void 0),n([p()],T.prototype,"tool",void 0),n([p()],T.prototype,"selectedViewshed",null),n([p()],T.prototype,"selectedViewshedComputedData",null),n([p()],T.prototype,"viewshedComputedDataHandles",void 0),n([p()],T.prototype,"_analysisVisualization",void 0),n([p()],T.prototype,"_placementTask",void 0),T=n([k("esri.views.3d.analysis.ViewshedAnalysisView3D")],T);const Ua=T;export{Ua as default};
