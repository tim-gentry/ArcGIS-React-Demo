const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/deleteForwardEdits-C_MFN_42.js","assets/index-DX0rcHuW.js","assets/index-B2yzeq1w.css","assets/utils-nzDIu46v.js","assets/DeleteForwardEditsParameters-B7gPsk4x.js"])))=>i.map(i=>d[i]);
import{U as S,_ as j,b5 as R,L as T,ac as A,ad as k,ag as x,a as p}from"./index-DX0rcHuW.js";import{o as D}from"./uuid-fwrPAdZb.js";const P=D(),U=new Map,$=new Map,z=new Map;async function C(e,n,r){if(!e||!r)return!1;if(!n)return!0;const s=new URL(e).host;let t=U.get(s);if(!t){const i=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");t=(await S(i,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return t===n}async function G(e,n,r=!1){var i,a,o;if(!e||!n)return!0;const s=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=(i=$.get(s))==null?void 0:i.entries();if(t){for(const[m,l]of t)if(l.name===n){const u=!((a=l.stack)!=null&&a.hasForwardEdits());if(!u&&r){const[{deleteForwardEdits:h},{default:I}]=await Promise.all([j(()=>import("./deleteForwardEdits-C_MFN_42.js"),__vite__mapDeps([0,1,2,3])),j(()=>import("./DeleteForwardEditsParameters-B7gPsk4x.js"),__vite__mapDeps([4,1,2]))]),b=await h(s,m,new I({sessionId:P,moment:l.moment}));return b.success&&((o=l.stack)==null||o.clearForwardEdits()),b.success}return u}}return!0}function O(e,n){var t;if(!e)return!1;const r=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),s=(t=$.get(r))==null?void 0:t.entries();if(s){for(const[i,a]of s)if(a.name===n)return a.lockType==="edit"}return!1}const g=new R.EventEmitter;function W(e){return g.on("apply-edits",new WeakRef(e))}function q(e){return g.on("update-moment",new WeakRef(e))}function J(e,n,r=null,s=!1){const t=T();return s=n==null||s,g.emit("apply-edits",{serviceUrl:e,layerId:n,gdbVersion:r,mayReceiveServiceEdits:s,result:t.promise}),t}function K(e,n,r=null,s){g.emit("update-moment",{serviceUrl:e,layerId:n,gdbVersion:r,moment:s})}const H=Symbol();function Q(e){return e!=null&&typeof e=="object"&&H in e}function f(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function y(e,n,r){const s=new URL(e).host,t=U.get(s),i=a=>!a||a===t;return i(n)&&i(r)||n===r}const X=e=>{var n;let r=class extends e{constructor(...s){super(...s),this[n]=!0,this._applyEditsHandler=t=>{const{serviceUrl:i,layerId:a,gdbVersion:o,mayReceiveServiceEdits:m,result:l}=t,u=i===this.url,h=a!=null&&this.layerId!=null&&a===this.layerId,I=f(this),b=f(this)&&y(i,o,this.gdbVersion);if(!u||I&&!b||!h&&!m)return;const L=l.then(d=>{var _;if(this.lastEditsEventDate=new Date,h&&(d.addedFeatures.length||d.updatedFeatures.length||d.deletedFeatures.length||d.addedAttachments.length||d.updatedAttachments.length||d.deletedAttachments.length))return this.emit("edits",p(d)),d;const v=(_=d.editedFeatures)==null?void 0:_.find(({layerId:F})=>F===this.layerId);if(v){const{adds:F,updates:E,deletes:w}=v.editedFeatures,V={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:F?F.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],deletedFeatures:w?w.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],updatedFeatures:E?E.map(({current:{attributes:c}})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],editedFeatures:p(d.editedFeatures),exceededTransferLimit:!1,historicMoment:p(d.historicMoment)};return this.emit("edits",V),V}const M={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:p(d.editedFeatures),exceededTransferLimit:!1,historicMoment:p(d.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(i,o,M.historicMoment)&&this.emit("edits",M),M}).then(d=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(i,o,d.historicMoment)&&(this.historicMoment=d.historicMoment),d));this.emit("apply-edits",{result:L})},this._updateMomentHandler=t=>{const{serviceUrl:i,gdbVersion:a,moment:o}=t,m=i===this.url,l=f(this),u=f(this)&&y(i,a,this.gdbVersion),h=f(this)&&!y(i,this.gdbVersion,null);m&&l&&u&&h&&"historicMoment"in this&&this.historicMoment!==o&&(this.historicMoment=o)},this.when().then(()=>{this.addHandles(W(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(q(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(s,t,i){return"historicMoment"in this&&this.historicMoment!==i&&O(s,t)}};return n=H,A([k()],r.prototype,"lastEditsEventDate",void 0),r=A([x("esri.layers.mixins.EditBusLayer")],r),r};export{X as F,O as a,z as b,J as c,y as g,q as h,G as i,W as l,U as n,C as o,Q as p,$ as s,P as t,K as u};
