const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ColorMaterial.glsl-CcrBVOmk.js","assets/index-DX0rcHuW.js","assets/index-B2yzeq1w.css","assets/mat3-Ck4GO2qT.js","assets/mat3f64-BBpwCtoL.js","assets/mat4f64-Dk4dwAN8.js","assets/vec2f64-Diu2Kaa8.js","assets/BufferView-XrMc2vJu.js","assets/vec2-C-4tM9Uv.js","assets/Texture-0jciB86n.js","assets/Matrix4PassUniform-CTNrzJ6Q.js","assets/interfaces-B8ge7Jg9.js","assets/BindType-BmZEZMMh.js","assets/VertexAttribute-BnAa5VW0.js","assets/Util-HYkJg9Vp.js","assets/enums-BlUEVwJR.js","assets/Texture-BF0Xf23l.js","assets/basicInterfaces-wONHx_SN.js","assets/ShaderTechniqueConfiguration-D3UbJ2mX.js","assets/doublePrecisionUtils-B0owpBza.js","assets/Indices-BZu2O98k.js","assets/Material-BfvzXcva.js","assets/ViewingMode-Dodu7ZZk.js","assets/triangle-CGr49R4x.js","assets/sphere-COyqsaGw.js","assets/plane-BL9J6YX0.js","assets/quatf64-BrpT0VRp.js","assets/mathUtils-BsqbT0oM.js","assets/lineSegment-C2OVzbAD.js","assets/renderState-yUi34s5A.js","assets/requestImageUtils-Cd7mPI4y.js","assets/InterleavedLayout-ZKuAjCiK.js","assets/types-D0PSWh4d.js","assets/VertexColor.glsl-BX9otDj2.js","assets/projectVectorToVector-DjKO2tJh.js","assets/projectPointToVector-6lqiVL77.js","assets/hydratedFeatures-DcIGyuBL.js","assets/floatRGBA-DZ6CgOhi.js"])))=>i.map(i=>d[i]);
import{r as eo,n as k}from"./vec2f64-Diu2Kaa8.js";import{bp as M,d7 as Jt,bW as wr,lJ as Wi,bn as Mt,bq as re,d6 as se,bB as ae,dk as X,d2 as at,bb as Pe,ac as m,ad as R,ag as tr,bh as Mi,dn as _i,bk as Ue,dW as st,d3 as Q,cT as Bi,c_ as ki,cZ as Br,cQ as or,bw as ke,by as kt,dO as Vr,dQ as ta,pE as to,bS as ro,bO as Tt,pF as qi,gd as Zi,c$ as Ft,jq as Qi,jp as io,dH as so,bj as Gt,g$ as Wt,d0 as Le,dP as ao,n as zr,pG as ra,ke as et,bC as ye,dj as Ji,d5 as le,bK as yi,aS as oo,M as no,e4 as lo,pH as co,d8 as ho,mF as uo,b8 as Cr,pI as Yi,e3 as po,aa as Dr,b9 as Et,pJ as Ar,j8 as bt,j9 as Rt,ee as Yt,b5 as ia,j6 as fo,dI as sa,cu as Ei,kY as mo,cR as wi,_ as $i,jB as go,gJ as vo,kD as Xi,bv as _o,d4 as yo,pK as Ki,pL as wo,aj as es,jZ as Be,nB as Co,bi as xo,bY as kr,dN as ts,b_ as So,h5 as qr,pM as To,eP as bo}from"./index-DX0rcHuW.js";import{r as J,n as be,t as rs}from"./vec3f32-Cw9Q6TO_.js";import{t as Ro}from"./DoubleArray-tnpOy9RK.js";import{Z as Zr,W as aa,X as oa,L as na,u as qe,E as ie,g as Fe,a9 as Qr,aa as Oo,t as De,I as we,ab as is,ac as ss,ad as as,ae as os,R as Mr,a1 as Do,q as la,af as Ao,S as Mo,Q as Eo,B as dt,o as Ii,K as ca,m as da,ag as ns,F as $o,f as Io,ah as Pi,b as xr,N as Po,V as Lo,H as Fo,a as No,c as jo,P as Vo,e as zo,h as Jr,i as Li,r as Fi,j as Ni,A as Yr,k as Uo,a2 as Ho,l as Go,s as Wo,a3 as ls,a4 as cs,a5 as Bo,O as ko,ai as ds,aj as qo,ak as Zo,al as Qo,am as Jo,n as Yo,an as Xo,ao as Ko,ap as en,aq as tn,a7 as rn,C as sn,ar as an}from"./Texture-0jciB86n.js";import{A as ha,l as on}from"./Indices-BZu2O98k.js";import{a as nn,E as rr,j as ln,S as cn,b as nr,V as Ae,F as hs}from"./plane-BL9J6YX0.js";import{m as dn,l as hn,V as Er,_ as ua,C as un}from"./sphere-COyqsaGw.js";import{t as j}from"./orientedBoundingBox-BTwqkknQ.js";import{e as jt,r as pa,c as pn,h as Re,O as fa,t as Xr}from"./Material-BfvzXcva.js";import{s as pe,m as fn,u as mn,c as ht,f as lr,l as gn}from"./Util-HYkJg9Vp.js";import{e as y,E as vn}from"./VertexAttribute-BnAa5VW0.js";import{o as We,e as W}from"./mat4f64-Dk4dwAN8.js";import{u as _n}from"./computeTranslationToOriginAndRotation-B9BchKSd.js";import{t as yn,f as wn,b as cr,e as us,G as Cn,i as xn}from"./ElevationProvider-Xg9LKEp7.js";import{u as Sn}from"./hydratedFeatures-DcIGyuBL.js";import{l as ji}from"./ViewingMode-Dodu7ZZk.js";import{a as ma,i as Nt,h as tt,c as Z,o as E,b as Tn,l as bn,m as Rn,p as ps,q as On}from"./Matrix4PassUniform-CTNrzJ6Q.js";import{r as Vi,E as Dn,o as Ci,u as Ze,l as xt,_ as zt,b as fs,e as St,j as ne,x as An,v as ms}from"./vec2-C-4tM9Uv.js";import{H as Mn,N as En,L as $n,b as dr}from"./frustum-Tc8kkw3_.js";import{o as w,n as ga}from"./interfaces-B8ge7Jg9.js";import{b as In,d as gs,y as vs}from"./axisAngleDegrees-jEN9n05M.js";import{p as ut,i as Pn}from"./weather-CSMUgeU9.js";import{a as Ln,I as Fn,C as Nn}from"./Scheduler-Bg_fxWwI.js";import{a as jn}from"./BindType-BmZEZMMh.js";import{o as _s}from"./Float4DrawUniform-X0Lc1Ix0.js";import{t as zi}from"./NestedMap-DgiGbX8E.js";import{t as va,r as P}from"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import{m as _a}from"./mathUtils-BsqbT0oM.js";import{i as Vn,t as ys,a as zn}from"./basicInterfaces-wONHx_SN.js";import{Y as Un}from"./Octree-lrGXb_0y.js";import{v as ya,j as Hn,h as Kr,d as Gn}from"./lineSegment-C2OVzbAD.js";import{H as Wn}from"./InterleavedLayout-ZKuAjCiK.js";import{o as wa}from"./floatRGBA-DZ6CgOhi.js";import{G as Ca,D as $r,f as hr,E as ws,M as Bn,_ as Ir,F as kn,R as Ot,L as qn}from"./enums-BlUEVwJR.js";import{e as Ui,c as Xt}from"./Texture-BF0Xf23l.js";import{S as rt,o as Zn,_ as $t,l as Qn,s as Jn}from"./renderState-yUi34s5A.js";import{e as Yn}from"./mat3f64-BBpwCtoL.js";import{i as Xn}from"./Intersector-CG5xfiNM.js";import{t as Kn}from"./glUtil-C6KhMg1m.js";import{o as el}from"./VertexArrayObject-9V6uZ6_q.js";import{c as tl}from"./BufferObject-CWTeBz1x.js";function rl(e){e.fragment.code.add(w`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}let il=class extends el{};var it,Pr;function fh(e){return(e==null?void 0:e.cubeMap)!=null}function sl(e){return e!=null&&!e.running}(function(e){e[e.RENDERING=0]="RENDERING",e[e.FADING=1]="FADING",e[e.FINISHED=2]="FINISHED"})(it||(it={})),function(e){e[e.RG=0]="RG",e[e.BA=1]="BA"}(Pr||(Pr={}));let al=class{constructor(){this.readChannels=Pr.RG,this.renderingStage=it.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=M(),this.parallax=new Cs,this.parallaxNew=new Cs,this.pointOnGround=M(),this.fadeMode=G.HIDE,this.fadeFactor=0,this.opacity=0}updateParallax(t){const r=this.parallax,i=Jt(t.eye);if(r.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(i*i-wr.radius*wr.radius,0))/i,gs(xs,r.anchorPointClouds,pt),Wi(r.transform,We,pt[3],vs(pt)),this.fadeMode===G.CROSS_FADE){const s=this.parallaxNew;gs(xs,s.anchorPointClouds,pt),Wi(s.transform,We,pt[3],vs(pt))}}updateFading(t,r,i,s){this.isFading&&this._advanceFading(i,s),this._evaluateFading(t,r,i)}_evaluateFading(t,r,i){const s=t.relativeElevation,a=this._calculateDistanceToAnchorPoint(t);if((s>1.7*ut||s<-ut||a>dl)&&this.opacity>0)this._setFade(G.HIDE,i);else if(!this.isFading){if((s>ut||s<-.35*ut||a>cl)&&this.opacity>0)this._setFade(G.FADE_OUT,i);else if(s<=ut&&s>=-.35*ut&&r===Ln.IDLE&&sl(this.data)){if(this.opacity===0)return void this._setFade(G.FADE_IN,i);(a>ll||this.renderingStage===it.FADING)&&this._setFade(G.CROSS_FADE,i)}}}_advanceFading(t,r){this._switchReadChannels(),this._updateAnchorPoint(),this._advanceFadingFactorAndOpacity(t,r)}_advanceFadingFactorAndOpacity(t,r){if(this.fadeFactor<1)return this.fadeFactor=r?Mt((t-this.startTime)/(nl*r),0,1):1,this.fadeMode===G.FADE_OUT&&(this.opacity=1-this.fadeFactor),this.fadeMode===G.FADE_IN&&(this.opacity=this.fadeFactor),void(this.fadeMode===G.CROSS_FADE&&(this.opacity=1));this.fadeFactor=0,this.fadeMode===G.FADE_OUT&&(this.opacity=0),this.fadeMode===G.FADE_IN&&(this.opacity=1),this.fadeMode===G.CROSS_FADE&&(this.opacity=1),this.fadeMode=G.NONE}_switchReadChannels(){const t=this.fadeMode===G.CROSS_FADE&&this.fadeFactor===1,r=this.fadeMode===G.FADE_IN&&this.fadeFactor===0;this.renderingStage===it.FADING&&(t||r)&&(this.readChannels=1-this.readChannels,this.renderingStage=it.FINISHED)}_calculateDistanceToAnchorPoint(t){return re(this.pointOnGround,t.eye),se(this.pointOnGround,this.pointOnGround,wr.radius),Jt(ae(ol,this.parallax.anchorPointClouds,this.pointOnGround))}_updateAnchorPoint(){this.fadeMode===G.CROSS_FADE&&(this.fadeFactor===0&&X(this.parallaxNew.anchorPointClouds,this.pointOnGround),this.fadeFactor===1&&X(this.parallax.anchorPointClouds,this.parallaxNew.anchorPointClouds)),this.fadeMode===G.FADE_IN&&this.fadeFactor===0&&X(this.parallax.anchorPointClouds,this.pointOnGround)}_setFade(t,r){switch(t){case G.HIDE:this.opacity=0;break;case G.FADE_OUT:this.opacity=1;break;case G.FADE_IN:this.opacity=0;break;case G.CROSS_FADE:this.opacity=1}this.fadeMode=t,this.fadeFactor=0,this.startTime=r}get isFading(){return this.fadeMode===G.FADE_OUT||this.fadeMode===G.FADE_IN||this.fadeMode===G.CROSS_FADE}};var G;(function(e){e[e.NONE=0]="NONE",e[e.HIDE=1]="HIDE",e[e.FADE_OUT=2]="FADE_OUT",e[e.FADE_IN=3]="FADE_IN",e[e.CROSS_FADE=4]="CROSS_FADE"})(G||(G={}));let Cs=class{constructor(){this.anchorPointClouds=M(),this.radiusCurvatureCorrectionFactor=0,this.transform=W()}};const xs=at(0,0,1),pt=In(),ol=M(),nl=1.25,ll=34e3,cl=64e3,dl=2e5;let hl=class extends ma{constructor(t,r){super(t,"samplerCube",jn.Pass,(i,s,a)=>i.bindTexture(t,r(s,a)))}};function ul(e){const t=e.fragment;t.uniforms.add(new Nt("rotationMatrixClouds",(r,i)=>i.cloudsFade.parallax.transform),new Nt("rotationMatrixCloudsCrossFade",(r,i)=>i.cloudsFade.parallaxNew.transform),new tt("anchorPosition",(r,i)=>i.cloudsFade.parallax.anchorPointClouds),new tt("anchorPositionCrossFade",(r,i)=>i.cloudsFade.parallaxNew.anchorPointClouds),new Z("cloudsHeight",()=>Pn),new Z("radiusCurvatureCorrectionFactor",(r,i)=>i.cloudsFade.parallax.radiusCurvatureCorrectionFactor),new Z("totalFadeInOut",(r,i)=>1-i.cloudsFade.opacity),new Z("crossFadeAnchorFactor",(r,i)=>Mt(i.cloudsFade.fadeFactor,0,1)),new hl("cubeMap",(r,i)=>{var s,a;return((a=(s=i.cloudsFade.data)==null?void 0:s.cubeMap)==null?void 0:a.colorTexture)??null}),new Zr("crossFade",(r,i)=>i.cloudsFade.fadeMode===G.CROSS_FADE),new Zr("readChannelsRG",(r,i)=>i.cloudsFade.readChannels===Pr.RG),new Zr("fadeTextureChannels",(r,i)=>i.cloudsFade.renderingStage===it.FADING)),t.constants.add("planetRadius","float",wr.radius),t.code.add(w`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)
{
float radiusClouds = planetRadius + cloudsHeight;
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),t.code.add(w`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),t.code.add(w`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),aa(t),oa(t),t.code.add(w`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),t.code.add(w`vec4 getCloudData(vec3 rayDir, bool readOtherChannel)
{
vec4 cloudData = texture(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
bool readChannels = readChannelsRG ^^ readOtherChannel;
if (readChannels) {
cloudData = vec4(vec3(cloudData.r), cloudData.g);
} else {
cloudData = vec4(vec3(cloudData.b), cloudData.a);
}
if (length(cloudData) == 0.0) {
return vec4(cloudData.rgb, 1.0);
}
return cloudData;
}`),t.code.add(w`vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);
}`),t.code.add(w`vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
vec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`),t.code.add(w`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)
{
return crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);
}`)}function pl(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/t)}function fl(e,t,r){return 2*Math.atan(Math.sqrt(t*t+r*r)*Math.tan(.5*e)/r)}function ml(e,t,r){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+r*r))}function gl(e,t,r){return 2*Math.atan(r*Math.tan(.5*e)/Math.sqrt(t*t+r*r))}let vl=class{constructor(){this.adds=new Pe,this.removes=new Pe,this.updates=new Pe({allocator:t=>t||new _l,deallocator:t=>(t.renderGeometry=null,t)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},_l=class{},yl=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var Ss,V;function wl(e){const t=new Map,r=i=>{let s=t.get(i);return s||(s=new yl,t.set(i,s)),s};return e.removes.forAll(i=>{ei(i)&&r(i.material).removes.push(i)}),e.adds.forAll(i=>{ei(i)&&r(i.material).adds.push(i)}),e.updates.forAll(i=>{ei(i.renderGeometry)&&r(i.renderGeometry.material).updates.push(i)}),t}function ei(e){return e.geometry.indexCount>=1}(function(e){e[e.Default=0]="Default",e[e.Screenshot=1]="Screenshot",e[e.ObjectAndLayerID=2]="ObjectAndLayerID"})(Ss||(Ss={})),function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"}(V||(V={}));var xi;let I=xi=class extends Mi{constructor(e){super(e),this._ray=dn(),this._viewport=_i(0,0,1,1),this._padding=_i(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=eo(1,1e3),this._viewDirty=!0,this._viewMatrix=W(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=W(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=W(),this._frustumDirty=!0,this._frustum=Mn(),this._fullViewport=Ue(),this._pixelRatio=1,this.row=0,this.column=0,this._rows=1,this._columns=1,this._center=M(),this._up=M(),this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(e){this._pixelRatio=e>0?e:1}get rows(){return this._rows}set rows(e){this._rows=Math.max(1,e)}get columns(){return this._columns}set columns(e){this._columns=Math.max(1,e)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center,"_center")}get ray(){return ae(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){st(this._viewMatrix,e),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),Q(M(),-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10])}get viewUp(){return this._ensureViewClean(),Q(M(),this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9])}get viewRight(){return this._ensureViewClean(),Q(M(),this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8])}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const e=Bi(Ue(),this._viewport,1/this.pixelRatio),t=this._get("screenViewport");return t&&ki(e,t)?t:e}get screenPadding(){if(this.pixelRatio===1)return this._padding;const e=Bi(Ue(),this._padding,1/this.pixelRatio),t=this._get("screenPadding");return t&&ki(e,t)?t:e}get x(){return this._viewport[0]}set x(e){e+=this._padding[V.LEFT],this._viewport[0]!==e&&(this._viewport[0]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(e){e+=this._padding[V.BOTTOM],this._viewport[1]!==e&&(this._viewport[1]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[V.RIGHT]+this._padding[V.LEFT]}set fullWidth(e){this.width=e-(this._padding[V.RIGHT]+this._padding[V.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[V.TOP]+this._padding[V.BOTTOM]}set fullHeight(e){this.height=e-(this._padding[V.TOP]+this._padding[V.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[V.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[V.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){Br(this._padding,e)||(this._viewport[0]+=e[V.LEFT]-this._padding[V.LEFT],this._viewport[1]+=e[V.BOTTOM]-this._padding[V.BOTTOM],this._viewport[2]-=e[V.RIGHT]+e[V.LEFT]-(this._padding[V.RIGHT]+this._padding[V.LEFT]),this._viewport[3]-=e[V.TOP]+e[V.BOTTOM]-(this._padding[V.TOP]+this._padding[V.BOTTOM]),or(this._padding,e),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(ke(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){return this._projectionMatrixInternal}get inverseProjectionMatrix(){return kt(W(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||W()}get fov(){return this._fov}set fov(e){this._fov=e,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return ml(this._fov,this.width,this.height)}set fovX(e){this._fov=pl(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return gl(this._fov,this.width,this.height)}set fovY(e){this._fov=fl(e,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return Vr(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(kt(this._viewInverseTransposeMatrix,this.viewMatrix),ta(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}get _projectionMatrixInternal(){const e=this.width,t=this.height,r=this.near*Math.tan(this.fovY/2)*2,i=r*this._aspect,s=r/this.rows,a=i/this.columns,o=-i/2+this.column*a,l=o+a,c=-r/2+this.row*s,n=c+s,d=to(W(),o*(1+2*this._padding[V.LEFT]/e),l*(1+2*this._padding[V.RIGHT]/e),c*(1+2*this._padding[V.BOTTOM]/t),n*(1+2*this._padding[V.TOP]/t),this.near,this.far),h=this._get("projectionMatrix");return h&&ro(h,d)?h:d}copyFrom(e){X(this._ray.origin,e.eye),this.center=e.center,this.up=e.up,or(this._viewport,e.viewport),this.notifyChange("_viewport"),or(this._padding,e.padding),this.notifyChange("_padding"),Vi(this._nearFar,e.nearFar),this.notifyChange("_nearFar"),this._fov=e.fov,this.row=e.row,this.column=e.column,this.rows=e.rows,this.columns=e.columns,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||(st(this._viewMatrix,e.viewMatrix),this.notifyChange("_viewMatrix")),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||(En(this._frustum,e.frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(st(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),or(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return new xi().copyFrom(this)}equals(e){return Tt(this.eye,e.eye)&&Tt(this.center,e.center)&&Tt(this.up,e.up)&&Br(this._viewport,e.viewport)&&Br(this._padding,e.padding)&&Dn(this.nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation&&this.row===e.row&&this.column===e.column&&this.rows===e.rows&&this.columns===e.columns}almostEquals(e){const t=Math.max(1,1/this.pixelRatio,1/e.pixelRatio);if(Math.abs(e.fov-this._fov)>=.001||qi(e.screenPadding,this.screenPadding)>=t||qi(this.screenViewport,e.screenViewport)>=t||this.row!==e.row||this.column!==e.column||this.rows!==e.rows||this.columns!==e.columns)return!1;Zi(oe,e.eye,e.center),Zi(ti,this.eye,this.center);const r=Ft(oe,ti),i=Qi(oe),s=Qi(ti),a=5e-4;return r*r>=(1-1e-10)*i*s&&io(e.eye,this.eye)<Math.max(i,s)*a*a}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(e))}_viewDirectionDistance(e){return Math.abs(nn(this.viewForward,ae(oe,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=so()){return e[0]=(this.padding[V.LEFT]+this.width/2)/this.pixelRatio,e[1]=(this.padding[V.TOP]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,r=.5){return e[0]=this.padding[V.LEFT]+this.width*t,e[1]=this.padding[V.BOTTOM]+this.height*r,e[2]=.5,e}setGLViewport(e){const t=this.viewport,r=this.padding;e.setViewport(t[0]-r[3],t[1]-r[2],t[2]+r[1]+r[3],t[3]+r[0]+r[2])}applyProjection(e,t){e!==L&&X(L,e),L[3]=1,Gt(L,L,this.projectionMatrix);const r=Math.abs(L[3]);se(L,L,1/r);const i=this.fullViewport;t[0]=Wt(0,i[0]+i[2],.5+.5*L[0]),t[1]=Wt(0,i[1]+i[3],.5+.5*L[1]),t[2]=.5*(L[2]+1),t[3]=r}unapplyProjection(e,t){const r=this.fullViewport;L[0]=(e[0]/(r[0]+r[2])*2-1)*e[3],L[1]=(e[1]/(r[1]+r[3])*2-1)*e[3],L[2]=(2*e[2]-1)*e[3],L[3]=e[3],this.inverseProjectionMatrix!=null&&(Gt(L,L,this.inverseProjectionMatrix),t[0]=L[0],t[1]=L[1],t[2]=L[2])}projectToScreen(e,t){return this.projectToRenderScreen(e,ri),this.renderToScreen(ri,t),t}projectToRenderScreen(e,t){if(L[0]=e[0],L[1]=e[1],L[2]=e[2],L[3]=1,Gt(L,L,this.viewProjectionMatrix),L[3]===0)return null;const r=L;se(r,r,1/Math.abs(L[3]));const i=this.fullViewport,s=Wt(0,i[0]+i[2],.5+.5*r[0]),a=Wt(0,i[1]+i[3],.5+.5*r[1]);return"x"in t?(t.x=s,t.y=a):(t[0]=s,t[1]=a,t.length>2&&(t[2]=.5*(r[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,ri),t)}unprojectFromRenderScreen(e,t){if(ke(ur,this.projectionMatrix,this.viewMatrix),!kt(ur,ur))return null;const r=this.fullViewport;return L[0]=2*(e[0]-r[0])/r[2]-1,L[1]=2*(e[1]-r[1])/r[3]-1,L[2]=2*e[2]-1,L[3]=1,Gt(L,L,ur),L[3]===0?null:(t[0]=L[0]/L[3],t[1]=L[1]/L[3],t[2]=L[2]/L[3],t)}constrainWindowSize(e,t,r,i){const s=e*this.pixelRatio,a=t*this.pixelRatio,o=Math.max(s-r/2,0),l=Math.max(this.fullHeight-a-i/2,0),c=-Math.min(s-r/2,0),n=-Math.min(this.fullHeight-a-i/2,0),d=r-c- -Math.min(this.fullWidth-s-r/2,0),h=i-n- -Math.min(a-i/2,0);return[Math.round(o),Math.round(l),Math.round(d),Math.round(h)]}computeUp(e){e===ji.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(e,t){const r=e[0]*this.pixelRatio,i=this.fullHeight-e[1]*this.pixelRatio;return t[0]=r,t[1]=i,t}renderToScreen(e,t){const r=e[0]/this.pixelRatio,i=(this.fullHeight-e[1])/this.pixelRatio;t[0]=r,t[1]=i}_computeUpGlobal(){ae(oe,this.center,this.eye);const e=Jt(this.center);e<1?(Q(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(Ft(oe,this.center))>.9999*Jt(oe)*e||(Le(this._up,oe,this.center),Le(this._up,this._up,oe),re(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){ao(oe,this.eye,this.center),Math.abs(oe[2])<=.9999&&(se(oe,oe,oe[2]),Q(this._up,-oe[0],-oe[1],1-oe[2]),re(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(e,t,r=""){typeof e[0]=="number"&&isFinite(e[0])&&typeof e[1]=="number"&&isFinite(e[1])&&typeof e[2]=="number"&&isFinite(e[2])?Tt(e,t)||(X(t,e),this._markViewDirty(),r.length&&this.notifyChange(r)):zr.getLogger("esri.views.3d.webgl-engine.lib.RenderCamera").warn("RenderCamera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&($n(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(ra(this._viewMatrix,this.eye,this.center,this.up),this.notifyChange("_viewMatrix"),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};m([R()],I.prototype,"_viewport",void 0),m([R()],I.prototype,"_padding",void 0),m([R()],I.prototype,"_fov",void 0),m([R()],I.prototype,"_nearFar",void 0),m([R()],I.prototype,"_viewDirty",void 0),m([R()],I.prototype,"_viewMatrix",void 0),m([R()],I.prototype,"_pixelRatio",void 0),m([R()],I.prototype,"pixelRatio",null),m([R()],I.prototype,"row",void 0),m([R()],I.prototype,"column",void 0),m([R()],I.prototype,"_rows",void 0),m([R()],I.prototype,"rows",null),m([R()],I.prototype,"_columns",void 0),m([R()],I.prototype,"columns",null),m([R()],I.prototype,"eye",null),m([R()],I.prototype,"center",null),m([R()],I.prototype,"_center",void 0),m([R()],I.prototype,"up",null),m([R()],I.prototype,"_up",void 0),m([R()],I.prototype,"viewMatrix",null),m([R({readOnly:!0})],I.prototype,"viewForward",null),m([R({readOnly:!0})],I.prototype,"viewUp",null),m([R({readOnly:!0})],I.prototype,"viewRight",null),m([R({readOnly:!0})],I.prototype,"nearFar",null),m([R()],I.prototype,"near",null),m([R()],I.prototype,"far",null),m([R()],I.prototype,"viewport",null),m([R({readOnly:!0})],I.prototype,"screenViewport",null),m([R({readOnly:!0})],I.prototype,"screenPadding",null),m([R()],I.prototype,"x",null),m([R()],I.prototype,"y",null),m([R()],I.prototype,"width",null),m([R()],I.prototype,"height",null),m([R()],I.prototype,"fullWidth",null),m([R()],I.prototype,"fullHeight",null),m([R({readOnly:!0})],I.prototype,"_aspect",null),m([R()],I.prototype,"padding",null),m([R({readOnly:!0})],I.prototype,"projectionMatrix",null),m([R({readOnly:!0})],I.prototype,"inverseProjectionMatrix",null),m([R()],I.prototype,"fov",null),m([R()],I.prototype,"fovX",null),m([R()],I.prototype,"fovY",null),m([R()],I.prototype,"viewInverseTransposeMatrix",null),m([R({readOnly:!0})],I.prototype,"_projectionMatrixInternal",null),m([R()],I.prototype,"relativeElevation",void 0),I=xi=m([tr("esri.views.3d.webgl.RenderCamera")],I);const Ur=I,L=Ue(),ur=W(),oe=M(),ti=M(),ri=et();var Si;(function(e){e[e.Occluded=0]="Occluded",e[e.NotOccluded=1]="NotOccluded",e[e.Both=2]="Both",e[e.COUNT=3]="COUNT"})(Si||(Si={}));function Ch(e){e.include(na),e.uniforms.add(new qe("geometryDepthTexture",(t,r)=>{var i;return(i=r.multipassGeometry.depth)==null?void 0:i.attachment})),e.code.add(w`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos);
return (elementDepth < (geometryDepth - 1.0));
}`)}let Cl=class{},xl=class{constructor(t,r){this.shadowMap=t,this.slicePlane=r,this.slot=ie.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=Fe.NONE,this.alignPixelEnabled=!1,this.decorations=Vn.ON,this.overlayStretch=1,this.viewshedEnabled=!1,this._camera=new Ur,this._inverseViewport=k(),this.oldLighting=new Qr,this.newLighting=new Qr,this._fadedLighting=new Qr,this._lighting=this.newLighting,this.ssr=new Sl,this.multipassEnabled=!1,this.multipassTerrain=new Oo,this.multipassGeometry=new Cl,this.hudRenderStyle=Si.Occluded,this.cloudsFade=new al,this.shadowHighlightsVisible=!1}get camera(){return this._camera}set camera(t){this._camera=t,this._inverseViewport[0]=1/t.fullViewport[2],this._inverseViewport[1]=1/t.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(t){const{oldLighting:r,newLighting:i}=this;t>=1?this._lighting=i:(this._fadedLighting.lerpLighting(r,i,t),this._lighting=this._fadedLighting)}},Sl=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=W()}};var Ti;(function(e){function t(o,l){const c=o[l],n=o[l+1],d=o[l+2];return Math.sqrt(c*c+n*n+d*d)}function r(o,l){const c=o[l],n=o[l+1],d=o[l+2],h=1/Math.sqrt(c*c+n*n+d*d);o[l]*=h,o[l+1]*=h,o[l+2]*=h}function i(o,l,c){o[l]*=c,o[l+1]*=c,o[l+2]*=c}function s(o,l,c,n,d,h=l){(d=d||o)[h]=o[l]+c[n],d[h+1]=o[l+1]+c[n+1],d[h+2]=o[l+2]+c[n+2]}function a(o,l,c,n,d,h=l){(d=d||o)[h]=o[l]-c[n],d[h+1]=o[l+1]-c[n+1],d[h+2]=o[l+2]-c[n+2]}e.length=t,e.normalize=r,e.scale=i,e.add=s,e.subtract=a})(Ti||(Ti={}));const ft=Ti,ii=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],Tl=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],bl=[0,0,1,0,1,1,0,1],Rl=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],xa=new Array(36);for(let e=0;e<6;e++)for(let t=0;t<6;t++)xa[6*e+t]=e;const Ke=new Array(36);for(let e=0;e<6;e++)Ke[6*e]=0,Ke[6*e+1]=1,Ke[6*e+2]=2,Ke[6*e+3]=2,Ke[6*e+4]=3,Ke[6*e+5]=0;function bh(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(24);for(let i=0;i<8;i++)r[3*i]=ii[i][0]*t[0],r[3*i+1]=ii[i][1]*t[1],r[3*i+2]=ii[i][2]*t[2];return new we(e,[[y.POSITION,new j(r,Rl,3,!0)],[y.NORMAL,new j(Tl,xa,3)],[y.UV0,new j(bl,Ke,2)]])}const si=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],Ol=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],Dl=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],Al=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];function Rh(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(18);for(let i=0;i<6;i++)r[3*i]=si[i][0]*t[0],r[3*i+1]=si[i][1]*t[1],r[3*i+2]=si[i][2]*t[2];return new we(e,[[y.POSITION,new j(r,Dl,3,!0)],[y.NORMAL,new j(Ol,Al,3)]])}const Sr=J(-.5,0,-.5),Tr=J(.5,0,-.5),br=J(0,0,.5),Rr=J(0,.5,0),mt=be(),gt=be(),It=be(),Pt=be(),Lt=be();ae(mt,Sr,Rr),ae(gt,Sr,Tr),Le(It,mt,gt),re(It,It),ae(mt,Tr,Rr),ae(gt,Tr,br),Le(Pt,mt,gt),re(Pt,Pt),ae(mt,br,Rr),ae(gt,br,Sr),Le(Lt,mt,gt),re(Lt,Lt);const ai=[Sr,Tr,br,Rr],Ml=[0,-1,0,It[0],It[1],It[2],Pt[0],Pt[1],Pt[2],Lt[0],Lt[1],Lt[2]],El=[0,1,2,3,1,0,3,2,1,3,0,2],$l=[0,0,0,1,1,1,2,2,2,3,3,3];function Oh(e,t){Array.isArray(t)||(t=[t,t,t]);const r=new Array(12);for(let i=0;i<4;i++)r[3*i]=ai[i][0]*t[0],r[3*i+1]=ai[i][1]*t[1],r[3*i+2]=ai[i][2]*t[2];return new we(e,[[y.POSITION,new j(r,El,3,!0)],[y.NORMAL,new j(Ml,$l,3)]])}function Dh(e,t,r,i,s={uv:!0}){const a=-Math.PI,o=2*Math.PI,l=-Math.PI/2,c=Math.PI,n=Math.max(3,Math.floor(r)),d=Math.max(2,Math.floor(i)),h=(n+1)*(d+1),p=De(3*h),u=De(3*h),f=De(2*h),v=[];let C=0;for(let _=0;_<=d;_++){const O=[],x=_/d,D=l+x*c,g=Math.cos(D);for(let U=0;U<=n;U++){const z=U/n,A=a+z*o,ce=Math.cos(A)*g,N=Math.sin(D),Ne=-Math.sin(A)*g;p[3*C]=ce*t,p[3*C+1]=N*t,p[3*C+2]=Ne*t,u[3*C]=ce,u[3*C+1]=N,u[3*C+2]=Ne,f[2*C]=z,f[2*C+1]=x,O.push(C),++C}v.push(O)}const T=new Array;for(let _=0;_<d;_++)for(let O=0;O<n;O++){const x=v[_][O],D=v[_][O+1],g=v[_+1][O+1],U=v[_+1][O];_===0?(T.push(x),T.push(g),T.push(U)):_===d-1?(T.push(x),T.push(D),T.push(g)):(T.push(x),T.push(D),T.push(g),T.push(g),T.push(U),T.push(x))}const S=[[y.POSITION,new j(p,T,3,!0)],[y.NORMAL,new j(u,T,3,!0)]];return s.uv&&S.push([y.UV0,new j(f,T,2,!0)]),s.offset&&(S[0][0]=y.OFFSET,S.push([y.POSITION,new j(Float64Array.from(s.offset),ha(T.length),3,!0)])),new we(e,S)}function Ah(e,t,r,i){const s=Il(t,r,i);return new we(e,s)}function Il(e,t,r){const i=e;let s,a;if(r)s=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],a=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const n=i*(1+Math.sqrt(5))/2;s=[-i,n,0,i,n,0,-i,-n,0,i,-n,0,0,-i,n,0,i,n,0,-i,-n,0,i,-n,n,0,-i,n,0,i,-n,0,-i,-n,0,i],a=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let n=0;n<s.length;n+=3)ft.scale(s,n,e/ft.length(s,n));let o={};function l(n,d){n>d&&([n,d]=[d,n]);const h=n.toString()+"."+d.toString();if(o[h])return o[h];let p=s.length;return s.length+=3,ft.add(s,3*n,s,3*d,s,p),ft.scale(s,p,e/ft.length(s,p)),p/=3,o[h]=p,p}for(let n=0;n<t;n++){const d=a.length,h=new Array(4*d);for(let p=0;p<d;p+=3){const u=a[p],f=a[p+1],v=a[p+2],C=l(u,f),T=l(f,v),S=l(v,u),_=4*p;h[_]=u,h[_+1]=C,h[_+2]=S,h[_+3]=f,h[_+4]=T,h[_+5]=C,h[_+6]=v,h[_+7]=S,h[_+8]=T,h[_+9]=C,h[_+10]=T,h[_+11]=S}a=h,o={}}const c=is(s);for(let n=0;n<c.length;n+=3)ft.normalize(c,n);return[[y.POSITION,new j(is(s),a,3,!0)],[y.NORMAL,new j(c,a,3,!0)]]}function Mh(e,t,r,i,s,a,o,l,c=null){const n=r?Ji(r):M(),d=t?Ji(t):at(0,0,1);o??(o=k());const h=i?[255*i[0],255*i[1],255*i[2],i.length>3?255*i[3]:255]:[255,255,255,255],p=s!=null&&s.length===2?s:[1,1],u=ha(1),f=[[y.POSITION,new j(n,u,3,!0)],[y.NORMAL,new j(d,u,3,!0)],[y.UV0,new j(o,u,o.length)],[y.COLOR,new j(h,u,4,!0)],[y.SIZE,new j(p,u,2)]];if(a!=null&&(a=[a[0],a[1],a[2],a[3]],f.push([y.CENTEROFFSETANDDISTANCE,new j(a,u,4)])),l){const v=[l[0],l[1],l[2],l[3]];f.push([y.FEATUREATTRIBUTE,new j(v,u,4)])}return new we(e,f,null,jt.Point,c)}const Pl=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function Eh(e,t=Pl){const r=new Array(12);for(let n=0;n<4;n++)for(let d=0;d<3;d++)r[3*n+d]=t[n][d];const i=[0,1,2,2,3,0],s=[0,0,1],a=[0,0,0,0,0,0],o=[0,0,1,0,1,1,0,1],l=[255,255,255,255],c=[[y.POSITION,new j(r,i,3,!0)],[y.NORMAL,new j(s,a,3,!0)],[y.UV0,new j(o,i,2,!0)],[y.COLOR,new j(l,a,4,!0)]];return new we(e,c)}function $h(e,t,r,i,s,a=!0,o=!0){let l=0;const c=r,n=t;let d=J(0,l,0),h=J(0,l+n,0),p=J(0,-1,0),u=J(0,1,0);s&&(l=n,h=J(0,0,0),d=J(0,l,0),p=J(0,1,0),u=J(0,-1,0));const f=[h,d],v=[p,u],C=i+2,T=Math.sqrt(n*n+c*c);if(s)for(let g=i-1;g>=0;g--){const U=g*(2*Math.PI/i),z=J(Math.cos(U)*c,l,Math.sin(U)*c);f.push(z);const A=J(n*Math.cos(U)/T,-c/T,n*Math.sin(U)/T);v.push(A)}else for(let g=0;g<i;g++){const U=g*(2*Math.PI/i),z=J(Math.cos(U)*c,l,Math.sin(U)*c);f.push(z);const A=J(n*Math.cos(U)/T,c/T,n*Math.sin(U)/T);v.push(A)}const S=new Array,_=new Array;if(a){for(let g=3;g<f.length;g++)S.push(1),S.push(g-1),S.push(g),_.push(0),_.push(0),_.push(0);S.push(f.length-1),S.push(2),S.push(1),_.push(0),_.push(0),_.push(0)}if(o){for(let g=3;g<f.length;g++)S.push(g),S.push(g-1),S.push(0),_.push(g),_.push(g-1),_.push(1);S.push(0),S.push(2),S.push(f.length-1),_.push(1),_.push(2),_.push(v.length-1)}const O=De(3*C);for(let g=0;g<C;g++)O[3*g]=f[g][0],O[3*g+1]=f[g][1],O[3*g+2]=f[g][2];const x=De(3*C);for(let g=0;g<C;g++)x[3*g]=v[g][0],x[3*g+1]=v[g][1],x[3*g+2]=v[g][2];const D=[[y.POSITION,new j(O,S,3,!0)],[y.NORMAL,new j(x,_,3,!0)]];return new we(e,D)}function Ih(e,t,r,i,s,a,o){const l=s?rs(s):J(1,0,0),c=a?rs(a):J(0,0,0);o??(o=!0);const n=be();re(n,l);const d=be();se(d,n,Math.abs(t));const h=be();se(h,d,-.5),le(h,h,c);const p=J(0,1,0);Math.abs(1-Ft(n,p))<.2&&Q(p,0,0,1);const u=be();Le(u,n,p),re(u,u),Le(p,u,n);const f=2*i+(o?2:0),v=i+(o?2:0),C=De(3*f),T=De(3*v),S=De(2*f),_=new Array(3*i*(o?4:2)),O=new Array(3*i*(o?4:2));o&&(C[3*(f-2)]=h[0],C[3*(f-2)+1]=h[1],C[3*(f-2)+2]=h[2],S[2*(f-2)]=0,S[2*(f-2)+1]=0,C[3*(f-1)]=C[3*(f-2)]+d[0],C[3*(f-1)+1]=C[3*(f-2)+1]+d[1],C[3*(f-1)+2]=C[3*(f-2)+2]+d[2],S[2*(f-1)]=1,S[2*(f-1)+1]=1,T[3*(v-2)]=-n[0],T[3*(v-2)+1]=-n[1],T[3*(v-2)+2]=-n[2],T[3*(v-1)]=n[0],T[3*(v-1)+1]=n[1],T[3*(v-1)+2]=n[2]);const x=(A,ce,N)=>{_[A]=ce,O[A]=N};let D=0;const g=be(),U=be();for(let A=0;A<i;A++){const ce=A*(2*Math.PI/i);se(g,p,Math.sin(ce)),se(U,u,Math.cos(ce)),le(g,g,U),T[3*A]=g[0],T[3*A+1]=g[1],T[3*A+2]=g[2],se(g,g,r),le(g,g,h),C[3*A]=g[0],C[3*A+1]=g[1],C[3*A+2]=g[2],S[2*A]=A/i,S[2*A+1]=0,C[3*(A+i)]=C[3*A]+d[0],C[3*(A+i)+1]=C[3*A+1]+d[1],C[3*(A+i)+2]=C[3*A+2]+d[2],S[2*(A+i)]=A/i,S[2*A+1]=1;const N=(A+1)%i;x(D++,A,A),x(D++,A+i,A),x(D++,N,N),x(D++,N,N),x(D++,A+i,A),x(D++,N+i,N)}if(o){for(let A=0;A<i;A++){const ce=(A+1)%i;x(D++,f-2,v-2),x(D++,A,v-2),x(D++,ce,v-2)}for(let A=0;A<i;A++){const ce=(A+1)%i;x(D++,A+i,v-1),x(D++,f-1,v-1),x(D++,ce+i,v-1)}}const z=[[y.POSITION,new j(C,_,3,!0)],[y.NORMAL,new j(T,O,3,!0)],[y.UV0,new j(S,_,2,!0)]];return new we(e,z)}function Ph(e,t,r,i,s,a){i=i||10,s=s==null||s,pe(t.length>1);const o=[[0,0,0]],l=[],c=[];for(let n=0;n<i;n++){l.push([0,-n-1,-(n+1)%i-1]);const d=n/i*2*Math.PI;c.push([Math.cos(d)*r,Math.sin(d)*r])}return Ll(e,c,t,o,l,s,a)}function Ll(e,t,r,i,s,a,o=J(0,0,0)){const l=t.length,c=De(r.length*l*3+(6*i.length||0)),n=De(r.length*l*3+(i?6:0)),d=new Array,h=new Array;let p=0,u=0;const f=M(),v=M(),C=M(),T=M(),S=M(),_=M(),O=M(),x=M(),D=M(),g=M(),U=M(),z=M(),A=M(),ce=rr();Q(D,0,1,0),ae(v,r[1],r[0]),re(v,v),a?(le(x,r[0],o),re(C,x)):Q(C,0,0,1),Ts(v,C,D,D,S,C,bs),X(T,C),X(z,S);for(let $=0;$<i.length;$++)se(_,S,i[$][0]),se(x,C,i[$][2]),le(_,_,x),le(_,_,r[0]),c[p++]=_[0],c[p++]=_[1],c[p++]=_[2];n[u++]=-v[0],n[u++]=-v[1],n[u++]=-v[2];for(let $=0;$<s.length;$++)d.push(s[$][0]>0?s[$][0]:-s[$][0]-1+i.length),d.push(s[$][1]>0?s[$][1]:-s[$][1]-1+i.length),d.push(s[$][2]>0?s[$][2]:-s[$][2]-1+i.length),h.push(0),h.push(0),h.push(0);let N=i.length;const Ne=i.length-1;for(let $=0;$<r.length;$++){let B=!1;$>0&&(X(f,v),$<r.length-1?(ae(v,r[$+1],r[$]),re(v,v)):B=!0,le(g,f,v),re(g,g),le(U,r[$-1],T),ln(r[$],g,ce),cn(ce,hn(U,f),x)?(ae(x,x,r[$]),re(C,x),Le(S,g,C),re(S,S)):Ts(g,T,z,D,S,C,bs),X(T,C),X(z,S)),a&&(le(x,r[$],o),re(A,x));for(let K=0;K<l;K++)if(se(_,S,t[K][0]),se(x,C,t[K][1]),le(_,_,x),re(O,_),n[u++]=O[0],n[u++]=O[1],n[u++]=O[2],le(_,_,r[$]),c[p++]=_[0],c[p++]=_[1],c[p++]=_[2],!B){const ge=(K+1)%l;d.push(N+K),d.push(N+l+K),d.push(N+ge),d.push(N+ge),d.push(N+l+K),d.push(N+l+ge);for(let Ve=0;Ve<6;Ve++){const ct=d.length-6;h.push(d[ct+Ve]-Ne)}}N+=l}const Vt=r[r.length-1];for(let $=0;$<i.length;$++)se(_,S,i[$][0]),se(x,C,i[$][1]),le(_,_,x),le(_,_,Vt),c[p++]=_[0],c[p++]=_[1],c[p++]=_[2];const je=u/3;n[u++]=v[0],n[u++]=v[1],n[u++]=v[2];const lt=N-l;for(let $=0;$<s.length;$++)d.push(s[$][0]>=0?N+s[$][0]:-s[$][0]-1+lt),d.push(s[$][2]>=0?N+s[$][2]:-s[$][2]-1+lt),d.push(s[$][1]>=0?N+s[$][1]:-s[$][1]-1+lt),h.push(je),h.push(je),h.push(je);const sr=[[y.POSITION,new j(c,d,3,!0)],[y.NORMAL,new j(n,h,3,!0)]];return new we(e,sr)}function Lh(e,t,r,i){pe(t.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),pe(t[0].length===3,"createPolylineGeometry(): malformed vertex"),pe(r==null||r.length===t.length,"createPolylineGeometry: need same number of points and normals"),pe(r==null||r[0].length===3,"createPolylineGeometry(): malformed normal");const s=Ro(3*t.length),a=new Array(2*(t.length-1));let o=0,l=0;for(let n=0;n<t.length;n++){for(let d=0;d<3;d++)s[o++]=t[n][d];n>0&&(a[l++]=n-1,a[l++]=n)}const c=[[y.POSITION,new j(s,a,3,!0)]];if(r){const n=De(3*r.length);let d=0;for(let h=0;h<t.length;h++)for(let p=0;p<3;p++)n[d++]=r[h][p];c.push([y.NORMAL,new j(n,a,3,!0)])}return i&&c.push([y.COLOR,new j(i,on(i.length/4),4)]),new we(e,c,null,jt.Line)}function Fh(e,t,r,i,s,a=0){const o=new Array(18),l=[[-r,a,s/2],[i,a,s/2],[0,t+a,s/2],[-r,a,-s/2],[i,a,-s/2],[0,t+a,-s/2]],c=[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5];for(let n=0;n<6;n++)o[3*n]=l[n][0],o[3*n+1]=l[n][1],o[3*n+2]=l[n][2];return new we(e,[[y.POSITION,new j(o,c,3,!0)]])}function Nh(e,t){const r=e.getMutableAttribute(y.POSITION).data;for(let i=0;i<r.length;i+=3){const s=r[i],a=r[i+1],o=r[i+2];Q(vt,s,a,o),ye(vt,vt,t),r[i]=vt[0],r[i+1]=vt[1],r[i+2]=vt[2]}}function jh(e,t=e){const r=e.attributes,i=r.get(y.POSITION).data,s=r.get(y.NORMAL).data;if(s){const a=t.getMutableAttribute(y.NORMAL).data;for(let o=0;o<s.length;o+=3){const l=s[o+1];a[o+1]=-s[o+2],a[o+2]=l}}if(i){const a=t.getMutableAttribute(y.POSITION).data;for(let o=0;o<i.length;o+=3){const l=i[o+1];a[o+1]=-i[o+2],a[o+2]=l}}}function oi(e,t,r,i,s){return!(Math.abs(Ft(t,e))>s)&&(Le(r,e,t),re(r,r),Le(i,r,e),re(i,i),!0)}function Ts(e,t,r,i,s,a,o){return oi(e,t,s,a,o)||oi(e,r,s,a,o)||oi(e,i,s,a,o)}const bs=.99619469809,vt=M(),Fl={required:[]},Vh={required:[E.Depth]};let Hr=class extends Mi{consumes(){return Fl}get usedMemory(){return 0}get isDecoration(){return!1}get running(){return!1}get materialReference(){return null}modify(t){}get numGeometries(){return 0}get hasOccludees(){return!1}queryRenderOccludedState(t){return!1}},Nl=class extends Hr{},jl=class extends Hr{constructor(){super(...arguments),this.drapedPriority=0}},Gh=class extends Hr{},Bh=class extends Hr{};function qh(e){return"prepareTechnique"in e}function Zh(e){return"prepareTechniques"in e}function Qh(e,t,r,i,s,a,o,l,c,n,d){const h=kl[d.mode];let p,u,f=0;if(yi(e,t,r,i,c.spatialReference,s,l))return h.requiresAlignment(d)?(f=h.applyElevationAlignmentBuffer(i,s,a,o,l,c,n,d),p=a,u=o):(p=i,u=s),yi(p,c.spatialReference,u,a,n.spatialReference,o,l)?f:void 0}function Sa(e,t,r,i,s){const a=(yn(e)?e.z:wn(e)?e.array[e.offset+2]:e[2])||0;switch(r.mode){case"on-the-ground":{const o=cr(t,e,"ground")??0;return s.verticalDistanceToGround=0,s.sampledElevation=o,void(s.z=o)}case"relative-to-ground":{const o=cr(t,e,"ground")??0,l=r.geometryZWithOffset(a,i);return s.verticalDistanceToGround=l,s.sampledElevation=o,void(s.z=l+o)}case"relative-to-scene":{const o=cr(t,e,"scene")??0,l=r.geometryZWithOffset(a,i);return s.verticalDistanceToGround=l,s.sampledElevation=o,void(s.z=l+o)}case"absolute-height":{const o=r.geometryZWithOffset(a,i),l=cr(t,e,"ground")??0;return s.verticalDistanceToGround=o-l,s.sampledElevation=l,void(s.z=o)}default:return void(s.z=0)}}function Jh(e,t,r,i){return Sa(e,t,r,i,Dt),Dt.z}function Yh(e,t,r){return t==="on-the-ground"&&r==="on-the-ground"?e.staysOnTheGround:t===r||t!=="on-the-ground"&&r!=="on-the-ground"?t==null||r==null?e.definedChanged:bi.UPDATE:e.onTheGroundChanged}function Xh(e){return e==="relative-to-ground"||e==="relative-to-scene"}function Kh(e){return e!=="absolute-height"}function eu(e,t,r,i,s){Sa(t,r,s,i,Dt),Vl(e,Dt.verticalDistanceToGround);const a=Dt.sampledElevation,o=st(ql,e.transformation);return pr[0]=t.x,pr[1]=t.y,pr[2]=Dt.z,_n(t.spatialReference,pr,o,i.spatialReference)?e.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),a}function Vl(e,t){for(let r=0;r<e.geometries.length;++r){const i=e.geometries[r].getMutableAttribute(y.CENTEROFFSETANDDISTANCE);i&&i.data[3]!==t&&(i.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[r],y.CENTEROFFSETANDDISTANCE))}}function zl(e,t,r,i,s,a){let o=0;const l=a.spatialReference;t*=3,i*=3;for(let c=0;c<s;++c){const n=e[t],d=e[t+1],h=e[t+2],p=a.getElevation(n,d,h,l,"ground")??0;o+=p,r[i]=n,r[i+1]=d,r[i+2]=p,t+=3,i+=3}return o/s}function Ul(e,t,r,i,s,a,o,l){let c=0;const n=l.calculateOffsetRenderUnits(o),d=l.featureExpressionInfoContext,h=a.spatialReference;t*=3,i*=3;for(let p=0;p<s;++p){const u=e[t],f=e[t+1],v=e[t+2],C=a.getElevation(u,f,v,h,"ground")??0;c+=C,r[i]=u,r[i+1]=f,r[i+2]=d==null?v+C+n:C+n,t+=3,i+=3}return c/s}function Hl(e,t,r,i,s,a,o,l){let c=0;const n=l.calculateOffsetRenderUnits(o),d=l.featureExpressionInfoContext,h=a.spatialReference;t*=3,i*=3;for(let p=0;p<s;++p){const u=e[t],f=e[t+1],v=e[t+2],C=a.getElevation(u,f,v,h,"scene")??0;c+=C,r[i]=u,r[i+1]=f,r[i+2]=d==null?v+C+n:C+n,t+=3,i+=3}return c/s}function Gl(e){const t=e.meterUnitOffset,r=e.featureExpressionInfoContext;return t!==0||r!=null}function Wl(e,t,r,i,s,a,o,l){const c=l.calculateOffsetRenderUnits(o),n=l.featureExpressionInfoContext;t*=3,i*=3;for(let d=0;d<s;++d){const h=e[t],p=e[t+1],u=e[t+2];r[i]=h,r[i+1]=p,r[i+2]=n==null?u+c:c,t+=3,i+=3}return 0}class Bl{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}var bi;(function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"})(bi||(bi={}));const kl={"absolute-height":{applyElevationAlignmentBuffer:Wl,requiresAlignment:Gl},"on-the-ground":{applyElevationAlignmentBuffer:zl,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:Ul,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:Hl,requiresAlignment:()=>!0}},ql=W(),Dt=new Bl,pr=M(),Zl=()=>zr.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function Ql(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}function tu(e){const t=e==null?void 0:e.expression;if(typeof t=="string"){const r=ba(t);if(r!=null)return{cachedResult:r}}return null}async function ru(e,t,r,i){const s=e==null?void 0:e.expression;if(typeof s!="string")return null;const a=ba(s);if(a!=null)return{cachedResult:a};const o=await oo();no(r);const l=o.arcadeUtils,c=l.createSyntaxTree(s);return l.dependsOnView(c)?(i!=null&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:l.createFunction(c),context:l.createExecContext(null,{sr:t}),modules:o}}}function Jl(e,t,r){return e.arcadeUtils.createFeature(t.attributes,t.geometry,r)}function Yl(e,t){if(e!=null&&!Ta(e)){if(!t||!e.arcade)return void Zl().errorOncePerTick("Arcade support required but not provided");const r=t;r._geometry&&(r._geometry=Sn(r._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function Xl(e){if(e!=null){if(Ta(e))return e.cachedResult;const t=e.arcade;let r=t==null?void 0:t.modules.arcadeUtils.executeFunction(t.func,t.context);return typeof r!="number"&&(e.cachedResult=0,r=0),r}return 0}function iu(e,t=!1){let r=e==null?void 0:e.featureExpressionInfo;const i=r==null?void 0:r.expression;return t||i==="0"||(r=null),r??null}const su={cachedResult:0};function Ta(e){return e.cachedResult!=null}function ba(e){return e==="0"?0:null}let au=class Ra{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(t){this._unit=t,this._metersPerElevationInfoUnit=lo(t)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(t){this._meterUnitOffset=t,this._renderUnitOffset=0}set offsetElevationInfoUnits(t){this._meterUnitOffset=t*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(t){this._renderUnitOffset+=t}geometryZWithOffset(t,r){const i=this.calculateOffsetRenderUnits(r);return this.featureExpressionInfoContext!=null?i:t+i}calculateOffsetRenderUnits(t){let r=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return i!=null&&(r+=Xl(i)*this._metersPerElevationInfoUnit),r/t.unitInMeters+this._renderUnitOffset}setFromElevationInfo(t){this.mode=t.mode,this.unit=co(t.unit)?t.unit:"meters",this.offsetElevationInfoUnits=t.offset??0}updateFeatureExpressionInfoContext(t,r,i){if(t==null)return void(this._featureExpressionInfoContext=null);const s=t==null?void 0:t.arcade;s&&r!=null&&i!=null?(this._featureExpressionInfoContext=Ql(t),Yl(this._featureExpressionInfoContext,Jl(s.modules,r,i))):this._featureExpressionInfoContext=t}static fromElevationInfo(t){const r=new Ra;return t!=null&&r.setFromElevationInfo(t),r}},Kl=class extends pa{get geometries(){return this._geometries}get transformation(){return this._transformation??We}set transformation(t){this._transformation=st(this._transformation??W(),t),this._invalidateBoundingVolume(),this._emit("transformationChanged",this)}get shaderTransformation(){return this._shaderTransformation}set shaderTransformation(t){this._shaderTransformation=t?st(this._shaderTransformation??W(),t):null,this._invalidateBoundingVolume(),this._emit("shaderTransformationChanged",this)}get effectiveTransformation(){return this.shaderTransformation??this.transformation}constructor(t={}){super(),this.type=jt.Object,this._shaderTransformation=null,this._parentLayer=null,this._visible=!0,this.castShadow=t.castShadow??!0,this.usesVerticalDistanceToGround=t.usesVerticalDistanceToGround??!1,this.graphicUid=t.graphicUid,this.layerUid=t.layerUid,t.isElevationSource&&(this.lastValidElevationBB=new Oa),this._geometries=t.geometries?Array.from(t.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(t){pe(this._parentLayer==null||t==null,"Object3D can only be added to a single Layer"),this._parentLayer=t}addGeometry(t){t.visible=this._visible,this._geometries.push(t),this._emit("geometryAdded",{object:this,geometry:t}),this._invalidateBoundingVolume()}removeGeometry(t){const r=this._geometries.splice(t,1)[0];r&&(this._emit("geometryRemoved",{object:this,geometry:r}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttributeUpdated(t,r,i=!1){this._emit("attributesChanged",{object:this,geometry:t,attribute:r,sync:i}),vn(r)&&this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(t){if(this._visible!==t){this._visible=t;for(const r of this._geometries)r.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const t=new ss(ys.MaskOccludee);for(const r of this._geometries)r.occludees=as(r.occludees,t);return this._emit("occlusionChanged",this),t}removeOcclude(t){for(const r of this._geometries)r.occludees=os(r.occludees,t);this._emit("occlusionChanged",this)}highlight(){const t=new ss(ys.Highlight);for(const r of this._geometries)r.highlights=as(r.highlights,t);return this._emit("highlightChanged",this),t}removeHighlight(t){for(const r of this._geometries)r.highlights=os(r.highlights,t);this._emit("highlightChanged",this)}getCombinedStaticTransformation(t,r){return ke(r,this.transformation,t.transformation)}getCombinedShaderTransformation(t,r=W()){return ke(r,this.effectiveTransformation,t.transformation)}get boundingVolumeWorldSpace(){return this._bvWorldSpace||(this._bvWorldSpace=this._bvWorldSpace||new Rs,this._validateBoundingVolume(this._bvWorldSpace,qt.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace||(this._bvObjectSpace=this._bvObjectSpace||new Rs,this._validateBoundingVolume(this._bvObjectSpace,qt.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(t,r){const i=r===qt.ObjectSpace;for(const s of this._geometries){const a=s.boundingInfo;a&&ec(a,t,i?s.transformation:this.getCombinedShaderTransformation(s))}ho(Er(t.bounds),t.min,t.max,.5);for(const s of this._geometries){const a=s.boundingInfo;if(a==null)continue;const o=i?s.transformation:this.getCombinedShaderTransformation(s),l=_a(o);ye(Os,a.center,o);const c=Vr(Os,Er(t.bounds)),n=a.radius*l;t.bounds[3]=Math.max(t.bounds[3],c+n)}}_invalidateBoundingVolume(){var r;const t=(r=this._bvWorldSpace)==null?void 0:r.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&t&&this._parentLayer.notifyObjectBBChanged(this,t)}_emit(t,r){this._parentLayer&&this._parentLayer.events.emit(t,r)}get test(){}},Oa=class{constructor(){this.min=at(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=at(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}},Rs=class extends Oa{constructor(){super(...arguments),this.bounds=ua()}};function ec(e,t,r){const i=e.bbMin,s=e.bbMax;if(uo(r)){const a=Q(tc,r[12],r[13],r[14]);le(ve,i,a),le(Se,s,a);for(let o=0;o<3;++o)t.min[o]=Math.min(t.min[o],ve[o]),t.max[o]=Math.max(t.max[o],Se[o])}else if(ye(ve,i,r),Tt(i,s))for(let a=0;a<3;++a)t.min[a]=Math.min(t.min[a],ve[a]),t.max[a]=Math.max(t.max[a],ve[a]);else{ye(Se,s,r);for(let a=0;a<3;++a)t.min[a]=Math.min(t.min[a],ve[a],Se[a]),t.max[a]=Math.max(t.max[a],ve[a],Se[a]);for(let a=0;a<3;++a){X(ve,i),X(Se,s),ve[a]=s[a],Se[a]=i[a],ye(ve,ve,r),ye(Se,Se,r);for(let o=0;o<3;++o)t.min[o]=Math.min(t.min[o],ve[o],Se[o]),t.max[o]=Math.max(t.max[o],ve[o],Se[o])}}}const tc=M(),ve=M(),Se=M(),Os=M();var qt;(function(e){e[e.WorldSpace=0]="WorldSpace",e[e.ObjectSpace=1]="ObjectSpace"})(qt||(qt={}));var Zt,Lr,Ri;(function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"})(Zt||(Zt={})),function(e){e[e.MapLayer=0]="MapLayer",e[e.ViewLayer=1]="ViewLayer",e[e.Outline=2]="Outline",e[e.SnappingHint=3]="SnappingHint"}(Lr||(Lr={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(Ri||(Ri={}));var Oe,Ds,As,Ms;(function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"})(Oe||(Oe={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(Ds||(Ds={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(As||(As={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(Ms||(Ms={}));let rc=class{constructor(t,r){this.vec3=t,this.id=r}};function Oi(e,t,r,i){return new rc(at(e,t,r),i)}let Es=class{constructor(){this._extent=Cr(),this.resolution=0,this.renderLocalOrigin=Oi(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new ic}get extent(){return this._extent}setupGeometryViewsCyclical(t){this.setupGeometryViewsDirect();const r=.001*t.range;if(this._extent[0]-r<=t.min){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Yi(this._extent,t.range,0,i)}if(this._extent[2]+r>=t.max){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];Yi(this._extent,-t.range,0,i)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,po(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let t=0;t<this.canvasGeometries.numViews;t++){const r=this.canvasGeometries.extents[t];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}},ic=class{constructor(){this.extents=[Cr(),Cr(),Cr()],this.numViews=0}};var Y;(function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.WaterNormal=3]="WaterNormal",e[e.Occluded=4]="Occluded",e[e.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"})(Y||(Y={}));let sc=class{constructor(t,r,i){this._fbos=t,this._format=r,this._name=i}get valid(){var t;return((t=this._handle)==null?void 0:t.getTexture())!=null}dispose(){this._handle=Dr(this._handle)}get texture(){var t;return(t=this._handle)==null?void 0:t.getTexture()}bind(t,r,i){var s,a,o,l,c,n;this._handle&&((s=this._handle.fbo)==null?void 0:s.width)===r&&((a=this._handle.fbo)==null?void 0:a.height)===i||((o=this._handle)==null||o.release(),this._handle=this._fbos.acquire(r,i,this._name,this._format)),t.unbindTexture((c=(l=this._handle)==null?void 0:l.fbo)==null?void 0:c.colorTexture),t.bindFramebuffer((n=this._handle)==null?void 0:n.fbo)}generateMipMap(){var t,r,i,s,a;(i=(r=(t=this._handle)==null?void 0:t.getTexture())==null?void 0:r.descriptor)!=null&&i.hasMipmap&&((a=(s=this._handle)==null?void 0:s.getTexture())==null||a.generateMipmap())}},_t=class{constructor(t,r,i,s,a=Mr.RGBA_MIPMAP){this.output=i,this.content=s,this.fbo=new sc(t,a,r)}get valid(){return this.fbo.valid}},ac=class{constructor(t){this.targets=[new _t(t,"overlay color",E.Color,Y.Color),new _t(t,"overlay IM color",E.Color,Y.ColorNoRasterImage),new _t(t,"overlay highlight",E.Highlight,Y.Highlight,Mr.RGBA4),new _t(t,"overlay water",E.Normal,Y.WaterNormal),new _t(t,"overlay occluded",E.Color,Y.Occluded)],Et("enable-feature:objectAndLayerId-rendering")&&this.targets.push(new _t(t,"overlay oid",E.ObjectAndLayerIdColor,Y.ObjectAndLayerIdColor))}getTexture(t){var r;return(r=this.targets[t])==null?void 0:r.fbo.texture}dispose(){for(const t of this.targets)t.fbo.dispose()}computeValidity(){return this.targets.reduce((t,r,i)=>r.valid?t|=1<<i:t,0)}},Gr=class extends Do{constructor(){super(...arguments),this.slicePlaneLocalOrigin=M(),this.origin=this.slicePlaneLocalOrigin,this.modelTransformation=null}};var He;(function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight",e[e.ViewshedShadowMap=3]="ViewshedShadowMap"})(He||(He={}));let gu=class extends Gr{constructor(){super(...arguments),this.identifier=He.Material,this.output=E.Color,this.transparent=!1}},_u=class extends Gr{constructor(){super(...arguments),this.identifier=He.ShadowMap}},wu=class extends Gr{constructor(){super(...arguments),this.identifier=He.Highlight}},xu=class extends Gr{constructor(){super(...arguments),this.identifier=He.ViewshedShadowMap}};function Tu(e){e.fragment.code.add(w`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function oc(e){e.fragment.code.add(w`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function nc(e,t){const r=e.fragment;r.include(na),r.uniforms.add(new la("nearFar",(i,s)=>s.camera.nearFar)),r.uniforms.add(new qe("depthMap",(i,s)=>{var a;return(a=s.depth)==null?void 0:a.attachment})),r.uniforms.add(new Nt("proj",(i,s)=>s.camera.projectionMatrix)),r.uniforms.add(new Z("invResolutionHeight",(i,s)=>1/s.camera.height)),r.uniforms.add(new Nt("reprojectionMatrix",(i,s)=>s.ssr.reprojectionMatrix)),r.code.add(w`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${t.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        return vec3(P, depth);
      }

      // continue with ray marching
      P = clamp(P + dP, vec2(0.0), vec2(0.999));
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function lc(e,t){e.include(Ao,t),e.include(rl),e.include(oc),t.hasCloudsReflections&&e.include(ul,t),t.hasScreenSpaceReflections&&e.include(nc,t);const r=e.fragment;r.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",Mo).add("ssrHeightFadeEnd","float",Eo).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),r.code.add(w`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),r.uniforms.add(new Z("lightingSpecularStrength",(i,s)=>s.lighting.mainLight.specularStrength),new Z("lightingEnvironmentStrength",(i,s)=>s.lighting.mainLight.environmentStrength)),r.code.add(w`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.hasCloudsReflections&&r.code.add(w`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);`),t.hasScreenSpaceReflections?(r.uniforms.add(new Nt("view",(i,s)=>s.camera.viewMatrix),new qe("lastFrameColorTexture",(i,s)=>{var a;return(a=s.ssr.lastFrameColor)==null?void 0:a.getTexture()}),new Z("fadeFactorSSR",(i,s)=>s.ssr.fadeFactor)),r.code.add(w`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`)):r.code.add(w`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.hasCloudsReflections?t.hasScreenSpaceReflections?r.code.add(w`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):r.code.add(w`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):r.code.add(w`return waterRenderedColor;
}`)}var At;function bu(e,t){const{vertex:r,fragment:i}=e;r.uniforms.add(new _s("overlayTexOffset",(s,a)=>dc(s,a)),new _s("overlayTexScale",(s,a)=>hc(s,a))),i.constants.add("overlayOpacity","float",1),i.uniforms.add(new qe("ovColorTex",(s,a)=>cc(s,a))),Da(e,t)}function Ru(e,t){const{vertex:r,fragment:i}=e;r.uniforms.add(new $s("overlayTexOffset"),new $s("overlayTexScale")),i.uniforms.add(new Z("overlayOpacity",s=>s.overlayOpacity),new qe("ovColorTex",(s,a)=>{var o;return(o=a.overlay)==null?void 0:o.getTexture(s.overlayContent)})),Da(e,t)}(function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"})(At||(At={}));let $s=class extends ma{constructor(t){super(t,"vec4")}};function Da(e,t){t.pbrMode!==dt.Water&&t.pbrMode!==dt.WaterOnIntegratedMesh&&t.pbrMode!==dt.TerrainWithWater||e.include(lc,t);const{vertex:r,fragment:i}=e;e.varyings.add("vtcOverlay","vec4"),r.code.add(w`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),i.code.add(w`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),i.code.add(w`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),i.code.add(w`vec4 getOverlayColorTexel(vec4 texCoords) {
vec2 texDim =  vec2(textureSize(ovColorTex, 0));
vec4 color0 = texelFetch(ovColorTex, ivec2(vec2(texCoords.x * 0.5, texCoords.y) * texDim), 0);
vec4 color1 = texelFetch(ovColorTex, ivec2(vec2(texCoords.z * 0.5 + 0.5, texCoords.w) * texDim), 0);
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),t.pbrMode!==dt.Water&&t.pbrMode!==dt.WaterOnIntegratedMesh&&t.pbrMode!==dt.TerrainWithWater||(aa(i),oa(i),i.code.add(w`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function cc(e,t){var r,i,s;return e.identifier===He.Material&&e.output===E.Color?(r=t.overlay)==null?void 0:r.getTexture(Y.ColorNoRasterImage):e.identifier===He.Material&&e.output===E.ObjectAndLayerIdColor?(i=t.overlay)==null?void 0:i.getTexture(Y.ObjectAndLayerIdColor):e.identifier===He.Highlight?(s=t.overlay)==null?void 0:s.getTexture(Y.Highlight):null}function dc(e,t){var s,a,o,l;const r=(a=(s=t.overlay)==null?void 0:s.overlays[Oe.INNER])==null?void 0:a.extent;Ar(r)&&($e[0]=e.toMapSpace[0]/bt(r)-r[0]/bt(r),$e[1]=e.toMapSpace[1]/Rt(r)-r[1]/Rt(r));const i=(l=(o=t.overlay)==null?void 0:o.overlays[Oe.OUTER])==null?void 0:l.extent;return Ar(i)&&($e[2]=e.toMapSpace[0]/bt(i)-i[0]/bt(i),$e[3]=e.toMapSpace[1]/Rt(i)-i[1]/Rt(i)),$e}function hc(e,t){var s,a,o,l;const r=(a=(s=t.overlay)==null?void 0:s.overlays[Oe.INNER])==null?void 0:a.extent;Ar(r)&&($e[0]=e.toMapSpace[2]/bt(r),$e[1]=e.toMapSpace[3]/Rt(r));const i=(l=(o=t.overlay)==null?void 0:o.overlays[Oe.OUTER])==null?void 0:l.extent;return Ar(i)&&($e[2]=e.toMapSpace[2]/bt(i),$e[3]=e.toMapSpace[3]/Rt(i)),$e}const $e=Ue();let Aa=class extends ga{constructor(){super(...arguments),this.color=at(1,1,1)}};function uc(){const e=new Ii;return e.include(ca),e.fragment.uniforms.add(new qe("tex",t=>t.texture),new tt("uColor",t=>t.color)),e.fragment.code.add(w`void main() {
vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);
}`),e}const pc=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:Aa,build:uc},Symbol.toStringTag,{value:"Module"}));let fc=class{constructor(t){this._context=t,this._perConstructorInstances=new zi,this._frameCounter=0,this._keepAliveFrameCount=Is}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach(t=>t.forEach(r=>r.technique.destroy())),this._perConstructorInstances.clear()}acquire(t,r=gc){const i=r.key;let s=this._perConstructorInstances.get(t,i);if(s==null){const a=new t(this._context,r,()=>this.release(a));s=new mc(a),this._perConstructorInstances.set(t,i,s)}return++s.refCount,s.technique}releaseAndAcquire(t,r,i){if(i!=null){if(r.key===i.key)return i;this.release(i)}return this.acquire(t,r)}release(t){if(t==null||this._perConstructorInstances.empty)return;const r=this._perConstructorInstances.get(t.constructor,t.key);r!=null&&(--r.refCount,r.refCount===0&&(r.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==Is&&this._perConstructorInstances.forEach((t,r)=>{t.forEach((i,s)=>{i.refCount===0&&i.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(i.technique.destroy(),this._perConstructorInstances.delete(r,s))})})}async reloadAll(){const t=new Array;this._perConstructorInstances.forEach((r,i)=>{const s=async(a,o)=>{const l=o.shader;l&&(await l.reload(),a.forEach(c=>c.technique.reload(this._context)))};t.push(s(r,i))}),await Promise.all(t)}},mc=class{constructor(t){this.technique=t,this.refCount=0,this.refZeroFrame=0}};const Is=-1,gc=new va;let vc=class{constructor(t,r,i,s){this._textures=t,this._techniques=r,this.materialChanged=i,this.requestRender=s,this._id2glMaterialRef=new zi}dispose(){this._textures.destroy()}acquire(t,r,i){this._ownMaterial(t);const s=t.produces.get(r);if(!(s!=null&&s(i)))return null;let a=this._id2glMaterialRef.get(i,t.id);if(a==null){const o=t.createGLMaterial({material:t,techniques:this._techniques,textures:this._textures,output:i});a=new _c(o),this._id2glMaterialRef.set(i,t.id,a)}return a.ref(),a.glMaterial}release(t,r){const i=this._id2glMaterialRef.get(r,t.id);i!=null&&(i.unref(),i.referenced||(Yt(i.glMaterial),this._id2glMaterialRef.delete(r,t.id)))}_ownMaterial(t){t.repository&&t.repository!==this&&zr.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),t.repository=this}},_c=class{constructor(t){this.glMaterial=t,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,pe(this._refCnt>=0)}get referenced(){return this._refCnt>0}};const yc=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","transformationChanged","shaderTransformationChanged","visibilityChanged","occlusionChanged","highlightChanged","geometryAdded","geometryRemoved","attributesChanged"];var Kt;(function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"})(Kt||(Kt={}));let wc=class extends pa{get objects(){return this._objects}constructor(t,r,i=""){super(),this.stage=t,this.apiLayerUid=i,this.type=jt.Layer,this.events=new ia,this.visible=!0,this.pickable=!0,this.sliceable=!1,this._objects=new Pe,this._objectsAdded=new Pe,this._handles=new fo,this.apiLayerUid=i,this.visible=(r==null?void 0:r.visible)??!0,this.pickable=(r==null?void 0:r.pickable)??!0,this.updatePolicy=(r==null?void 0:r.updatePolicy)??Kt.ASYNC,this._disableOctree=(r==null?void 0:r.disableOctree)??!1,t.add(this);for(const s of yc)this._handles.add(this.events.on(s,a=>t.handleEvent(s,a)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(t){this._objects.push(t),t.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:t}),this._octree!=null&&this._objectsAdded.push(t)}remove(t){this._objects.removeUnordered(t)&&(t.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:t}),this._octree!=null&&(this._objectsAdded.removeUnordered(t)||this._octree.remove([t])))}addMany(t){this._objects.pushArray(t);for(const r of t)r.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:t}),this._octree!=null&&this._objectsAdded.pushArray(t)}removeMany(t){const r=new Array;if(this._objects.removeUnorderedMany(t,t.length,r),r.length!==0){for(const i of r)i.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:r}),this._octree!=null){for(let i=0;i<r.length;)this._objectsAdded.removeUnordered(r[i])?(r[i]=r[r.length-1],r.length-=1):++i;this._octree.remove(r)}}}sync(){this.updatePolicy!==Kt.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(t,r){this._octree==null||this._objectsAdded.includes(t)||this._octree.update(t,r)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.length>50&&!this._disableOctree?(this._octree=new Un(t=>t.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}invalidateSpatialQueryAccelerator(){this._octree=sa(this._octree),this._objectsAdded.clear()}};function Pu(e){return e!=null&&e.type===jt.Layer}var ot,er;(function(e){e[e.Draped=0]="Draped",e[e.Screen=1]="Screen",e[e.World=2]="World",e[e.COUNT=3]="COUNT"})(ot||(ot={})),function(e){e[e.Center=0]="Center",e[e.Tip=1]="Tip",e[e.COUNT=2]="COUNT"}(er||(er={}));let ee=class extends da{constructor(){super(...arguments),this.output=E.Color,this.transparencyPassType=Fe.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=ot.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=er.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1}get draped(){return this.space===ot.Draped}};m([P({count:E.COUNT})],ee.prototype,"output",void 0),m([P({count:Fe.COUNT})],ee.prototype,"transparencyPassType",void 0),m([P()],ee.prototype,"occluder",void 0),m([P()],ee.prototype,"hasSlicePlane",void 0),m([P()],ee.prototype,"writeDepth",void 0),m([P({count:ot.COUNT})],ee.prototype,"space",void 0),m([P()],ee.prototype,"hideOnShortSegments",void 0),m([P()],ee.prototype,"hasCap",void 0),m([P({count:er.COUNT})],ee.prototype,"anchor",void 0),m([P()],ee.prototype,"hasTip",void 0),m([P()],ee.prototype,"vvSize",void 0),m([P()],ee.prototype,"vvColor",void 0),m([P()],ee.prototype,"vvOpacity",void 0),m([P()],ee.prototype,"hasOccludees",void 0),m([P()],ee.prototype,"multipassEnabled",void 0),m([P()],ee.prototype,"cullAboveGround",void 0),m([P({constValue:!1})],ee.prototype,"occlusionPass",void 0),m([P({constValue:!0})],ee.prototype,"hasVvInstancing",void 0),m([P({constValue:!0})],ee.prototype,"hasSliceTranslatedView",void 0);const Ps=8;function Cc(e,t){const r=e.vertex;r.uniforms.add(new Z("intrinsicWidth",i=>i.width)),t.vvSize?(e.attributes.add(y.SIZEFEATUREATTRIBUTE,"float"),r.uniforms.add(new tt("vvSizeMinSize",i=>i.vvSize.minSize),new tt("vvSizeMaxSize",i=>i.vvSize.maxSize),new tt("vvSizeOffset",i=>i.vvSize.offset),new tt("vvSizeFactor",i=>i.vvSize.factor)),r.code.add(w`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(e.attributes.add(y.SIZE,"float"),r.code.add(w`float getSize(){
return intrinsicWidth * size;
}`)),t.vvOpacity?(e.attributes.add(y.OPACITYFEATUREATTRIBUTE,"float"),r.constants.add("vvOpacityNumber","int",8),r.uniforms.add(new ns("vvOpacityValues",i=>i.vvOpacity.values,Ps),new ns("vvOpacityOpacities",i=>i.vvOpacity.opacityValues,Ps)),r.code.add(w`float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):r.code.add(w`vec4 applyOpacity( vec4 color ){
return color;
}`),t.vvColor?(e.include($o,t),e.attributes.add(y.COLORFEATUREATTRIBUTE,"float"),r.code.add(w`vec4 getColor(){
return applyOpacity(interpolateVVColor(colorFeatureAttribute));
}`)):(e.attributes.add(y.COLOR,"vec4"),r.code.add(w`vec4 getColor(){
return applyOpacity(color);
}`))}let xc=class{constructor(t,r,i){this._createTexture=t,this._parametersKey=r,this._repository=new Map,this._orphanCache=i.newCache(`procedural-texture-repository:${Ei()}`,s=>s.dispose())}destroy(){for(const[t,{texture:r}]of this._repository)r.dispose();this._repository.clear(),this._orphanCache.destroy()}swap(t,r=null){const i=this._acquire(t);return this.release(r),i}release(t){if(t==null)return;const r=this._parametersKey(t),i=this._repository.get(r);if(i&&(i.refCount--,i.refCount===0)){this._repository.delete(r);const{texture:s}=i,a=s.usedMemory;this._orphanCache.put(r,s,a)}}_acquire(t){if(t==null)return null;const r=this._parametersKey(t),i=this._repository.get(r);if(i)return i.refCount++,i.texture;const s=this._orphanCache.pop(r)??this._createTexture(t),a=new Sc(s);return this._repository.set(r,a),s}},Sc=class{constructor(t){this.texture=t,this.refCount=1}};function ju(e,t){return new xc(r=>{const{encodedData:i,textureSize:s}=Tc(r),a=new Ui;return a.internalFormat=Ca.RGBA,a.width=s,a.height=1,a.wrapMode=$r.REPEAT,new Xt(e,a,i)},r=>`${r.pattern.join(",")}-r${r.pixelRatio}`,t)}function Tc(e){const t=Hi(e),r=1/e.pixelRatio,i=Ma(e),s=Ea(e),a=(Math.floor(.5*(s-1))+.5)*r,o=[];let l=1;for(const p of t){for(let u=0;u<p;u++){const f=l*(Math.min(u,p-1-u)+.5)*r/a*.5+.5;o.push(f)}l=-l}const c=Math.round(t[0]/2),n=[...o.slice(c),...o.slice(0,c)],d=new Uint8Array(4*i);let h=0;for(const p of n)wa(p,d,h),h+=4;return{encodedData:d,textureSize:i}}function Hi(e){return e.pattern.map(t=>Math.round(t*e.pixelRatio))}function Ma(e){if(e==null)return 1;const t=Hi(e);return Math.floor(t.reduce((r,i)=>r+i))}function Ea(e){return Hi(e).reduce((t,r)=>Math.max(t,r))}function bc(e){return e==null?mo:e.length===4?e:wi(Rc,e[0],e[1],e[2],1)}const Rc=Ue();function Oc(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?Dc(e,t):Ac(e)}function Dc(e,t){const r=!(t.draped&&t.stipplePreferContinuous),{vertex:i,fragment:s}=e;s.include(Tn),t.draped||(Io(i,t),i.uniforms.add(new Z("worldToScreenPerDistanceRatio",(a,o)=>1/o.camera.perScreenPixelRatio)),i.code.add(w`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),e.varyings.add("vStippleDistanceLimits","vec2"),e.varyings.add("vStipplePatternStretch","float"),i.code.add(w`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${Ec};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),i.code.add(w`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),i.code.add(w`
    if (segmentLengthPseudoScreen >= ${r?"patternLength":"1e4"}) {
  `),Pi(i),i.code.add(w`float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
float segmentLengthScreenRounded = flooredRepetitions * patternLength;
float stretch = repetitions / flooredRepetitions;
vStipplePatternStretch = max(0.75, stretch);
return vec2(0.0, segmentLengthScreenRounded);
}
return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
}`),s.uniforms.add(new qe("stipplePatternTexture",a=>a.stippleTexture),new Z("stipplePatternSDFNormalizer",a=>Mc(a.stipplePattern)),new Z("stipplePatternPixelSizeInv",a=>1/$a(a))),s.code.add(w`float getStippleSDF(out bool isClamped) {
float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;
float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv * vLineSizeInv;
u = fract(u);
float encodedSDF = rgba2float(texture(stipplePatternTexture, vec2(u, 0.5)));
float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;
return (sdf - 0.5) * vStipplePatternStretch + 0.5;
}
float getStippleSDF() {
bool ignored;
return getStippleSDF(ignored);
}
float getStippleAlpha() {
bool isClamped;
float stippleSDF = getStippleSDF(isClamped);
float antiAliasedResult = clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);
return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
}`),t.stippleOffColorEnabled?(s.uniforms.add(new xr("stippleOffColor",a=>bc(a.stippleOffColor))),s.code.add(w`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`)):s.code.add(w`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}function Ac(e){e.fragment.code.add(w`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}function Mc(e){return e?(Math.floor(.5*(Ea(e)-1))+.5)/e.pixelRatio:1}function $a(e){const t=e.stipplePattern;return t?Ma(e.stipplePattern)/t.pixelRatio:1}const Ec=w.float(.4),Ia=128,Pa=.5;function Vu(e){return e==="cross"||e==="x"}function zu(e,t=Ia,r=t*Pa,i=0){const s=La(e,t,r,i);return new Po(s,{mipmap:!1,wrap:{s:$r.CLAMP_TO_EDGE,t:$r.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0,reloadable:!0})}function La(e,t=Ia,r=t*Pa,i=0){switch(e){case"circle":default:return $c(t,r);case"square":return Ic(t,r);case"cross":return Lc(t,r,i);case"x":return Fc(t,r,i);case"kite":return Pc(t,r);case"triangle":return Nc(t,r);case"arrow":return jc(t,r)}}function $c(e,t){const r=e/2-.5;return ir(e,ja(r,r,t/2))}function Ic(e,t){return Fa(e,t,!1)}function Pc(e,t){return Fa(e,t,!0)}function Lc(e,t,r=0){return Na(e,t,!1,r)}function Fc(e,t,r=0){return Na(e,t,!0,r)}function Nc(e,t){return ir(e,Va(e/2,t,t/2))}function jc(e,t){const r=t,i=t/2,s=e/2,a=.8*r,o=ja(s,(e-t)/2-a,Math.sqrt(a*a+i*i)),l=Va(s,r,i);return ir(e,(c,n)=>Math.max(l(c,n),-o(c,n)))}function Fa(e,t,r){return r&&(t/=Math.SQRT2),ir(e,(i,s)=>{let a=i-.5*e+.25,o=.5*e-s-.75;if(r){const l=(a+o)/Math.SQRT2;o=(o-a)/Math.SQRT2,a=l}return Math.max(Math.abs(a),Math.abs(o))-.5*t})}function Na(e,t,r,i=0){t-=i,r&&(t*=Math.SQRT2);const s=.5*t;return ir(e,(a,o)=>{let l,c=a-.5*e,n=.5*e-o-1;if(r){const d=(c+n)/Math.SQRT2;n=(n-c)/Math.SQRT2,c=d}return c=Math.abs(c),n=Math.abs(n),l=c>n?c>s?Math.sqrt((c-s)*(c-s)+n*n):n:n>s?Math.sqrt(c*c+(n-s)*(n-s)):c,l-=i/2,l})}function ja(e,t,r){return(i,s)=>{const a=i-e,o=s-t;return Math.sqrt(a*a+o*o)-r}}function Va(e,t,r){const i=Math.sqrt(t*t+r*r);return(s,a)=>{const o=Math.abs(s-e)-r,l=a-e+t/2+.75,c=(t*o+r*l)/i,n=-l;return Math.max(c,n)}}function ir(e,t){const r=new Uint8Array(4*e*e);for(let i=0;i<e;i++)for(let s=0;s<e;s++){const a=s+e*i;let o=t(s,i);o=o/e+.5,wa(o,r,4*a)}return r}const Qt=64,za=Qt/2,Ua=za/5,Vc=Qt/Ua,Uu=.25;function Hu(e,t){const r=La(e,Qt,za,Ua),i=new Ui;return i.internalFormat=Ca.RGBA,i.width=Qt,i.height=Qt,i.wrapMode=$r.CLAMP_TO_EDGE,new Xt(t,i,r)}function zc(e,t){const{vertex:r,constants:i}=e;i.add("markerSizePerLineWidth","float",Vc),Pi(r),r.uniforms.get("markerScale")==null&&r.constants.add("markerScale","float",1),r.code.add(w`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),t.space===ot.World&&(r.constants.add("maxSegmentLengthFraction","float",.45),r.uniforms.add(new Z("perRenderPixelRatio",(s,a)=>a.camera.perRenderPixelRatio)),r.code.add(w`bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}
float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}`))}var nt;(function(e){e[e.BUTT=0]="BUTT",e[e.SQUARE=1]="SQUARE",e[e.ROUND=2]="ROUND",e[e.COUNT=3]="COUNT"})(nt||(nt={}));let H=class extends da{constructor(){super(...arguments),this.output=E.Color,this.capType=nt.BUTT,this.transparencyPassType=Fe.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.multipassEnabled=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}};m([P({count:E.COUNT})],H.prototype,"output",void 0),m([P({count:nt.COUNT})],H.prototype,"capType",void 0),m([P({count:Fe.COUNT})],H.prototype,"transparencyPassType",void 0),m([P()],H.prototype,"occluder",void 0),m([P()],H.prototype,"hasSlicePlane",void 0),m([P()],H.prototype,"hasPolygonOffset",void 0),m([P()],H.prototype,"writeDepth",void 0),m([P()],H.prototype,"draped",void 0),m([P()],H.prototype,"stippleEnabled",void 0),m([P()],H.prototype,"stippleOffColorEnabled",void 0),m([P()],H.prototype,"stipplePreferContinuous",void 0),m([P()],H.prototype,"roundJoins",void 0),m([P()],H.prototype,"applyMarkerOffset",void 0),m([P()],H.prototype,"vvSize",void 0),m([P()],H.prototype,"vvColor",void 0),m([P()],H.prototype,"vvOpacity",void 0),m([P()],H.prototype,"falloffEnabled",void 0),m([P()],H.prototype,"innerColorEnabled",void 0),m([P()],H.prototype,"hasOccludees",void 0),m([P()],H.prototype,"multipassEnabled",void 0),m([P()],H.prototype,"cullAboveGround",void 0),m([P()],H.prototype,"wireframe",void 0),m([P()],H.prototype,"objectAndLayerIdColorInstanced",void 0),m([P({constValue:!1})],H.prototype,"occlusionPass",void 0),m([P({constValue:!0})],H.prototype,"hasVvInstancing",void 0),m([P({constValue:!0})],H.prototype,"hasSliceTranslatedView",void 0);const Fr=1;function Uc(e){const t=new Ii,{attributes:r,varyings:i,constants:s,vertex:a,fragment:o}=t;t.include(Lo),t.include(Cc,e),t.include(Oc,e);const l=e.applyMarkerOffset&&!e.draped;l&&(a.uniforms.add(new Z("markerScale",f=>f.markerScale)),t.include(zc,{space:ot.World,draped:!1})),t.include(Fo,e),No(a,e),a.uniforms.add(new Nt("inverseProjectionMatrix",(f,v)=>v.camera.inverseProjectionMatrix),new la("nearFar",(f,v)=>v.camera.nearFar),new Z("miterLimit",f=>f.join!=="miter"?0:f.miterLimit),new xr("viewport",(f,v)=>v.camera.fullViewport)),a.constants.add("LARGE_HALF_FLOAT","float",65500),r.add(y.POSITION,"vec3"),r.add(y.PREVPOSITION,"vec3"),r.add(y.NEXTPOSITION,"vec3"),r.add(y.SUBDIVISIONFACTOR,"float"),r.add(y.UV0,"vec2"),i.add("vColor","vec4"),i.add("vpos","vec3"),i.add("vLineDistance","float"),i.add("vLineWidth","float");const c=e.multipassEnabled&&e.output===E.Color;c&&i.add("depth","float");const n=e.stippleEnabled;n&&i.add("vLineSizeInv","float"),s.add("aaWidth","float",e.stippleEnabled?0:1);const d=e.capType===nt.ROUND,h=e.stippleEnabled&&d,p=e.falloffEnabled||h;p&&i.add("vLineDistanceNorm","float"),d&&(i.add("vSegmentSDF","float"),i.add("vReverseSegmentSDF","float")),a.code.add(w`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),a.code.add(w`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),a.code.add(w`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${c?"depth = pos.z;":""}

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),Pi(a),a.code.add(w`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;
      float lineSize = getSize();

      if (lineSize < 1.0) {
        coverage = lineSize; // convert sub-pixel coverage to alpha
        lineSize = 1.0;
      }
      lineSize += aaWidth;

      float lineWidth = lineSize * pixelRatio;
      vLineWidth = lineWidth;
      ${n?w`vLineSizeInv = 1.0 / lineSize;`:""}

      vec4 pos  = view * vec4(position, 1.0);
      vec4 prev = view * vec4(prevPosition, 1.0);
      vec4 next = view * vec4(nextPosition, 1.0);
  `),l&&a.code.add(w`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),a.code.add(w`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(e.stippleEnabled||d)&&a.code.add(w`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${d?w`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),a.code.add(w`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),e.roundJoins?a.code.add(w`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${e.stippleEnabled?w`min(1.0, subdivisionFactor * ${w.float((Fr+2)/(Fr+1))})`:w`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):a.code.add(w`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`);const u=e.capType!==nt.BUTT;return a.code.add(w`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${u?w`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),a.code.add(w`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;
    float lineDistNorm = sign(uv0.y) * pos.w;

    vLineDistance =  lineWidth * lineDistNorm;
    ${p?w`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),d&&a.code.add(w`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),e.stippleEnabled&&(e.draped?a.uniforms.add(new Z("worldToScreenRatio",(f,v)=>1/v.screenToPCSRatio)):a.code.add(w`vec3 segmentCenter = mix((nextPosition + position) * 0.5, (position + prevPosition) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),a.code.add(w`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(nextPosition - position, position - prevPosition, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),e.draped?a.code.add(w`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):a.code.add(w`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),a.uniforms.add(new Z("stipplePatternPixelSize",f=>$a(f))),a.code.add(w`float patternLength = lineSize * stipplePatternPixelSize;
vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);
vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);
if (segmentLengthScreenDouble >= 0.001) {
vec2 stippleDisplacement = pos.xy - segmentOrigin;
float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);
vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
}
vStippleDistanceLimits *= pos.w;
vStippleDistance *= pos.w;
vStippleDistanceLimits = isJoin ?
vStippleDistanceLimits :
isStartVertex ?
vec2(-1e34, vStippleDistanceLimits.y) :
vec2(vStippleDistanceLimits.x, 1e34);`)),a.code.add(w`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }
  }
  `),c&&t.include(jo,e),t.include(Vo,e),o.include(zo),o.code.add(w`
  void main() {
    discardBySlice(vpos);
    ${c?"terrainDepthTest(depth);":""}
  `),e.wireframe?o.code.add(w`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(d&&o.code.add(w`
        float sdf = min(vSegmentSDF, vReverseSegmentSDF);
        vec2 fragmentPosition = vec2(
          min(sdf, 0.0),
          vLineDistance
        ) * gl_FragCoord.w;

        float fragmentRadius = length(fragmentPosition);
        float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
        float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

        if (capCoverage < ${w.float(Jr)}) {
          discard;
        }
      `),h?o.code.add(w`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${w.float(Jr)}, stippleCoverage);
      `):o.code.add(w`float stippleAlpha = getStippleAlpha();`),e.output!==E.ObjectAndLayerIdColor&&o.code.add(w`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);`),o.uniforms.add(new xr("intrinsicColor",f=>f.color)),o.code.add(w`vec4 color = intrinsicColor * vColor;`),e.innerColorEnabled&&(o.uniforms.add(new xr("innerColor",f=>f.innerColor??f.color),new Z("innerWidth",(f,v)=>f.innerWidth*v.camera.pixelRatio)),o.code.add(w`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),o.code.add(w`vec4 finalColor = blendStipple(color, stippleAlpha);`),e.falloffEnabled&&(o.uniforms.add(new Z("falloff",f=>f.falloff)),o.code.add(w`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`)),e.stippleEnabled||o.code.add(w`float featherStartDistance = max(vLineWidth - 2.0, 0.0);
float value = abs(vLineDistance) * gl_FragCoord.w;
float feather = (value - featherStartDistance) / (vLineWidth - featherStartDistance);
finalColor.a *= 1.0 - clamp(feather, 0.0, 1.0);`)),e.transparencyPassType===Fe.ColorAlpha&&(t.outputs.add("fragColor","vec4",0),t.outputs.add("fragAlpha","float",1)),o.code.add(w`
    ${e.output===E.ObjectAndLayerIdColor?w`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${w.float(Jr)}) {
      discard;
    }

    ${e.output===E.Color?w`fragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===E.Color&&e.transparencyPassType===Fe.ColorAlpha?w`
            fragColor = premultiplyAlpha(fragColor);
            fragAlpha = fragColor.a;`:""}
    ${e.output===E.Highlight?w`fragColor = vec4(1.0);`:""}
    ${e.output===E.ObjectAndLayerIdColor?w`outputObjectAndLayerIdColor();`:""}
  }
  `),t}const Hc=Object.freeze(Object.defineProperty({__proto__:null,build:Uc,ribbonlineNumRoundJoinSubdivisions:Fr},Symbol.toStringTag,{value:"Module"})),Ha=new Map([[y.POSITION,0],[y.PREVPOSITION,1],[y.NEXTPOSITION,2],[y.SUBDIVISIONFACTOR,3],[y.UV0,4],[y.COLOR,5],[y.COLORFEATUREATTRIBUTE,5],[y.SIZE,6],[y.SIZEFEATUREATTRIBUTE,6],[y.OPACITYFEATUREATTRIBUTE,7],[y.OBJECTANDLAYERIDCOLOR,8]]);let Ga=class Wa extends Fi{initializeProgram(t){return new Ni(t.rctx,Wa.shader.get().build(this.configuration),Ha)}_makePipelineState(t,r){const i=this.configuration,s=t===Fe.NONE,a=t===Fe.FrontFace,o=bn(i.output);return rt({blending:i.output===E.Color?s?Yr:Uo(t):null,depthTest:{func:Ho(t)},depthWrite:s?i.writeDepth||o?Zn:null:Go(t),drawBuffers:i.output===E.Depth?{buffers:[hr.NONE]}:Wo(t),colorWrite:$t,stencilWrite:i.hasOccludees?ls:null,stencilTest:i.hasOccludees?r?cs:Bo:null,polygonOffset:s||a?i.hasPolygonOffset?Ls:null:ko})}initializePipeline(){const t=this.configuration;if(t.occluder){const r=t.hasPolygonOffset?Ls:null;this._occluderPipelineTransparent=rt({blending:Yr,polygonOffset:r,depthTest:ds,depthWrite:null,colorWrite:$t,stencilWrite:null,stencilTest:qo,drawBuffers:t.output===E.Depth?{buffers:[hr.NONE]}:null}),this._occluderPipelineOpaque=rt({blending:Yr,polygonOffset:r,depthTest:ds,depthWrite:null,colorWrite:$t,stencilWrite:Zo,stencilTest:Qo,drawBuffers:t.output===E.Depth?{buffers:[hr.NONE]}:null}),this._occluderPipelineMaskWrite=rt({blending:null,polygonOffset:r,depthTest:Jo,depthWrite:null,colorWrite:null,stencilWrite:ls,stencilTest:cs,drawBuffers:t.output===E.Depth?{buffers:[hr.NONE]}:null})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?ws.LINES:ws.TRIANGLE_STRIP}getPipeline(t,r,i){return t?this._occludeePipelineState:this.configuration.occluder?i?this._occluderPipelineTransparent:r?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipeline()}};Ga.shader=new Li(Hc,()=>$i(()=>import("./ColorMaterial.glsl-CcrBVOmk.js").then(e=>e.R),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37])));const Ls={factor:0,units:-4};var me;(function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(me||(me={}));let Gc=class extends pn{constructor(t){super(t,new Bc),this._configuration=new H,this.produces=new Map([[ie.OPAQUE_MATERIAL,r=>r===E.Highlight||r===E.ObjectAndLayerIdColor||r===E.Color&&this.parameters.renderOccluded===Re.OccludeAndTransparentStencil],[ie.OPAQUE_NO_SSAO_DEPTH,r=>Rn(r)],[ie.OCCLUDER_MATERIAL,r=>ps(r)&&this.parameters.renderOccluded===Re.OccludeAndTransparentStencil],[ie.TRANSPARENT_OCCLUDER_MATERIAL,r=>ps(r)&&this.parameters.renderOccluded===Re.OccludeAndTransparentStencil],[ie.TRANSPARENT_MATERIAL,r=>r===E.Color&&this.parameters.writeDepth&&this.parameters.renderOccluded!==Re.OccludeAndTransparentStencil],[ie.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,r=>r===E.Color&&!this.parameters.writeDepth&&this.parameters.renderOccluded!==Re.OccludeAndTransparentStencil],[ie.DRAPED_MATERIAL,r=>On(r)]]),this._vertexAttributeLocations=Ha}getConfiguration(t,r){this._configuration.output=t,this._configuration.draped=r.slot===ie.DRAPED_MATERIAL;const i=this.parameters.stipplePattern!=null&&t!==E.Highlight;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&this.parameters.stippleOffColor!=null,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&qc(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===Re.OccludeAndTransparentStencil,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.multipassEnabled=r.multipassEnabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(t,r,i,s,a,o){if(!i.options.selectionMode)return;const l=t.attributes.get(y.POSITION).data,c=t.attributes.get(y.SIZE);let n=this.parameters.width;if(this.parameters.vvSize){const v=t.attributes.get(y.SIZEFEATUREATTRIBUTE).data[0];n*=Mt(this.parameters.vvSize.offset[0]+v*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else c&&(n*=c.data[0]);const d=s[0],h=s[1],p=(n/2+4)*t.screenToWorldRatio;let u=Number.MAX_VALUE,f=0;for(let v=0;v<l.length-5;v+=3){const C=l[v],T=l[v+1],S=d-C,_=h-T,O=l[v+3]-C,x=l[v+4]-T,D=Mt((O*S+x*_)/(O*O+x*x),0,1),g=O*D-S,U=x*D-_,z=g*g+U*U;z<u&&(u=z,f=v/3)}u<p*p&&a(o.dist,o.normal,f,!1)}intersect(t,r,i,s,a,o){if(!i.options.selectionMode||!t.visible)return;if(!fn(r))return void zr.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const l=t.attributes,c=l.get(y.POSITION).data;let n=this.parameters.width;if(this.parameters.vvSize){const S=l.get(y.SIZEFEATUREATTRIBUTE).data[0];n*=Mt(this.parameters.vvSize.offset[0]+S*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else l.has(y.SIZE)&&(n*=l.get(y.SIZE).data[0]);const d=i.camera,h=Zc;Vi(h,i.point);const p=n*d.pixelRatio/2+4*d.pixelRatio;Q(Ut[0],h[0]-p,h[1]+p,0),Q(Ut[1],h[0]+p,h[1]+p,0),Q(Ut[2],h[0]+p,h[1]-p,0),Q(Ut[3],h[0]-p,h[1]-p,0);for(let S=0;S<4;S++)if(!d.unprojectFromRenderScreen(Ut[S],ze[S]))return;nr(d.eye,ze[0],ze[1],li),nr(d.eye,ze[1],ze[2],ci),nr(d.eye,ze[2],ze[3],di),nr(d.eye,ze[3],ze[0],hi);let u=Number.MAX_VALUE,f=0;const v=Ba(this.parameters,l)?c.length-2:c.length-5;for(let S=0;S<v;S+=3){de[0]=c[S]+r[12],de[1]=c[S+1]+r[13],de[2]=c[S+2]+r[14];const _=(S+3)%c.length;if(he[0]=c[_]+r[12],he[1]=c[_+1]+r[13],he[2]=c[_+2]+r[14],Ae(li,de)<0&&Ae(li,he)<0||Ae(ci,de)<0&&Ae(ci,he)<0||Ae(di,de)<0&&Ae(di,he)<0||Ae(hi,de)<0&&Ae(hi,he)<0)continue;if(d.projectToRenderScreen(de,Je),d.projectToRenderScreen(he,Ye),Je[2]<0&&Ye[2]>0){ae(Me,de,he);const x=d.frustum,D=-Ae(x[dr.NEAR],de)/Ft(Me,hs(x[dr.NEAR]));se(Me,Me,D),le(de,de,Me),d.projectToRenderScreen(de,Je)}else if(Je[2]>0&&Ye[2]<0){ae(Me,he,de);const x=d.frustum,D=-Ae(x[dr.NEAR],he)/Ft(Me,hs(x[dr.NEAR]));se(Me,Me,D),le(he,he,Me),d.projectToRenderScreen(he,Ye)}else if(Je[2]<0&&Ye[2]<0)continue;Je[2]=0,Ye[2]=0;const O=Hn(Kr(Je,Ye,js),h);O<u&&(u=O,X(Fs,de),X(Ns,he),f=S/3)}const C=i.rayBegin,T=i.rayEnd;if(u<p*p){let S=Number.MAX_VALUE;if(Gn(Kr(Fs,Ns,js),Kr(C,T,Qc),Qe)){ae(Qe,Qe,C);const _=Jt(Qe);se(Qe,Qe,1/_),S=_/Vr(C,T)}o(S,Qe,f,!1)}}get _layout(){const t=Wn().vec3f(y.POSITION).vec3f(y.PREVPOSITION).vec3f(y.NEXTPOSITION).f32(y.SUBDIVISIONFACTOR).vec2f(y.UV0);return this.parameters.vvSize?t.f32(y.SIZEFEATUREATTRIBUTE):t.f32(y.SIZE),this.parameters.vvColor?t.f32(y.COLORFEATUREATTRIBUTE):t.vec4f(y.COLOR),this.parameters.vvOpacity&&t.f32(y.OPACITYFEATUREATTRIBUTE),Et("enable-feature:objectAndLayerId-rendering")&&t.vec4u8(y.OBJECTANDLAYERIDCOLOR),t}createBufferWriter(){return new kc(this._layout,this.parameters)}createGLMaterial(t){return new Wc(t)}validateParameters(t){t.join!=="miter"&&(t.miterLimit=0),t.markerParameters!=null&&(t.markerScale=t.markerParameters.width/t.width)}},Wc=class extends Yo{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextures.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees})}beginSlot(t){this._output===E.Color&&this._updateOccludeeState(t);const r=this._material.parameters.stipplePattern;return this._stipplePattern!==r&&(this._material.setParameters({stippleTexture:this._stippleTextures.swap(r,this._stipplePattern)}),this._stipplePattern=r),this.ensureTechnique(Ga,t)}},Bc=class extends Xo{constructor(){super(...arguments),this.width=0,this.color=go,this.join="miter",this.cap=nt.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}},kc=class{constructor(t,r){this.vertexBufferLayout=t,this._parameters=r,this.numJoinSubdivisions=0;const i=r.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=Fr+i}}_isClosed(t){return Ba(this._parameters,t.attributes)}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){const i=t.attributes.get(y.POSITION).indices.length/2+1,s=this._isClosed(t);let a=s?2:2*2;return a+=((s?i:i-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),a+=2,this._parameters.wireframe&&(a=2+4*(a-2)),a}write(t,r,i,s,a){var lt,sr,$;const o=Jc,l=Yc,c=Xc,n=i.attributes.get(y.POSITION),d=n.indices,h=n.data.length/3,p=(lt=i.attributes.get(y.DISTANCETOSTART))==null?void 0:lt.data;d&&d.length!==2*(h-1)&&console.warn("RibbonLineMaterial does not support indices");const u=((sr=i.attributes.get(y.SIZEFEATUREATTRIBUTE))==null?void 0:sr.data[0])??(($=i.attributes.get(y.SIZE))==null?void 0:$.data[0])??1;let f=[1,1,1,1],v=0;const C=this.vertexBufferLayout.fields.has(y.COLORFEATUREATTRIBUTE);C?v=i.attributes.get(y.COLORFEATUREATTRIBUTE).data[0]:i.attributes.has(y.COLOR)&&(f=i.attributes.get(y.COLOR).data);const T=Et("enable-feature:objectAndLayerId-rendering")?i.objectAndLayerIdColor:null,S=this.vertexBufferLayout.fields.has(y.OPACITYFEATUREATTRIBUTE),_=S?i.attributes.get(y.OPACITYFEATUREATTRIBUTE).data[0]:0,O=new Float32Array(s.buffer),x=Et("enable-feature:objectAndLayerId-rendering")?new Uint8Array(s.buffer):null,D=this.vertexBufferLayout.stride/4;let g=a*D;const U=g;let z=0;const A=p?(B,K,ge)=>z=p[ge]:(B,K,ge)=>z+=Vr(B,K),ce=Et("enable-feature:objectAndLayerId-rendering"),N=(B,K,ge,Ve,ct,Xa,Ka)=>{if(O[g++]=K[0],O[g++]=K[1],O[g++]=K[2],O[g++]=B[0],O[g++]=B[1],O[g++]=B[2],O[g++]=ge[0],O[g++]=ge[1],O[g++]=ge[2],O[g++]=Ve,O[g++]=Ka,O[g++]=ct,O[g++]=u,C)O[g++]=v;else{const ar=Math.min(4*Xa,f.length-4);O[g++]=f[ar],O[g++]=f[ar+1],O[g++]=f[ar+2],O[g++]=f[ar+3]}S&&(O[g++]=_),ce&&(T!=null&&(x[4*g]=T[0],x[4*g+1]=T[1],x[4*g+2]=T[2],x[4*g+3]=T[3]),g++)};g+=D,Q(l,n.data[0],n.data[1],n.data[2]),t&&ye(l,l,t);const Ne=this._isClosed(i);if(Ne){const B=n.data.length-3;Q(o,n.data[B],n.data[B+1],n.data[B+2]),t&&ye(o,o,t)}else Q(c,n.data[3],n.data[4],n.data[5]),t&&ye(c,c,t),N(l,l,c,1,me.LEFT_CAP_START,0,0),N(l,l,c,1,me.RIGHT_CAP_START,0,0),X(o,l),X(l,c);const Vt=Ne?0:1,je=Ne?h:h-1;for(let B=Vt;B<je;B++){const K=(B+1)%h*3;Q(c,n.data[K],n.data[K+1],n.data[K+2]),t&&ye(c,c,t),A(o,l,B),N(o,l,c,0,me.LEFT_JOIN_END,B,z),N(o,l,c,0,me.RIGHT_JOIN_END,B,z);const ge=this.numJoinSubdivisions;for(let Ve=0;Ve<ge;++Ve){const ct=(Ve+1)/(ge+1);N(o,l,c,ct,me.LEFT_JOIN_END,B,z),N(o,l,c,ct,me.RIGHT_JOIN_END,B,z)}N(o,l,c,1,me.LEFT_JOIN_START,B,z),N(o,l,c,1,me.RIGHT_JOIN_START,B,z),X(o,l),X(l,c)}Ne?(Q(c,n.data[3],n.data[4],n.data[5]),t&&ye(c,c,t),z=A(o,l,je),N(o,l,c,0,me.LEFT_JOIN_END,Vt,z),N(o,l,c,0,me.RIGHT_JOIN_END,Vt,z)):(z=A(o,l,je),N(o,l,l,0,me.LEFT_CAP_END,je,z),N(o,l,l,0,me.RIGHT_CAP_END,je,z)),ni(O,U+D,O,U,D),g=ni(O,g-D,O,g,D),this._parameters.wireframe&&this._addWireframeVertices(s,U,g,D)}_addWireframeVertices(t,r,i,s){const a=new Float32Array(t.buffer,i*Float32Array.BYTES_PER_ELEMENT),o=new Float32Array(t.buffer,r*Float32Array.BYTES_PER_ELEMENT,i-r);let l=0;const c=n=>l=ni(o,n,a,l,s);for(let n=0;n<o.length-1;n+=2*s)c(n),c(n+2*s),c(n+1*s),c(n+2*s),c(n+1*s),c(n+3*s)}};function ni(e,t,r,i,s){for(let a=0;a<s;a++)r[i++]=e[t++];return i}function Ba(e,t){return e.isClosed?t.get(y.POSITION).indices.length>2:!1}function qc(e){return e.anchor===er.Tip&&e.hideOnShortSegments&&e.placement==="begin-end"&&e.worldSpace}const de=M(),he=M(),Me=M(),Qe=M(),Zc=M(),Je=et(),Ye=et(),Fs=M(),Ns=M(),js=ya(),Qc=ya(),Jc=M(),Yc=M(),Xc=M(),Ut=[et(),et(),et(),et()],ze=[M(),M(),M(),M()],li=rr(),ci=rr(),di=rr(),hi=rr();class Kc{constructor(t){this._originSR=t,this._rootOriginId="root/"+Ei(),this._origins=new Map,this._objects=new Map,this._gridSize=5e5}getOrigin(t){const r=this._origins.get(this._rootOriginId);if(r==null){const d=Oi(t[0]+Math.random()-.5,t[1]+Math.random()-.5,t[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,d),d}const i=this._gridSize,s=Math.round(t[0]/i),a=Math.round(t[1]/i),o=Math.round(t[2]/i),l=`${s}/${a}/${o}`;let c=this._origins.get(l);const n=.5*i;if(ae(te,t,r.vec3),te[0]=Math.abs(te[0]),te[1]=Math.abs(te[1]),te[2]=Math.abs(te[2]),te[0]<n&&te[1]<n&&te[2]<n){if(c){const d=Math.max(...te);if(ae(te,t,c.vec3),te[0]=Math.abs(te[0]),te[1]=Math.abs(te[1]),te[2]=Math.abs(te[2]),Math.max(...te)<d)return c}return r}return c||(c=Oi(s*i,a*i,o*i,l),this._origins.set(l,c)),c}_drawOriginBox(t,r=_i(1,1,0,1)){const i=window.view,s=i._stage,a=r.toString();if(!this._objects.has(a)){this._material=new Gc({width:2,color:r}),s.add(this._material);const u=new wc(s,{pickable:!1}),f=new Kl({castShadow:!1});s.add(f),u.add(f),this._objects.set(a,f)}const o=this._objects.get(a),l=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],c=l.length,n=new Array(3*c),d=new Array,h=.5*this._gridSize;for(let u=0;u<c;u++)n[3*u]=t[0]+(1&l[u]?h:-h),n[3*u+1]=t[1]+(2&l[u]?h:-h),n[3*u+2]=t[2]+(4&l[u]?h:-h),u>0&&d.push(u-1,u);yi(n,this._originSR,0,n,i.renderSpatialReference,0,c);const p=new we(this._material,[[y.POSITION,new j(n,d,3,!0)]],null,jt.Line);s.add(p),o.addGeometry(p)}get test(){}}const te=M();let ka=class{constructor(t,r,i=null){this.rctx=t,this.sliceHelper=i,this.lastFrameCamera=new Ur,this.output=E.Color,this.renderOccludedMask=Di,this.bindParameters=new xl(r,i!=null?i.plane:null),this.bindParameters.alignPixelEnabled=!0}},Qu=class extends ka{constructor(t,r,i,s){super(t,i,s),this.offscreenRenderingHelper=r,this.sliceHelper=s,this.time=vo(0)}};const Di=Re.Occlude|Re.OccludeAndTransparent|Re.OccludeAndTransparentStencil;let Bt=class extends Ur{constructor(){super(...arguments),this._projectionMatrix=W()}get projectionMatrix(){return this._projectionMatrix}};m([R()],Bt.prototype,"_projectionMatrix",void 0),m([R({readOnly:!0})],Bt.prototype,"projectionMatrix",null),Bt=m([tr("esri.views.3d.webgl-engine.lib.CascadeCamera")],Bt);var Ai;(function(e){e[e.Highlight=0]="Highlight",e[e.ExcludeHighlight=1]="ExcludeHighlight"})(Ai||(Ai={}));let fr=class{constructor(){this.camera=new Bt,this.lightMat=W()}};class ed{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}let td=class{constructor(t,r){this._fbos=t,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new ed,this._projectionView=W(),this._projectionViewInverse=W(),this._modelViewLight=W(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=Ue(),this._cascades=[new fr,new fr,new fr,new fr],this._lastOrigin=null,this._maxTextureWidth=Math.min(Et("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){var t;return(t=this._handle)==null?void 0:t.getTexture()}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return wi(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeOffscreenBuffers(){this._handle=Dr(this._handle),this._discardSnapshots()}set maxCascades(t){this.settings.maxNumCascadesHighQuality=Mt(Math.floor(t),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(t){this._enabled=t,t||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let t=0;t<this._numCascades;++t)pi[t]=this._cascades[t];return pi.length=this._numCascades,pi}start(t,r,i,s,a){pe(this.enabled);const{near:o,far:l}=nd(i);this._computeCascadeDistances(o,l,s),this._textureHeight=this._computeTextureHeight(t,a,s),this._setupMatrices(t,r);const{viewMatrix:c,projectionMatrix:n}=t;for(let d=0;d<this._numCascades;++d)this._constructCascade(d,n,c,r);this._lastOrigin=null,this.clear()}finish(){var t;pe(this.enabled),(t=this._handle)==null||t.detachDepth()}getShadowMapMatrices(t){if(!this._lastOrigin||!Tt(t,this._lastOrigin)){this._lastOrigin=this._lastOrigin||M(),X(this._lastOrigin,t);for(let r=0;r<this._numCascades;++r){Xi(Ws,this._cascades[r].lightMat,t);for(let i=0;i<16;++i)Bs[16*r+i]=Ws[i]}}return Bs}moveSnapshot(t){var r,i;pe(this.enabled),(r=this._handle)==null||r.detachDepth(),(i=this._snapshots[t])==null||i.release(),this._snapshots[t]=this._handle,this._handle=null,this.clear()}copySnapshot(t){var c,n,d,h;const r=(n=(c=this._handle)==null?void 0:c.getTexture())==null?void 0:n.descriptor;if(!this.enabled||!r)return;(d=this._snapshots[t])==null||d.release();const{width:i,height:s}=r,a=t===Ai.Highlight?"shadow highlight snapshot":"shadow no highlight snapshot";this._snapshots[t]=this._fbos.acquire(i,s,a,Mr.RGBA4);const o=this._fbos.rctx;this._bindFbo();const l=o.bindTexture((h=this._snapshots[t])==null?void 0:h.getTexture(),Xt.TEXTURE_UNIT_FOR_UPDATES);o.gl.copyTexSubImage2D(Bn.TEXTURE_2D,0,0,0,0,0,i,s),o.bindTexture(l,Xt.TEXTURE_UNIT_FOR_UPDATES)}getSnapshot(t){var r;return this.enabled?(r=this._snapshots[t])==null?void 0:r.getTexture():null}clear(){const t=this._fbos.rctx;this._ensureFbo(),this._bindFbo(),t.setClearColor(1,1,1,1),t.clear(Ir.COLOR_BUFFER_BIT|Ir.DEPTH_BUFFER_BIT)}_computeTextureHeight(t,r,i){const s=Math.min(window.devicePixelRatio,r)/t.pixelRatio,a=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality,o=Ko(Math.floor(Math.max(t.fullWidth,t.fullHeight)*s*a)),l=Math.min(this._maxTextureWidth,this._numCascades*o);return en(l/this._numCascades)}_ensureFbo(){var t,r,i,s,a;((r=(t=this._handle)==null?void 0:t.fbo)==null?void 0:r.width)===this._textureWidth&&((i=this._handle)==null?void 0:i.fbo.height)===this._textureHeight||((s=this._handle)==null||s.release(),this._handle=this._fbos.acquire(this._textureWidth,this._textureHeight,"shadow map",Mr.RGBA4)),(a=this._handle)==null||a.acquireDepth(tn.DEPTH16_BUFFER)}_discardSnapshot(t){this._snapshots[t]=Dr(this._snapshots[t])}_discardSnapshots(){for(let t=0;t<this._snapshots.length;++t)this._discardSnapshot(t);this._snapshots.length=0}_bindFbo(){var r;const t=this._fbos.rctx;t.unbindTexture(this.depthTexture),t.bindFramebuffer((r=this._handle)==null?void 0:r.fbo)}_constructCascade(t,r,i,s){const a=this._cascades[t],o=-this._cascadeDistances[t],l=-this._cascadeDistances[t+1],c=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]),n=(r[10]*l+r[14])/Math.abs(r[11]*l+r[15]);pe(c<n);for(let u=0;u<8;++u){wi(Vs,u%4==0||u%4==3?-1:1,u%4==0||u%4==1?-1:1,u<4?c:n,1);const f=xe[u];Gt(f,Vs,this._projectionViewInverse),f[0]/=f[3],f[1]/=f[3],f[2]/=f[3]}_o(ui,xe[0]),a.camera.viewMatrix=Xi(rd,this._modelViewLight,ui);for(let u=0;u<8;++u)ye(xe[u],xe[u],a.camera.viewMatrix);let d=xe[0][2],h=xe[0][2];for(let u=1;u<8;++u)d=Math.min(d,xe[u][2]),h=Math.max(h,xe[u][2]);d-=200,h+=200,a.camera.near=-h,a.camera.far=-d,od(i,s,d,h,a.camera),ke(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);const p=this._textureHeight;a.camera.viewport=[t*p,0,p,p]}_setupMatrices(t,r){ke(this._projectionView,t.projectionMatrix,t.viewMatrix),kt(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===ji.Global?t.eye:Q(ui,0,0,1);ra(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],i)}_computeCascadeDistances(t,r,i){const s=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(mn(r/t,4)),s);const a=(r-t)/this._numCascades,o=(r/t)**(1/this._numCascades);let l=t,c=t;for(let n=0;n<this._numCascades+1;++n)this._cascadeDistances[n]=Wt(l,c,this.settings.splitSchemeLambda),l*=o,c+=a}get test(){}};const rd=W(),Vs=Ue(),xe=[];for(let e=0;e<8;++e)xe.push(Ue());const zs=k(),Us=k(),id=k(),Hs=k(),Gs=k(),ui=M(),pi=[],Ws=W(),Bs=We.concat(We,We,We,We),_e=k(),yt=k(),Xe=[k(),k(),k(),k()],q=k(),fi=k(),Ge=k(),Ht=k(),wt=k(),Ct=k(),mr=k();function sd(e,t,r,i,s,a,o,l){Ci(_e,0,0);for(let x=0;x<4;++x)Ze(_e,_e,e[x]);xt(_e,_e,.25),Ci(yt,0,0);for(let x=4;x<8;++x)Ze(yt,yt,e[x]);xt(yt,yt,.25),zt(Xe[0],e[4],e[5],.5),zt(Xe[1],e[5],e[6],.5),zt(Xe[2],e[6],e[7],.5),zt(Xe[3],e[7],e[4],.5);let c=0,n=fs(Xe[0],_e);for(let x=1;x<4;++x){const D=fs(Xe[x],_e);D<n&&(n=D,c=x)}St(q,Xe[c],e[c+4]);const d=q[0];let h,p;q[0]=-q[1],q[1]=d,St(fi,yt,_e),ne(fi,q)<0&&An(q,q),zt(q,q,fi,r),ms(q,q),h=p=ne(St(Ge,e[0],_e),q);for(let x=1;x<8;++x){const D=ne(St(Ge,e[x],_e),q);D<h?h=D:D>p&&(p=D)}Vi(i,_e),xt(Ge,q,h-t),Ze(i,i,Ge);let u=-1,f=1,v=0,C=0;for(let x=0;x<8;++x){St(Ht,e[x],i),ms(Ht,Ht);const D=q[0]*Ht[1]-q[1]*Ht[0];D>0?D>u&&(u=D,v=x):D<f&&(f=D,C=x)}ht(u>0,"leftArea"),ht(f<0,"rightArea"),xt(wt,q,h),Ze(wt,wt,_e),xt(Ct,q,p),Ze(Ct,Ct,_e),mr[0]=-q[1],mr[1]=q[0];const T=lr(i,e[C],Ct,Ze(Ge,Ct,mr),1,s),S=lr(i,e[v],Ct,Ge,1,a),_=lr(i,e[v],wt,Ze(Ge,wt,mr),1,o),O=lr(i,e[C],wt,Ge,1,l);ht(T,"rayRay"),ht(S,"rayRay"),ht(_,"rayRay"),ht(O,"rayRay")}function F(e,t){return 3*t+e}const ks=k();function fe(e,t){return Ci(ks,e[t],e[t+3]),ks}const ue=k(),b=Yn();function ad(e,t,r,i,s){St(ue,r,i),xt(ue,ue,.5),b[0]=ue[0],b[1]=ue[1],b[2]=0,b[3]=ue[1],b[4]=-ue[0],b[5]=0,b[6]=ue[0]*ue[0]+ue[1]*ue[1],b[7]=ue[0]*ue[1]-ue[1]*ue[0],b[8]=1,b[F(0,2)]=-ne(fe(b,0),e),b[F(1,2)]=-ne(fe(b,1),e);let a=ne(fe(b,0),r)+b[F(0,2)],o=ne(fe(b,1),r)+b[F(1,2)],l=ne(fe(b,0),i)+b[F(0,2)],c=ne(fe(b,1),i)+b[F(1,2)];a=-(a+l)/(o+c),b[F(0,0)]+=b[F(1,0)]*a,b[F(0,1)]+=b[F(1,1)]*a,b[F(0,2)]+=b[F(1,2)]*a,a=1/(ne(fe(b,0),r)+b[F(0,2)]),o=1/(ne(fe(b,1),r)+b[F(1,2)]),b[F(0,0)]*=a,b[F(0,1)]*=a,b[F(0,2)]*=a,b[F(1,0)]*=o,b[F(1,1)]*=o,b[F(1,2)]*=o,b[F(2,0)]=b[F(1,0)],b[F(2,1)]=b[F(1,1)],b[F(2,2)]=b[F(1,2)],b[F(1,2)]+=1,a=ne(fe(b,1),t)+b[F(1,2)],o=ne(fe(b,2),t)+b[F(2,2)],l=ne(fe(b,1),r)+b[F(1,2)],c=ne(fe(b,2),r)+b[F(2,2)],a=-.5*(a/o+l/c),b[F(1,0)]+=b[F(2,0)]*a,b[F(1,1)]+=b[F(2,1)]*a,b[F(1,2)]+=b[F(2,2)]*a,a=ne(fe(b,1),t)+b[F(1,2)],o=ne(fe(b,2),t)+b[F(2,2)],l=-o/a,b[F(1,0)]*=l,b[F(1,1)]*=l,b[F(1,2)]*=l,s[0]=b[0],s[1]=b[1],s[2]=0,s[3]=b[2],s[4]=b[3],s[5]=b[4],s[6]=0,s[7]=b[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=b[6],s[13]=b[7],s[14]=0,s[15]=b[8]}function od(e,t,r,i,s){const a=1/xe[0][3],o=1/xe[4][3];pe(a<o);let l=a+Math.sqrt(a*o);const c=Math.sin(yo(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));l/=c,sd(xe,l,c,zs,Us,id,Hs,Gs),ad(zs,Us,Hs,Gs,s.projectionMatrix),s.projectionMatrix[10]=2/(r-i),s.projectionMatrix[14]=-(r+i)/(r-i)}function nd(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}var Nr,Ie;(function(e){e[e.ADD=0]="ADD",e[e.UPDATE=1]="UPDATE",e[e.REMOVE=2]="REMOVE"})(Nr||(Nr={})),function(e){e[e.NONE=0]="NONE",e[e.VISIBILITY=1]="VISIBILITY",e[e.GEOMETRY=2]="GEOMETRY",e[e.TRANSFORMATION=4]="TRANSFORMATION",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.OCCLUDEE=16]="OCCLUDEE"}(Ie||(Ie={}));let ld=class{constructor(t,r){this._material=t,this._repository=r,this._map=new Map}dispose(){this._map.forEach((t,r)=>{t!=null&&this._repository.release(this._material,r)})}load(t,r,i){const s=this._material.produces.get(r);if(!(s!=null&&s(i)))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,r,i));const a=this._map.get(i);if(a!=null){if(a.ensureResources(t)===zn.LOADED)return a;this._repository.requestRender()}return null}},cd=class extends rn{constructor(t=M()){super(),this.origin=t,this.slicePlaneLocalOrigin=this.origin}},Gi=class{constructor(t=0,r=0){this.from=t,this.to=r}get numElements(){return this.to-this.from}};function qs(e){const t=new Map;e.forAll(i=>t.set(i.from,i));let r=!0;for(;r;){r=!1;for(let i=0;i<e.length;++i){const s=e.data[i],a=t.get(s.to);if(!a)return;s.to=a.to,t.delete(a.from),e.removeUnordered(a),r=!0}}}let Zs=class extends Gi{constructor(t,r,i){super(r,i),this.geometry=t}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.geometry.highlights!=null&&this.isVisible}get hasOccludees(){return this.geometry.occludees!=null}};class dd{constructor(){this.first=0,this.count=0}}let hd=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new Pe({allocator:t=>t||new Gi,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=gr(),this.drawCommandsHighlight=gr(),this.drawCommandsOccludees=gr(),this.drawCommandsShadowHighlightRest=gr()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(t,r){this.deleteInstance(t),this._instances.set(t,r),this._numElements+=r.numElements}deleteInstance(t){const r=this._instances.get(t);r&&(this._numElements-=r.numElements,this._instances.delete(t))}updateInstance(t,r,i){const s=this._instances.get(t);s&&(this._numElements-=s.numElements,s.from=r,s.to=i,this._numElements+=s.numElements)}updateDrawState(t){t.isVisible?(t.hasHighlights&&(this.hasHighlights=!0),t.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(t){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){const i=this.drawCommandsDefault.pushNew(),s=this.holes.front();return this.vao!=null&&this.holes.length===1&&s.to===Math.floor(this.vao.byteSize/t)?(i.first=0,void(i.count=s.from)):(i.first=1/0,i.count=0,this._instances.forEach(a=>{i.first=Math.min(i.first,a.from),i.count=Math.max(i.count,a.to)}),void(i.count-=i.first))}const r=Array.from(this._instances.values()).sort((i,s)=>i.from===s.from?i.to-s.to:i.from-s.from);for(const i of r)i.isVisible&&(Qs(i.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,i),Qs(i.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,i))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function ud(e){return e.vao!=null}function gr(){return new Pe({allocator:e=>e||new dd,deallocator:e=>e})}function Qs(e,t){const r=e.back();if(r==null){const i=e.pushNew();return i.first=t.from,void(i.count=t.numElements)}if(pd(r,t)){const i=t.from-r.first+t.numElements;r.count=i}else{const i=e.pushNew();i.first=t.from,i.count=t.numElements}}function pd(e,t){return e.first+e.count>=t.from}let fd=class{constructor(t){this.origin=t,this.buffers=new Array}dispose(){this.buffers.forEach(t=>t.vao.dispose()),this.buffers.length=0}findBuffer(t){return this.buffers.find(r=>r.instances.has(t))}};class md{constructor(t,r){this._cache=t(r,(i,s,a)=>{switch(s){case Ki.ALL:return i.forEach(o=>o.dispose()),0;case Ki.SOME:{const o=i.shift();return o&&(a-=Math.round(o.usedMemory),o.dispose()),a}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(t){return this._cache.getSize(t)}pop(t){const r=this._cache.peek(t);if(!r)return;const i=r.pop();if(r.length>0){if(i){const s=this._cache.getSize(t)-Math.round(i.usedMemory);this._cache.updateSize(t,r,s)}}else this._cache.pop(t);return i}put(t,r,i=wo){const s=this._cache.peek(t);if(!s)return void this._cache.put(t,[r],r.usedMemory,i);s.push(r);const a=this._cache.getSize(t)+Math.round(r.usedMemory);this._cache.updateSize(t,s,a)}}class gd{constructor(t,r,i){this._rctx=t,this._locations=r,this._layout=i,this._cache=new md(t.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(t){const r=t.toString();let i=this._cache.pop(r);return i||(i=new il(this._rctx,this._locations,{geometry:this._layout},{geometry:tl.createVertex(this._rctx,kn.STATIC_DRAW)}),i.vertexBuffers.geometry.setSize(t),i)}deleteVao(t){if(t==null)return;const r=t.byteSize.toString();this._cache.put(r,t)}}let Or=class extends jl{constructor(e){super(e),this._vaoCache=null,this._glMaterials=null,this._bufferWriter=null,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._produces=new Map,this.drapedPriority=0}destroy(){this._glMaterials=Yt(this._glMaterials),this._dataByOrigin.forEach(e=>e.dispose()),this._dataByOrigin.clear(),this._vaoCache=Yt(this._vaoCache)}initialize(){this.material.produces.forEach((e,t)=>{this._produces.set(t,r=>!(this._dataByOrigin.size===0||!(r!==E.Highlight&&r!==E.ShadowHighlight||this._hasHighlights))&&e(r))})}get produces(){return this._produces}initializeRenderContext(e,t){const{rctx:r}=e.renderContext;this._glMaterials=new ld(this.material,t??e.materials),this._bufferWriter=this.material.createBufferWriter(),this._vaoCache=new gd(r,this.material.vertexAttributeLocations,Kn(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}get hasOccludees(){return this._hasOccludees}get isDecoration(){return this.material.parameters.isDecoration}queryRenderOccludedState(e){return this.material.queryRenderOccludedState(e)}get materialReference(){return this.material}get numGeometries(){let e=0;return this._dataByOrigin.forEach(t=>e+=t.buffers.reduce((r,i)=>r+i.instances.size,0)),e}get usedMemory(){let e=0;return this._dataByOrigin.forEach(t=>e+=t.buffers.reduce((r,i)=>r+i.vao.usedMemory,0)),e}forEachGeometry(e){this._dataByOrigin.forEach(t=>t.buffers.forEach(r=>r.instances.forEach(i=>e(i.geometry))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const t=this._bufferWriter;if(t===null)return;const r=t.vertexBufferLayout.stride/4;for(const i of e){const s=i.renderGeometry,a=this._dataByOrigin.get(s.localOrigin.id),o=a==null?void 0:a.findBuffer(s.id);if(o==null)return;const l=o.instances.get(s.id);if(i.updateType&(Ie.GEOMETRY|Ie.TRANSFORMATION)){const c=yr(t.elementCount(l.geometry.geometry)*r),n=t.vertexBufferLayout.createView(c.buffer);this._writeGeometry(s,n,0),o.vao.vertexBuffers.geometry.setSubData(c,l.from*r,0,l.numElements*r)}i.updateType&(Ie.HIGHLIGHT|Ie.OCCLUDEE|Ie.VISIBILITY)&&(o.drawCommandsDirty=!0)}}_computeDeltas(e,t){const r=new zi;for(const i of e){const s=i.localOrigin;if(s==null)continue;let a=r.get(s.id,null);a==null&&(a=new Js(s.vec3),r.set(s.id,null,a)),a.changes.push(i)}for(const i of t){const s=i.localOrigin;if(s==null)continue;const a=this._dataByOrigin.get(s.id),o=a==null?void 0:a.findBuffer(i.id);if(o==null)continue;let l=r.get(s.id,o);l==null&&(l=new Js(s.vec3),r.set(s.id,o,l)),l.changes.push(i)}return r}_addAndRemoveGeometries(e,t){if(this._bufferWriter===null||this._vaoCache===null)return;const{_bufferWriter:r,_dataByOrigin:i}=this,s=r.vertexBufferLayout.stride/4,a=this._computeDeltas(e,t);a.forEach((o,l)=>{const c=o.get(null),n=c!=null?c.changes:[];a.delete(l,null);let d=i.get(l);if(o.forEach((h,p)=>{if(a.delete(l,p),p==null)return void pe(!1,"No VAO for removed geometries");if(p.instances.size===h.changes.length)return this._vaoCache.deleteVao(p.vao),es(d.buffers,p),void(d.buffers.length===0&&n.length===0&&i.delete(l));const u=p.numElements,f=p.vao.byteSize/4,v=n.reduce((_,O)=>_+r.elementCount(O.geometry),0),C=h.changes.reduce((_,O)=>_+r.elementCount(O.geometry),0),T=Math.min((u+v-C)*s,_r),S=T>f;T>jr&&T<f/2?(h.changes.forEach(({id:_})=>p.deleteInstance(_)),p.instances.forEach(({geometry:_})=>n.push(_)),this._vaoCache.deleteVao(p.vao),es(d.buffers,p)):S?this._applyAndRebuild(p,n,h):this._applyRemoves(p,h)}),n.length>0)for(d==null&&(d=new fd(c.origin),i.set(l,d)),d.buffers.forEach(h=>this._applyAdds(h,n));n.length>0;)d.buffers.push(this._applyAndRebuild(new hd,n,null))})}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(e=>{e.buffers.forEach(t=>{t.drawCommandsDirty&&(t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,Be(t.instances,r=>(t.updateDrawState(r),t.hasHiddenInstances&&t.hasHighlights&&t.hasOccludees)),t.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||t.hasHighlights,this._hasOccludees=this._hasOccludees||t.hasOccludees})})}_applyAndRebuild(e,t,r){if(r!=null)for(const u of r.changes)e.deleteInstance(u.id);const i=this._bufferWriter,s=i.vertexBufferLayout.stride,a=s/4,o=Math.floor(_r/a);let l=e.numElements;for(;t.length>0;){const u=t.pop(),f=i.elementCount(u.geometry);if(l+f>o&&l>0){t.push(u);break}l+=f;const v=new Zs(u,0,0);pe(e.instances.get(u.id)==null),e.addInstance(u.id,v)}const c=l*a,n=yr(c),d=i.vertexBufferLayout.createView(n.buffer);let h=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach((u,f)=>{this._writeGeometry(u.geometry,d,h);const v=h;h+=i.elementCount(u.geometry.geometry),e.updateInstance(f,v,h),e.updateDrawState(u)}),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(Ks(c)),e.vao.vertexBuffers.geometry.setSubData(n,0,0,h*a),e.holes.clear();const p=e.holes.pushNew();return p.from=h,p.to=Math.floor(e.vao.byteSize/s),e.updateDrawCommands(s),e}_applyRemoves(e,t){if(t.changes.length===0||this._bufferWriter===null)return;for(const o of t.changes){const l=o.id,c=e.instances.get(l);if(!c)continue;e.deleteInstance(l);const n=Ee.back();if(n){if(n.to===c.from){n.to=c.to;continue}if(n.from===c.to){n.from=c.from;continue}}const d=Ee.pushNew();d.from=c.from,d.to=c.to}qs(Ee);const r=this._bufferWriter.vertexBufferLayout.stride/4,i=Ee.reduce((o,l)=>Math.max(o,l.numElements),0)*r,s=yr(i);s.fill(0,0,i);const a=e.vao.vertexBuffers.geometry;Ee.forAll(o=>a.setSubData(s,o.from*r,0,o.numElements*r)),e.holes.pushArray(Ee.data,Ee.length),Ee.forAll((o,l)=>Ee.data[l]=null),Ee.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(t.length===0||this._bufferWriter===null)return;if(!ud(e))return void this._applyAndRebuild(e,t,null);const r=this._bufferWriter,i=r.vertexBufferLayout.stride/4,s=e.numElements,a=t.reduce((C,T)=>C+r.elementCount(T.geometry),0),o=Math.min((s+a)*i,_r),l=4*o;if(e.vao.byteSize<Ks(_r-jr)&&l>e.vao.byteSize)return void this._applyAndRebuild(e,t,null);qs(e.holes);const c=new Array;for(const C of t){const T=r.elementCount(C.geometry),S=vd(e.holes,T);c.push(S)}const n=e.vao.vertexBuffers.geometry;let d=0,h=0,p=0;const u=yr(o),f=r.vertexBufferLayout.createView(u.buffer);t.forEach((C,T)=>{const S=c[T];if(S==null)return;if(p!==S){const x=p-h;x>0&&n.setSubData(u,h*i,0,x*i),h=S,d=0}const _=r.elementCount(C.geometry);this._writeGeometry(C,f,d),d+=_,p=S+_;const O=new Zs(C,S,S+_);pe(e.instances.get(C.id)==null),e.addInstance(C.id,O),e.drawCommandsDirty=!0});const v=p-h;v>0&&n.setSubData(u,h*i,0,v*i),Co(t,(C,T)=>c[T]==null)}_writeGeometry(e,t,r){if(this._bufferWriter===null)return;const i=e.localOrigin.vec3;gn(Ys,-i[0],-i[1],-i[2]);const s=ke(_d,Ys,e.transformation);kt(vr,s),ta(vr,vr),this._bufferWriter.write(s,vr,e.geometry,t,r)}updateAnimation(e){return this.material.update(e)}prepareTechnique(e){if(!this.material.shouldRender(e))return null;const{output:t,bindParameters:r}=e,i=this.material.produces.get(r.slot);if(!(i!=null&&i(t)))return null;const s=t===E.Highlight||t===E.ShadowHighlight;if(s&&!this._hasHighlights)return null;const a=t===E.ShadowExcludeHighlight,o=!(s||a);for(const l of this._dataByOrigin.values())for(const c of l.buffers){if(s&&!c.hasHighlights)continue;const n=(s?c.drawCommandsHighlight:a&&c.needsMultipleCommands()?c.drawCommandsShadowHighlightRest:c.drawCommandsDefault)||null,d=o&&c.drawCommandsOccludees||null;if(n!=null&&n.length||d!=null&&d.length){const h=this._glMaterials.load(e.rctx,r.slot,t),p=h!=null?h.beginSlot(r):null;if(p!=null)return p}}return null}renderNode(e,t){const{output:r,bindParameters:i}=e,s=r===E.Highlight||r===E.ShadowHighlight,a=r===E.ShadowExcludeHighlight,o=!(s||a),l=i.slot===ie.OCCLUDER_MATERIAL,c=i.slot===ie.TRANSPARENT_OCCLUDER_MATERIAL,n=e.rctx;n.runAppleAmdDriverHelper(),n.bindTechnique(t,i,this.material.parameters);for(const d of this._dataByOrigin.values())for(const h of d.buffers){if(s&&!h.hasHighlights)continue;const p=(s?h.drawCommandsHighlight:a&&h.needsMultipleCommands()?h.drawCommandsShadowHighlightRest:h.drawCommandsDefault)||null,u=o&&h.drawCommandsOccludees||null;(p!=null&&p.length||u!=null&&u.length)&&(t.program.bindDraw(new cd(d.origin),i,this.material.parameters),t.ensureAttributeLocations(h.vao),n.bindVAO(h.vao),p!=null&&p.length&&(n.setPipelineState(t.getPipeline(!1,l,c)),p.forAll(f=>n.drawArrays(t.primitiveType,f.first,f.count))),u!=null&&u.length&&(n.setPipelineState(t.getPipeline(!0,l,c)),u.forAll(f=>n.drawArrays(t.primitiveType,f.first,f.count))))}}get test(){}};m([R({constructOnly:!0})],Or.prototype,"material",void 0),Or=m([tr("esri.views.3d.webgl-engine.materials.renderers.MergedRenderer")],Or);class Js{constructor(t){this.origin=t,this.changes=new Array}}function vd(e,t){let r;if(!e.some(s=>!(s.numElements<t)&&(r=s,!0)))return null;const i=r.from;return r.from+=t,r.from>=r.to&&e.removeUnordered(r),i}const Ys=W(),_d=W(),vr=W(),Ee=new Pe({allocator:e=>e||new Gi,deallocator:null}),jr=65536,mi=4*jr,Xs=1024,qa=16777216,_r=qa/4;let gi=new Float32Array(jr);function yr(e){return gi.length<e&&(gi=new Float32Array(e)),gi}function Ks(e){const t=4*e;return t<=Xs?Xs:t<mi?xo(t):Math.max(Math.min(Math.ceil(1.5*t/mi)*mi,qa),t)}let Ce=class extends Mi{constructor(e){super(e),this._pending=new yd,this._changes=new vl,this._materialRenderers=new Map,this._sortedMaterialRenderers=new Pe,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach(e=>e.destroy()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materials(){return this.rendererContext.materials}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccludedDraped(){return Be(this._materialRenderers,e=>e.numGeometries!==0&&!e.queryRenderOccludedState(Re.Occlude))}get isEmpty(){return!this.updating&&this._materialRenderers.size===0&&this._geometries.size===0}getMaterialRenderer(e){return this._materialRenderers.get(e)}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=wl(this._changes);let t=!1;return e.forEach((r,i)=>{let s=this.getMaterialRenderer(i);if(!s&&r.adds.length>0){const a=new Or({material:i});a.initializeRenderContext(this.rendererContext.pluginContext,this._materials),s=a,this._materialRenderers.set(i,s),t=!0}s&&(s.modify(r),s.numGeometries===0&&(this._materialRenderers.delete(i),s.destroy(),t=!0))}),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),this._hasHighlights=Be(this._materialRenderers,r=>{const i=r.produces.get(ie.DRAPED_MATERIAL);return!!i&&i(E.Highlight)}),this._hasWater=Be(this._materialRenderers,r=>{const i=r.produces.get(ie.DRAPED_WATER);return!!i&&i(E.Normal)}),this.notifyChange("updating"),!0}addGeometries(e,t){if(e.length===0)return;const r=this._validateRenderGeometries(e);for(const s of r)this._geometries.set(s.id,s);const i=this._pending.empty;for(const s of r)this._pending.adds.add(s);i&&this.notifyChange("updating"),t===Nr.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const r=this._pending.empty,i=this._pending.adds;for(const s of e)i.has(s)?(this._pending.removed.add(s),i.delete(s)):this._pending.removed.has(s)||this._pending.removes.add(s),this._geometries.delete(s.id);r&&!this._pending.empty&&this.notifyChange("updating"),t===Nr.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const r=this._changes.updates.length===0;for(const i of e){const s=this._changes.updates.pushNew();s.renderGeometry=this._validateRenderGeometry(i),s.updateType=t}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case Ie.TRANSFORMATION:case Ie.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case Ie.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll(r=>t=!!r.updateAnimation&&r.updateAnimation(e)||t),t}shouldRender(e){return this._sortedMaterialRenderers.some(t=>t.prepareTechnique(e))}render(e){this._sortedMaterialRenderers.forAll(t=>{const r=t.prepareTechnique(e);r!=null&&t.renderNode(e,r)})}intersect(e,t,r,i,s){return this._geometries.forEach(a=>{if(i&&!i(a))return;this._intersectRenderGeometry(a,r,t,0,e,s);const o=this.rendererContext.longitudeCyclical;o&&(a.boundingSphere[0]-a.boundingSphere[3]<o.min&&this._intersectRenderGeometry(a,r,t,o.range,e,s),a.boundingSphere[0]+a.boundingSphere[3]>o.max&&this._intersectRenderGeometry(a,r,t,-o.range,e,s)),s++}),s}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;for(const t of this._materialRenderers.values())t.drapedPriority=e++,this._sortedMaterialRenderers.push(t);this._sortedMaterialRenderers.sort((t,r)=>{var i,s,a,o;return((i=r.materialReference)==null?void 0:i.renderPriority)===((s=t.materialReference)==null?void 0:s.renderPriority)?t.drapedPriority-r.drapedPriority:(((a=r.materialReference)==null?void 0:a.renderPriority)||0)-(((o=t.materialReference)==null?void 0:o.renderPriority)||0)})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,t,r,i,s,a){if(!e.visible)return;let o=0;i+=e.transformation[12],o=e.transformation[13],vi[0]=r[0]-i,vi[1]=r[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,s,vi,(l,c,n)=>{wd(t,n,a,e.material.renderPriority,s,e.layerUid,e.graphicUid)},t)}_notifyGraphicGeometryChanged(e){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let t;for(const r of e){const i=r.graphicUid;i!=null&&i!==t&&(this.drapeSource.notifyGraphicGeometryChanged(i),t=i)}}_notifyGraphicVisibilityChanged(e){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let t;for(const r of e){const i=r.graphicUid;i!=null&&i!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(i),t=i)}}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return e.localOrigin==null&&(e.localOrigin=this._localOriginFactory.getOrigin(Er(e.boundingSphere))),e}get test(){}};m([R()],Ce.prototype,"drapeSource",void 0),m([R()],Ce.prototype,"updating",null),m([R()],Ce.prototype,"rctx",null),m([R({constructOnly:!0})],Ce.prototype,"rendererContext",void 0),m([R()],Ce.prototype,"_materials",null),m([R()],Ce.prototype,"_localOriginFactory",null),m([R({readOnly:!0})],Ce.prototype,"isEmpty",null),m([R()],Ce.prototype,"_materialRenderers",void 0),m([R()],Ce.prototype,"_geometries",void 0),Ce=m([tr("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Ce);class yd{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(t){return this.adds.has(t)||this.removes.has(t)||this.removed.has(t)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}function wd(e,t,r,i,s,a,o){const l=new Xn(a,o,t),c=n=>{n.set(xn.OVERLAY,l,e.dist,e.normal,e.transformation,r,i)};if((s.results.min.drapedLayerOrder==null||r>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&c(s.results.min),s.options.store!==us.MIN&&(s.results.max.drapedLayerOrder==null||r<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&c(s.results.max),s.options.store===us.ALL){const n=Cn(s.ray);c(n),s.results.all.push(n)}}const vi=k();let Za=class Qa extends Fi{initializeProgram(t){return new Ni(t.rctx,Qa.shader.get().build(),fa)}initializePipeline(){return this.configuration.hasAlpha?rt({blending:Qn(Ot.SRC_ALPHA,Ot.ONE,Ot.ONE_MINUS_SRC_ALPHA,Ot.ONE_MINUS_SRC_ALPHA),colorWrite:$t}):rt({colorWrite:$t})}};Za.shader=new Li(pc,()=>$i(()=>import("./ColorMaterial.glsl-CcrBVOmk.js").then(e=>e.T),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37])));class Ja extends va{constructor(){super(...arguments),this.hasAlpha=!1}}m([P()],Ja.prototype,"hasAlpha",void 0);class Ya extends ga{constructor(){super(...arguments),this.overlayIndex=Oe.INNER,this.opacity=1}}function Cd(){const e=new Ii;return e.include(ca),e.fragment.uniforms.add(new qe("tex",t=>t.texture)),e.fragment.uniforms.add(new sn("overlayIdx",t=>t.overlayIndex)),e.fragment.uniforms.add(new Z("opacity",t=>t.opacity)),e.fragment.code.add(w`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;
}`),e}const xd=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:Ya,build:Cd},Symbol.toStringTag,{value:"Module"}));class Wr extends Fi{initializeProgram(t){return new Ni(t.rctx,Wr.shader.get().build(),fa)}initializePipeline(){return rt({blending:Jn(Ot.ONE,Ot.ONE_MINUS_SRC_ALPHA),colorWrite:$t})}}Wr.shader=new Li(xd,()=>$i(()=>import("./ColorMaterial.glsl-CcrBVOmk.js").then(e=>e.O),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37])));let Te=class extends Nl{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new Ya,this.hasHighlights=!1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new Pe,this._passParameters=new Aa,this._materials=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new Ur,this.worldToPCSRatio=1,this.events=new ia,this.longitudeCyclical=null,this.produces=new Map([[ie.DRAPED_MATERIAL,t=>t!==E.Highlight||this.hasHighlights],[ie.DRAPED_WATER,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1}initialize(){const e=this.view._stage.renderer.fboCache,t=this.view._stage.renderView,{waterTextures:r,stippleTextures:i,markerTextures:s}=t;this._techniques=new fc({rctx:this._rctx,viewingMode:ji.Local,stippleTextures:i,markerTextures:s,waterTextures:r}),this._renderContext=new ka(this._rctx,new td(e,this.view.state.viewingMode),null),this.addHandles([kr(()=>r.updating,()=>this.events.emit("content-changed"),ts),kr(()=>this.spatialReference,a=>this._localOriginFactory=new Kc(a),ts),So(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0)]),this._materials=new vc(t.textures,this._techniques,()=>{this.notifyChange("rendersOccludedDraped"),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed")),this._bindParameters.slot=ie.DRAPED_MATERIAL,this._bindParameters.mainDepth=null,this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=Fe.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new an(at(1,1,1))]),this.addHandles(this.view.resourceController.scheduler.registerTask(Fn.STAGE,this))}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._debugTextureTechnique=Dr(this._debugTextureTechnique),this._passParameters.texture=Yt(this._passParameters.texture),this._techniques=sa(this._techniques),this.disposeOverlays()}get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materials(){return this._materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}initializeRenderContext(e){this.pluginContext=e}uninitializeRenderContext(){}renderNode(){}get updating(){return this._sortedDrapeSourceRenderersDirty||Be(this._renderers,e=>e.updating)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(const t of this._renderers.values()){const r=t.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e)}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,Ce)}createDrapeSourceRenderer(e,t,r){const i=this._renderers.get(e);i!=null&&i.destroy();const s=new t({...r,rendererContext:this,drapeSource:e});return this._renderers.set(e,s),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(kr(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e),s}removeDrapeSourceRenderer(e){if(e==null)return;const t=this._renderers.get(e);t!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){var e;return((e=this._renderTargets)==null?void 0:e.computeValidity())??0}releaseRenderTargets(){var e;(e=this._renderTargets)==null||e.dispose()}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&qr(e,t=>t.drapeTargetType===Ri.WithoutRasterImage)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=qr(e,t=>t.drapeSourceType===Zt.Features),this._hasDrapedRasterSource=qr(e,t=>t.drapeSourceType===Zt.RasterImage)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new ac(this.view._stage.renderer.fboCache),this._overlays=[new Es,new Es]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){this._overlays=null,this._renderTargets=Yt(this._renderTargets),this.events.emit("textures-disposed")}getTexture(e){var t,r;if(e!=null)return e===Y.ColorNoRasterImage&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource?(t=this._renderTargets)==null?void 0:t.getTexture(Y.Color):(r=this._renderTargets)==null?void 0:r.getTexture(e)}get running(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_processDrapeSources(e,t){let r=!1;for(const[i,s]of this._renderers){if(e.done)break;(i.destroyed||t(i))&&s.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this.hasHighlights=Be(this._renderers,i=>i.hasHighlights),this.notifyChange("rendersOccludedDraped"),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Nn,e=>e.updatePolicy===Kt.SYNC)}get isEmpty(){return!Xr.OVERLAY_DRAW_DEBUG_TEXTURE&&!Be(this._renderers,e=>!e.isEmpty)}get hasWater(){return this._hasWater}get rendersOccludedDraped(){const e=this._renderContext.renderOccludedMask;this._renderContext.renderOccludedMask=ea;const t=this._sortedRenderers.some(({renderer:r})=>r.shouldRender(this._renderContext));return this._renderContext.renderOccludedMask=e,t}renders(e){return Xr.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==Y.Occluded||this._sortedRenderers.some(({renderer:t})=>t.shouldRender(this._renderContext))}get mode(){var e,t;return this.isEmpty?At.Disabled:(e=this._renderTargets)!=null&&e.getTexture(Y.WaterNormal)?At.EnabledWithWater:(t=this._renderTargets)!=null&&t.getTexture(Y.Color)?At.Enabled:At.Disabled}updateAnimation(e){let t=!1;return this._renderers.forEach(r=>t=r.updateAnimation(e)||t),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawOverlays(e){if(this._overlays&&this._renderTargets){for(const t of this._overlays)this.longitudeCyclical?t.setupGeometryViewsCyclical(this.longitudeCyclical):t.setupGeometryViewsDirect();for(const t of this._renderTargets.targets){if(t.content===Y.ColorNoRasterImage&&!this._needsColorWithoutRasterImage)continue;const r=this._drawTarget(Oe.INNER,t,e),i=this._drawTarget(Oe.OUTER,t,e);(r||i)&&t.fbo.generateMipMap()}}}_drawTarget(e,t,r){const i=this._overlays[e],s=i.canvasGeometries;if(s.numViews===0)return!1;const{alignPixelEnabled:a,contentPixelRatio:o}=r;this._screenToWorldRatio=o*i.mapUnitsPerPixel/this._bindParameters.overlayStretch;const l=t.output;if(this.isEmpty||l===E.Highlight&&!this.hasHighlights||l===E.Normal&&!this.hasWater||!i.hasSomeSizedView())return!1;const c=this._rctx;if(this._camera.pixelRatio=i.pixelRatio*o,this._renderContext.output=l,this._bindParameters.alignPixelEnabled=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=l===E.Normal?ie.DRAPED_WATER:ie.DRAPED_MATERIAL,t.content===Y.Occluded&&(this._renderContext.renderOccludedMask=ea),!this.renders(t.content))return this._renderContext.renderOccludedMask=Di,!1;const n=i.resolution;this._rctx.setViewport(e===Oe.INNER?0:n,0,n,n);const d=2*i.resolution,h=i.resolution,p=t.fbo;if(p.bind(c,d,h),e===Oe.INNER&&(c.setClearColor(0,0,0,0),c.clear(Ir.COLOR_BUFFER_BIT)),Xr.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==Y.Occluded)for(let u=0;u<s.numViews;u++)this._setViewParameters(s.extents[u],i),this._ensureDebugPatternResources(i.resolution,Td[e]),this._rctx.bindTechnique(this._debugTextureTechnique,this._renderContext.bindParameters,this._passParameters),this._rctx.screen.draw();return this._sortedRenderers.forAll(({drapeSource:u,renderer:f})=>{if(t.content===Y.ColorNoRasterImage&&u.drapeSourceType===Zt.RasterImage)return;const{fullOpacity:v}=u,C=v!=null&&v<1&&l===E.Color?this.bindTemporaryFramebuffer(d,h):null;for(let T=0;T<s.numViews;T++)this._setViewParameters(s.extents[T],i),f.render(this._renderContext);if(C){p.bind(c,d,h),this._overlayParameters.texture=C.getTexture(),this._overlayParameters.opacity=v,this._overlayParameters.overlayIndex=e;const T=this.pluginContext.techniques.acquire(Wr);this._rctx.bindTechnique(T,this._renderContext.bindParameters,this._overlayParameters),this._rctx.screen.draw(),T.release(),C.release()}}),c.bindFramebuffer(null),this._renderContext.renderOccludedMask=Di,!0}bindTemporaryFramebuffer(e,t){var s;const r=this.view._stage.renderer.fboCache,i=r.acquire(e,t,"overlay tmp");return r.rctx.unbindTexture((s=i.fbo)==null?void 0:s.colorTexture),r.rctx.bindFramebuffer(i.fbo),r.rctx.clear(Ir.COLOR_BUFFER_BIT),i}async reloadShaders(){await this._techniques.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,i){var a;this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let s=0;for(const{renderer:o}of this._sortedRenderers)s=((a=o.intersect)==null?void 0:a.call(o,e,t,r,i,s))??s}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this.view.map.allLayers,t=e.length;this._renderers.forEach((r,i)=>{const s=e.indexOf(i.layer),a=s>=0,o=i.renderGroup??(a?Lr.MapLayer:Lr.ViewLayer),l=t*o+(a?s:0);this._sortedRenderers.push(new Sd(i,r,l))}),this._sortedRenderers.sort((r,i)=>r.index-i.index)}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],To(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),bo(r.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=Be(this._renderers,t=>t.hasWater);e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_ensureDebugPatternResources(e,t){if(Q(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let i=0;for(let o=0;o<e;o++)for(let l=0;l<e;l++){const c=Math.floor(l/10),n=Math.floor(o/10);c<2||n<2||10*c>e-20||10*n>e-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&c&&1&n?1&l^1&o?0:255:1&c^1&n?0:128)}const s=new Ui(e);s.samplingMode=qn.NEAREST,this._passParameters.texture=new Xt(this._rctx,s,r);const a=new Ja;a.hasAlpha=!0,this._debugTextureTechnique=this._techniques.acquire(Za,a)}get test(){}};m([R()],Te.prototype,"hasHighlights",void 0),m([R()],Te.prototype,"_sortedDrapeSourceRenderersDirty",void 0),m([R()],Te.prototype,"_techniques",void 0),m([R({constructOnly:!0})],Te.prototype,"view",void 0),m([R()],Te.prototype,"worldToPCSRatio",void 0),m([R()],Te.prototype,"spatialReference",void 0),m([R({type:Boolean,readOnly:!0})],Te.prototype,"updating",null),m([R()],Te.prototype,"isEmpty",null),m([R({readOnly:!0})],Te.prototype,"rendersOccludedDraped",null),Te=m([tr("esri.views.3d.terrain.OverlayRenderer")],Te);class Sd{constructor(t,r,i){this.drapeSource=t,this.renderer=r,this.index=i}}const Td=[[1,.5,.5],[.5,.5,1]],ap=-2,ea=Re.OccludeAndTransparent;class op{constructor(t,r={}){this.geometry=t,this.screenToWorldRatio=1,this._transformation=W(),this._shaderTransformation=null,this._boundingSphere=null,this.id=Ei(),this.layerUid=r.layerUid,this.graphicUid=r.graphicUid,this.castShadow=r.castShadow??!1,r.objectShaderTransformation!=null&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(t){st(this._transformation,t),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(t){t==null?this._shaderTransformation=null:(this._shaderTransformation??(this._shaderTransformation=W()),ke(this._shaderTransformation,t,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??(this._boundingSphere=ua()),ye(Er(this._boundingSphere),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*_a(this.shaderTransformation)),this._boundingSphere):un}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(t){this.geometry.visible=t}}export{Oh as $,Ph as A,$h as B,Kt as C,tu as D,Nr as E,Vc as F,er as G,Ll as H,Ie as I,jl as J,il as K,Vh as L,Ce as M,Si as N,Kl as O,Uc as P,Fr as Q,Bl as R,Aa as S,uc as T,Ya as U,Cd as V,Vl as W,Yl as X,jh as Y,Rh as Z,Kc as _,Vu as a,Za as a$,bh as a0,Ah as a1,su as a2,bi as a3,eu as a4,Ch as a5,Yh as a6,Xh as a7,Jl as a8,Kh as a9,Ms as aA,At as aB,Ru as aC,Y as aD,Ds as aE,md as aF,cd as aG,ea as aH,As as aI,Pu as aJ,bu as aK,cc as aL,He as aM,Ai as aN,Gh as aO,gu as aP,_u as aQ,wu as aR,xu as aS,qh as aT,Zh as aU,Ss as aV,td as aW,Qu as aX,wl as aY,Or as aZ,Di as a_,Ia as aa,nt as ab,ot as ac,Cc as ad,zc as ae,Qt as af,za as ag,Uu as ah,ee as ai,ld as aj,Bh as ak,Ts as al,Tu as am,lc as an,rl as ao,ul as ap,Pr as aq,xl as ar,G as as,it as at,Il as au,Fl as av,fh as aw,V as ax,Te as ay,Oi as az,Pa as b,Ja as b0,xc as b1,Hu as b2,ju as b3,fc as b4,vc as b5,vl as b6,wc as c,Ri as d,Zt as e,Jh as f,Lh as g,Mh as h,Lr as i,Eh as j,Oe as k,iu as l,op as m,ru as n,au as o,Sa as p,Qh as q,Nl as r,Dh as s,ap as t,zu as u,Ur as v,Fh as w,Nh as x,Ih as y,Gc as z};
