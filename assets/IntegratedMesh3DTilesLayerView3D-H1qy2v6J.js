import{d as Fe,s as Y,bY as ge,fa as He,dI as be,c0 as Ve,fN as De,bD as Le,kD as je,kE as Be,bp as K,b9 as ke,d5 as Ge,bo as Ne,dn as $e,n as ye,ac as S,ad as L,ag as ze}from"./index-DX0rcHuW.js";import{n as We,s as qe}from"./mat3-Ck4GO2qT.js";import{e as _e,o as Q}from"./mat3f64-BBpwCtoL.js";import{e as we}from"./mat4f64-Dk4dwAN8.js";import{t as Je}from"./quatf64-BrpT0VRp.js";import{u as Xe}from"./computeTranslationToOriginAndRotation-B9BchKSd.js";import{x as Ye,f as Ke,t as Qe,i as Ze}from"./Transform-Suzpgz1x.js";import{n as et}from"./projectVectorToVector-DjKO2tJh.js";import{c as tt,x as it,L as rt,i as Z,O as ot,E as st,u as at,k as nt,B as ve,g as xe}from"./BufferView-XrMc2vJu.js";import{r as P,a as ee,S as j,N as U,e as u,m as lt,d as mt,g as Ce,t as E,n as te,i as R}from"./ILyr3DWasmPerSceneView-vPx4somd.js";import{R as Te}from"./elevationInfoUtils-JmMUMmCn.js";import{l as pt}from"./ViewingMode-Dodu7ZZk.js";import{t as ct}from"./WaterSurface.glsl-CB7boCuS.js";import{d as dt}from"./RenderGeometry-CQQOC_nW.js";import{l as ht}from"./LayerView3D-CLOjZQPa.js";import{i as ut,l as B,a as Me}from"./DefaultUI-BM5o-ZLH.js";import{s as $,e as A,u as Ee}from"./basicInterfaces-wONHx_SN.js";import{E as Pe,D as x}from"./enums-BlUEVwJR.js";import{l as ft}from"./ElevationQueryTileCache-ByGSevWc.js";import{i as gt,e as bt,G as yt}from"./ElevationProvider-Xg9LKEp7.js";import{m as _t,A as wt}from"./VertexColor.glsl-BX9otDj2.js";import{e as vt}from"./ElevationRange-BrgM1moX.js";import{I as xt,J as Ct,t as k}from"./orientedBoundingBox-BTwqkknQ.js";import{b as Tt,I as Mt,d as Et}from"./Viewshed.glsl-BfaJltDE.js";import{s as Pt}from"./RenderTexture-CQ39aJeo.js";import{d as Oe,N as Ot}from"./Texture-0jciB86n.js";import{c as Ut}from"./Normals-ClOhen2_.js";import{e as G}from"./VertexAttribute-BnAa5VW0.js";import{y as At}from"./LayerView-C2s9lN61.js";import{c as It}from"./layerViewUtils-D2JqIDZ8.js";import"./sphere-COyqsaGw.js";import"./plane-BL9J6YX0.js";import"./vec2f64-Diu2Kaa8.js";import"./mathUtils-BsqbT0oM.js";import"./projectPointToVector-6lqiVL77.js";import"./vec2-C-4tM9Uv.js";import"./ColorMaterial.glsl-CcrBVOmk.js";import"./Material-BfvzXcva.js";import"./interfaces-B8ge7Jg9.js";import"./InterleavedLayout-ZKuAjCiK.js";import"./types-D0PSWh4d.js";import"./Util-HYkJg9Vp.js";import"./Matrix4PassUniform-CTNrzJ6Q.js";import"./BindType-BmZEZMMh.js";import"./renderState-yUi34s5A.js";import"./ShaderTechniqueConfiguration-D3UbJ2mX.js";import"./hydratedFeatures-DcIGyuBL.js";import"./floatRGBA-DZ6CgOhi.js";import"./Texture-BF0Xf23l.js";import"./vec2f32-BbH2jxlN.js";import"./dehydratedFeatures-DvwHN5Vy.js";import"./featureConversionUtils-C8uvc1AG.js";import"./OptimizedFeature-7juV2tZm.js";import"./OptimizedGeometry-vU5jWBvU.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./edgeUtils-CckHLSHv.js";import"./DecodeSymbolColor.glsl-CpAWHGzb.js";import"./Float4DrawUniform-X0Lc1Ix0.js";import"./earcut-BqgeR2O3.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./DoubleArray-tnpOy9RK.js";import"./Indices-BZu2O98k.js";import"./vec3-DxxvdsHs.js";import"./SnappingCandidate-O5eRSE6e.js";import"./triangulationUtils-BSy4A0L9.js";import"./deduplicate-CREmZpKM.js";import"./triangle-CGr49R4x.js";import"./lineSegment-C2OVzbAD.js";import"./objectResourceUtils-dMevf21j.js";import"./devEnvironmentUtils-D6qIi8Ky.js";import"./vec4-B2fX0VJI.js";import"./DefaultMaterial_COLOR_GAMMA-vDn2TTUE.js";import"./quat-DrJsq_-D.js";import"./resourceUtils-Cv8EFCAN.js";import"./NestedMap-DgiGbX8E.js";import"./requestImageUtils-Cd7mPI4y.js";import"./verticalOffsetUtils-Bq_pVrum.js";import"./CIMSymbolHelper-DvNaY2BT.js";import"./BidiEngine-BwB1Df7c.js";import"./fontUtils-BN21lj56.js";import"./GeometryUtils-CGNDP0vy.js";import"./enums-BRXbslMp.js";import"./definitions-ByNBSgP9.js";import"./mat2d-CXMJJ9G6.js";import"./mat2df32-orApM5a3.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BhuXqU4L.js";import"./cimSymbolUtils-DzDRYI6s.js";import"./utils-BbU12Hvz.js";import"./lineStippleUtils-Cu2kwDBg.js";import"./projectVectorToPoint-jxEu1YJy.js";import"./MeshComponent-CcZOTV9N.js";import"./imageUtils-BsB3EL45.js";import"./MeshVertexAttributes-DiX-RN8y.js";import"./meshVertexSpaceUtils-UWZ_3JBG.js";import"./MeshLocalVertexSpace-Ck1lhGhd.js";import"./projection-BJFZt5ZW.js";import"./spatialReferenceEllipsoidUtils-Bv0mQCFg.js";import"./DefaultLayouts-LbPHMYzg.js";import"./frustum-Tc8kkw3_.js";import"./webStyleSymbolUtils-CT_ZIx-N.js";import"./glUtil-C6KhMg1m.js";import"./VertexElementDescriptor-BOD-G50G.js";import"./Octree-lrGXb_0y.js";import"./BufferObject-CWTeBz1x.js";import"./Intersector-ENyKy7_L.js";import"./Scheduler-Bg_fxWwI.js";import"./signal-CpmfLcHB.js";import"./debugFlags-Cr0sx6r_.js";import"./weather-CSMUgeU9.js";import"./vec3f32-Cw9Q6TO_.js";import"./axisAngleDegrees-jEN9n05M.js";import"./Intersector-CG5xfiNM.js";import"./VertexArrayObject-9V6uZ6_q.js";import"./heightModelInfoUtils-CTi_JiJC.js";import"./HeightModelInfo-DaJXTLDg.js";import"./arcgisLayerUrl-BpJodxxk.js";import"./jsxFactory-DmHi7Kb2.js";import"./uuid-fwrPAdZb.js";import"./UpdatingHandles-CERUeL1P.js";import"./InputManager-abOXR3ru.js";import"./Map-BcseqEdU.js";import"./Basemap-CjElSnyL.js";import"./loadAll-8MiqgLTH.js";import"./writeUtils-RiCb1SCd.js";import"./Ground-dhRLerDt.js";import"./CollectionFlattener-Be8YW6oV.js";import"./editableLayers-DuIVmwOk.js";import"./catalogUtils-B2PovfNH.js";import"./basemapUtils-rjdIOXhY.js";import"./TablesMixin-CcZZ6esO.js";import"./GraphicsCollection-BjA_qBYu.js";import"./ReactiveMap-r-vujrh9.js";import"./selectionUtils-DYi6daQO.js";import"./IViewEvents-Bci6PjlS.js";import"./interfaces-D6pIddIh.js";import"./screenUtils-BcEL8jIe.js";import"./a11yUtils-BcOnuh2m.js";import"./capabilities-C84AMSCg.js";import"./themeUtils-C3zvZbsE.js";import"./globalCss-CZa70j6i.js";import"./accessibleHandler-CjDcv_he.js";import"./Compass-S4M9NML1.js";import"./utils-DsJqvptN.js";import"./GoTo-Bv8U0vYJ.js";import"./NavigationToggle-Da_EVApx.js";import"./Zoom-OTCbJYcz.js";import"./LayerConstants-B33OP6sh.js";import"./boundedPlane-MAPkm7Yi.js";import"./Viewpoint-sw4jiA6m.js";import"./Cyclical-CEj-eenM.js";import"./RenderCoordsHelper-D33jtR9v.js";import"./scaleUtils-ClqQrarK.js";import"./viewpointUtils-CNGyoIgw.js";import"./earthUtils-GWU8KixL.js";import"./spatialReferenceSupport-Bk67zMEK.js";import"./ElevationSamplerData-CFwzCheb.js";import"./terrainUtils-BQLPw4Jq.js";import"./TileInfo-DuivnO5H.js";import"./TileKey-DZd6gJy7.js";import"./Environment-Bpau6Ty8.js";import"./quantityUtils-DSpmykXR.js";import"./Program-BnQQlkGO.js";import"./ShadowCastVisualizeTechniqueConfiguration-Dah3u-G-.js";import"./euclideanLengthMeasurementUtils-CuSkQONc.js";import"./ray-BtGY6UNr.js";import"./ZoomMomentumEstimator-pQkiU-PR.js";import"./labelFormatUtils-DjuAeSua.js";import"./FeatureTileDescriptor3D-CvT50Jkf.js";import"./geometryServiceUtils-zF1xOQ4Y.js";import"./project-BQyPiext.js";import"./utils-nzDIu46v.js";import"./utils-D67OULxu.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./RenderableTile-CE6botJN.js";import"./enums-BRzLM11V.js";import"./TileStrategy-CcsveE-I.js";import"./TileKey-m4M152GY.js";import"./QueueProcessor-01Ee2ByR.js";import"./config-MDUrh2eL.js";import"./DefaultVertexAttributeLayouts-_lUGuBk_.js";import"./DisplayObject-I7xo9JVP.js";import"./StyleDefinition-BK3ROBTO.js";import"./resources-Bv-4dVJF.js";import"./edgeProcessing-BO3TMEUB.js";import"./testSVGPremultipliedAlpha-eKesxQ43.js";import"./RenderingContext-DNkBZ-bu.js";import"./ProgramCache-DLTjjJNh.js";import"./doublePrecisionUtils-B0owpBza.js";class St extends ct{constructor(e,p,s,m,n,o,c){super(e,0,0,0,p),this.nodesCached=s,this.vboMB=m,this.textureMB=n,this.vboMBCached=o,this.textureMBCached=c}}const Rt={[P.Points]:null,[P.Lines]:null,[P.LineStrip]:null,[P.Triangles]:Pe.TRIANGLES,[P.TriangleStrip]:Pe.TRIANGLE_STRIP,[P.NotSet]:null},Ue={[ee.Opaque]:$.Opaque,[ee.Mask]:$.Mask,[ee.Blend]:$.Blend},Ft={[j.Back]:A.Back,[j.Front]:A.Front,[j.None]:A.None,[j.NotSet]:A.Back},Ht={[U.WrapYBit]:{s:x.CLAMP_TO_EDGE,t:x.REPEAT},[U.WrapXBit]:{s:x.REPEAT,t:x.CLAMP_TO_EDGE},[U.WrapXy]:{s:x.REPEAT,t:x.REPEAT},[U.None]:{s:x.CLAMP_TO_EDGE,t:x.CLAMP_TO_EDGE},[U.NotSet]:{s:x.CLAMP_TO_EDGE,t:x.CLAMP_TO_EDGE}},Vt={[u.U8]:1,[u.I8]:1,[u.U16]:2,[u.I16]:2,[u.U32]:4,[u.I32]:4,[u.F32]:4,[u.F64]:8,[u.Utf8String]:1,[u.NotSet]:1};class Dt{constructor(e){this.layerUid=[],this.type=gt.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,p,s,m,n,o){const c=e.results,_=e.options.store===bt.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const w=this.layerView.view._stage.renderView.componentObjectCollection,f=new _t(o??!1,e.options.normalRequired);this.layerView.objects.forEach(h=>{h.visible&&h.intersectionGeometry&&w.intersect(h,s,m,e.tolerance,null,f,(d,a,i,g)=>{if(a>=0){if(p!=null&&!p(s,m,a))return;const l=T=>{const C=new ft(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));T.set(this.type,C,a,i)};if(this.isGround&&(c.ground.dist==null||a<c.ground.dist)&&l(c.ground),e.options.isFiltered)return;if((c.min.dist==null||a<c.min.dist)&&l(c.min),(c.max.dist==null||a>c.max.dist)&&l(c.max),_){const T=yt(e.ray);l(T),e.results.all.push(T)}}})})}_createTiles3DGraphic(e,p){return new Fe({layer:e,sourceLayer:e,attributes:p})}}var b;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(b||(b={}));class Lt{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function N(t){return Math.round(t/1048.576)/1e3}let O=class extends ht(At){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=dt.WithoutRasterImage,this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(b.Error),this._dbg(b.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new Y("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=ut(this).then(e=>{this._intersectionHandler=new Dt(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,s=>this._slicePlaneEnabledChange(s)),this._elevationProvider=new Ye({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const p=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,s=>this._onRemoveFromCache(s));this._memCache=p,this.addHandles([ge(()=>this.layer.elevationInfo,s=>this._elevationInfoChanged(s))]),this._suspendedHandle=ge(()=>this.suspended,s=>{const m=B(this.view);m&&m.setEnabled(this,!s)},He)}).catch(e=>{if(Me(this),this._wasmLayerId=-1,e===lt)throw new Y("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===mt)throw new Y("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(b.VerboseAPI,"Tiles3DLayerView3D destroy() called"),Me(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=be(this._memCache),this._updatingHandles=be(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle==null&&(this._visibleGeometryChangedSchedulerHandle=Ve(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const p=this._collection.getMaterial(e);p.commonMaterialParameters.hasSlicePlane=t,p.commonMaterialParameters.cullFace=t?A.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){const e=B(this.view);e&&e.setLayerOffset(this,Te(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.totalMemory())}),t}get unloadedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.totalMemory())}),t}get visibleAtCurrentScale(){return It(this.layer.effectiveScaleRange,this.view.terrainScale)}get performanceInfo(){let t=0,e=0,p=0,s=0,m=0,n=0;return this._lyrHandleToObjects.forEach(o=>{o.isVisible?(t+=o.texMemoryUsage,e+=o.vboMemoryUsage,m++):(p+=o.texMemoryUsage,s+=o.vboMemoryUsage,n++)}),new St(this.usedMemory,m,n,N(e),N(t),N(s),N(p))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===pt.Local){const p=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(p!==3857&&p!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return Te(this.layer.elevationInfo)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new vt(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=B(this.view);return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var a;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const p=De(e.desc.origin),s=new Array,m=new Map,n=new Lt;n.handle=t.handle,this._lyrHandleToObjects.set(t.handle,n);const o=this.view.basemapTerrain.spatialReference;let c,_;if(this.view.viewingMode==="global"){const i=we();Xe(Le,p,i,o),c=We(_e(),i),_=qe(_e(),c)}else c=Q,_=Q;const w=we();je(w,w,p);const f=Be(K(),w);let h=null;const d=K();if(e.desc.obb){const i=e.desc.obb.quaternion;h=new xt(e.desc.obb.center,e.desc.obb.halfSize,Je(i[0],i[1],i[2],i[3]))}for(let i=0;i<e.desc.prims.length;i++){const g=e.desc.prims[i];if(this._dbg(b.VerboseAPI,JSON.stringify(g)),g.ptype===P.Lines)continue;if(Rt[g.ptype]==null||e.data==null){this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+g.ptype+"). Skipping primitive.");continue}const l=(a=e.desc)!=null&&a.materials&&g.materialId!=null?e.desc.materials[g.materialId]:null,T=l!=null?l.lightingModel:Ce.Unlit,C=!ke("disable-feature:im-shading"),{positionView:y,positionAttr:M,normalsView:Ae,normalsAttr:z,colorAttr:F,texCoord0Attr:H,indicesView:I}=this.getBufferViews(g,e.data.buffer,c,C);if(M==null||y==null||I==null)continue;const ie={colors:F!=null,textureCoordinates:H!=null?Oe.Default:Oe.None,hasNormals:Ae!=null,needsNormals:C},Ie=M.data.length/M.size,W=(r,v)=>!r||r.data.length/r.size===Ie||(this._dbg(b.Error,`${v} !== numPos. Skipping primitive.`),!1);if(!W(H,"numTexcoord")||!W(F,"numColors")||!W(z,"normals"))continue;const re=Tt(ie);if(h!=null?h=h.clone():(h=Ct(M),Ge(d,h.center,p),h.center=d),c!==Q)for(let r=0;r<y.count;r++)y.getVec(r,d),Ne(d,d,c),y.setVec(r,d);const q=re.createBuffer(M.data.length),V=new Map([[G.POSITION,M]]);H!=null&&V.set(G.UV0,H),F!=null&&V.set(G.COLOR,F),z!=null&&V.set(G.NORMALCOMPRESSED,z),V.forEach((r,v)=>{r!=null&&wt(v,r,null,null,q,0)});const Se=new Uint32Array([0,I.typedBuffer.length]),Re={vertices:{data:q.buffer,count:q.byteLength/re.stride,layoutParameters:ie},positionData:{positions:y.typedBuffer,indices:I.typedBuffer},indices:I.typedBuffer,componentOffsets:Se};n.cpuMemoryUsage+=y.count,n.cpuMemoryUsage+=I.count;const oe=this.view.renderSpatialReference,J=K(),X=[1,1,1];Ke(f,oe,X,o)||this._dbg(b.Error,"Unsupported coordinate system for IM overlay"),et(f,oe,J,o);const D=this._collection.createObject(new Qe($e(J[0],J[1],X[0],X[1]),new Ze(f,_),h,Re));l&&this._collection.updateMaterial(D,r=>{r.baseColor=l.baseColorFactor,r.usePBR=T===Ce.Pbr,r.hasParametersFromSource=!1,r.baseColorTexture=this._getTexture(l.baseColorTex,e,m),r.usePBR&&(r.mrrFactors=[l.metallicFactor,l.roughnessFactor,0],r.emissiveFactor=l.emissiveFactor??[0,0,0],r.metallicRoughnessTexture=this._getTexture(l.metalTex,e,m),r.emissionTexture=this._getTexture(l.emissiveTex,e,m),r.occlusionTexture=this._getTexture(l.occlusionTex,e,m),r.normalTexture=this._getTexture(l.normalTex,e,m)),r.objectOpacity=0,r.alphaDiscardMode=$.Mask;const v=[];r.baseColorTexture&&v.push(r.baseColorTexture.loadPromise),r.usePBR&&r.metallicRoughnessTexture&&v.push(r.metallicRoughnessTexture.loadPromise),r.usePBR&&r.emissionTexture&&v.push(r.emissionTexture.loadPromise),r.usePBR&&r.occlusionTexture&&v.push(r.occlusionTexture.loadPromise),r.usePBR&&r.normalTexture&&v.push(r.normalTexture.loadPromise);const se=Promise.all(v);s.push(se),se.then(()=>{var ae,ne,le,me,pe,ce,de,he,ue,fe;r.alphaDiscardMode=Ue[l.alphaMode],r.objectOpacity=1,n.texMemoryUsage+=((ne=(ae=r.baseColorTexture)==null?void 0:ae.glTexture)==null?void 0:ne.usedMemory)||0,r.usePBR&&(n.texMemoryUsage+=((me=(le=r.metallicRoughnessTexture)==null?void 0:le.glTexture)==null?void 0:me.usedMemory)||0,n.texMemoryUsage+=((ce=(pe=r.emissionTexture)==null?void 0:pe.glTexture)==null?void 0:ce.usedMemory)||0,n.texMemoryUsage+=((he=(de=r.occlusionTexture)==null?void 0:de.glTexture)==null?void 0:he.usedMemory)||0,n.texMemoryUsage+=((fe=(ue=r.normalTexture)==null?void 0:ue.glTexture)==null?void 0:fe.usedMemory)||0)}),r.commonMaterialParameters.doubleSided=l.isDoubleSided,r.commonMaterialParameters.cullFace=l.faceCulling?Ft[l.faceCulling]:A.Back,this._initialCullFace.set(D,r.commonMaterialParameters.cullFace),r.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,r.componentParameters.castShadows=Mt.All,r.textureAlphaCutoff=l.alphaCutoff??.1,r.alphaDiscardMode=Ue[l.alphaMode],r.isIntegratedMesh=!0,r.polygonOffsetEnabled=!1,r.hasOccludees=!1,r.ellipsoidMode=Et(this.view.spatialReference)}),n.components.push(D),n.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(D)}if(await Promise.all(s),m.forEach(i=>{n.textures.push(i)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${n.handle}`,n,n.totalMemory()),{memUsageBytes:n.totalMemory()}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(p=>{this._stage.remove(p)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,p){if(this._memCache){for(let s=0;s<p;++s){const m=t[s],n=e[s];if(!n)continue;const o=this._lyrHandleToObjects.get(m);o&&(this._visibleGeometryChanged(),o.isVisible=n,o.components.forEach(c=>{this._collection.setObjectVisibility(c,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(c))}),this._memCache.pop(`${m}`))}for(let s=0;s<p;++s){const m=t[s],n=e[s];if(n)continue;const o=this._lyrHandleToObjects.get(m);o&&(this._visibleGeometryChanged(),o.isVisible=n,o.components.forEach(c=>{this._collection.setObjectVisibility(c,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(c))}),this._memCache.put(`${m}`,o,o.totalMemory()))}}}_getTexture(t,e,p){var m,n;let s=null;if(t&&((m=e.desc)!=null&&m.images)&&((n=e.data)!=null&&n.buffer)){const o=e.desc.images[t==null?void 0:t.imageId];if(s=p.get(o),!s&&o){const c=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,_=c>1,w=Ht[t.wrapMode??U.None];let f=o.alpha?4:3;const h=new Uint8Array(e.data.buffer,o.data.byteOffset,o.data.byteCount);let d=null,a=null,i=null;switch(o.format){case E.Raw:o.pixelFormat===te.R8?(d=h.buffer,f=1,a=""):o.pixelFormat===te.Rgb8?(d=h.buffer,f=3,a=""):o.pixelFormat===te.Rgba8&&(d=h.buffer,f=4,a="");break;case E.Dxt1:d=h.buffer,f=3,a=Ee.DDS_ENCODING;break;case E.Dxt5:d=h.buffer,f=4,a=Ee.DDS_ENCODING;break;case E.Png:a="image/png",i=document.createElement("img");break;case E.Jpeg:a="image/jpeg",i=document.createElement("img");break;case E.Etc2:a="image/ktx",i=document.createElement("img");break;case E.Astc:this._dbg(b.Error,"Astc texture not supported");break;case E.Pvrtc:this._dbg(b.Error,"Pvrtc texture not supported")}if(i&&a){const g=new Blob([h],{type:a});i.src=URL.createObjectURL(g),d=i}d&&a!=null&&(s=new Ot(d,{mipmap:_,maxAnisotropy:c,encoding:a,wrap:w,components:f,noUnpackFlip:!0,width:o.mip0Width,height:o.mip0Height}),this._stage.add(s),p.set(o,s))}}return s?new Pt(this.view._stage.renderView.textures,s.id):null}getBufferViews(t,e,p,s){let m,n,o,c,_,w,f,h=null;for(let d=0;d<t.atrbs.length;d++){const a=t.atrbs[d],i=a.view,g=void 0,l=i.byteOffset+i.byteCount,T=i.byteCount/Vt[i.type],C=[...Array(T).keys()].map(y=>y);try{switch(a.sem){case R.Position:i.ncomp!==3||i.type!==u.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Position ("+i+")"):(m=new Z(e,i.byteOffset,g,l),n=new k(m.typedBuffer,C,3));break;case R.Normal:if(i.ncomp!==3||i.type!==u.F32)this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Normal ("+i+")");else if(s){const y=new Z(e,i.byteOffset,g,l),M=Ut(y.typedBuffer,p);_=new nt(M),w=new k(_.typedBuffer,C,2)}break;case R.TexCoord:i.ncomp!==2||i.type!==u.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+i+")"):c===void 0&&(c=new k(new at(e,i.byteOffset,g,l).typedBuffer,C,2));break;case R.Color:i.ncomp===4?(i.type===u.F32&&(h=new tt(e,i.byteOffset,g,l)),i.type===u.U8&&(h=new it(e,i.byteOffset,g,l)),i.type===u.U16&&(h=new rt(e,i.byteOffset,g,l))):i.ncomp===3&&(i.type===u.F32&&(h=new Z(e,i.byteOffset,g,l)),i.type===u.U8&&(h=new ot(e,i.byteOffset,g,l)),i.type===u.U16&&(h=new st(e,i.byteOffset,g,l))),h==null?this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+i+")"):o=new k(h.typedBuffer,C,i.ncomp);break;case R.FeatureIndex:break;default:this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+a.sem+"). Skipping vertex attribute.")}}catch(y){this._dbg(b.VerboseAPI,"Error Creating buffer ("+y+"). Skipping vertex attribute.")}}if(t.index){const d=t.index.view,a=void 0,i=d.byteOffset+d.byteCount;switch(t.index.view.type){case u.U16:f=new xe(e,d.byteOffset,a,i);break;case u.U32:f=new ve(e,d.byteOffset,a,i);break;case u.U8:default:this._dbg(b.Error,"[Unsupported Feature] index type not supported ("+d.type+").")}}if(f==null&&m!=null){const d=m.count;if(d<65535){const a=new Uint16Array(d);f=new xe(a)}else{const a=new Uint32Array(d);f=new ve(a)}for(let a=0;a<d;a++)f.set(a,a)}return{positionView:m,positionAttr:n,colorAttr:o,texCoord0Attr:c,indicesView:f,normalsView:_,normalsAttr:w}}_onRemoveFromCache(t){const e=B(this.view);e&&e.onRenderableEvicted(this,t.handle,t.totalMemory()),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===b.Error?ye.getLogger(this).error(e):ye.getLogger(this).warn(e))}};S([L()],O.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),S([L()],O.prototype,"layer",void 0),S([L({readOnly:!0})],O.prototype,"visibleAtCurrentScale",null),S([L()],O.prototype,"elevationOffset",null),O=S([ze("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],O);const us=O;export{us as default};
