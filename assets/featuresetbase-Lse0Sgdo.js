import{m as Ie}from"./TimeOnly-DZBbU_oj.js";import{a as b,v as De,w as X,B as A,N as v,b as c,r as m,G as P,m as N,a4 as Te,W as ue,X as de,a5 as ce,P as S,K as k,U as x,H as j,a1 as Ee,Q as M,_ as be,g as O,D as Ne,a6 as xe,a7 as B,a8 as Y,a9 as Ae,aa as q}from"./arcadeUtils-hyHMGEak.js";import{q as Le,G as me,d as Se,c as _,e as Ce,a as ve,b as Pe,T as ee,E as Ze,N as Re,O as Ue,B as $,f as $e,k as K,L as C,I as ne}from"./featureSetUtils-DRH7yxz1.js";import{t as Me}from"./ImmutableArray-BPVd6ESQ.js";import{l as ke}from"./portalUtils-DfaJkW0b.js";import{u as Oe,D as pe}from"./SpatialFilter-C4HkHc6U.js";import{E as ye,cB as ze,ct as G}from"./index-DX0rcHuW.js";import{O as E}from"./WhereClause-C3Bpu3MP.js";import te from"./FeatureLayer-Bb5mf85J.js";import"./number-CjunerCe.js";import"./featureConversionUtils-C8uvc1AG.js";import"./OptimizedFeature-7juV2tZm.js";import"./OptimizedGeometry-vU5jWBvU.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./hash-CcEbRgUF.js";import"./uuid-fwrPAdZb.js";import"./infoFor3D-CxOdoily.js";import"./executeQueryJSON-_Gsxb9pi.js";import"./utils-nzDIu46v.js";import"./query-95tcIPsI.js";import"./normalizeUtils-CzEkgn6d.js";import"./normalizeUtilsCommon-DXRtgGFh.js";import"./utils-D67OULxu.js";import"./pbfQueryUtils-B33F7Io8.js";import"./pbf-9I_px9lQ.js";import"./queryZScale-B1r3mH-Y.js";import"./executeQueryPBF-Ds4PRVlt.js";import"./AttachmentInfo-CypukXoR.js";import"./executeForIds-BJu0fyay.js";import"./TopFeaturesQuery-B-wHLSqs.js";import"./FeatureType-Bb4KOLCq.js";import"./geometryEngineAsync-B-QoKuqI.js";import"./FeatureLayerBase-uK0oK06Z.js";import"./inputs-Due4QVtL.js";import"./formUtils-Dni92j4V.js";import"./HeightModelInfo-DaJXTLDg.js";import"./arcgisLayerUrl-BpJodxxk.js";import"./LayerFloorInfo-D-bXPB8b.js";import"./Relationship-Clp_49iY.js";import"./serviceCapabilitiesUtils-CIgEASrL.js";import"./editsZScale-BDLbHb5e.js";import"./APIKeyMixin-DSbft86T.js";import"./ArcGISService-CVVnFG2B.js";import"./EditBusLayer-Brt5ASt_.js";import"./versionUtils-DlHqsQBg.js";import"./styleUtils-CxRaW7Jr.js";import"./interfaces-CL2NbQte.js";function He(a){if(a.length===1){if(x(a[0]))return q("distinct",a[0],-1);if(M(a[0]))return q("distinct",a[0].toArray(),-1)}return q("distinct",a,-1)}async function ae(a,n,i){const y=a.getVariables();if(y.length>0){const I=[];for(let t=0;t<y.length;t++){const s={name:y[t]};I.push(await n.evaluateIdentifier(i,s))}const e={};for(let t=0;t<y.length;t++)e[y[t]]=I[t];return a.parameters=e,a}return a}function d(a,n,i=null){for(const y in a)if(y.toLowerCase()===n.toLowerCase())return a[y];return i}function we(a){if(a===null)return null;const n={type:d(a,"type",""),name:d(a,"name","")};if(n.type==="range")n.range=d(a,"range",[]);else{n.codedValues=[];for(const i of d(a,"codedValues",[]))n.codedValues.push({name:d(i,"name",""),code:d(i,"code",null)})}return n}function ie(a){if(a===null)return null;const n={},i=d(a,"wkt");i!==null&&(n.wkt=i);const y=d(a,"wkid");return y!==null&&(n.wkid=y),n}function he(a){if(a===null)return null;const n={hasZ:d(a,"hasz",!1),hasM:d(a,"hasm",!1)},i=d(a,"spatialreference");i!=null&&(n.spatialReference=ie(i));const y=d(a,"x",null);if(y!==null)return n.x=y,n.y=d(a,"y",null),n.hasZ&&(n.z=d(a,"z",null)),n.hasM&&(n.m=d(a,"m",null)),n;const I=d(a,"rings",null);if(I!==null)return n.rings=I,n;const e=d(a,"paths",null);if(e!==null)return n.paths=e,n;const t=d(a,"points",null);if(t!==null)return n.points=t,n;for(const s of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const f=d(a,s,null);f!==null&&(n[s]=f)}return n}function We(a,n){for(const i of n)if(i===a)return!0;return!1}function Ge(a){return!!a.layerDefinition&&!!a.featureSet&&We(a.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&x(a.layerDefinition.fields)!==!1&&x(a.featureSet.features)!==!1}function z(a){return(a==null?void 0:a.toLowerCase())==="utc"?"UTC":(a==null?void 0:a.toLowerCase())==="unknown"?"Unknown":a}function kn(a){a.mode==="async"&&(a.functions.timezone=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{var f,p;if(b(e,1,2,n,i),De(e[0])||X(e[0]))return"Unknown";if(A(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?z("unknown"):z(e[0].dateFieldsTimeZone);if(!(e[1]instanceof v)||e[1].hasField("type")===!1)throw new c(n,m.InvalidParameter,i);const l=e[1].field("type");if(P(l)===!1)throw new c(n,m.InvalidParameter,i);switch(N(l).toLowerCase()){case"preferredtimezone":return z(e[0].preferredTimeZone);case"editfieldsinfo":return z(((f=e[0].editFieldsInfo)==null?void 0:f.timeZone)??null);case"timeinfo":return z(((p=e[0].timeInfo)==null?void 0:p.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&P(e[1].field("fieldname")))return z(e[0].fieldTimeZone(N(e[1].field("fieldname"))))}throw new c(n,m.InvalidParameter,i)}const t=Te(e[0],ue(n));if(t===null)return null;const s=t.timeZone;return s==="system"?Ie.systemTimeZoneCanonicalName:s.toLowerCase()==="utc"?"UTC":s.toLowerCase()==="unknown"?"Unknown":s})},a.functions.sqltimestamp=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{b(e,1,3,n,i);const t=e[0];if(de(t)){if(e.length===1)return t.toSQLWithKeyword();if(e.length===2)return t.changeTimeZone(N(e[1])).toSQLWithKeyword();throw new c(n,m.InvalidParameter,i)}if(X(t))return t.toSQLWithKeyword();if(A(t)){if(e.length!==3)throw new c(n,m.InvalidParameter,i);await t.load();const s=N(e[1]);if(X(e[2]))return e[2].toSQLWithKeyword();if(de(e[2])===!1)throw new c(n,m.InvalidParameter,i);const f=t.fieldTimeZone(s);return f===null?e[2].toSQLWithKeyword():e[2].changeTimeZone(f).toSQLWithKeyword()}throw new c(n,m.InvalidParameter,i)})},a.signatures.push({name:"sqltimestamp",min:2,max:4}),a.functions.featuresetbyid=function(n,i){return a.standardFunctionAsync(n,i,(y,I,e)=>{if(b(e,2,4,n,i),ce(e[0])){const t=N(e[1]);let s=S(e[2],null);const f=k(S(e[3],!0));if(s===null&&(s=["*"]),x(s)===!1)throw new c(n,m.InvalidParameter,i);return e[0].featureSetById(t,f,s)}throw new c(n,m.InvalidParameter,i)})},a.signatures.push({name:"featuresetbyid",min:2,max:4}),a.functions.getfeatureset=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{if(b(e,1,2,n,i),j(e[0])){let t=S(e[1],"datasource");return t===null&&(t="datasource"),t=N(t).toLowerCase(),Le(e[0].fullSchema(),t,n.lrucache,n.interceptor,n.spatialReference??null)}throw new c(n,m.InvalidParameter,i)})},a.signatures.push({name:"getfeatureset",min:1,max:2}),a.functions.featuresetbyportalitem=function(n,i){return a.standardFunctionAsync(n,i,(y,I,e)=>{var l,r;if(b(e,2,5,n,i),e[0]===null)throw new c(n,m.PortalRequired,i);if(e[0]instanceof Ee){const o=N(e[1]),u=N(e[2]);let w=S(e[3],null);const D=k(S(e[4],!0));if(w===null&&(w=["*"]),x(w)===!1)throw new c(n,m.InvalidParameter,i);let h;return h=(l=n.services)!=null&&l.portal?n.services.portal:ye.getDefault(),h=ke(e[0],h),me(o,u,n.spatialReference??null,w,D,h,n.lrucache,n.interceptor)}if(P(e[0])===!1)throw new c(n,m.PortalRequired,i);const t=N(e[0]),s=N(e[1]);let f=S(e[2],null);const p=k(S(e[3],!0));if(f===null&&(f=["*"]),x(f)===!1)throw new c(n,m.InvalidParameter,i);return me(t,s,n.spatialReference??null,f,p,((r=n.services)==null?void 0:r.portal)??ye.getDefault(),n.lrucache,n.interceptor)})},a.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),a.functions.featuresetbyname=function(n,i){return a.standardFunctionAsync(n,i,(y,I,e)=>{if(b(e,2,4,n,i),ce(e[0])){const t=N(e[1]);let s=S(e[2],null);const f=k(S(e[3],!0));if(s===null&&(s=["*"]),x(s)===!1)throw new c(n,m.InvalidParameter,i);return e[0].featureSetByName(t,f,s)}throw new c(n,m.InvalidParameter,i)})},a.signatures.push({name:"featuresetbyname",min:2,max:4}),a.functions.featureset=function(n,i){return a.standardFunction(n,i,(y,I,e)=>{b(e,1,1,n,i);const t={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(P(e[0])){const s=JSON.parse(e[0]);s.layerDefinition!==void 0?(t.layerDefinition=s.layerDefinition,t.featureSet=s.featureSet,s.layerDefinition.spatialReference&&(t.layerDefinition.spatialReference=s.layerDefinition.spatialReference)):(t.featureSet.features=s.features,t.featureSet.geometryType=s.geometryType,t.layerDefinition.geometryType=t.featureSet.geometryType,t.layerDefinition.objectIdField=s.objectIdFieldName??"",t.layerDefinition.typeIdField=s.typeIdFieldName,t.layerDefinition.globalIdField=s.globalIdFieldName,t.layerDefinition.fields=s.fields,s.spatialReference&&(t.layerDefinition.spatialReference=s.spatialReference))}else{if(!(e[0]instanceof v))throw new c(n,m.InvalidParameter,i);{const s=JSON.parse(e[0].castToText(!0)),f=d(s,"layerdefinition");if(f!==null){t.layerDefinition.geometryType=d(f,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.globalIdField=d(f,"globalidfield",""),t.layerDefinition.objectIdField=d(f,"objectidfield",""),t.layerDefinition.typeIdField=d(f,"typeidfield",""),t.layerDefinition.hasZ=d(f,"hasz",!1)===!0,t.layerDefinition.hasM=d(f,"hasm",!1)===!0;const p=d(f,"spatialreference");p&&(t.layerDefinition.spatialReference=ie(p));const l=[];for(const o of d(f,"fields",[])){const u={name:d(o,"name",""),alias:d(o,"alias",""),type:d(o,"type",""),nullable:d(o,"nullable",!0),editable:d(o,"editable",!0),length:d(o,"length",null),domain:we(d(o,"domain"))};l.push(u)}t.layerDefinition.fields=l;const r=d(s,"featureset");if(r){const o={};for(const u of l)o[u.name.toLowerCase()]=u.name;for(const u of d(r,"features",[])){const w={},D=d(u,"attributes",{});for(const h in D)w[o[h.toLowerCase()]]=D[h];t.featureSet.features.push({attributes:w,geometry:he(d(u,"geometry"))})}}}else{t.layerDefinition.hasZ=d(s,"hasz",!1)===!0,t.layerDefinition.hasM=d(s,"hasm",!1)===!0,t.layerDefinition.geometryType=d(s,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.objectIdField=d(s,"objectidfieldname",""),t.layerDefinition.typeIdField=d(s,"typeidfieldname","");const p=d(s,"spatialreference");p&&(t.layerDefinition.spatialReference=ie(p));const l=[],r=d(s,"fields",null);if(!x(r))throw new c(n,m.InvalidParameter,i);for(const w of r){const D={name:d(w,"name",""),alias:d(w,"alias",""),type:d(w,"type",""),nullable:d(w,"nullable",!0),editable:d(w,"editable",!0),length:d(w,"length",null),domain:we(d(w,"domain"))};l.push(D)}t.layerDefinition.fields=l;const o={};for(const w of l)o[w.name.toLowerCase()]=w.name;let u=d(s,"features",null);if(x(u))for(const w of u){const D={},h=d(w,"attributes",{});for(const T in h)D[o[T.toLowerCase()]]=h[T];t.featureSet.features.push({attributes:D,geometry:he(d(w,"geometry",null))})}else u=null,t.featureSet.features=u}}}if(Ge(t)===!1)throw new c(n,m.InvalidParameter,i);return t.layerDefinition.geometryType||(t.layerDefinition.geometryType="esriGeometryNull"),Se.create(t,n.spatialReference)})},a.signatures.push({name:"featureset",min:1,max:1}),a.functions.filter=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{if(b(e,2,2,n,i),x(e[0])||M(e[0])){const t=[];let s,f=e[0];if(f instanceof Me&&(f=f.toArray()),!be(e[1]))throw new c(n,m.InvalidParameter,i);s=e[1].createFunction(n);for(const p of f){const l=s(p);ze(l)?await l===!0&&t.push(p):l===!0&&t.push(p)}return t}if(A(e[0])){const t=await e[0].load(),s=E.create(e[1],t.getFieldsIndex(),t.dateFieldsTimeZoneDefaultUTC),f=s.getVariables();if(f.length>0){const p=[];for(let r=0;r<f.length;r++){const o={name:f[r]};p.push(await a.evaluateIdentifier(n,o))}const l={};for(let r=0;r<f.length;r++)l[f[r]]=p[r];return s.parameters=l,new _({parentfeatureset:e[0],whereclause:s})}return new _({parentfeatureset:e[0],whereclause:s})}throw new c(n,m.InvalidParameter,i)})},a.signatures.push({name:"filter",min:2,max:2}),a.functions.orderby=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{if(b(e,2,2,n,i),A(e[0])){const t=new Ce(e[1]);return new ve({parentfeatureset:e[0],orderbyclause:t})}throw new c(n,m.InvalidParameter,i)})},a.signatures.push({name:"orderby",min:2,max:2}),a.functions.top=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{if(b(e,2,2,n,i),A(e[0]))return new Pe({parentfeatureset:e[0],topnum:e[1]});if(x(e[0]))return O(e[1])>=e[0].length?e[0].slice(0):e[0].slice(0,O(e[1]));if(M(e[0]))return O(e[1])>=e[0].length()?e[0].slice(0):e[0].slice(0,O(e[1]));throw new c(n,m.InvalidParameter,i)})},a.signatures.push({name:"top",min:2,max:2}),a.functions.first=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{if(b(e,1,1,n,i),A(e[0])){const t=await e[0].first(y.abortSignal);if(t!==null){const s=Ne.createFromGraphicLikeObject(t.geometry,t.attributes,e[0],n.timeZone);return s._underlyingGraphic=t,s}return t}return x(e[0])?e[0].length===0?null:e[0][0]:M(e[0])?e[0].length()===0?null:e[0].get(0):null})},a.signatures.push({name:"first",min:1,max:1}),a.functions.attachments=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{b(e,1,2,n,i);const t={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof v){if(e[1].hasField("minsize")&&(t.minsize=O(e[1].field("minsize"))),e[1].hasField("metadata")&&(t.returnMetadata=k(e[1].field("metadata"))),e[1].hasField("maxsize")&&(t.maxsize=O(e[1].field("maxsize"))),e[1].hasField("types")){const s=xe(e[1].field("types"),!1);s.length>0&&(t.types=s)}}else if(e[1]!==null)throw new c(n,m.InvalidParameter,i)}if(j(e[0])){let s=e[0]._layer;return s instanceof te&&(s=ee(s,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),s===null?[]:A(s)===!1?[]:(await s.load(),s.queryAttachments(e[0].field(s.objectIdField),t.minsize,t.maxsize,t.types,t.returnMetadata))}if(e[0]===null)return[];throw new c(n,m.InvalidParameter,i)})},a.signatures.push({name:"attachments",min:1,max:2}),a.functions.featuresetbyrelationshipname=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{b(e,2,4,n,i);const t=e[0],s=N(e[1]);let f=S(e[2],null);const p=k(S(e[3],!0));if(f===null&&(f=["*"]),x(f)===!1)throw new c(n,m.InvalidParameter,i);if(e[0]===null)return null;if(!j(e[0]))throw new c(n,m.InvalidParameter,i);let l=t._layer;if(l instanceof te&&(l=ee(l,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),l===null||A(l)===!1)return null;l=await l.load();const r=l.relationshipMetaData().filter(h=>h.name===s);if(r.length===0)return null;if(r[0].relationshipTableId!==void 0&&r[0].relationshipTableId!==null&&r[0].relationshipTableId>-1)return Ze(l,r[0],t.field(l.objectIdField),l.spatialReference,f,p,n.lrucache,n.interceptor);let o=l.serviceUrl();if(!o)return null;o=o.charAt(o.length-1)==="/"?o+r[0].relatedTableId.toString():o+"/"+r[0].relatedTableId.toString();const u=await Re(o,l.spatialReference,f,p,n.lrucache,n.interceptor);await u.load();let w=u.relationshipMetaData();if(w=w.filter(h=>h.id===r[0].id),t.hasField(r[0].keyField)===!1||t.field(r[0].keyField)===null){const h=await l.getFeatureByObjectId(t.field(l.objectIdField),[r[0].keyField]);if(h){const T=E.create(w[0].keyField+"= @id",u.getFieldsIndex(),u.dateFieldsTimeZoneDefaultUTC);return T.parameters={id:h.attributes[r[0].keyField]},u.filter(T)}return new Oe({parentfeatureset:u})}const D=E.create(w[0].keyField+"= @id",u.getFieldsIndex(),u.dateFieldsTimeZoneDefaultUTC);return D.parameters={id:t.field(r[0].keyField)},u.filter(D)})},a.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),a.functions.featuresetbyassociation=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{b(e,2,3,n,i);const t=e[0],s=N(S(e[1],"")).toLowerCase(),f=P(e[2])?N(e[2]):null;if(e[0]===null)return null;if(!j(e[0]))throw new c(n,m.InvalidParameter,i);let p=t._layer;if(p instanceof te&&(p=ee(p,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),p===null||A(p)===!1)return null;await p.load();const l=p.serviceUrl(),r=await Ue(l,n.spatialReference);let o=null,u=null,w=!1;if(f!==null&&f!==""&&f!==void 0){for(const F of r.terminals)F.terminalName===f&&(u=F.terminalId);u===null&&(w=!0)}const D=r.associations.getFieldsIndex(),h=D.get("TOGLOBALID").name,T=D.get("FROMGLOBALID").name,V=D.get("TOTERMINALID").name,Q=D.get("FROMTERMINALID").name,H=D.get("FROMNETWORKSOURCEID").name,W=D.get("TONETWORKSOURCEID").name,U=D.get("ASSOCIATIONTYPE").name,ge=D.get("ISCONTENTVISIBLE").name,Fe=D.get("OBJECTID").name;for(const F of p.fields)if(F.type==="global-id"){o=t.field(F.name);break}let Z=null,re=new $(new G({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",r.associations.getFieldsIndex(),r.associations.dateFieldsTimeZoneDefaultUTC)),se=new $(new G({name:"side",alias:"side",type:"string"}),E.create("''",r.associations.getFieldsIndex(),r.associations.dateFieldsTimeZoneDefaultUTC));const L="globalid",oe="globalId",le={};for(const F in r.lkp)le[F]=r.lkp[F].sourceId;const R=new $e(new G({name:"classname",alias:"classname",type:"string"}),null,le);let g="";switch(s){case"midspan":{g=`((${h}='${o}') OR ( ${T}='${o}')) AND (${U} IN (5))`,R.codefield=E.create(`CASE WHEN (${h}='${o}') THEN ${H} ELSE ${W} END`,r.associations.getFieldsIndex(),r.associations.dateFieldsTimeZoneDefaultUTC);const F=Y(C.findField(r.associations.fields,T));F.name=L,F.alias=L,Z=new $(F,E.create(`CASE WHEN (${T}='${o}') THEN ${h} ELSE ${T} END`,r.associations.getFieldsIndex(),r.associations.dateFieldsTimeZoneDefaultUTC)),re=r.unVersion>=4?new ne(C.findField(r.associations.fields,D.get("PERCENTALONG").name)):new $(new G({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",r.associations.getFieldsIndex(),r.associations.dateFieldsTimeZoneDefaultUTC));break}case"junctionedge":{g=`((${h}='${o}') OR ( ${T}='${o}')) AND (${U} IN (4,6))`,R.codefield=E.create(`CASE WHEN (${h}='${o}') THEN ${H} ELSE ${W} END`,r.associations.getFieldsIndex(),r.associations.dateFieldsTimeZoneDefaultUTC);const F=Y(C.findField(r.associations.fields,T));F.name=L,F.alias=L,Z=new $(F,E.create(`CASE WHEN (${T}='${o}') THEN ${h} ELSE ${T} END`,r.associations.getFieldsIndex(),r.associations.dateFieldsTimeZoneDefaultUTC)),se=new $(new G({name:"side",alias:"side",type:"string"}),E.create(`CASE WHEN (${U}=4) THEN 'from' ELSE 'to' END`,r.associations.getFieldsIndex(),r.associations.dateFieldsTimeZoneDefaultUTC));break}case"connected":{let F=`${h}='@T'`,fe=`${T}='@T'`;u!==null&&(F+=` AND ${V}=@A`,fe+=` AND ${Q}=@A`),g="(("+F+") OR ("+fe+"))",g=B(g,"@T",o??""),F=B(F,"@T",o??""),u!==null&&(F=B(F,"@A",u.toString()),g=B(g,"@A",u.toString())),R.codefield=E.create("CASE WHEN "+F+` THEN ${H} ELSE ${W} END`,r.associations.getFieldsIndex(),r.associations.dateFieldsTimeZoneDefaultUTC);const J=Y(C.findField(r.associations.fields,T));J.name=L,J.alias=L,Z=new $(J,E.create("CASE WHEN "+F+` THEN ${T} ELSE ${h} END`,r.associations.getFieldsIndex(),r.associations.dateFieldsTimeZoneDefaultUTC));break}case"container":g=`${h}='${o}' AND ${U} = 2`,u!==null&&(g+=` AND ${V} = `+u.toString()),R.codefield=H,g="( "+g+" )",Z=new K(C.findField(r.associations.fields,T),L,L);break;case"content":g=`(${T}='${o}' AND ${U} = 2)`,u!==null&&(g+=` AND ${Q} = `+u.toString()),R.codefield=W,g="( "+g+" )",Z=new K(C.findField(r.associations.fields,h),L,L);break;case"structure":g=`(${h}='${o}' AND ${U} = 3)`,u!==null&&(g+=` AND ${V} = `+u.toString()),R.codefield=H,g="( "+g+" )",Z=new K(C.findField(r.associations.fields,T),L,oe);break;case"attached":g=`(${T}='${o}' AND ${U} = 3)`,u!==null&&(g+=` AND ${Q} = `+u.toString()),R.codefield=W,g="( "+g+" )",Z=new K(C.findField(r.associations.fields,h),L,oe);break;default:throw new c(n,m.InvalidParameter,i)}return w&&(g="1 <> 1"),new C({parentfeatureset:r.associations,adaptedFields:[new ne(C.findField(r.associations.fields,Fe)),new ne(C.findField(r.associations.fields,ge)),Z,se,R,re],extraFilter:g?E.create(g,r.associations.getFieldsIndex(),r.associations.dateFieldsTimeZoneDefaultUTC):null})})},a.signatures.push({name:"featuresetbyassociation",min:2,max:6}),a.functions.groupby=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{if(b(e,3,3,n,i),!A(e[0]))throw new c(n,m.InvalidParameter,i);const t=await e[0].load(),s=[],f=[];let p=!1,l=[];if(P(e[1]))l.push(e[1]);else if(e[1]instanceof v)l.push(e[1]);else if(x(e[1]))l=e[1];else{if(!M(e[1]))throw new c(n,m.InvalidParameter,i);l=e[1].toArray()}for(const r of l)if(P(r)){const o=E.create(N(r),t.getFieldsIndex(),t.dateFieldsTimeZoneDefaultUTC),u=pe(o)===!0?N(r):"%%%%FIELDNAME";s.push({name:u,expression:o}),u==="%%%%FIELDNAME"&&(p=!0)}else{if(!(r instanceof v))throw new c(n,m.InvalidParameter,i);{const o=r.hasField("name")?r.field("name"):"%%%%FIELDNAME",u=r.hasField("expression")?r.field("expression"):"";if(o==="%%%%FIELDNAME"&&(p=!0),!o)throw new c(n,m.InvalidParameter,i);s.push({name:o,expression:E.create(u||o,t.getFieldsIndex(),t.dateFieldsTimeZoneDefaultUTC)})}}if(l=[],P(e[2]))l.push(e[2]);else if(x(e[2]))l=e[2];else if(M(e[2]))l=e[2].toArray();else{if(!(e[2]instanceof v))throw new c(n,m.InvalidParameter,i);l.push(e[2])}for(const r of l){if(!(r instanceof v))throw new c(n,m.InvalidParameter,i);{const o=r.hasField("name")?r.field("name"):"",u=r.hasField("statistic")?r.field("statistic"):"",w=r.hasField("expression")?r.field("expression"):"";if(!o||!u||!w)throw new c(n,m.InvalidParameter,i);f.push({name:o,statistic:u.toLowerCase(),expression:E.create(w,t.getFieldsIndex(),t.dateFieldsTimeZoneDefaultUTC)})}}if(p){const r={};for(const u of t.fields)r[u.name.toLowerCase()]=1;for(const u of s)u.name!=="%%%%FIELDNAME"&&(r[u.name.toLowerCase()]=1);for(const u of f)u.name!=="%%%%FIELDNAME"&&(r[u.name.toLowerCase()]=1);let o=0;for(const u of s)if(u.name==="%%%%FIELDNAME"){for(;r["field_"+o.toString()]===1;)o++;r["field_"+o.toString()]=1,u.name="FIELD_"+o.toString()}}for(const r of s)await ae(r.expression,a,n);for(const r of f)await ae(r.expression,a,n);return e[0].groupby(s,f)})},a.signatures.push({name:"groupby",min:3,max:3}),a.functions.distinct=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{if(A(e[0])){b(e,2,2,n,i);const t=await e[0].load(),s=[];let f=[];if(P(e[1]))f.push(e[1]);else if(e[1]instanceof v)f.push(e[1]);else if(x(e[1]))f=e[1];else{if(!M(e[1]))throw new c(n,m.InvalidParameter,i);f=e[1].toArray()}let p=!1;for(const l of f)if(P(l)){const r=E.create(N(l),t.getFieldsIndex(),t.dateFieldsTimeZoneDefaultUTC),o=pe(r)===!0?N(l):"%%%%FIELDNAME";s.push({name:o,expression:r}),o==="%%%%FIELDNAME"&&(p=!0)}else{if(!(l instanceof v))throw new c(n,m.InvalidParameter,i);{const r=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",o=l.hasField("expression")?l.field("expression"):"";if(r==="%%%%FIELDNAME"&&(p=!0),!r)throw new c(n,m.InvalidParameter,i);s.push({name:r,expression:E.create(o||r,t.getFieldsIndex(),t.dateFieldsTimeZoneDefaultUTC)})}}if(p){const l={};for(const o of t.fields)l[o.name.toLowerCase()]=1;for(const o of s)o.name!=="%%%%FIELDNAME"&&(l[o.name.toLowerCase()]=1);let r=0;for(const o of s)if(o.name==="%%%%FIELDNAME"){for(;l["field_"+r.toString()]===1;)r++;l["field_"+r.toString()]=1,o.name="FIELD_"+r.toString()}}for(const l of s)await ae(l.expression,a,n);return e[0].groupby(s,[])}return He(e)})},a.functions.getfeaturesetinfo=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{if(b(e,1,1,n,i),!A(e[0]))return null;const t=await e[0].getFeatureSetInfo();return t?v.convertObjectToArcadeDictionary({layerId:t.layerId,layerName:t.layerName,itemId:t.itemId,serviceLayerUrl:t.serviceLayerUrl,webMapLayerId:t.webMapLayerId??null,webMapLayerTitle:t.webMapLayerTitle??null,className:null,objectClassId:null},ue(n),!1,!1):null})},a.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),a.functions.filterbysubtypecode=function(n,i){return a.standardFunctionAsync(n,i,async(y,I,e)=>{if(b(e,2,2,n,i),A(e[0])){const t=await e[0].load(),s=e[1];if(!Ae(s))throw new c(n,m.InvalidParameter,i);if(t.subtypeField){const p=E.create(`${t.subtypeField}= ${e[1]}`,t.getFieldsIndex(),t.dateFieldsTimeZoneDefaultUTC);return new _({parentfeatureset:e[0],whereclause:p})}if(t.typeIdField===null||t.typeIdField==="")throw new c(n,m.FeatureSetDoesNotHaveSubtypes,i);const f=E.create(`${t.typeIdField}= ${e[1]}`,t.getFieldsIndex(),t.dateFieldsTimeZoneDefaultUTC);return new _({parentfeatureset:e[0],whereclause:f})}throw new c(n,m.InvalidParameter,i)})},a.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{kn as registerFunctions};
