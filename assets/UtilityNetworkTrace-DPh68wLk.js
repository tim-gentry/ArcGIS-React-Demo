const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/calcite-action-BQdWHUTy.js","assets/action-BdLH7y4R.js","assets/jsxFactory-DmHi7Kb2.js","assets/index-DX0rcHuW.js","assets/index-B2yzeq1w.css","assets/uuid-fwrPAdZb.js","assets/dom-Dv5tDaqe.js","assets/interactive-CM5F_5Ay.js","assets/loadable-BpL5xwNx.js","assets/locale-jvDArz_C.js","assets/key-D5DPfjW0.js","assets/observers-CLdbMMrh.js","assets/component-ByvC-PUv.js","assets/t9n-Bv5oqD69.js","assets/icon-CWAu07D3.js","assets/loader-CQvnYTBN.js","assets/calcite-action-group-B8GYDGFN.js","assets/action-group-DTA_uOXw.js","assets/conditionalSlot-CqkDrxC7.js","assets/action-menu-D84YVNtM.js","assets/array-DofFqflK.js","assets/popover-Zk0D1hdH.js","assets/floating-ui-CVXgJmXk.js","assets/debounce-C5YDvsuO.js","assets/focusTrapComponent-CklV4nIL.js","assets/openCloseComponent-BcNBZQe2.js","assets/Heading-DiaW_And.js","assets/FloatingArrow-Cy8j4zsH.js","assets/calcite-action-pad-DhsA5bpl.js","assets/ExpandToggle-Dotf6BRD.js","assets/calcite-block-qdFeD75E.js","assets/handle-BKDOnSwp.js","assets/scrim-CLRFMMcr.js","assets/calcite-block-section-CgMu0zRh.js","assets/switch-DGXW061d.js","assets/form-DT0Txu1X.js","assets/label-CcvHzygA.js","assets/calcite-button-B3dK3J4O.js","assets/button-D77aSY9T.js","assets/calcite-checkbox-B3jaud22.js","assets/calcite-color-picker-swatch-IOxk8WY7.js","assets/color-picker-swatch-Bvinex3s.js","assets/calcite-combobox-CFk50a9E.js","assets/combobox-71NFiN9k.js","assets/core-2D-WamSI.js","assets/filter-BHzLPuAd.js","assets/Validation-BmSC9xQN.js","assets/utils2-C9ILKKiq.js","assets/chip-Dw2wHkeW.js","assets/combobox-item-COrIQXYO.js","assets/input-message-D42H2lMx.js","assets/calcite-combobox-item-CebKWX2e.js","assets/calcite-flow-DRMo8BV0.js","assets/calcite-flow-item-C1dz4xH2.js","assets/panel-DPpK0hDp.js","assets/calcite-icon-W-AdNGRC.js","assets/calcite-input-number-CJjaZ08i.js","assets/input-number-C9dNUp9Q.js","assets/input-Dt5r39B0.js","assets/progress-Cn98mWq-.js","assets/calcite-label-75nr6He8.js","assets/calcite-list-Dnyd1Dz_.js","assets/resources4-CT6dxwoZ.js","assets/utils3-DHpXCuCx.js","assets/input2-Dot_SaOW.js","assets/calcite-list-item-DvRwTdOl.js","assets/calcite-loader-DWyhLzpy.js","assets/calcite-notice-DA7FQ9_1.js","assets/calcite-option-rXI2IAFc.js","assets/calcite-panel-DcFdTOap.js","assets/calcite-popover-CqUVx7C5.js","assets/calcite-scrim-ChpvlkQb.js","assets/calcite-select-DumKFjGo.js","assets/calcite-tab-sZKJtdlq.js","assets/tab-DShWdgcr.js","assets/calcite-tab-nav-seQtCzON.js","assets/tab-nav-zw6L6rTp.js","assets/calcite-tab-title-DQ3WaKSS.js","assets/tab-title-B9-2hkzg.js","assets/calcite-tabs-B_KJHFbv.js","assets/tabs-DpEF7HZj.js","assets/calcite-tooltip-CXmK6QYS.js"])))=>i.map(i=>d[i]);
import{f as L,db as B,da as ye,m as we,V as oe,g9 as z,eD as fe,eC as Z,d as ne,lr as ve,gl as be,ii as q,b5 as Ae,n as Te,s as K,eJ as Re,P as Y,R as Se,t as ke,ac as u,ad as d,ag as ce,ic as he,jN as ue,ij as Fe,E as Ie,bY as x,_ as m,bZ as Q}from"./index-DX0rcHuW.js";import{e as H,B as Ce,n as l,r as Me,s as Ge}from"./jsxFactory-DmHi7Kb2.js";import{e as D}from"./globalCss-CZa70j6i.js";import{e as Ne}from"./vmEvent-D4Ubqkbq.js";import Ee from"./FeatureLayer-Bb5mf85J.js";import de from"./GraphicsLayer-SBXo_p0G.js";import{T as Pe,n as X,e as Oe}from"./UtilityNetwork-NjDvAhhO.js";import{t as Le}from"./utils-N6COAsLj.js";import{trace as Be}from"./trace-CfeqG993.js";import{m as xe,a as V}from"./TraceParameters-B_1Ni3D_.js";import{geodesicBuffer as ee,buffer as te,convexHull as $,geodesicArea as He,planarArea as De,cut as se,planarLength as N}from"./geometryEngine-C92iiwvG.js";import{l as Ve,k as $e}from"./SnappingManager-C8RCylzd.js";import{p as Ue}from"./SketchViewModel-CW2OqW_5.js";import"./uuid-fwrPAdZb.js";import"./FeatureLayerBase-uK0oK06Z.js";import"./inputs-Due4QVtL.js";import"./formUtils-Dni92j4V.js";import"./HeightModelInfo-DaJXTLDg.js";import"./arcgisLayerUrl-BpJodxxk.js";import"./LayerFloorInfo-D-bXPB8b.js";import"./Relationship-Clp_49iY.js";import"./serviceCapabilitiesUtils-CIgEASrL.js";import"./editsZScale-BDLbHb5e.js";import"./queryZScale-B1r3mH-Y.js";import"./APIKeyMixin-DSbft86T.js";import"./ArcGISService-CVVnFG2B.js";import"./EditBusLayer-Brt5ASt_.js";import"./FeatureType-Bb4KOLCq.js";import"./versionUtils-DlHqsQBg.js";import"./styleUtils-CxRaW7Jr.js";import"./TopFeaturesQuery-B-wHLSqs.js";import"./interfaces-CL2NbQte.js";import"./GraphicsCollection-BjA_qBYu.js";import"./utils-nzDIu46v.js";import"./geometryEngineBase-RmbNeFm7.js";import"./_commonjsHelpers-DCkdB7M8.js";import"./hydrated-CEL7VY_R.js";import"./elevationInfoUtils-JmMUMmCn.js";import"./projectVectorToVector-DjKO2tJh.js";import"./projectPointToVector-6lqiVL77.js";import"./vec2-C-4tM9Uv.js";import"./UpdatingHandles-CERUeL1P.js";import"./vec2f64-Diu2Kaa8.js";import"./geodesicUtils-BPlO99Nt.js";import"./plane-BL9J6YX0.js";import"./mat3f64-BBpwCtoL.js";import"./mat4f64-Dk4dwAN8.js";import"./quatf64-BrpT0VRp.js";import"./mathUtils-BsqbT0oM.js";import"./sphere-COyqsaGw.js";import"./geometry2dUtils-D5ud2BJg.js";import"./floorFilterUtils-DZ5C6FQv.js";import"./InputManager-abOXR3ru.js";import"./signal-CpmfLcHB.js";import"./keybindings-RFI4I3n4.js";import"./utils-CXgSw6Sd.js";import"./layerViewUtils-D2JqIDZ8.js";import"./geodesicLengthMeasurementUtils-1VjlYqtL.js";import"./quantityUtils-DSpmykXR.js";import"./Cyclical-CEj-eenM.js";import"./isSupportedObject-DZrOSWxn.js";import"./SketchLabelOptions-zVB6yjLA.js";import"./layerUtils-BS1Di3Pm.js";import"./hitTestSelectUtils-UXJPjatw.js";import"./screenUtils-BcEL8jIe.js";function U(e){return e.type==="polygon"||e.type==="polyline"}function je(e){return e.hasOwnProperty("points")}function We(e){return je(e)&&e.points.length===2}class pe{createBuffer(t,s,i,r){if(Array.isArray(t)){if(t.length>0){const o=L.fromJSON(t[0].spatialReference);return o.isWGS84||o.isWebMercator?ee(t,s,i):te(t,s,i,r)}return}const a=L.fromJSON(t.spatialReference);return a.isWGS84||a.isWebMercator?ee(t,s[0],i):te(t,s[0],i)}createConvexHull(t){if(Array.isArray(t)){if(t.length===1&&We(t[0])){const i=$(t[0]);if(U(i))return i}return $(t,!0).filter(U)}const s=$(t);if(U(s))return s}calculateArea(t,s){const i=new L({wkid:t.spatialReference.wkid});return i.isWGS84||i.isWebMercator?parseFloat(He(t,s).toFixed(2)):parseFloat(De(t,s).toFixed(2))}mergeAggregatedToGeometries(t){const s=[],{line:i,multipoint:r,polygon:a}=t;return i&&s.push(i),r&&s.push(r),a&&s.push(a),s}getPercentageAlong(t,s,i){let r=t;const a=this._createPolyline(t.paths,i.wkid);if(s.type==="point"){const n=s.x-.5,c=s.x+.5,h=[[n,s.y-.5],[c,s.y+.5]];r=this._createPolyline(h,s.spatialReference.wkid),r=B(r,i);const p=se(a,r);if(p.length>0){const _=N(a,"feet");let y;return y=p[0].paths[0][0][0]===a.paths[0][0][0]?N(p[0],"feet"):N(p[1],"feet"),[y/_]}return[.5]}r=B(s,i);const o=se(a,r);if(o.length>0){const n=N(a,"feet");return[N(o[0],"feet")/n]}return[.5]}async projectGeometry(t,s){return await ye(),B(t,s)}_createPolyline(t,s){return new we({hasZ:!1,hasM:!0,paths:t,spatialReference:{wkid:s}})}}const ge=[227,27,21,.6],me=[21,244,21,.6],O=12,J=[{color:[255,0,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ff0000"},{color:[255,0,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ff00ff"},{color:[217,188,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#D9BCFF"},{color:[0,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#00ff00"},{color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ffff00"},{color:[0,0,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#0000ff"},{color:[255,165,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#ffa500"},{color:[0,0,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#000000"}];let ze=class{constructor(){this.highlightColor=[...J]}addCustomColor(t){this.highlightColor=[...J],this.highlightColor.some(s=>s.hex.toLowerCase()===t.hex.toLowerCase())||this.highlightColor.push(t)}getFlagGraphic(t,s,i,r){const a=s==="starting-point"?me:ge;if(t.type==="polygon"){const o=t;o.centroid&&(t=o.centroid)}return r?this.makeGraphic(t,a,i==null?void 0:i.attributes,null,r):this.makeGraphic(t,a,i==null?void 0:i.attributes)}initializeSketch(t,s,i){const r=new oe;return i.forEach(a=>r.add(new Ve({layer:a,enabled:!0}))),new Ue({layer:s,view:t,snappingOptions:new $e({enabled:!0,featureEnabled:!0,featureSources:r})})}makeGraphic(t,s,i,r,a){let o,n=t;switch(t.type){case"multipoint":o=new Z({color:s,size:O,outline:{color:s,width:0}}),r&&(n=t);break;case"point":o=a||new Z({color:s,size:O,outline:{color:s,width:0}}),r&&(n=t);break;case"polyline":o=new fe({color:s,width:O}),r&&(n=t);break;case"polygon":o=new z({color:s,outline:{color:s,width:O}}),r&&(n=t)}return new ne({geometry:n,symbol:o,attributes:i??null})}};const k=`utility-network-trace-result-area-${Date.now()}`;function E(e){return e.type==="graphics"}class qe{constructor(){this.traceInformation={},this._geometryHandler=new pe}addResultAreaToMap(t,s){const i=this.createGraphicLayer(s);i&&E(i)&&i.add(t)}changeResultAreaColor(t,s,i){const r=new z({color:s.color,style:"solid",outline:{color:s.color,width:1}}),a=this._findGraphicsByTraceId(t,i);return a&&a.forEach(o=>{o.symbol=r}),r}createBuffer(t,s,i,r){return this._geometryHandler.createBuffer(t,s,i,r)}createConvexHull(t,s,i){const r=this._geometryHandler.createConvexHull(t);return s>0&&r?this.createBuffer(r,[s],i,!1):r}createResultAreaGraphic(t,s,i,r,a,o){var h;const n=new z({color:o.color,style:"solid",outline:{color:o.color,width:1}}),c=[];for(const p in s)c.push(new ve({fieldName:p,label:p==="areaStatistic"?r.attributeStrings[p]+" ("+((h=a.units[i])==null?void 0:h.abbr)+")":r.attributeStrings[p]}));return new ne({geometry:t,symbol:n,attributes:s,popupTemplate:new be({title:s.traceName,content:[{type:"fields",fieldInfos:c}]})})}removeResultArea(t,s){const i=s.findLayerById(k);if(i&&E(i)){const r=this._findGraphicsByTraceId(t,s);return r&&i.removeMany(r),r}return null}removeAllResultAreaGraphics(t){if(t){const s=t.findLayerById(k);s&&E(s)&&s.removeAll()}}createGraphicLayer(t,s){const i=t.findLayerById(k);if(i&&E(i))return i;const r=new de({title:s??k,listMode:"hide",id:k});return t.add(r),r}_findGraphicsByTraceId(t,s){const i=s.findLayerById(k);if(i&&E(i)){const r=i.graphics.filter(a=>a.attributes.traceId===t);return r.length>0?r.toArray():null}return null}}function ie(e){return e.type==="feature"}function j(e,t){return e.url.includes(t)}function re(e,t){var s;return(((s=e.dataElement)==null?void 0:s.domainNetworks)||[]).some(i=>i.subnetworkLayerId===t.layerId)}class Je{getValidUtilityNetworkLayers(t,s){const i=[];return t==null||t.allLayers.forEach(r=>{r.type==="group"?i.push(...r.layers.filter(q).filter(a=>ie(a)&&s.isUtilityLayer(a)&&!re(s,a)).filter(a=>j(a,s.featureServiceUrl)).toArray()):r.type==="subtype-group"?i.push(...r.sublayers.filter(a=>j(a,s.featureServiceUrl)).toArray()):q(r)&&ie(r)&&s.isUtilityLayer(r)&&!re(s,r)&&j(r,s.featureServiceUrl)&&i.push(r)}),i}}const Ze=()=>he("esri/widgets/UtilityNetworkTrace/t9n/UtilityNetworkTrace"),Ke=()=>he("esri/core/t9n/Units"),S=`utility-network-trace-flags-${Date.now()}`,P=`utility-network-trace-results-${Date.now()}`;function Ye(e){return e instanceof ue}function Qe(e){return e.layer.type==="feature"||e.layer.type==="subtype-group"}function Xe(e){return"layer"in e}function et(e){return e.layerViews!==void 0}function tt(e){return e.type==="graphics"}async function st(e){var i;const t=new Ee({url:e.networkSystemLayers.dirtyAreasLayerUrl});await t.load();const s=t.version;if(Number(s)<=11.1){const r=await Fe(e.layerUrl),a=new Ie({url:r});await a.load();const o=(i=a==null?void 0:a.user)==null?void 0:i.username;return!!o&&Le(a,o,"utilityNetwork")}return!0}let w=class extends Ae.EventedAccessor{constructor(e){super(e),this._activeProgress=!1,this._clickHandler=null,this._flags=[],this._flagId=0,this._geometryHandler=null,this._highlightHandler=[],this._resultAreaHandler=null,this._utilityHelper=new Je,this._watchHandler=null,this._validUNLayers=[],this._traceTimeout=6e5,this._sketchViewModel=null,this.traces=[],this.graphicHandler=null,this.defaultGraphicColor={color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#FFFF00"},this.enableResultArea=!1,this.flags=[],this.gdbVersion="sde.DEFAULT",this.messages=null,this.messagesUnits=null,this.defaultResultAreaProperties={type:"convexhull",distance:10,unit:"meters",areaUnit:"square-meters",color:{color:[255,165,0,.5],haloOpacity:.9,fillOpacity:.2,hex:"#ffa500"},show:!1},this.selectedTraces=[],this.selectOnComplete=!0,this.showGraphicsOnComplete=!0,this.showSelectionAttributes=!0,this.traceResults=[],this.utilityNetwork=null}initialize(){this._geometryHandler=new pe,this.graphicHandler=new ze,this._resultAreaHandler=new qe,(async()=>{const[e,t]=await Promise.all([Ze(),Ke()]);this.set({messages:e,messagesUnits:t})})()}destroy(){this.view=null}get resultAreaProperties(){return this.defaultResultAreaProperties}set resultAreaProperties(e){this._set("resultAreaProperties",{...this.defaultResultAreaProperties,...e}),this.graphicHandler.addCustomColor(this.resultAreaProperties.color),this.traceResults.forEach(t=>{var i;const s=(i=t.resultArea)==null?void 0:i.show;t.resultArea={...this.defaultResultAreaProperties,...e},this.removeResultAreaFromMap(t),this.enableResultArea&&this.createResultAreaGraphic(t).then(r=>{if(r){t.resultAreaGraphic=r;const a=(e==null?void 0:e.show)??s;t.resultArea&&(t.resultArea.show=a),a&&this.addResultAreaToMap(t,r)}})})}get state(){var e;return(e=this.view)!=null&&e.ready?"ready":"loading"}get view(){return this._get("view")}set view(e){e&&e.type!=="2d"&&Te.getLogger(this).error(new K("view:invalid-view","SceneView is not supported",{view:e})),this._set("view",e),this.utilityNetwork&&this.reset(),this.utilityNetwork=null,this.loadUtilityNetwork().then(t=>{t&&this.selectTracesOnLoad()})}addFlagByHit(e,t){const s=i=>{var r;(r=this.view)!=null&&r.popup&&(this.view.popupEnabled=i)};return new Promise((i,r)=>{var a;s(!1),(a=this._clickHandler)==null||a.remove(),this._clickHandler=this._sketchViewModel.on("create",o=>{if(o.state==="complete"){const n=this._getGraphicLayer(S);n&&o.graphic&&n.remove(o.graphic),this.queryFlagByHitTest(o,e,t).then(c=>{var h;s(!0),(h=this._clickHandler)==null||h.remove(),this.emit("add-flag-complete",{type:e,symbol:t}),i(c)}).catch(c=>{var h;s(!0),(h=this._clickHandler)==null||h.remove(),this.emit("add-flag-error",{type:e,symbol:t}),r(c)})}}),this._sketchViewModel.create("point"),this.emit("add-flag",{type:e})})}async addFlagsOnLoad(){return this._flags.length>0?[]:(await Re(()=>this.view!=null&&!this.view.updating),(await Promise.all(this.flags.map(async e=>{if(!e.mapPoint)return null;const{type:t}=e,s=e.mapPoint.clone(),i=t==="barrier"?ge:me,r={graphic:this.graphicHandler.makeGraphic(s,i),state:"complete",tool:"point",toolEventInfo:null,type:"create"};try{return await this.queryFlagByHitTest(r,e.type,null),this.emit("add-flag-complete",{type:t}),null}catch{return this.emit("add-flag-error",{type:t}),t==="barrier"?"barrier":"starting-point"}}))).filter(e=>!e))}async addResultAreaToMap(e,t){var s,i;if(this.view){if(e.resultArea.show=!0,t)(s=this._resultAreaHandler)==null||s.addResultAreaToMap(t,this.view.map),this.emit("add-result-area",{graphic:t});else if(e.results){const r=await this.createResultAreaGraphic(e);r&&(e.resultAreaGraphic=r,(i=this._resultAreaHandler)==null||i.addResultAreaToMap(r,this.view.map),this.emit("add-result-area",{graphic:r}))}}}async addResultGraphicToView(e,t){var r;const{view:s}=this,{results:i}=e;if(s&&i&&this.utilityNetwork){for(const a in i.aggregatedGeometry)if("line,multipoint,polygon".includes(a)){const o=a,n=i.aggregatedGeometry[o];if(n!=null){n.spatialReference=this.utilityNetwork.spatialReference,e.graphicEnabled=!0;const c=await this._geometryHandler.projectGeometry(n,s.spatialReference),h={globalid:e.trace.globalId};if(c!==null){const p=this.graphicHandler.makeGraphic(c,t.color,h,s.spatialReference);(r=this._getGraphicLayer(P))==null||r.add(p)}}}}}addTerminal(e,t){const s=[...this._flags];s.forEach(i=>{var r,a;i.globalId===t.globalId&&((r=t.selectedTerminals)!=null&&r.includes(parseInt(e,10))||((a=i.selectedTerminals)==null||a.push(parseInt(e,10))))}),this._flags=s}async callTrace(){const e=this.traces.filter(t=>t.selected);return e.length>0&&(this.traceResults.length>0&&this.traceResults.forEach(t=>{this.removeResultGraphicFromView(t)}),this.traceResults=[],this.removeSelection(),await Promise.all(e.map(async(t,s)=>{var a;const i=t,r=new xe({gdbVersion:this.utilityNetwork?this.utilityNetwork.gdbVersion:this.gdbVersion,moment:null,traceType:i.traceType,traceLocations:this._flags,namedTraceConfigurationGlobalId:i.globalId,traceConfiguration:null,outSpatialReference:null,resultTypes:null});await this.executeTrace(i,(a=this.utilityNetwork)==null?void 0:a.networkServiceUrl,r).then(o=>{if(o.hasOwnProperty("results")){const n={...o};if(n.results!==null){n.resultArea={...this.resultAreaProperties};const c=[...n.results.elements];n.results.elements.length=0;const h=new Map;for(const _ of c)h.has(_.globalId)||(h.set(_.globalId,!0),n.results.elements.push(_));const p=[...this.traceResults];p.splice(s,0,n),this.traceResults=p,n.results!==null&&(this.selectOnComplete&&this.mergeSelection(!0,n.trace),this.showGraphicsOnComplete&&this.addResultGraphicToView(n,n.graphicColor),this.enableResultArea&&this.createResultAreaGraphic(n).then(_=>{var y;_&&(n.resultAreaGraphic=_,(y=n.resultArea)!=null&&y.show&&this.addResultAreaToMap(n,n.resultAreaGraphic))}))}else{const c=[...this.traceResults];c.splice(s,0,o),this.traceResults=c}this._activeProgress=!1}else{this._activeProgress=!1;const n=[...this.traceResults];n.splice(s,0,o),this.traceResults=n}}).catch(o=>{throw this._activeProgress=!1,o})})),!0)}changeResultAreaColor(e,t){var i;if(!e.resultArea)return;e.resultArea.color=t;const s=(i=this._resultAreaHandler)==null?void 0:i.changeResultAreaColor(e.trace.globalId,t,this.view.map);e.resultAreaGraphic&&(e.resultAreaGraphic.symbol=s)}changeResultGraphicColor(e,t){const s=[...this.traceResults];s.length>0&&s.forEach(i=>{i.trace.globalId===t.trace.globalId&&(i.graphicColor=e,i.graphicEnabled=!0)}),this.traceResults=s,this.removeResultGraphicFromView(t),this.addResultGraphicToView(t,e)}changeFlagSymbol(e,t){this._flags.length>0&&this._flags.forEach(s=>{s.type===e&&t&&s.mapGraphic&&(s.mapGraphic.symbol=t)})}checkCanTrace(){const e={status:!0,issues:[]};let t=!1;const s=this._flags.some(a=>a.type==="starting-point"),i=this._flags.filter(a=>a.allTerminals!==null);i.length>0&&(t=i.some(a=>a.selectedTerminals.length<=0));let r=[];return s?(r=this.traces.filter(a=>a.selected),r.length<=0?(e.status=!1,e.issues=["noTrace"],t&&(e.status=!1,e.issues=["noTrace","noTerminalSelected"])):t&&(e.status=!1,e.issues=["noTerminalSelected"])):(r=this.traces.filter(a=>a.selected===!0),r.length>0?(e.status=!1,e.issues=["noStart"],t&&(e.status=!1,e.issues=["noStart","noTerminalSelected"])):(e.status=!1,e.issues=["noStart","noTrace"],t&&(e.status=!1,e.issues=["noStart","noTrace","noTerminalSelected"]))),e}checkSelectionExist(){return this._highlightHandler.some(e=>e)}clearResult(e){if(!this.view)return;let t=this.traceResults;if(t.length>0){const s=t.filter(i=>i.trace.globalId===e.globalId);s.length>0&&(this.removeResultGraphicFromView(s[0]),this.removeResultAreaFromMap(s[0])),t=t.filter(i=>i.trace.globalId!==e.globalId)}this.traceResults=t,t.length===0?(this.removeAllResultAreaGraphics(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]})):this.mergeSelection(!1,e)}createResultAreaGeometries(e,t,s){var a,o,n,c,h,p,_,y,A,T,F,I,C,M;if(!this.view||!this.resultAreaProperties)return;let i;if(i=((a=this.resultAreaProperties)==null?void 0:a.type)==="convexhull"?t.length===1&&(Y(t[0])||Se(t[0])&&t[0].points.length===1)?(n=this._resultAreaHandler)==null?void 0:n.createBuffer(t,s,(o=e.resultArea)==null?void 0:o.unit,!0):(p=this._resultAreaHandler)==null?void 0:p.createConvexHull(t,(c=e.resultArea)==null?void 0:c.distance,(h=e.resultArea)==null?void 0:h.unit):(y=this._resultAreaHandler)==null?void 0:y.createBuffer(t,s,(_=e.resultArea)==null?void 0:_.unit,!0),!i)return;if(Array.isArray(i)){for(const f of i){const R=this.getResultAreaAttributes(e,f),G=(F=this._resultAreaHandler)==null?void 0:F.createResultAreaGraphic(f,R,(A=e.resultArea)==null?void 0:A.areaUnit,this.messages,this.messagesUnits,(T=e.resultArea)==null?void 0:T.color);if(G)return G}return}const r=this.getResultAreaAttributes(e,i);return(M=this._resultAreaHandler)==null?void 0:M.createResultAreaGraphic(i,r,(I=e.resultArea)==null?void 0:I.areaUnit,this.messages,this.messagesUnits,(C=e.resultArea)==null?void 0:C.color)}async createResultAreaGraphic(e){var t;if(e.results){const s=await this._createResultAreaInputGeometry(e.results);if(s.length>0){const i=Array(s.length).fill((t=e.resultArea)==null?void 0:t.distance),r=this.createResultAreaGeometries(e,s,i);return this.emit("create-result-area",{graphic:r}),r}}}executeTrace(e,t,s){const i=this._processFlags(s.traceLocations);return s.traceLocations=i,Be(t,s,{timeout:this._traceTimeout}).then(r=>({trace:e,results:r,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:"success",date:new Date})).catch(r=>({trace:e,results:null,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:r.message,date:new Date}))}getResultAreaAttributes(e,t){var o,n,c;const{messages:s}=this,i=[],r=[];this._flags.forEach(h=>{var _,y,A,T;const p=((_=h.displayValue)==null?void 0:_.field)+":"+((y=h.displayValue)==null?void 0:y.value)+";"+s.attributeStrings.globalid+":"+h.globalId+";"+s.attributeStrings.terminalid+":"+h.terminalId+";"+s.attributeStrings.x+":"+((A=h.mapPoint)==null?void 0:A.x)+";"+s.attributeStrings.y+":"+((T=h.mapPoint)==null?void 0:T.y);h.type==="starting-point"?i.push(p):r.push(p)});const a=this.utilityNetwork?this.utilityNetwork.gdbVersion:this.gdbVersion;return{traceId:e.trace.globalId,traceName:e.trace.title,traceDescription:e.trace.description??"",startingPoints:i.toString(),barriers:r.toString(),version:a??void 0,username:ke.credentials[0].userId,date:e.date,elementCount:(o=e.results)==null?void 0:o.elements.length,functionResult:JSON.stringify((n=e.results)==null?void 0:n.globalFunctionResults),areaStatistic:t?this._geometryHandler.calculateArea(t,(c=e.resultArea)==null?void 0:c.areaUnit):0}}getValidSources(){var s,i;let e=[];const t=((i=(s=this.utilityNetwork)==null?void 0:s.dataElement)==null?void 0:i.domainNetworks)??[];for(const r of t)e=e.concat(r.junctionSources),e=e.concat(r.edgeSources);return e}groupResultsByNetworkSource(e){return e.length===0?[]:this._groupBy(e,"networkSourceId")}async loadUtilityNetwork(){var i;const{view:e}=this;if(!e)return null;if(await e.when(),this.utilityNetwork){if(this.utilityNetwork.loaded||await this.utilityNetwork.load(),this.utilityNetwork instanceof Pe){try{await e.map.loadAll(),this._loadUNSupportItems()}catch{this._loadUNSupportItems()}return this.utilityNetwork}return null}const t=e.map,s=(i=t.utilityNetworks)==null?void 0:i.at(0);if(s){if(await s.load(),this.utilityNetwork=s,!await st(s))throw new K("utility-network:no-user-type-extension","User type extension not found");try{await t.loadAll(),this._loadUNSupportItems()}catch{}finally{this._loadUNSupportItems()}return s}return null}manageFilterBarrier(e,t){const s=[...this._flags];s.forEach(i=>{i.globalId===t.globalId&&t.type==="barrier"&&i.id===t.id&&(i.isFilterBarrier=e)}),this._flags=s}mergeSelection(e,t){let s=[];const i=[...this.traceResults],r=t.globalId;i.forEach(a=>{var o,n;r===a.trace.globalId&&(a.selectionEnabled=e),a.selectionEnabled&&((o=a.results)==null?void 0:o.elements)!==null&&(s=[...s,...((n=a.results)==null?void 0:n.elements)??[]])}),this.selectResults([...new Set(s)])}async queryFeaturesById(e){var o;const{view:t}=this;if(!t||!this.utilityNetwork)return null;const s=X(this.utilityNetwork,e),i={layerUrl:s[0].layerUrl,objectIds:s[0].objectIds,outFields:["*"]},r=((o=t.map)==null?void 0:o.allTables.toArray().filter(n=>{var c;return((c=n==null?void 0:n.parsedUrl)==null?void 0:c.path)===s[0].layerUrl}).filter(q))??[];this._getUniqueMapLayerViews(t).filter(({layer:n})=>{var c;return((c=n==null?void 0:n.parsedUrl)==null?void 0:c.path)===s[0].layerUrl}).forEach(({layer:n})=>{n.type!=="feature"&&n.type!=="subtype-group"||r.push(n)});const a=(await Promise.all(r.map(async n=>{const c={layers:new oe([n]),layerInfos:[i],returnGeometry:!0,outSpatialReference:t.spatialReference},[h]=await Oe(c);return h}))).filter(({featureSet:n})=>n.features.length>0);return a.length>0?a:null}queryFlagByHitTest(e,t,s){return this._lookupFlagByHit(e).then(i=>{const{view:r}=this;if(!r)return!1;if(i.length>0){const a=[...this._flags],o=s;return i.forEach(n=>{var p,_;const c=n.graphic,h=c.attributes.hasOwnProperty("GLOBALID")?c.attributes.GLOBALID:c.attributes.globalid;if(a.filter(y=>y.globalId===h).length<=0){const y=this.graphicHandler.getFlagGraphic(c.attributes.mapPoint,t,c,o);(p=this._getGraphicLayer(S))==null||p.add(y);const A=this._createFlagProperty(c,t,y);a.push(A)}else if(c.attributes.percentAlong!==null){const y=this.graphicHandler.getFlagGraphic(c.attributes.mapPoint,t,c,o);(_=this._getGraphicLayer(S))==null||_.add(y);const A=this._createFlagProperty(c,t,y);a.push(A)}}),this._flags=a,!0}return!1})}removeResultGraphicFromView(e){var r;const{view:t}=this;if(!t)return;const s=(r=this._getGraphicLayer(P))==null?void 0:r.graphics;e.graphicEnabled=!1;const i=s==null?void 0:s.filter(a=>a.attributes[a.attributes.hasOwnProperty("GLOBALID")?"GLOBALID":"globalid"]===e.trace.globalId);i==null||i.forEach(a=>{var o;(o=this._getGraphicLayer(P))==null||o.remove(a)})}removeFlag(e){const t=this._flags.filter(s=>{if(s.id!==e.id)return s});this._removeGraphic(e),this._flags=t}removeAllResultAreaGraphics(){var e;(e=this._resultAreaHandler)==null||e.removeAllResultAreaGraphics(this.view.map)}removeResultAreaFromMap(e){var t,s;if(e.resultArea){e.resultArea.show=!1;const i=(s=this._resultAreaHandler)==null?void 0:s.removeResultArea(e.trace.globalId,(t=this.view)==null?void 0:t.map);i&&this.emit("remove-result-area",{graphic:i})}}removeSelection(){this._highlightHandler.forEach(e=>{e&&e.remove()}),this._highlightHandler=[]}removeTerminal(e,t){const s=[...this._flags];s.forEach(i=>{var r,a;if(i.globalId===t.globalId&&((r=t.selectedTerminals)!=null&&r.includes(parseInt(e,10)))){const o=t.selectedTerminals.indexOf(parseInt(e,10));(a=i.selectedTerminals)==null||a.splice(o,1)}}),this._flags=s}removeFlagsOnLoadWatcher(){this._watchHandler&&this._watchHandler!==null&&this._watchHandler.remove()}removeClickHandler(){this._clickHandler&&(this._sketchViewModel.cancel(),this._clickHandler.remove())}reset(){var t,s;this._flags=[],this.traceResults=[];const e=[...this.traces];e.forEach(i=>{i.selected=!1}),this.traces=e,this.view&&((t=this._getGraphicLayer(P))==null||t.removeAll(),(s=this._getGraphicLayer(S))==null||s.removeAll(),this.removeAllResultAreaGraphics(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]}))}selectFeaturesById(e){const{view:t}=this;if(!t||!this.utilityNetwork)return;const s=X(this.utilityNetwork,e);this._getUniqueMapLayerViews(t).forEach(i=>{var r,a;Xe(i)&&((a=(r=i.layer)==null?void 0:r.parsedUrl)==null?void 0:a.path)===s[0].layerUrl&&Qe(i)&&this._highlightHandler.push(i.highlight(s[0].objectIds))})}selectResults(e){if(e.length>0){this.removeSelection();const t=this.groupResultsByNetworkSource(e),s=[];for(const i in t)this.selectFeaturesById(t[i]),s.push(this.queryFeaturesById(t[i]));Promise.all(s).then(i=>{this.emit("select-features",{resultSet:i})})}else this.removeSelection(),this.emit("clear-selection",{resultSet:[]})}selectTraces(e,t){const s=[...this.traces];s.forEach(i=>{t===i.globalId&&(i.selected=e)}),this.traces=s}selectTracesOnLoad(){var e;(e=this.utilityNetwork)!=null&&e.hasOwnProperty("sharedNamedTraceConfigurations")&&(this.traces=[...this.utilityNetwork.sharedNamedTraceConfigurations],this.traces.forEach(t=>{t.selected=!1,this.selectedTraces.includes(t.globalId)&&(t.selected=!0)}))}zoomToAsset(e){var t;(t=this.view)==null||t.goTo(e).catch(s=>console.error(s))}async _createResultAreaInputGeometry(e){if(e.aggregatedGeometry!=null)return this._geometryHandler.mergeAggregatedToGeometries(e.aggregatedGeometry);const t=this.groupResultsByNetworkSource(e.elements),s=[];for(const i in t)s.push(this.queryFeaturesById(t[i]));try{const i=await Promise.all(s),r=[];for(const a of i)if(a)for(const o of a)for(const n of o.featureSet.features)r.push(n.geometry);return r}catch{return[]}}_loadUNSupportItems(){var s;if(!this.utilityNetwork)return;const{map:e}=this.view,{messages:t}=this;this._populateOutfields(),this._createGraphicLayer(S),this._createGraphicLayer(P),(s=this._resultAreaHandler)==null||s.createGraphicLayer(e,t==null?void 0:t.alertsStrings.genericResultHeader),this._validUNLayers=this._utilityHelper.getValidUtilityNetworkLayers(e,this.utilityNetwork),this._sketchViewModel=this.graphicHandler.initializeSketch(this.view,this._getGraphicLayer(S),this._validUNLayers)}_getUniqueMapLayerViews(e){const t=[];return e.layerViews.filter(({layer:{type:s}})=>s==="feature"||s==="group"||s==="subtype-group").toArray().forEach(s=>{switch(s.layer.type){case"group":if(et(s))for(const i of s.layerViews)t.push(i);break;case"subtype-group":t.push(s);break;default:t.some(i=>i.layer.id===s.layer.id)||t.push(s)}}),t}_processFlags(e){const t=[];return e.forEach(s=>{if(s.selectedTerminals!==null&&s.selectedTerminals.length>0)s.selectedTerminals.forEach(i=>{const r=new V({globalId:s.globalId,percentAlong:s.percentAlong,terminalId:i,type:s.type,isFilterBarrier:s.isFilterBarrier});t.push(r)});else{const i=new V({globalId:s.globalId,percentAlong:s.percentAlong,type:s.type,isFilterBarrier:s.isFilterBarrier});t.push(i)}}),t}_getDisplayField(e){var t;return((t=e==null?void 0:e.layer)==null?void 0:t.type)==="subtype-sublayer"?this._getDisplayFieldBySublayer(e):this._getDisplayFieldByFeatureLayer(e)}_getDisplayFieldBySublayer(e){let t="",s="";const i=e.layer;t=this._checkParentForData(i,"displayField");for(const r in e.attributes){const a=r.toLowerCase();a===(t==null?void 0:t.toLowerCase())?(s=e.attributes[r],a==="assetgroup"||a==="assettype"?s=this._checkSubtype(i,i.subtypeCode):(s=this._checkDomain(i.fields,r,s),typeof s=="string"&&(s=this._defaultDisplayField(s,i)))):(s=this._checkDomain(i.fields,r,s),typeof s=="string"&&(s=this._defaultDisplayField(s,i)))}return{field:t,value:s.toString()}}_getDisplayFieldByFeatureLayer(e){var r,a;const t=e.layer;let s=t.displayField,i="";for(const o in e.attributes){const n=o.toLowerCase();if(n===(s==null?void 0:s.toLowerCase()))if(i=e.attributes[o],n==="assetgroup"||n==="assettype"){let c=e.attributes[t.typeIdField.toUpperCase()];c||(c=e.attributes[t.typeIdField.toLowerCase()]),s=t.typeIdField,i=this._checkSubtype(t,c),s===""&&(t.templates&&t.templates.length>0?(s=(r=t.templates[0])==null?void 0:r.name,i=(a=t.templates[0])==null?void 0:a.name):(s=t.displayField,i=e.attributes[o]))}else i=this._checkDomain(t.fields,o,i),typeof i=="string"&&(i=this._defaultDisplayField(i,t));else i=this._checkDomain(t.fields,o,i),typeof i=="string"&&(i=this._defaultDisplayField(i,t))}return{field:s,value:i?i.toString():""}}_checkSubtype(e,t){let s=t;if(e.type==="subtype-sublayer"){const i=this._checkParentForData(e,"subtypes");(i==null?void 0:i.length)>0&&i.forEach(r=>{r.code===t&&(s=r.name)})}else if(e.types!=null&&e.types.length>0){const i=e.types.filter(r=>r.id===t);i.length>0&&(s=i[0].name)}return s}_checkDomain(e,t,s){var a;let i=s;const r=e.filter(o=>o.name.toLowerCase()===t.toLowerCase());if(r.length>0&&Ye(r[0].domain)&&((a=r[0].domain)!=null&&a.codedValues)){const o=r[0].domain.codedValues.filter(({code:n})=>n===s);o.length>0&&(i=o[0].name)}return i}_checkParentForData(e,t){var s;return((s=e.parent)==null?void 0:s[t])??null}_defaultDisplayField(e,t){var s;return e.trim()?e:t.templates&&((s=t.templates)==null?void 0:s.length)>0?t.templates[0].name:t.title}get _uniqueFlagId(){return this._flagId++}_groupBy(e,t){return e.reduce((s,i)=>((s[i[t]]=s[i[t]]||[]).push(i),s),{})}async _lookupFlagByHit(e){var i,r,a,o;const t=(i=e.graphic)==null?void 0:i.geometry,s=[];if(t&&Y(t)&&this.view){const n=this.view.toScreen(t);if(n){const c=await this.view.hitTest(n,{include:this._validUNLayers});if(c&&c.results.length>0){const h=c.results.find(p=>p.layer!==null);if(((r=h.graphic)==null?void 0:r.geometry)!=null){if(h.graphic.geometry.type==="polyline"){const p={terminalId:null,isFilterBarrier:!1,allTerminals:null,selectedTerminals:null,percentAlong:this._geometryHandler.getPercentageAlong(h.graphic.geometry,(a=e.graphic)==null?void 0:a.geometry,h.graphic.geometry.spatialReference),displayValue:this._getDisplayField(h.graphic),mapPoint:h.mapPoint};h.graphic.attributes={...h.graphic.attributes,...p},s.push(h)}else if((h.graphic.geometry.type==="point"||h.graphic.geometry.type==="polygon")&&this.utilityNetwork!==null){const p=(o=this.utilityNetwork)==null?void 0:o.getTerminalConfiguration(h.graphic),_=this._getDisplayField(h.graphic),y={terminalId:p?p.terminals[0].id||null:1,isFilterBarrier:!1,allTerminals:p??null,selectedTerminals:[p?p.terminals[0].id||null:1],percentAlong:null,displayValue:_,mapPoint:h.mapPoint};h.graphic.attributes={...h.graphic.attributes,...y},s.push(h)}}}}}return s}_createFlagProperty(e,t,s){const i=new V;i.terminalId=e.attributes.terminalId,i.isFilterBarrier=e.attributes.isFilterBarrier,i.percentAlong=e.attributes.percentAlong,i.globalId=e.attributes.globalid||e.attributes.GLOBALID,i.type=t;const r=i;return r.details=e,r.mapGraphic=s,r.id=this._uniqueFlagId,r.allTerminals=e.attributes.allTerminals,r.selectedTerminals=e.attributes.selectedTerminals,r.displayValue=e.attributes.displayValue,r.mapPoint=e.attributes.mapPoint,r}async _populateOutfields(){var s;const e=(s=this.view)==null?void 0:s.map,t=this.getValidSources();e==null||e.layers.forEach(i=>{i.type==="group"?i.layers.forEach(r=>{t.some(a=>a.layerId===r.layerId)&&r.fields.some(a=>a.name.toLowerCase()==="assetgroup")&&(r.outFields=["assetgroup","assettype","globalid","objectid"])}):t.some(r=>r.layerId===i.layerId)&&i.fields.some(r=>r.name.toLowerCase()==="assetgroup")&&(i.outFields=["assetgroup","assettype","globalid","objectid"])})}_removeGraphic(e){var t;(t=this._getGraphicLayer(S))==null||t.remove(e.mapGraphic)}_createGraphicLayer(e){const{map:t}=this.view;if(!t.findLayerById(e)){const s=new de({title:e,listMode:"hide",id:e});t.add(s)}}_getGraphicLayer(e){const{map:t}=this.view;if(t){const s=t.findLayerById(e);if(s&&tt(s))return s}return null}};u([d()],w.prototype,"_activeProgress",void 0),u([d()],w.prototype,"_flags",void 0),u([d()],w.prototype,"traces",void 0),u([d()],w.prototype,"defaultGraphicColor",void 0),u([d()],w.prototype,"enableResultArea",void 0),u([d()],w.prototype,"flags",void 0),u([d()],w.prototype,"gdbVersion",void 0),u([d()],w.prototype,"messages",void 0),u([d()],w.prototype,"messagesUnits",void 0),u([d()],w.prototype,"resultAreaProperties",null),u([d()],w.prototype,"selectedTraces",void 0),u([d()],w.prototype,"selectOnComplete",void 0),u([d()],w.prototype,"showGraphicsOnComplete",void 0),u([d()],w.prototype,"showSelectionAttributes",void 0),u([d({readOnly:!0})],w.prototype,"state",null),u([d()],w.prototype,"traceResults",void 0),u([d()],w.prototype,"utilityNetwork",void 0),u([d({value:null})],w.prototype,"view",null),w=u([ce("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceViewModel")],w);const _e=w,v="esri-utility-trace-network",b={base:v,loaderContainer:`${v}__loader-container`,loader:`${v}__loader`,fadeIn:`${v}--fade-in`,addButtonContainer:`${v}__add-button-container`,noticeContainer:`${v}__notice-container`,listContainer:`${v}__list-container`,resultsContainer:`${v}__results-container`,flow:`${v}__flow`,numberInput:`${v}__number-input`,clearPrompt:`${v}__reset-prompt`,promptDivider:`${v}__divider`,paddingTop:`${v}__padTop`};function it(e){return{height:e+"px"}}function rt(e){return{width:e+"px"}}function at(){return{width:"75%"}}function ae(){return{textAlign:"center",padding:"1rem"}}function lt(e){return{width:"100%",height:window.getComputedStyle(e).getPropertyValue("max-height")}}function W(){return{height:"100%"}}function le(e){return{display:"flex",flexDirection:e}}function ot(e){return e instanceof ue}const nt={noExtension:-2147208474};let g=class extends Ce{constructor(e,t){super(e,t),this._selectToolActive=!1,this._activeTrace=null,this._activeSwatch="",this._traceHeaderForFlow="",this._assetGroupHeader="",this._assetTypeHeader="",this._traceResultsFunctions=[],this._traceResultsAssetGroup=[],this._traceResultsAssetType=[],this._traceResultsIndividual=[],this._showTraceResultFunctions=!1,this._showTraceResultAssetGroup=!1,this._showTraceResultAssetType=!1,this._showIndividualRecords=!1,this._activeTab="input",this._flagViewType="starting-point",this._alertRemoveModal=!1,this._warningNoFlag=!1,this._warningNoTraceSelected=!1,this._warningNoStartAssetFound=!1,this._warningNoBarrierAssetFound=!1,this._warningNoTerminal=!1,this._confirmReset=!1,this._showResultOptions=!1,this._resultObjectIdField="objectid",this._resultDisplayField="objectid",this._resultSortField="objectid",this._resultSortOrder="desc",this._swatchNode=null,this._individualResultNode=null,this._symbolStartFlag=null,this._symbolBarrier=null,this._watchHandler=null,this._loadUNError=!0,this._errorMessage="",this.disabled=!0,this.inputSettings=[],this.messages=null,this.messagesCommon=null,this.messagesUnits=null,this.viewModel=new _e,this._afterComponentCreate=this._afterComponentCreate.bind(this)}initialize(){this._utilityNetworkTraceInitialized(),this.addHandles(x(()=>{var e;return(e=this.viewModel)==null?void 0:e.resultAreaProperties},()=>this.scheduleRender()))}get defaultGraphicColor(){return this.viewModel.defaultGraphicColor}set defaultGraphicColor(e){this.viewModel.defaultGraphicColor=e}get flags(){return this.viewModel.flags}set flags(e){this.viewModel.flags=e}get gdbVersion(){return this.viewModel.gdbVersion}set gdbVersion(e){this.viewModel.gdbVersion=e}get icon(){return"utility-network-trace"}set icon(e){this._overrideIfSome("icon",e)}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get resultAreaProperties(){return this.viewModel.resultAreaProperties}set resultAreaProperties(e){this.viewModel.resultAreaProperties=e}get selectedTraces(){return this.viewModel.selectedTraces}set selectedTraces(e){this.viewModel.selectedTraces=e}get selectOnComplete(){return this.viewModel.selectOnComplete}set selectOnComplete(e){this.viewModel.selectOnComplete=e}get showGraphicsOnComplete(){return this.viewModel.showGraphicsOnComplete}set showGraphicsOnComplete(e){this.viewModel.showGraphicsOnComplete=e}get enableResultArea(){return this.viewModel.enableResultArea}set enableResultArea(e){this.viewModel.enableResultArea=e}get showSelectionAttributes(){return this.viewModel.showSelectionAttributes}set showSelectionAttributes(e){this.viewModel.showSelectionAttributes=e}get utilityNetwork(){return this.viewModel.utilityNetwork}set utilityNetwork(e){this.viewModel.utilityNetwork=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}async checkCanTrace(){this._confirmReset=!1;const e=this.viewModel.checkCanTrace();e.status?(this._warningNoFlag=!1,this._warningNoTraceSelected=!1,this._warningNoTraceSelected=!1,this._warningNoTerminal=!1,this._showTraceResultFunctions=!1,this._showTraceResultAssetGroup=!1,this._showTraceResultAssetType=!1,this._showIndividualRecords=!1,this.switchTab("result"),this.viewModel._activeProgress=!0,this.viewModel.removeAllResultAreaGraphics(),await this.viewModel.callTrace(),this.viewModel._activeProgress=!1):e.issues.forEach(t=>{switch(t){case"noStart":this._warningNoFlag=!0;break;case"noTerminalSelected":this._warningNoTerminal=!0;break;default:this._warningNoTraceSelected=!0}})}confirmReset(){this._confirmReset=!0}render(){const{state:e}=this.viewModel;this._mixCustomStrings(),this._overrideFlagSymbol();const t=e==="loading"?this._renderWarningMessage("noTraceConfig",!1):this._renderUtilityNetworkTrace();return l("div",{class:this.classes(b.base,D.widget,D.panel,{[D.widgetDisabled]:this.disabled}),styles:W()},t)}loadDependencies(){return Me({action:()=>m(()=>import("./calcite-action-BQdWHUTy.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15])),"action-group":()=>m(()=>import("./calcite-action-group-B8GYDGFN.js"),__vite__mapDeps([16,17,2,3,4,5,18,11,8,9,6,10,13,19,20,1,7,12,14,15,21,22,23,24,25,26,27])),"action-pad":()=>m(()=>import("./calcite-action-pad-DhsA5bpl.js"),__vite__mapDeps([28,2,3,4,5,18,11,6,8,9,10,13,29,17,19,20,1,7,12,14,15,21,22,23,24,25,26,27])),block:()=>m(()=>import("./calcite-block-qdFeD75E.js"),__vite__mapDeps([30,2,3,4,5,18,11,6,7,9,10,13,26,8,25,1,12,14,15,19,20,21,22,23,24,27,31,32])),"block-section":()=>m(()=>import("./calcite-block-section-CgMu0zRh.js"),__vite__mapDeps([33,2,3,4,5,6,10,9,11,13,8,14,34,35,7,36,12])),button:()=>m(()=>import("./calcite-button-B3dK3J4O.js"),__vite__mapDeps([37,38,2,3,4,5,35,6,7,36,12,8,9,10,11,13,14,15])),checkbox:()=>m(()=>import("./calcite-checkbox-B3jaud22.js"),__vite__mapDeps([39,2,3,4,5,6,35,7,10,36,12,8])),"color-picker-swatch":()=>m(()=>import("./calcite-color-picker-swatch-IOxk8WY7.js"),__vite__mapDeps([40,41,2,3,4,5,6])),combobox:()=>m(()=>import("./calcite-combobox-CFk50a9E.js"),__vite__mapDeps([42,43,2,3,4,5,44,45,23,6,22,35,7,36,12,8,9,10,11,25,13,46,47,48,14,49,18,50])),"combobox-item":()=>m(()=>import("./calcite-combobox-item-CebKWX2e.js"),__vite__mapDeps([51,49,2,3,4,5,18,11,6,7,47,12,14])),flow:()=>m(()=>import("./calcite-flow-DRMo8BV0.js"),__vite__mapDeps([52,2,3,4,5,11,8])),"flow-item":()=>m(()=>import("./calcite-flow-item-C1dz4xH2.js"),__vite__mapDeps([53,2,3,4,5,6,7,8,9,10,11,13,54,19,20,1,12,14,15,21,22,23,24,25,26,27,32])),icon:()=>m(()=>import("./calcite-icon-W-AdNGRC.js"),__vite__mapDeps([55,14,2,3,4,5,6,11])),"input-number":()=>m(()=>import("./calcite-input-number-CJjaZ08i.js"),__vite__mapDeps([56,57,2,3,4,5,6,35,7,10,36,12,8,9,11,13,46,58,14,50,59])),label:()=>m(()=>import("./calcite-label-75nr6He8.js"),__vite__mapDeps([60,2,3,4,5,36,6,12])),list:()=>m(()=>import("./calcite-list-Dnyd1Dz_.js"),__vite__mapDeps([61,2,3,4,5,6,7,11,62,63,8,13,9,10,45,23,14,64,35,36,12,46,58,50,59,15,32])),"list-item":()=>m(()=>import("./calcite-list-item-DvRwTdOl.js"),__vite__mapDeps([65,2,3,4,5,6,7,9,10,11,13,8,63,62,1,12,14,15,31])),loader:()=>m(()=>import("./calcite-loader-DWyhLzpy.js"),__vite__mapDeps([66,15,2,3,4,5,6,9,10,11])),notice:()=>m(()=>import("./calcite-notice-DA7FQ9_1.js"),__vite__mapDeps([67,2,3,4,5,18,11,6,8,9,10,13,25,12,14])),option:()=>m(()=>import("./calcite-option-rXI2IAFc.js"),__vite__mapDeps([68,2,3,4,5,11])),panel:()=>m(()=>import("./calcite-panel-DcFdTOap.js"),__vite__mapDeps([69,54,2,3,4,5,6,7,8,11,19,20,10,1,9,12,13,14,15,21,22,23,24,25,26,27,32])),popover:()=>m(()=>import("./calcite-popover-CqUVx7C5.js"),__vite__mapDeps([70,21,2,3,4,5,22,6,23,24,25,26,9,10,11,13,8,27,12,1,7,14,15])),scrim:()=>m(()=>import("./calcite-scrim-ChpvlkQb.js"),__vite__mapDeps([71,32,2,3,4,5,9,6,10,11,13,15])),select:()=>m(()=>import("./calcite-select-DumKFjGo.js"),__vite__mapDeps([72,2,3,4,5,6,35,7,36,12,8,11,46,14,50])),tab:()=>m(()=>import("./calcite-tab-sZKJtdlq.js"),__vite__mapDeps([73,74,2,3,4,5,6])),"tab-nav":()=>m(()=>import("./calcite-tab-nav-seQtCzON.js"),__vite__mapDeps([75,76,2,3,4,5,44,6,11,9,10,13,38,35,7,36,12,8,14,15])),"tab-title":()=>m(()=>import("./calcite-tab-title-DQ3WaKSS.js"),__vite__mapDeps([77,78,2,3,4,5,6,7,11,9,10,13,12,14])),tabs:()=>m(()=>import("./calcite-tabs-B_KJHFbv.js"),__vite__mapDeps([79,80,2,3,4,5,6])),tooltip:()=>m(()=>import("./calcite-tooltip-CXmK6QYS.js"),__vite__mapDeps([81,2,3,4,5,6,22,23,25,27]))})}switchTab(e){this._activeTab=e}switchToFunctions(e,t){this._traceResultsFunctions=e,this._showTraceResultFunctions=t}switchToAssetGroup(e,t,s){this._traceHeaderForFlow=t,this._traceResultsAssetGroup=e,this._showTraceResultAssetGroup=s}switchToAssetType(e,t,s){this._assetGroupHeader=t,this._traceResultsAssetType=e,this._showTraceResultAssetType=s}switchToIndividualRecords(e,t,s){this._assetTypeHeader=t,this._traceResultsIndividual=e,this._showIndividualRecords=s}_renderUtilityNetworkTrace(){const{messages:e,messagesCommon:t}=this;let s=l("calcite-tabs",{layout:"center",position:"top",styles:lt(this.container)},l("calcite-tab-nav",{slot:"title-group"},l("calcite-tab-title",{onclick:()=>{this.switchTab("input")},selected:this._activeTab==="input"},e.inputsStrings.headerTabInputs),l("calcite-tab-title",{onclick:()=>{this.switchTab("result")},selected:this._activeTab==="result"},e.resultsStrings.headerTabResults)),l("calcite-tab",{selected:this._activeTab==="input"},this._renderInputPanel()),l("calcite-tab",{selected:this._activeTab==="result"},this.viewModel._activeProgress?l("calcite-loader",{label:e.alertsStrings.traceExecuting,text:e.alertsStrings.traceExecuting,type:"indeterminate"}):this.viewModel.traceResults.length>0?this._renderResultPanel():this._renderWarningMessage("noTraceExecuted",!1),this._confirmReset?l("calcite-scrim",{key:"prompt"},l("div",{class:b.clearPrompt},l("h3",{slot:"header"},e.resultsStrings.startOverButton),l("div",{slot:"content"},e.resultsStrings.startOverValidation),l("div",{class:b.promptDivider}),l("div",{styles:le("row")},l("calcite-button",{appearance:"outline",onclick:()=>{this._confirmReset=!1},slot:"secondary",width:"full"},t.cancel),l("calcite-button",{onclick:()=>{this._confirmReset=!1,this.viewModel.reset(),this.switchTab("input")},slot:"primary",width:"full"},t.form.ok)))):null));return this.viewModel.traces.length===0&&(s=l("calcite-panel",null,this._renderWarningMessage("noTraceConfig",!1))),this._loadUNError||(s=l("calcite-panel",null,this._renderWarningMessage("loadUNError",!1,this._errorMessage))),s}_renderInputPanel(){const{messages:e}=this;return l("calcite-flow",{class:b.flow},l("calcite-flow-item",null,this._warningNoFlag?this._renderWarningMessage("flag",!0):null,this._warningNoTerminal?this._renderWarningMessage("noTerminal",!0):null,this._warningNoTraceSelected?this._renderWarningMessage("trace",!0):null,this._renderTraceSelectorContainer(),this._renderStartFlagsContainer(),this._renderBarriersFlagsContainer(),this._warningNoFlag&&this._warningNoTraceSelected?l("div",{styles:it(10)}):null,l("calcite-button",{kind:"brand",onclick:()=>{this.checkCanTrace()},slot:"footer",width:"full"},e.tracingStrings.runTrace)),this._selectToolActive?this._renderActiveTool():null)}_renderResultPanel(){return l("calcite-flow",{styles:W()},this._renderTraceResults(),this._showTraceResultFunctions?this._renderTraceResultFunctions():null,this._showTraceResultAssetGroup?this._renderTraceResultByAssetGroup():null,this._showTraceResultAssetType?this._renderTraceResultByAssetType():null,this._showIndividualRecords?this._renderTraceResultIndividual():null,this._showIndividualRecords?this._renderTraceResultIndividualPopover():null)}_renderStartFlagsContainer(){const{messages:e}=this,t=[];let s=[];s=this.viewModel._flags.filter(r=>r.type==="starting-point"),s.forEach(r=>{r.displayValue&&t.push(this._renderFlagRow(r,"start"))});let i=null;return this._symbolStartFlag&&(i=this._getSymbolIcon(this._symbolStartFlag)),l("calcite-block",{collapsible:!0,heading:e.inputsStrings.headerStartingPoint+" ("+s.length+")",open:!0,overlayPositioning:"fixed"},l("div",{slot:"icon"},i||l("calcite-icon",{icon:"pin",scale:"s"})),l("div",null,e.inputsStrings.startingPointHint),l("div",{class:b.listContainer},t),this._warningNoStartAssetFound?this._renderWarningMessage("noStartAsset",!0):null,l("div",{class:b.addButtonContainer},l("calcite-button",{alignment:"center",appearance:"outline",href:"",iconStart:"plus",label:e.inputsStrings.addPointOption,onclick:()=>{this._changeCursor("crosshair"),this._flagViewType="starting-point",this._selectToolActive=!0,this._warningNoStartAssetFound=!1,this.viewModel.addFlagByHit("starting-point",this._symbolStartFlag).then(r=>{this._changeCursor("default"),r?this._warningNoFlag=!1:this._warningNoStartAssetFound=!0,this._selectToolActive=!1})},round:!0})))}_renderBarriersFlagsContainer(){const{messages:e}=this,t=[];let s=[];s=this.viewModel._flags.filter(r=>r.type==="barrier"),s.forEach(r=>{r.displayValue&&t.push(this._renderFlagRow(r,"barrier"))});let i=null;return this._symbolBarrier&&(i=this._getSymbolIcon(this._symbolBarrier)),l("calcite-block",{collapsible:!0,heading:e.inputsStrings.headerBarrier+" ("+s.length+")",open:!1,overlayPositioning:"fixed"},l("div",{slot:"icon"},i||l("calcite-icon",{icon:"x-circle-f",scale:"s"})),l("div",null,e.inputsStrings.barrierPointHint),l("div",{class:b.listContainer},t),this._warningNoBarrierAssetFound?this._renderWarningMessage("noBarrierAsset",!0):null,l("div",{class:b.addButtonContainer},l("calcite-button",{alignment:"center",appearance:"outline",href:"",iconStart:"plus",kind:"brand",label:e.inputsStrings.addPointOption,onclick:()=>{this._changeCursor("crosshair"),this._flagViewType="barrier",this._selectToolActive=!0,this._warningNoBarrierAssetFound=!1,this.viewModel.addFlagByHit("barrier",this._symbolBarrier).then(r=>{this._changeCursor("default"),r||(this._warningNoBarrierAssetFound=!0),this._selectToolActive=!1})},round:!0})))}_renderFlagRow(e,t){var o;const{messages:s,messagesCommon:i}=this,r=[];let a=!1;return e.allTerminals!=null&&e.allTerminals.terminals.length>0&&(a=!0,e.allTerminals.terminals.forEach(n=>{var h;let c=!1;(h=e==null?void 0:e.selectedTerminals)!=null&&h.includes(n.id)&&(c=!0),r.push(l("calcite-combobox-item",{key:n.name,selected:c,textLabel:n.name,value:n.id}))})),l("calcite-block",{collapsible:e.allTerminals!==null||e.type==="barrier",heading:((o=e.displayValue)==null?void 0:o.value)??"",key:"pop"+e.globalId+e.type+e.id+t,overlayPositioning:"fixed"},l("calcite-action",{icon:"trash",label:i.remove,onclick:()=>{this.viewModel.removeFlag(e)},scale:"s",slot:"header-menu-actions",text:i.remove,textEnabled:!0}),l("calcite-action",{icon:"zoom-to-object",label:s.globalStrings.zoomToFeature,onclick:()=>{this.viewModel.zoomToAsset(e.details.geometry)},scale:"s",slot:"header-menu-actions",text:s.globalStrings.zoomToFeature,textEnabled:!0}),e.type==="barrier"?l("calcite-label",{layout:"inline",scale:"s"},l("calcite-checkbox",{checked:e.isFilterBarrier,onclick:()=>{this.viewModel.manageFilterBarrier(!e.isFilterBarrier,e)},scale:"s"}),s.inputsStrings.barrierFilter):null,a?l("calcite-combobox",{label:s.globalStrings.selectTerminalPlaceholder,maxItems:0,placeholder:s.globalStrings.selectTerminalPlaceholder,scale:"s",selectionMode:"multiple",onCalciteComboboxChange:n=>{n.target.selectedItems.length>0?(e.selectedTerminals=[],n.target.selectedItems.forEach(c=>{this.viewModel.addTerminal(c.value,e)})):e.selectedTerminals=[]},onCalciteComboboxChipClose:n=>{n.preventDefault(),this.viewModel.removeTerminal(n.target.value,e)}},r):null)}_renderActiveTool(){const{messages:e}=this;let t=null;return this._flagViewType==="starting-point"?this._symbolStartFlag&&(t=this._getSymbolIcon(this._symbolStartFlag)):this._symbolBarrier&&(t=this._getSymbolIcon(this._symbolBarrier)),l("calcite-flow-item",{heading:e.inputsStrings.addPointOption,onCalciteFlowItemBack:()=>{var s;this.viewModel.removeClickHandler(),(s=this.view)!=null&&s.popup&&(this.view.popupEnabled=!0),this._changeCursor("default"),this._selectToolActive=!1}},l("calcite-block",{collapsible:!1,heading:"",open:!0,overlayPositioning:"fixed"},l("div",{styles:ae()},t||l("calcite-icon",{icon:this._flagViewType==="starting-point"?"pin-plus":"x-circle-f"})),l("div",{styles:ae()},e.inputsStrings.addPointHint)))}_renderTraceSelectorContainer(){const{messages:e}=this,t=[];let s=e.tracingStrings.traceOperation,i=0;return this.viewModel.traces.length>0&&this.viewModel.traces.forEach(r=>{t.push(l("calcite-combobox-item",{key:r.globalId,selected:r.selected,textLabel:r.title,value:r.globalId,onCalciteComboboxItemChange:a=>{const o=a.target;this.viewModel.selectTraces(o.selected,o.value),this.viewModel.traces.length>0&&(this._warningNoTraceSelected=!1)}})),r.selected&&i++}),s+=` (${i})`,l("calcite-block",{collapsible:!0,heading:s,open:!0,overlayPositioning:"fixed"},l("calcite-icon",{icon:"utility-network-trace",scale:"s",slot:"icon"}),l("calcite-combobox",{label:e.inputsStrings.selectTraces,maxItems:0,overlayPositioning:"fixed",placeholder:e.inputsStrings.selectTraces,scale:"s",selectionMode:"multiple"},t))}_renderStartOverContainer(){const{messages:e}=this;return l("calcite-button",{kind:"brand",onclick:()=>{this.confirmReset()},slot:"footer",width:"full"},e.resultsStrings.startOverButton)}_renderWarningMessage(e,t,s){const{messages:i}=this;let r=i.alertsStrings.NoRunAlertHeader,a=i.alertsStrings.noResultsInfo;switch(e){case"flag":r=i.alertsStrings.startingPointAlertHeader,a=i.alertsStrings.startingPointAlert;break;case"noTerminal":r=i.alertsStrings.noTerminalDefinedHeader,a=i.alertsStrings.noTerminalDefined;break;case"trace":r=i.alertsStrings.selectTraceAlertHeader,a=i.alertsStrings.selectTraceAlert;break;case"noTraceExecuted":r=i.alertsStrings.NoRunAlertHeader,a=i.alertsStrings.noResultsInfo;break;case"noBarrierAsset":case"noStartAsset":r=i.alertsStrings.noAssetsFoundHeader,a=i.alertsStrings.noAssetFound;break;case"noTraceConfig":r="",a=i.alertsStrings.noTraceSupported;break;default:r=i.alertsStrings.genericErrorHeader,a=s||""}return l("div",{class:b.noticeContainer,key:e},l("calcite-notice",{closable:t,icon:!0,key:e,kind:"danger",open:!0,scale:"s",width:"auto",onCalciteNoticeClose:()=>{switch(e){case"flag":this._warningNoFlag=!1;break;case"noTerminal":this._warningNoTerminal=!1;break;case"trace":this._warningNoTraceSelected=!1;break;case"noStartAsset":this._warningNoStartAssetFound=!1;break;case"noBarrierAsset":this._warningNoBarrierAssetFound=!1}}},l("div",{slot:"title"},r),l("div",{slot:"message"},a)))}_renderRemoveTraceContainer(e){const{messages:t}=this;return l("calcite-action",{icon:"trash",label:t.globalStrings.clearResults,onclick:()=>{this._alertRemoveModal=!0,this._activeTrace=e.trace},scale:"s",slot:"header-menu-actions",text:t.globalStrings.clearResults,textEnabled:!0})}_renderHighlightColorPicker(e,t,s){const{messages:i}=this,{graphicHandler:r}=this.viewModel,a=[],o=new RegExp(`^${e.hex}$`,"i"),n=r.highlightColor.length>J.length?5:4;for(const c of r.highlightColor)a.push(l("calcite-action",{active:o.test(c.hex),key:c.hex,label:i.resultsStrings.graphicColor,onclick:()=>{s==="aggregate"?this.viewModel.changeResultGraphicColor(c,t):this.viewModel.changeResultAreaColor(t,c)},scale:"s",text:i.resultsStrings.graphicColor},l("calcite-color-picker-swatch",{active:o.test(c.hex),color:c.hex,scale:"s"})));return l("calcite-action-pad",{expandDisabled:!0,layout:"grid",position:"start"},l("calcite-action-group",{columns:n,layout:"grid"},a))}_renderTraceResults(){const{messages:e,messagesCommon:t}=this,{selectFeatures:s}=e.resultsStrings,i=this.viewModel.traceResults,r=[];return i.forEach((a,o)=>{var A,T,F,I,C,M;let n=[],c=[],h=!1,p=!1,_=!1,y="";a.results!==null&&a.results.hasOwnProperty("elements")?(a.results.aggregatedGeometry!==null&&(p=!0),a.results.globalFunctionResults!==null&&a.results.globalFunctionResults.length>0&&(c=a.results.globalFunctionResults,c.length>0&&(_=!0)),a.results.elements&&a.results.elements.length>0&&(n=a.results.elements,n.length>0&&(h=!0)),(p||h)&&(y=(T=this.messagesUnits.units[(A=a.resultArea)==null?void 0:A.unit])==null?void 0:T.abbr),r.push(l("calcite-block",{collapsible:!0,description:a.trace.description??"",heading:a.trace.title,key:`${a.trace.title}${o}`,open:!0,overlayPositioning:"fixed"},this._renderRemoveTraceContainer(a),l("calcite-list",null,_?l("calcite-list-item",{label:e.resultsStrings.functionHeader+" ("+c.length+")",onCalciteListItemSelect:()=>{this.switchToFunctions(c,!0)}},l("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})):null,h&&this.viewModel.showSelectionAttributes?l("calcite-list-item",{key:this.id,label:e.resultsStrings.viewFeatures+" ("+n.length+")",onCalciteListItemSelect:()=>{this.switchToAssetGroup(this._groupResultsByAssetGroup(a),a.trace.title+" ("+n.length+")",!0)}},l("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"})):this.viewModel.showSelectionAttributes?l("calcite-label",{layout:"inline",scale:"s"},e.resultsStrings.noSelectionResults):null),h?l("div",{class:b.paddingTop},l("calcite-label",{layout:"inline",onclick:f=>{f.preventDefault(),f.stopPropagation(),this.viewModel.mergeSelection(!a.selectionEnabled,a.trace)},scale:"s"},l("calcite-checkbox",{checked:a.selectionEnabled,onclick:f=>{f.preventDefault(),f.stopPropagation(),this.viewModel.mergeSelection(!a.selectionEnabled,a.trace)}}),this.viewModel.showSelectionAttributes?s:`${s} (${n.length})`)):null,p?l("calcite-block-section",{key:`aggregate-${a.trace.title}-${o}`,open:a.graphicEnabled,text:e.resultsStrings.highlightTrace,toggleDisplay:"switch",onCalciteBlockSectionToggle:f=>{f.target.open?this.viewModel.changeResultGraphicColor(a.graphicColor,a):this.viewModel.removeResultGraphicFromView(a)}},l("calcite-list",{selectionMode:"none"},l("calcite-list-item",{label:e.resultsStrings.graphicColor,onclick:f=>{const R=f.target;this._swatchNode=R,this._activeSwatch="aggGeom_"+o}},l("calcite-color-picker-swatch",{color:a.graphicColor.hex,scale:"s",slot:"actions-end"})))):null,this.enableResultArea&&(p||h)?l("calcite-block-section",{key:`area-${a.trace.title}-${o}`,open:(F=a.resultArea)==null?void 0:F.show,text:e.resultsStrings.resultAreaHeader,toggleDisplay:"switch",onCalciteBlockSectionToggle:f=>{f.target.open?a.resultAreaGraphic?this.viewModel.addResultAreaToMap(a,a.resultAreaGraphic):this.viewModel.addResultAreaToMap(a):this.viewModel.removeResultAreaFromMap(a)}},l("calcite-list",{selectionMode:"none"},l("calcite-list-item",{label:e.resultsStrings.graphicColor,onclick:f=>{const R=f.target;this._swatchNode=R,this._activeSwatch="resultArea_"+o}},l("calcite-color-picker-swatch",{color:(I=a.resultArea)==null?void 0:I.color.hex,scale:"s",slot:"actions-end"}))),l("calcite-list",{selectionMode:"none"},l("calcite-list-item",{label:e.resultsStrings.resultAreaBuffer},l("calcite-input-number",{afterCreate:this._afterComponentCreate,class:b.numberInput,max:999999,maxLength:999999,min:0,scale:"s",slot:"actions-end",suffixText:y,value:(C=a.resultArea)==null?void 0:C.distance.toString(),onCalciteInputNumberChange:f=>{var G;if(!((G=this.view)!=null&&G.popup))return;this.view.popup.visible&&this.view.closePopup();const R=f.target;a.resultArea.distance>=0?(a.resultArea.distance=parseInt(R.value,10),this.viewModel.removeResultAreaFromMap(a),this.viewModel.addResultAreaToMap(a)):(a.resultArea.distance=0,this.viewModel.removeResultAreaFromMap(a),this.viewModel.addResultAreaToMap(a))}})))):null,l("calcite-popover",{autoClose:!0,closable:!0,label:e.resultsStrings.graphicColor,offsetDistance:0,offsetSkidding:0,open:this._activeSwatch==="aggGeom_"+o||this._activeSwatch==="resultArea_"+o,placement:"auto-start",referenceElement:this._swatchNode,scale:"s",onCalcitePopoverClose:()=>{this._swatchNode=null,this._activeSwatch=null}},this._renderHighlightColorPicker(this._activeSwatch==="resultArea_"+o?(M=a.resultArea)==null?void 0:M.color:a.graphicColor,a,this._activeSwatch==="resultArea_"+o?"resultArea":"aggregate"))))):r.push(l("calcite-block",{collapsible:!1,heading:a.trace.title,key:"error-"+o,open:!0,overlayPositioning:"fixed"},this._renderRemoveTraceContainer(a),this._renderWarningMessage("noController",!1,a.status)))}),l("calcite-flow-item",{key:"traceResults",styles:W()},r,this._renderStartOverContainer(),this._alertRemoveModal?l("calcite-scrim",{key:"prompt"},l("div",{class:b.clearPrompt},l("h3",{slot:"header"},e.globalStrings.clearResults),l("div",{slot:"content"},e.alertsStrings.clearResultsAlert),l("div",{class:b.promptDivider}),l("div",{styles:le("row")},l("calcite-button",{appearance:"outline",onclick:()=>{this._alertRemoveModal=!1},slot:"secondary",width:"full"},t.cancel),l("calcite-button",{onclick:()=>{this._activeTrace&&this.viewModel.clearResult(this._activeTrace),this._alertRemoveModal=!1,this.viewModel.traceResults.length===0?this.switchTab("input"):(this._activeTrace=this.viewModel.traceResults[0].trace,this._showTraceResultFunctions=!1,this._showTraceResultAssetGroup=!1,this._showTraceResultAssetType=!1,this._showIndividualRecords=!1)},slot:"primary",width:"full"},t.form.ok)))):null)}_renderTraceResultFunctions(){const{messages:e}=this,t=this._traceResultsFunctions,s=[];return t.forEach(i=>{s.push(this._renderResultRowFunctions(i))}),l("calcite-flow-item",{heading:e.resultsStrings.functionHeader,key:"functionResultMultiple",onCalciteFlowItemBack:()=>{this.switchToFunctions([],!1)}},s,this._renderStartOverContainer())}_renderTraceResultByAssetGroup(){const e=this._traceResultsAssetGroup,t=[];for(const s in e){const i=e[s];for(const r in i)t.push(this._renderResultRowAssetGroup(i[r]))}return l("calcite-flow-item",{heading:this._traceHeaderForFlow,key:"assetGroupResultMultiple",onCalciteFlowItemBack:()=>{this.switchToAssetGroup([],"",!1)}},l("calcite-list",null,t),this._renderStartOverContainer())}_renderTraceResultByAssetType(){const e=this._traceResultsAssetType,t=[];for(const s in e)e[s].length>0&&t.push(this._renderResultRowAssetType(e[s]));return l("calcite-flow-item",{heading:this._assetGroupHeader,key:"assetTypeResult",onCalciteFlowItemBack:()=>{this.switchToAssetType([],"",!1)}},l("calcite-list",{selectionMode:"none"},t),this._renderStartOverContainer())}_renderTraceResultIndividual(){var i;const{messages:e}=this,t=this._traceResultsIndividual;t.sort(this._compare(this._resultSortField,this._resultSortOrder));const s=[];return t.length>0&&((((i=t[0].details)==null?void 0:i.fields.some(({name:r})=>r.toLowerCase()===this._resultDisplayField.toLocaleLowerCase()))??!1)||(this._resultDisplayField=this._resultObjectIdField,this._resultSortField=this._resultObjectIdField),t.forEach(r=>{r!=null&&r.details&&s.push(this._renderResultRowIndividual(r))}),s.length===0&&s.push(l("calcite-list-item",{label:e.resultsStrings.noFeaturesInMap}))),l("calcite-flow-item",{heading:this._assetTypeHeader,key:"individualResult",onCalciteFlowItemBack:()=>{this._showResultOptions=!1,this.switchToIndividualRecords([],"",!1)}},l("calcite-action",{afterCreate:Ge,bind:this,"data-node-ref":"_individualResultNode",icon:"gear",id:"field_options"+this.id,label:e.resultsStrings.displayAttribute,onclick:()=>{this._showResultOptions=!0},slot:"header-actions-end",text:e.resultsStrings.displayAttribute}),l("calcite-list",{selectionMode:"none"},s),this._renderStartOverContainer())}_renderTraceResultIndividualPopover(){const{messages:e}=this,t=this._traceResultsIndividual,s=[],i=[];return t.length>0&&(t[0].details?t[0].details.fields.forEach(({name:r,alias:a})=>{s.push(l("calcite-option",{key:`display-${r}`,label:a??r,selected:r===this._resultDisplayField,value:r})),i.push(l("calcite-option",{key:`sort-${r}`,label:a??r,selected:r===this._resultSortField,value:r}))}):(s.push(l("calcite-option",{key:`display-${this._resultDisplayField}`,label:this._resultDisplayField,value:this._resultDisplayField})),i.push(l("calcite-option",{key:`sort-${this._resultDisplayField}`,label:this._resultDisplayField,value:this._resultDisplayField})))),l("calcite-popover",{autoClose:!0,label:e.resultsStrings.displayAttribute,offsetDistance:0,offsetSkidding:0,open:this._showResultOptions,overlayPositioning:"fixed",placement:"left-start",referenceElement:this._individualResultNode,styles:this.domNode!==null?rt(.75*this.domNode.clientWidth):at()},l("calcite-block",{heading:"",open:!0,overlayPositioning:"fixed"},l("calcite-label",{scale:"s"},e.resultsStrings.displayAttribute,l("calcite-select",{label:e.resultsStrings.displayAttribute,scale:"s",onCalciteSelectChange:r=>{const a=r.target;this._resultDisplayField=a.selectedOption.value,this._showResultOptions=!1}},s)),l("calcite-label",{scale:"s"},e.resultsStrings.sortBy,l("calcite-select",{label:e.resultsStrings.sortBy,scale:"s",onCalciteSelectChange:r=>{const a=r.target;this._resultSortField=a.selectedOption.value,t.sort(this._compare(this._resultSortField,this._resultSortOrder)),this._traceResultsIndividual=t,this._showResultOptions=!1}},i))))}_renderResultRowFunctions(e){return l("calcite-block",{collapsible:!1,heading:e.networkAttributeName+" "+e.functionType+" = "+e.result,overlayPositioning:"fixed"})}_renderResultRowAssetGroup(e){const t=this._getAssetGroupName(e[0]);return l("calcite-list-item",{label:t+" ("+e.length+")",onCalciteListItemSelect:()=>{this.switchToAssetType(this._groupResultsByAssetType(e),t+" ("+e.length+")",!0)}},l("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"}))}_renderResultRowAssetType(e){const t=this._getAssetTypeName(e[0]);return l("calcite-list-item",{label:t+" ("+e.length+")",onCalciteListItemSelect:()=>{this.viewModel.queryFeaturesById(e).then(s=>{if(s!=null&&s.length){this._resultObjectIdField=s[0].layer.objectIdField,this._resultDisplayField==="objectid"&&(this._resultDisplayField=s[0].layer.objectIdField),this._resultSortField==="objectid"&&(this._resultSortField=s[0].layer.objectIdField);const i=this._appendAttributes(e,s,"objectId");this.switchToIndividualRecords(i,t+" ("+e.length+")",!0)}else this.switchToIndividualRecords(e,t+" ("+e.length+")",!0)})}},l("calcite-icon",{icon:"chevron-right",scale:"s",slot:"content-end"}))}_renderResultRowIndividual(e){var n,c,h;const{messages:t}=this,s=`display-${e.objectId}-nso`,{nonSpatialObject:i,zoomToFeature:r}=t.globalStrings;let a="",o=null;if(o=(n=e==null?void 0:e.details)==null?void 0:n.fields.find(({name:p})=>p===this._resultDisplayField),(o==null?void 0:o.type)==="date")a=new Date(e.details.attributes[this._resultDisplayField]).toDateString();else if(this._resultDisplayField.toLowerCase()==="assetgroup")a=this._getAssetGroupName(e);else if(this._resultDisplayField.toLowerCase()==="assettype")a=this._getAssetTypeName(e);else if(o!=null&&o.domain&&ot(o.domain)){const p=o.domain.codedValues.find(({code:_})=>_===e.details.attributes[this._resultDisplayField]);a=p==null?void 0:p.name}else a=((c=e.details)==null?void 0:c.attributes[this._resultDisplayField])??e.objectId;return a&&a!==""&&a!==null?typeof a=="string"&&(a.trim()||(a=t.resultsStrings.noValue)):a=t.resultsStrings.noValue,((h=e==null?void 0:e.details)==null?void 0:h.geometry)!==null?l("calcite-list-item",{label:a,onCalciteListItemSelect:()=>{this.viewModel.zoomToAsset(e.details.geometry)}},l("calcite-icon",{icon:"zoom-to-object",scale:"s",slot:"content-end",textLabel:r})):l("calcite-list-item",{label:a},l("calcite-icon",{icon:"table",id:s,scale:"s",slot:"content-end",textLabel:i}),l("calcite-tooltip",{label:i,referenceElement:s},l("span",null,i)))}_afterComponentCreate(e){"value"in e&&e.value!=null&&"setNumberValue"in e&&e.setNumberValue({committing:!1,value:e.value,origin:"direct"})}_mixCustomStrings(){const{messages:e}=this;this.inputSettings.length>0&&this.inputSettings.forEach(t=>{t.type==="starting-point"&&(e.inputsStrings.headerStartingPoint=t.label,e.inputsStrings.startingPointHint=t.description),t.type==="barrier"&&(e.inputsStrings.headerBarrier=t.label,e.inputsStrings.barrierPointHint=t.description)})}_overrideFlagSymbol(){this.inputSettings.length>0&&this.inputSettings.forEach(e=>{e.type==="starting-point"?this._symbolStartFlag=e.symbol:this._symbolBarrier=e.symbol,this.viewModel.changeFlagSymbol(e.type,e.symbol)})}_utilityNetworkTraceInitialized(){return this.viewModel.loadUtilityNetwork().then(e=>{var t;if(e)return this.viewModel.selectTracesOnLoad(),this._registerWatchers(),this.viewModel.flags.length>0&&this._processFlagOnLoad(),(t=this.view)==null?void 0:t.when().then(()=>{this._watchViewState()});this.disabled=!1}).catch(e=>{const{messages:t}=this;this._loadUNError=!1,e.name==="utility-network:no-user-type-extension"||e.details.raw.extendedCode===nt.noExtension?this._errorMessage=t.alertsStrings.noUserExtension:this._errorMessage=e.message,this.disabled=!1})}_processFlagOnLoad(){var e;return(e=this.view)==null?void 0:e.when().then(()=>{this._watchHandler=Q(()=>{var t;return!((t=this.view)!=null&&t.updating)},async()=>{this._warningNoFlag=!1,this._warningNoBarrierAssetFound=!1,this._warningNoStartAssetFound=!1;const t=await this.viewModel.addFlagsOnLoad();this.viewModel.removeFlagsOnLoadWatcher(),t.includes("barrier")&&(this._warningNoBarrierAssetFound=!0),t.includes("starting-point")&&(this._warningNoStartAssetFound=!0),this.disabled=!1,this._watchHandler!==null&&this._watchHandler.remove()})})}_registerWatchers(){this.addHandles([x(()=>this.selectedTraces,()=>{this.viewModel.selectTracesOnLoad(),this.scheduleRender()}),x(()=>this.defaultGraphicColor,()=>{this.viewModel.traceResults.length>0&&this.viewModel.traceResults.forEach(e=>{this.viewModel.changeResultGraphicColor(this.viewModel.defaultGraphicColor,e)}),this.scheduleRender()})])}_groupResultsByAssetGroup(e){var r;const t=[],s=(r=e.results)==null?void 0:r.elements,i=this._groupBy(s??[],"networkSourceId");for(const a in i)t.push(this._groupBy(i[a],"assetGroupCode"));return t}_groupResultsByAssetType(e){return this._groupBy(e,"assetTypeCode")}_appendAttributes(e,t,s){const i=[];return e.forEach(r=>{t.forEach(a=>{a.featureSet.features.forEach(o=>{r[s]===o.attributes[this._resultObjectIdField]&&(r.details=o,r.details.fields=a.featureSet.fields,i.push(r))})})}),i}_getAssetGroupName(e){let t=e.assetGroupCode.toString();const s=e.assetGroupCode,i=this.viewModel.getValidSources().find(r=>r.sourceId===e.networkSourceId);if(i){const r=i.assetGroups.find(a=>a.assetGroupCode===s);r&&(t=r.assetGroupName)}return t}_getAssetTypeName(e){let t=e.assetTypeCode.toString();const s=e.assetGroupCode,i=this.viewModel.getValidSources().find(r=>r.sourceId===e.networkSourceId);if(i){const r=i.assetGroups.find(a=>a.assetGroupCode===s);if(r){const a=r.assetTypes.find(o=>o.assetTypeCode===e.assetTypeCode);a&&(t=a.assetTypeName)}}return t}_compare(e,t){return(s,i)=>{var n,c;let r=0,a=((n=s.details)==null?void 0:n.attributes[e])??s.objectId,o=((c=i.details)==null?void 0:c.attributes[e])??i.objectId;return isNaN(a)&&(a=a.toLowerCase()),isNaN(o)&&(o=o.toLowerCase()),t==="desc"?a>o?r=1:a<o&&(r=-1):a<o?r=1:a>o&&(r=-1),r}}_groupBy(e,t){return e.reduce((s,i)=>((s[i[t]]=s[i[t]]||[]).push(i),s),{})}_getSymbolIcon(e){return e.type==="picture-marker"?l("img",{height:e.height,src:e.url??void 0,width:e.width}):null}_watchViewState(){this._watchHandler=Q(()=>{var e;return!((e=this.view)!=null&&e.updating)},()=>{this.disabled=!1,this._watchHandler!==null&&this._watchHandler.remove()},{initial:!0})}_changeCursor(e="default"){var s,i;const t=(i=(s=this.view)==null?void 0:s.container)==null?void 0:i.style;t&&(t.cursor=e)}};u([d()],g.prototype,"_selectToolActive",void 0),u([d()],g.prototype,"_activeTrace",void 0),u([d()],g.prototype,"_activeSwatch",void 0),u([d()],g.prototype,"_traceHeaderForFlow",void 0),u([d()],g.prototype,"_assetGroupHeader",void 0),u([d()],g.prototype,"_assetTypeHeader",void 0),u([d()],g.prototype,"_traceResultsFunctions",void 0),u([d()],g.prototype,"_traceResultsAssetGroup",void 0),u([d()],g.prototype,"_traceResultsAssetType",void 0),u([d()],g.prototype,"_traceResultsIndividual",void 0),u([d()],g.prototype,"_showTraceResultFunctions",void 0),u([d()],g.prototype,"_showTraceResultAssetGroup",void 0),u([d()],g.prototype,"_showTraceResultAssetType",void 0),u([d()],g.prototype,"_showIndividualRecords",void 0),u([d()],g.prototype,"_activeTab",void 0),u([d()],g.prototype,"_alertRemoveModal",void 0),u([d()],g.prototype,"_warningNoFlag",void 0),u([d()],g.prototype,"_warningNoTraceSelected",void 0),u([d()],g.prototype,"_confirmReset",void 0),u([d()],g.prototype,"_swatchNode",void 0),u([d()],g.prototype,"_errorMessage",void 0),u([d()],g.prototype,"defaultGraphicColor",null),u([d()],g.prototype,"disabled",void 0),u([d()],g.prototype,"flags",null),u([d()],g.prototype,"gdbVersion",null),u([d()],g.prototype,"icon",null),u([d()],g.prototype,"inputSettings",void 0),u([d()],g.prototype,"label",null),u([d(),H("esri/widgets/UtilityNetworkTrace/t9n/UtilityNetworkTrace")],g.prototype,"messages",void 0),u([d(),H("esri/t9n/common")],g.prototype,"messagesCommon",void 0),u([d(),H("esri/core/t9n/Units")],g.prototype,"messagesUnits",void 0),u([d()],g.prototype,"resultAreaProperties",null),u([d()],g.prototype,"selectedTraces",null),u([d()],g.prototype,"selectOnComplete",null),u([d()],g.prototype,"showGraphicsOnComplete",null),u([d()],g.prototype,"enableResultArea",null),u([d()],g.prototype,"showSelectionAttributes",null),u([d()],g.prototype,"utilityNetwork",null),u([d()],g.prototype,"view",null),u([Ne(["add-flag","add-flag-complete","add-flag-error","select-features","clear-selection","add-result-area","remove-result-area","create-result-area"]),d({type:_e})],g.prototype,"viewModel",void 0),g=u([ce("esri.widgets.UtilityNetworkTrace")],g);const bs=g;export{bs as default};
